# 통합 배포 워크플로우 가이드

## 📋 목차
1. [개요](#개요)
2. [워크플로우 아키텍처](#워크플로우-아키텍처)
3. [구성 요소](#구성-요소)
4. [사용 방법](#사용-방법)
5. [CI/CD 통합](#cicd-통합)
6. [설정 및 구성](#설정-및-구성)

---

## 개요

이 통합 배포 워크플로우는 Node.js, Python, Java, MySQL, PostgreSQL, MongoDB의 전체 설치 및 배포 프로세스를 자동화합니다.

### 주요 기능
- ✅ **다중 OS 지원**: Ubuntu, CentOS, Amazon Linux
- ✅ **자동 백업**: 배포 전 자동 백업 생성
- ✅ **보안 설정**: 데이터베이스 보안 자동화
- ✅ **테스트 자동화**: 설치 검증 및 스모크 테스트
- ✅ **롤백 지원**: 배포 실패 시 자동 롤백
- ✅ **CI/CD 통합**: GitHub Actions, Jenkins, GitLab CI 지원
- ✅ **알림 시스템**: Slack, Email 알림

---

## 워크플로우 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                   배포 워크플로우 오케스트레이터               │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  사전 검사    │     │   백업 생성   │     │  설치 실행    │
└──────────────┘     └──────────────┘     └──────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  보안 설정    │     │   테스트 실행 │     │  배포 완료    │
└──────────────┘     └──────────────┘     └──────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  성공/실패 알림   │
                    └──────────────────┘
```

---

## 구성 요소

### 1. 핵심 스크립트

| 파일명 | 용도 | 설명 |
|--------|------|------|
| `deployment_workflow.sh` | 메인 오케스트레이터 | 전체 배포 프로세스 관리 |
| `ci_cd_pipeline.sh` | CI/CD 통합 | 자동화된 배포 파이프라인 |
| `install_ubuntu.sh` | Ubuntu 설치 | Ubuntu/Debian 환경 설치 |
| `install_centos.sh` | CentOS 설치 | CentOS/RHEL 환경 설치 |
| `install_amazon_linux.sh` | AWS 설치 | Amazon Linux 환경 설치 |
| `upgrade_all.sh` | 업그레이드 | 기존 시스템 업그레이드 |

### 2. CI/CD 설정 파일

| 파일명 | 플랫폼 | 용도 |
|--------|--------|------|
| `.github_workflows_deploy.yml` | GitHub Actions | GitHub CI/CD |
| `Jenkinsfile` | Jenkins | Jenkins Pipeline |
| `.gitlab-ci.yml` | GitLab | GitLab CI/CD |

### 3. 문서

| 파일명 | 내용 |
|--------|------|
| `DEPLOYMENT_GUIDE.md` | 상세 배포 가이드 |
| `DEPLOYMENT_CHECKLIST.md` | 단계별 체크리스트 |
| `WORKFLOW_README.md` | 워크플로우 가이드 (현재 문서) |

---

## 사용 방법

### 1. 수동 배포

#### 전체 배포 (권장)
```bash
# 1. 스크립트 다운로드
git clone <repository-url>
cd deployment-scripts

# 2. 실행 권한 부여
chmod +x *.sh

# 3. 워크플로우 실행
sudo ./deployment_workflow.sh

# 4. 옵션 선택
# 1) 전체 배포 선택
```

#### 설정 파일 커스터마이징
```bash
# deployment_config.conf 생성/수정
cat > deployment_config.conf << EOF
# 설치할 컴포넌트
INSTALL_NODEJS=true
INSTALL_PYTHON=true
INSTALL_JAVA=true
INSTALL_MYSQL=true
INSTALL_POSTGRESQL=true
INSTALL_MONGODB=true

# 보안 설정
AUTO_SECURITY_SETUP=false
CREATE_BACKUP=true
RUN_TESTS=true

# 데이터베이스 비밀번호 (선택사항)
MYSQL_ROOT_PASSWORD="YourStrongPassword123!"
POSTGRES_ADMIN_PASSWORD="YourStrongPassword123!"
MONGODB_ADMIN_PASSWORD="YourStrongPassword123!"
EOF

# 워크플로우 실행
sudo ./deployment_workflow.sh
```

### 2. 개별 스크립트 실행

#### OS별 설치
```bash
# Ubuntu/Debian
sudo ./install_ubuntu.sh

# CentOS/RHEL
sudo ./install_centos.sh

# Amazon Linux
sudo ./install_amazon_linux.sh
```

#### 업그레이드만
```bash
sudo ./upgrade_all.sh
```

### 3. 단계별 수동 제어

```bash
# 워크플로우 실행
sudo ./deployment_workflow.sh

# 메뉴 선택:
# 1) 전체 배포 (설치 + 설정 + 테스트)
# 2) 설치만
# 3) 업그레이드만
# 4) 테스트만
# 5) 롤백
```

---

## CI/CD 통합

### GitHub Actions

#### 1. 리포지토리 설정

**Secrets 추가** (Settings → Secrets → Actions):
```
SSH_PRIVATE_KEY_STAGING    # 스테이징 SSH 키
SSH_PRIVATE_KEY_PRODUCTION # 프로덕션 SSH 키
STAGING_USER               # 스테이징 사용자명
STAGING_HOST               # 스테이징 호스트
PROD_USER                  # 프로덕션 사용자명
PROD_HOST                  # 프로덕션 호스트
SLACK_WEBHOOK              # Slack 웹훅 URL
MAIL_SERVER                # 메일 서버
NOTIFICATION_EMAIL         # 알림 이메일
```

#### 2. 워크플로우 파일 배치
```bash
# GitHub Actions 워크플로우 디렉토리 생성
mkdir -p .github/workflows

# 워크플로우 파일 복사
cp .github_workflows_deploy.yml .github/workflows/deploy.yml

# Git에 추가 및 푸시
git add .github/workflows/deploy.yml
git commit -m "Add deployment workflow"
git push
```

#### 3. 배포 실행

**자동 배포**:
- `develop` 브랜치에 푸시 → 스테이징 배포
- `main` 브랜치에 푸시 → 프로덕션 배포

**수동 배포**:
1. Actions 탭 클릭
2. "Deployment Pipeline" 선택
3. "Run workflow" 클릭
4. 환경 선택 (staging/production)
5. "Run workflow" 실행

### Jenkins

#### 1. Jenkins 설정

**필요한 플러그인**:
- Pipeline
- SSH Agent
- Slack Notification
- Email Extension

**Credentials 추가**:
```
staging-ssh-key  # 스테이징 SSH 키
prod-ssh-key     # 프로덕션 SSH 키
slack-webhook-url # Slack 웹훅
```

**환경 변수 설정**:
```
STAGING_USER  # 스테이징 사용자
STAGING_HOST  # 스테이징 호스트
PROD_USER     # 프로덕션 사용자
PROD_HOST     # 프로덕션 호스트
```

#### 2. Pipeline Job 생성

1. Jenkins 대시보드 → "New Item"
2. "Pipeline" 선택
3. "Pipeline script from SCM" 선택
4. Repository URL 입력
5. Script Path: `Jenkinsfile`
6. 저장

#### 3. 배포 실행

1. Job 선택
2. "Build with Parameters" 클릭
3. 환경 선택 (staging/production)
4. 옵션 선택
5. "Build" 클릭

### GitLab CI/CD

#### 1. GitLab 설정

**Variables 추가** (Settings → CI/CD → Variables):
```
SSH_PRIVATE_KEY        # SSH 개인 키
STAGING_USER           # 스테이징 사용자
STAGING_HOST           # 스테이징 호스트
PROD_USER              # 프로덕션 사용자
PROD_HOST              # 프로덕션 호스트
SLACK_WEBHOOK_URL      # Slack 웹훅
```

**Variables 보호 옵션**:
- Protected: Yes (프로덕션용)
- Masked: Yes (민감 정보)

#### 2. CI/CD 파일 배치
```bash
# .gitlab-ci.yml 파일이 루트에 있는지 확인
ls -la .gitlab-ci.yml

# Git에 추가
git add .gitlab-ci.yml
git commit -m "Add GitLab CI/CD pipeline"
git push
```

#### 3. 배포 실행

**자동 배포**:
- `develop` 브랜치 푸시 → 스테이징 배포
- `main` 브랜치 푸시 → 프로덕션 배포 (수동 승인 필요)

**수동 배포**:
1. CI/CD → Pipelines
2. 원하는 파이프라인 선택
3. 수동 작업 버튼 클릭

---

## 설정 및 구성

### 배포 설정 파일 (deployment_config.conf)

```bash
# 설치할 컴포넌트 선택
INSTALL_NODEJS=true
INSTALL_PYTHON=true
INSTALL_JAVA=true
INSTALL_MYSQL=true
INSTALL_POSTGRESQL=true
INSTALL_MONGODB=true

# 자동화 옵션
AUTO_SECURITY_SETUP=false  # true로 설정 시 비밀번호 필요
CREATE_BACKUP=true
RUN_TESTS=true

# 데이터베이스 비밀번호 (AUTO_SECURITY_SETUP=true 일 때)
MYSQL_ROOT_PASSWORD=""
POSTGRES_ADMIN_PASSWORD=""
MONGODB_ADMIN_PASSWORD=""

# 애플리케이션 사용자
APP_DB_USER="appuser"
APP_DB_PASSWORD=""
```

### 환경별 설정

#### Staging 환경
```bash
# deployment_config_staging.conf
INSTALL_NODEJS=true
INSTALL_PYTHON=true
INSTALL_JAVA=true
INSTALL_MYSQL=true
INSTALL_POSTGRESQL=false
INSTALL_MONGODB=false

AUTO_SECURITY_SETUP=false
CREATE_BACKUP=true
RUN_TESTS=true
```

#### Production 환경
```bash
# deployment_config_production.conf
INSTALL_NODEJS=true
INSTALL_PYTHON=true
INSTALL_JAVA=true
INSTALL_MYSQL=true
INSTALL_POSTGRESQL=true
INSTALL_MONGODB=true

AUTO_SECURITY_SETUP=true
CREATE_BACKUP=true
RUN_TESTS=true

# 강력한 비밀번호 설정 필수
MYSQL_ROOT_PASSWORD="ComplexPassword123!@#"
POSTGRES_ADMIN_PASSWORD="ComplexPassword123!@#"
MONGODB_ADMIN_PASSWORD="ComplexPassword123!@#"
```

---

## 알림 설정

### Slack 알림

#### 1. Slack Webhook URL 생성
1. Slack 워크스페이스 설정
2. Apps → Incoming WebHooks
3. Add to Slack
4. 채널 선택
5. Webhook URL 복사

#### 2. 환경 변수 설정
```bash
export SLACK_WEBHOOK="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
```

### Email 알림

#### Jenkins 이메일 설정
1. Manage Jenkins → Configure System
2. Extended E-mail Notification 설정
3. SMTP 서버 정보 입력

#### GitLab 이메일 설정
1. Settings → Integrations
2. Email on push 설정

---

## 모니터링 및 로그

### 로그 위치

```bash
# 배포 로그
/var/log/deployment/deployment_YYYYMMDD_HHMMSS.log

# 백업 위치
/backup/deployment_YYYYMMDD_HHMMSS/

# 버전 리포트
/tmp/deployment_versions.txt
```

### 로그 확인

```bash
# 최신 배포 로그
tail -f /var/log/deployment/deployment_*.log

# 특정 배포 로그
cat /var/log/deployment/deployment_20241211_150000.log

# 서비스 로그
journalctl -u mysql -f
journalctl -u postgresql-16 -f
journalctl -u mongod -f
```

---

## 롤백 절차

### 자동 롤백 (CI/CD)
- GitHub Actions: 배포 실패 시 자동 롤백 작업 실행
- Jenkins: 실패 시 수동 롤백 작업 트리거
- GitLab: 수동 롤백 작업 실행

### 수동 롤백

```bash
# 워크플로우 실행
sudo ./deployment_workflow.sh

# 메뉴에서 5) 롤백 선택

# 또는 직접 실행
sudo bash deployment_workflow.sh
echo "5" | sudo bash deployment_workflow.sh
```

### 백업에서 복원

```bash
# 백업 위치 확인
cat /tmp/last_backup_location.txt

# MySQL 복원
mysql < /backup/deployment_YYYYMMDD_HHMMSS/mysql_backup.sql

# PostgreSQL 복원
sudo -u postgres psql -f /backup/deployment_YYYYMMDD_HHMMSS/postgres_backup.sql

# MongoDB 복원
mongorestore /backup/deployment_YYYYMMDD_HHMMSS/mongodb_backup
```

---

## 문제 해결

### 일반적인 문제

#### 1. 권한 문제
```bash
# 해결: sudo 사용
sudo ./deployment_workflow.sh
```

#### 2. SSH 연결 실패
```bash
# SSH 키 권한 확인
chmod 600 ~/.ssh/id_rsa

# SSH 연결 테스트
ssh user@host
```

#### 3. 스크립트 실행 권한 없음
```bash
# 실행 권한 부여
chmod +x *.sh
```

#### 4. 백업 공간 부족
```bash
# 디스크 공간 확인
df -h

# 오래된 백업 삭제
sudo rm -rf /backup/old_backup_*
```

---

## 보안 고려사항

### 1. 비밀번호 관리
- 설정 파일에 평문 비밀번호 저장 금지
- CI/CD Secrets 사용
- 환경 변수로 전달

### 2. SSH 키 관리
- 키 권한: 600
- 개인 키 보호
- 정기적인 키 교체

### 3. 방화벽 설정
- 필요한 포트만 개방
- IP 화이트리스트 사용
- VPN/Bastion 호스트 사용

### 4. 감사 로그
- 모든 배포 로그 보관
- 변경 사항 추적
- 접근 로그 모니터링

---

## 추가 리소스

### 관련 문서
- [DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md) - 상세 배포 가이드
- [DEPLOYMENT_CHECKLIST.md](DEPLOYMENT_CHECKLIST.md) - 배포 체크리스트

### 외부 리소스
- [GitHub Actions 문서](https://docs.github.com/actions)
- [Jenkins 문서](https://www.jenkins.io/doc/)
- [GitLab CI/CD 문서](https://docs.gitlab.com/ee/ci/)

---

## 지원 및 문의

문제가 발생하거나 도움이 필요한 경우:
1. 로그 파일 확인
2. 문서 검토
3. 커뮤니티 포럼 참조
4. Issue 티켓 생성

---

**버전**: 1.0.0  
**최종 업데이트**: 2024-12-11
