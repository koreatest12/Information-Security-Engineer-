name: ğŸš¨ Grand Ops Atomic Sync (Final Fix)

# ê¶Œí•œ ì„¤ì •: ì´ ë¶€ë¶„ì´ ì—†ìœ¼ë©´ Pushê°€ 403 ì—ëŸ¬ë¡œ ê±°ë¶€ë  ìˆ˜ ìˆìŒ
permissions:
  contents: write
  actions: write
  checks: write

on:
  schedule:
    - cron: '*/20 * * * *' # ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ 20ë¶„ ì£¼ê¸°ë¡œ ë³€ê²½ ê¶Œì¥
  workflow_dispatch:
  push:
    branches: [ "main" ]

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  FRONTEND_DIR: 'frontend'
  SERVER_DIR: 'backend_server'

jobs:
  atomic-genesis-engine:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # 1. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (ì „ì²´ íˆìŠ¤í† ë¦¬ í¬í•¨)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Python í™˜ê²½ ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # =========================================================
      # 3. [í•µì‹¬] ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì¸ë¼ì¸ ì£¼ì… & ì‹¤í–‰
      # =========================================================
      - name: ğŸ’‰ Inject & Execute Generator
        run: |
          echo "ğŸ”¥ Injecting Genesis Script..."
          mkdir -p scripts
          
          # íŒŒì´ì¬ ìƒì„±ê¸° ì½”ë“œ ì‘ì„±
          cat << 'EOF' > scripts/generate_ultimate_stack.py
          import os, json
          
          BASE = os.getcwd()
          FRONT = os.path.join(BASE, "frontend")
          SERVER = os.path.join(BASE, "backend_server")
          
          def write(path, content):
              d = os.path.dirname(path)
              if not os.path.exists(d): os.makedirs(d)
              with open(path, "w", encoding="utf-8") as f: f.write(content.strip())
              print(f"âœ… Created: {path}")
          
          def gen_root_config():
              # ë£¨íŠ¸ gitignore ìµœì í™”
              gitignore = """
          node_modules
          dist
          .env
          .DS_Store
          coverage
          # ë°ì´í„° í´ë”ëŠ” ë¬´ì‹œí•˜ë˜ DBëŠ” í—ˆìš©
          data/*
          !data/*.db
          !data/*.sql
          """
              write(os.path.join(BASE, ".gitignore"), gitignore)
          
          def gen_frontend():
              # Package.json
              pkg = {
                  "name": "grand-ops-pro", "private": True, "version": "3.1.0", "type": "module",
                  "scripts": { "dev": "vite", "build": "vite build", "lint": "eslint ." },
                  "dependencies": {
                      "react": "^18.2.0", "react-dom": "^18.2.0", "react-router-dom": "^6.20.0",
                      "axios": "^1.6.2", "framer-motion": "^10.16.0", "recharts": "^2.10.0",
                      "lucide-react": "^0.294.0", "clsx": "^2.0.0", "tailwind-merge": "^2.1.0"
                  },
                  "devDependencies": {
                      "@types/react": "^18.2.43", "@vitejs/plugin-react": "^4.2.1",
                      "autoprefixer": "^10.4.16", "postcss": "^8.4.32", "tailwindcss": "^3.3.6",
                      "vite": "^5.0.8", "eslint": "^8.55.0"
                  }
              }
              write(os.path.join(FRONT, "package.json"), json.dumps(pkg, indent=2))
              
              # Configs
              write(os.path.join(FRONT, "vite.config.js"), "import { defineConfig } from 'vite'; import react from '@vitejs/plugin-react'; import path from 'path'; export default defineConfig({ plugins: [react()], resolve: { alias: { '@': path.resolve(__dirname, './src') } }, build: { outDir: 'dist', emptyOutDir: true } });")
              write(os.path.join(FRONT, "tailwind.config.js"), "export default { content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'], theme: { extend: { colors: { ops: { 900:'#0f172a', 800:'#1e293b', 500:'#0ea5e9' } } } }, plugins: [] }")
              write(os.path.join(FRONT, "postcss.config.js"), "export default { plugins: { tailwindcss: {}, autoprefixer: {} } }")
              
              # HTML & Main
              write(os.path.join(FRONT, "index.html"), "<!doctype html><html lang='en'><head><meta charset='UTF-8'/><title>Grand Ops System</title></head><body class='bg-ops-900 text-white'><div id='root'></div><script type='module' src='/src/main.jsx'></script></body></html>")
              write(os.path.join(FRONT, "src/main.jsx"), "import React from 'react'; import ReactDOM from 'react-dom/client'; import { BrowserRouter } from 'react-router-dom'; import App from './App'; import './index.css'; ReactDOM.createRoot(document.getElementById('root')).render(<React.StrictMode><BrowserRouter><App /></BrowserRouter></React.StrictMode>);")
              write(os.path.join(FRONT, "src/index.css"), "@tailwind base; @tailwind components; @tailwind utilities;")
              
              # App & Components
              write(os.path.join(FRONT, "src/App.jsx"), """
          import { Routes, Route } from 'react-router-dom';
          import Layout from './Layout';
          import Dashboard from './Dashboard';
          export default function App() { return (<Routes><Route path="/" element={<Layout />}><Route index element={<Dashboard />} /></Route></Routes>); }
          """)
              
              write(os.path.join(FRONT, "src/Layout.jsx"), """
          import { Outlet } from 'react-router-dom';
          import { Shield } from 'lucide-react';
          export default function Layout() {
            return (
              <div className="flex h-screen bg-ops-900 text-white">
                <aside className="w-64 border-r border-ops-800 p-6">
                  <h1 className="flex items-center gap-2 font-bold text-xl mb-8"><Shield className="text-ops-500"/> Grand Ops</h1>
                  <div className="text-sm text-slate-500">System V3.1 Active</div>
                </aside>
                <main className="flex-1 p-8"><Outlet /></main>
              </div>
            )
          }
          """)
              
              write(os.path.join(FRONT, "src/Dashboard.jsx"), """
          import { AreaChart, Area, ResponsiveContainer } from 'recharts';
          const data = [{v:40},{v:30},{v:60},{v:50},{v:80},{v:70}];
          export default function Dashboard() {
             return (
               <div>
                 <h2 className="text-2xl font-bold mb-6">System Status: <span className="text-green-500">OPTIMAL</span></h2>
                 <div className="h-64 bg-ops-800 rounded border border-slate-700 p-4">
                   <ResponsiveContainer width="100%" height="100%">
                     <AreaChart data={data}><Area type="monotone" dataKey="v" stroke="#0ea5e9" fill="#0ea5e9" fillOpacity={0.2} /></AreaChart>
                   </ResponsiveContainer>
                 </div>
               </div>
             )
          }
          """)
          
          def gen_server():
              pkg = { "name": "server", "version": "1.0.0", "type": "module", "scripts": { "start": "node server.js" }, "dependencies": { "express": "^4.18.2", "cors": "^2.8.5", "helmet": "^7.1.0" } }
              write(os.path.join(SERVER, "package.json"), json.dumps(pkg, indent=2))
              write(os.path.join(SERVER, "server.js"), """
          import express from 'express'; import path from 'path'; import { fileURLToPath } from 'url';
          const app = express(); const PORT = process.env.PORT || 5000;
          const __dirname = path.dirname(fileURLToPath(import.meta.url));
          app.use(express.static(path.join(__dirname, '../frontend/dist')));
          app.get('*', (req, res) => res.sendFile(path.join(__dirname, '../frontend/dist/index.html')));
          app.listen(PORT, () => console.log('Server Ready'));
          """)
          
          if __name__ == "__main__":
              gen_root_config()
              gen_frontend()
              gen_server()
          EOF
          
          # ìƒì„±ê¸° ì‹¤í–‰
          python scripts/generate_ultimate_stack.py
          ls -F ${{ env.FRONTEND_DIR }}

      # 4. Node.js ì„¤ì • (ìºì‹œ ë¬´ì‹œ ë° ì¬ì„¤ì •)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
        continue-on-error: true

      # 5. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (ì´ˆëŒ€ëŸ‰)
      - name: ğŸ“¦ Build Frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          if [ ! -f package-lock.json ]; then npm install; else npm ci; fi
          npm run build
          if [ ! -d "dist" ]; then echo "âŒ Build Failed"; exit 1; fi

      # 6. ë°±ì—”ë“œ ì„¤ì¹˜
      - name: ğŸ“¦ Install Server
        working-directory: ${{ env.SERVER_DIR }}
        run: npm install

      # 7. ë ˆê±°ì‹œ DB ì—”ì§„ ì‹¤í–‰
      - name: Run DB Engine
        run: |
           mkdir -p data
           pip install bandit requests
           if [ -f scripts/security_db_master.py ]; then python scripts/security_db_master.py; fi

      # =========================================================
      # ğŸš¨ [CRITICAL FIX] Atomic Force Sync Strategy
      # =========================================================
      - name: ğŸš€ Atomic Git Sync (Conflict Auto-Resolve)
        run: |
          # 1. ì‚¬ìš©ì ì„¤ì •
          git config --global user.name "Grand-Ops-Bot"
          git config --global user.email "bot@grandops.internal"
          git config --global advice.addIgnoredFile false
          
          echo "ğŸ”„ Starting Atomic Sync..."
          
          # 2. ëª¨ë“  ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§• (ê°•ì œ)
          git add -A # ì‚­ì œëœ íŒŒì¼ê¹Œì§€ í¬í•¨
          git add -f frontend/ backend_server/ scripts/
          
          if [ -d "data" ]; then
             echo "ğŸ“‚ Adding Data..."
             git add -f data/
          fi
          
          # 3. ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… Clean state. No sync needed."
            exit 0
          fi
          
          # 4. ì»¤ë°‹ ìƒì„±
          git commit -m "ops: auto-healing & sync [skip ci]"
          
          # 5. [í•µì‹¬] ì¬ì‹œë„ ë£¨í”„ (Pull-Rebase-Push)
          # ì›ê²©ì— ë³€ê²½ì´ ìƒê²¼ì„ ê²½ìš°, 'ë‚´ ë³€ê²½ì‚¬í•­(theirs)'ì„ ìš°ì„ ìœ¼ë¡œ í•˜ì—¬ ìë™ ë³‘í•©
          MAX_RETRIES=10
          COUNT=0
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ“¡ Sync Attempt $((COUNT+1))..."
            
            # ì›ê²© ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°
            git fetch origin main
            
            # Rebase ì‹œë„ (ì¶©ëŒ ì‹œ ë‚´ ë¡œì»¬ ë³€ê²½ì‚¬í•­ ìš°ì„  ì ìš©)
            git pull --rebase -Xtheirs origin main
            
            # Push ì‹œë„
            if git push origin main; then
              echo "ğŸš€ SUCCESS: Atomic Sync Complete!"
              exit 0
            fi
            
            echo "âš ï¸ Push failed (likely race condition). Retrying in 5s..."
            sleep 5
            COUNT=$((COUNT+1))
          done
          
          echo "âŒ CRITICAL: Sync Failed after all retries."
          exit 1

      # 8. ì•„í‹°íŒ©íŠ¸ ë³´ê´€
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: grand-ops-final
          path: |
            frontend/dist
            backend_server
            data/*.db
