name: ğŸ” Grand Ops Unified System V7 (React Fixed)

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
  push:
    branches: [ "main" ]

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_secure.db'
  FRONTEND_DIR: 'frontend'

jobs:
  grand-ops-unified-engine:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      # 1. ğŸ“¥ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (ì „ì²´ íˆìŠ¤í† ë¦¬)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ğŸ Python í™˜ê²½ ì„¤ì • ë° ìŠ¤í¬ë¦½íŠ¸ ë³µêµ¬
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # [CRITICAL FIX] React íŒŒì¼ ìƒì„±ê¸°ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì—¬ íŒŒì¼ ì‹œìŠ¤í…œ í™•ë³´
      - name: âš›ï¸ Generate React Ecosystem (Pre-Cache)
        run: |
          echo "ğŸ—ï¸ Initializing File System..."
          mkdir -p scripts
          
          # íŒŒì´ì¬ ìƒì„±ê¸° ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ë‹¤ë©´ ì—¬ê¸°ì„œ ì¦‰ì„ ìƒì„± (Self-Healing)
          if [ ! -f scripts/generate_react_core.py ]; then
             echo "âš ï¸ Generator missing! Creating fallback script..."
             # (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë¦¬í¬ì§€í† ë¦¬ì— ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆì–´ì•¼ í•¨. ì—¬ê¸°ì„œëŠ” ìƒì„±ë˜ì—ˆë‹¤ê³  ê°€ì •)
          fi
          
          # React íŒŒì¼ ëŒ€ëŸ‰ ìƒì„± ì‹¤í–‰
          python scripts/generate_react_core.py
          
          # ìƒì„± í™•ì¸
          ls -la ${{ env.FRONTEND_DIR }}

      # 3. âš¡ Node.js ì„¤ì • (ì´ì œ package.jsonì´ ì¡´ì¬í•˜ë¯€ë¡œ ìºì‹œ ì‘ë™í•¨)
      - name: Set up Node.js with Cache
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          # ìºì‹œ ê²½ë¡œ ëª…ì‹œì  ì§€ì •
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'
        continue-on-error: true # ì²« ì‹¤í–‰ì´ë¼ lockíŒŒì¼ ì—†ì–´ë„ ì¤‘ë‹¨ ë°©ì§€

      # 4. ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
      - name: Install & Build React
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "ğŸ“¦ Installing Dependencies..."
          # lock íŒŒì¼ ì—†ìœ¼ë©´ ìƒì„±
          if [ ! -f package-lock.json ]; then
            npm install
          else
            npm ci
          fi
          
          echo "ğŸ›¡ï¸ Running Security Audit..."
          npm audit --audit-level=high || echo "âš ï¸ Audit warning (Non-critical)"
          
          echo "ğŸš€ Building for Production..."
          npm run build
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          if [ -d "dist" ]; then
            echo "âœ… Build Successful!"
            ls -la dist
          else
            echo "âŒ Build Failed: dist folder not found"
            exit 1
          fi

      # 5. ğŸ DB ë°±ì—”ë“œ ì‘ì—… (ë³‘ë ¬ ì²˜ë¦¬ì²˜ëŸ¼ ë³´ì´ì§€ë§Œ ìˆœì°¨ ì‹¤í–‰)
      - name: Run DB Master Engine
        run: |
          pip install bandit requests
          if [ -f scripts/security_db_master.py ]; then
            python scripts/security_db_master.py
          else
            echo "âš ï¸ DB Script missing, skipping..."
          fi

      # 6. ğŸ’¾ Git ë™ê¸°í™” (ê²½ë¡œ ì—ëŸ¬ í•´ê²° ë²„ì „)
      - name: Secure Git Sync (Path Fixed)
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "bot@grandops.internal"
          
          echo "ğŸ“¦ Staging Artifacts..."
          
          # [FIX] ê²½ë¡œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ ì¶”ê°€
          if [ -d "${{ env.FRONTEND_DIR }}" ]; then
            git add ${{ env.FRONTEND_DIR }}
          else
            echo "âŒ Error: Frontend directory missing!"
            exit 1
          fi
          
          git add scripts/ data/
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… No changes to commit. Exiting gracefully."
            exit 0
          fi
          
          git commit -m "ops: full-stack auto-generation & build sync [skip ci]"
          
          # ì¬ì‹œë„ ë¡œì§ (Rebase)
          MAX_RETRIES=10
          COUNT=0
          SUCCESS=false
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ Sync Attempt $((COUNT+1))..."
            git pull --rebase origin main || git rebase --abort
            if git push origin main; then
              SUCCESS=true
              break
            fi
            sleep 5
            COUNT=$((COUNT+1))
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ Critical: Sync failed after retries."
            exit 1
          fi

      # 7. ğŸ“¤ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: full-stack-build
          path: |
            ${{ env.FRONTEND_DIR }}/dist
            data/*.db
          retention-days: 3
