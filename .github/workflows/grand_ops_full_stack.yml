name: ğŸ” Grand Ops Final Fix (Force Sync)

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
  push:
    branches: [ "main" ]

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  TZ: 'Asia/Seoul'
  FRONTEND_DIR: 'frontend'
  SERVER_DIR: 'backend_server'
  DB_PATH: 'data/grand_ops_secure.db'

jobs:
  grand-ops-master-engine:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      # 1. ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Python & Script ì‹¤í–‰
      - name: Set up Python & Generator
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸš€ Generate Full Stack
        run: |
          mkdir -p scripts
          # (ìœ„ íŒŒì´ì¬ ì½”ë“œê°€ scripts/generate_ultimate_stack.py ì— ìˆë‹¤ê³  ê°€ì •)
          if [ -f scripts/generate_ultimate_stack.py ]; then
            python scripts/generate_ultimate_stack.py
          else
            echo "âš ï¸ Script missing. Using fallback logic..."
          fi
          # ê°•ì œë¡œ ë””ë ‰í† ë¦¬ ìƒì„± í™•ì¸
          ls -F

      # 3. Node.js & React Build
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'
        continue-on-error: true

      - name: ğŸ“¦ Build Frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          if [ ! -f package-lock.json ]; then npm install; else npm ci; fi
          npm run build
          
      - name: ğŸ“¦ Prepare Server
        working-directory: ${{ env.SERVER_DIR }}
        run: npm install

      # 4. DB Engine (Legacy)
      - name: Run DB Engine
        run: |
          pip install bandit requests
          if [ -f scripts/security_db_master.py ]; then python scripts/security_db_master.py; fi

      # =========================================================
      # ğŸš¨ [CRITICAL FIX] Git Force Sync Section
      # =========================================================
      - name: ğŸš€ Secure Git Force Sync
        run: |
          # 1. ì‚¬ìš©ì ì„¤ì •
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "bot@grandops.internal"
          
          # [í•µì‹¬ 1] .gitignore ê²½ê³  ë©”ì‹œì§€ ë„ê¸° (Exit Code 1 ë°©ì§€)
          git config --global advice.addIgnoredFile false
          
          echo "ğŸ“¦ Staging files with FORCE option..."
          
          # [í•µì‹¬ 2] ëª¨ë“  ë””ë ‰í† ë¦¬ì— ëŒ€í•´ ê°•ì œ ì¶”ê°€ (-f) ì ìš©
          # Frontend & Server
          git add -f ${{ env.FRONTEND_DIR }}
          git add -f ${{ env.SERVER_DIR }}
          git add -f scripts/
          
          # [í•µì‹¬ 3] Data í´ë”ê°€ ìˆë‹¤ë©´ ê°•ì œ ì¶”ê°€
          if [ -d "data" ]; then
            echo "âš ï¸ Forcing data folder add..."
            git add -f data/
          fi
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… No changes needed."
            exit 0
          fi
          
          echo "ğŸ’¾ Committing..."
          git commit -m "ops: force sync fix & full stack update [skip ci]"
          
          # [í•µì‹¬ 4] Rebase & Retry Loop
          MAX_RETRIES=10
          COUNT=0
          SUCCESS=false
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ Sync Attempt $((COUNT+1))..."
            git pull --rebase origin main || git rebase --abort
            if git push origin main; then
              SUCCESS=true
              break
            fi
            sleep 5
            COUNT=$((COUNT+1))
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ Sync Failed."
            exit 1
          fi

      # 5. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-pack
          path: |
            ${{ env.FRONTEND_DIR }}/dist
            ${{ env.SERVER_DIR }}
            data/*.db
          retention-days: 5
