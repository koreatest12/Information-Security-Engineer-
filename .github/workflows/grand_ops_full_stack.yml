name: ğŸš€ Grand Ops Genesis (Auto-Repair & Massive Build)

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
  push:
    branches: [ "main" ]

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  TZ: 'Asia/Seoul'
  FRONTEND_DIR: 'frontend'
  SERVER_DIR: 'backend_server'

jobs:
  genesis-engine:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # 1. ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Python í™˜ê²½
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # =========================================================
      # ğŸš¨ [CRITICAL] ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì¸ë¼ì¸ ì£¼ì… (íŒŒì¼ ëˆ„ë½ ì›ì²œ ì°¨ë‹¨)
      # =========================================================
      - name: ğŸ’‰ Inject & Execute Ultimate Generator
        run: |
          echo "ğŸ”¥ Injecting Genesis Script..."
          mkdir -p scripts
          
          # íŒŒì´ì¬ ì½”ë“œë¥¼ ì¦‰ì„ì—ì„œ ìƒì„± (ì´ ë¶€ë¶„ì´ ì—ëŸ¬ë¥¼ í•´ê²°í•˜ëŠ” í•µì‹¬ì…ë‹ˆë‹¤)
          cat << 'EOF' > scripts/generate_ultimate_stack.py
          import os
          import json
          
          BASE = os.getcwd()
          FRONT = os.path.join(BASE, "frontend")
          SERVER = os.path.join(BASE, "backend_server")
          
          def write(path, content):
              d = os.path.dirname(path)
              if not os.path.exists(d): os.makedirs(d)
              with open(path, "w", encoding="utf-8") as f: f.write(content.strip())
              print(f"âœ… Created: {path}")
          
          def gen_frontend():
              # 1. Package.json (Expert Deps)
              pkg = {
                  "name": "grand-ops-pro",
                  "private": True,
                  "version": "3.0.0",
                  "type": "module",
                  "scripts": { "dev": "vite", "build": "vite build", "lint": "eslint ." },
                  "dependencies": {
                      "react": "^18.2.0", "react-dom": "^18.2.0", "react-router-dom": "^6.20.0",
                      "axios": "^1.6.2", "framer-motion": "^10.16.0", "recharts": "^2.10.0",
                      "lucide-react": "^0.294.0", "clsx": "^2.0.0", "tailwind-merge": "^2.1.0",
                      "zustand": "^4.4.7", "date-fns": "^2.30.0", "@tanstack/react-query": "^5.14.0"
                  },
                  "devDependencies": {
                      "@types/react": "^18.2.43", "@vitejs/plugin-react": "^4.2.1",
                      "autoprefixer": "^10.4.16", "postcss": "^8.4.32", "tailwindcss": "^3.3.6",
                      "vite": "^5.0.8", "eslint": "^8.55.0"
                  }
              }
              write(os.path.join(FRONT, "package.json"), json.dumps(pkg, indent=2))
          
              # 2. Configs
              write(os.path.join(FRONT, "vite.config.js"), "import { defineConfig } from 'vite'; import react from '@vitejs/plugin-react'; import path from 'path'; export default defineConfig({ plugins: [react()], resolve: { alias: { '@': path.resolve(__dirname, './src') } }, build: { outDir: 'dist', emptyOutDir: true } });")
              write(os.path.join(FRONT, "tailwind.config.js"), "export default { content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'], theme: { extend: { colors: { ops: { 900:'#0f172a', 800:'#1e293b', 500:'#0ea5e9' } } } }, plugins: [] }")
              write(os.path.join(FRONT, "postcss.config.js"), "export default { plugins: { tailwindcss: {}, autoprefixer: {} } }")
          
              # 3. Code Structure
              write(os.path.join(FRONT, "index.html"), "<!doctype html><html lang='en'><head><meta charset='UTF-8' /><title>Grand Ops Pro</title></head><body class='bg-ops-900 text-white'><div id='root'></div><script type='module' src='/src/main.jsx'></script></body></html>")
              
              # Main
              write(os.path.join(FRONT, "src/main.jsx"), "import React from 'react'; import ReactDOM from 'react-dom/client'; import { BrowserRouter } from 'react-router-dom'; import App from './App'; import './index.css'; ReactDOM.createRoot(document.getElementById('root')).render(<React.StrictMode><BrowserRouter><App /></BrowserRouter></React.StrictMode>);")
              write(os.path.join(FRONT, "src/index.css"), "@tailwind base; @tailwind components; @tailwind utilities;")
              
              # App & Routing
              write(os.path.join(FRONT, "src/App.jsx"), """
          import { Routes, Route, Navigate } from 'react-router-dom';
          import Layout from './layout/Layout';
          import Dashboard from './pages/Dashboard';
          import Security from './pages/Security';
          export default function App() {
            return (
              <Routes>
                <Route path="/" element={<Layout />}>
                  <Route index element={<Dashboard />} />
                  <Route path="security" element={<Security />} />
                  <Route path="*" element={<Navigate to="/" replace />} />
                </Route>
              </Routes>
            );
          }
          """)
              
              # Components (Layout)
              write(os.path.join(FRONT, "src/layout/Layout.jsx"), """
          import { Outlet, Link, useLocation } from 'react-router-dom';
          import { Shield, Activity, Lock } from 'lucide-react';
          import clsx from 'clsx';
          const NavItem = ({ to, icon: Icon, label }) => {
             const active = useLocation().pathname === to;
             return <Link to={to} className={clsx('flex items-center gap-3 p-3 rounded transition', active ? 'bg-ops-500 text-white' : 'text-slate-400 hover:text-white')}><Icon size={18} /><span>{label}</span></Link>
          }
          export default function Layout() {
            return (
              <div className="flex min-h-screen bg-ops-900 text-slate-200">
                <aside className="w-64 border-r border-ops-800 p-4 flex flex-col gap-2">
                  <div className="flex items-center gap-2 px-3 py-4 text-white font-bold text-lg mb-4"><Shield className="text-ops-500"/> GRAND OPS</div>
                  <NavItem to="/" icon={Activity} label="Dashboard" />
                  <NavItem to="/security" icon={Lock} label="Security Core" />
                </aside>
                <main className="flex-1 p-8 overflow-auto"><Outlet /></main>
              </div>
            )
          }
          """)
              
              # Components (Dashboard)
              write(os.path.join(FRONT, "src/pages/Dashboard.jsx"), """
          import { AreaChart, Area, ResponsiveContainer, Tooltip } from 'recharts';
          const data = [{n:1,v:40},{n:2,v:30},{n:3,v:60},{n:4,v:50},{n:5,v:80},{n:6,v:70}];
          export default function Dashboard() {
            return (
              <div className="space-y-6">
                <h1 className="text-3xl font-bold text-white">System Overview</h1>
                <div className="grid grid-cols-3 gap-6">
                   <div className="bg-ops-800 p-6 rounded-xl border border-slate-700">
                      <h3 className="text-slate-400 text-sm">Active Nodes</h3>
                      <p className="text-3xl font-bold text-white mt-2">12 / 12</p>
                   </div>
                   <div className="bg-ops-800 p-6 rounded-xl border border-slate-700">
                      <h3 className="text-slate-400 text-sm">Memory Usage</h3>
                      <p className="text-3xl font-bold text-ops-500 mt-2">42%</p>
                   </div>
                   <div className="bg-ops-800 p-6 rounded-xl border border-slate-700">
                      <h3 className="text-slate-400 text-sm">Security Level</h3>
                      <p className="text-3xl font-bold text-green-500 mt-2">MAXIMUM</p>
                   </div>
                </div>
                <div className="h-64 bg-ops-800 rounded-xl border border-slate-700 p-4">
                  <ResponsiveContainer width="100%" height="100%">
                    <AreaChart data={data}>
                      <Tooltip contentStyle={{background:'#1e293b', border:'none'}}/>
                      <Area type="monotone" dataKey="v" stroke="#0ea5e9" fill="#0ea5e9" fillOpacity={0.2} />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
              </div>
            )
          }
          """)
          
              # Components (Security)
              write(os.path.join(FRONT, "src/pages/Security.jsx"), """
          import { ShieldCheck } from 'lucide-react';
          export default function Security() {
             return <div className="text-center p-20"><ShieldCheck size={64} className="mx-auto text-green-500 mb-4"/><h1 className="text-2xl text-white">All Systems Secure</h1></div>
          }
          """)
          
          def gen_server():
              # Server Pkg
              pkg = {
                  "name": "grand-ops-server", "version": "1.0.0", "type": "module",
                  "scripts": { "start": "node server.js" },
                  "dependencies": { "express": "^4.18.2", "cors": "^2.8.5", "helmet": "^7.1.0", "compression": "^1.7.4" }
              }
              write(os.path.join(SERVER, "package.json"), json.dumps(pkg, indent=2))
              
              # Server JS
              write(os.path.join(SERVER, "server.js"), """
          import express from 'express'; import path from 'path'; import { fileURLToPath } from 'url';
          import cors from 'cors'; import helmet from 'helmet'; import compression from 'compression';
          const app = express(); const PORT = process.env.PORT || 5000;
          const __dirname = path.dirname(fileURLToPath(import.meta.url));
          app.use(helmet({ contentSecurityPolicy: false })); app.use(cors()); app.use(compression()); app.use(express.json());
          app.get('/api/status', (req, res) => res.json({ status: 'OK', time: new Date() }));
          app.use(express.static(path.join(__dirname, '../frontend/dist')));
          app.get('*', (req, res) => res.sendFile(path.join(__dirname, '../frontend/dist/index.html')));
          app.listen(PORT, () => console.log(`ğŸš€ Server on ${PORT}`));
          """)
          
          if __name__ == "__main__":
              gen_frontend()
              gen_server()
          EOF
          
          # ìƒì„±ê¸° ì‹¤í–‰ (ì´ì œ frontend í´ë”ê°€ ë¬´ì¡°ê±´ ìƒê¹€)
          python scripts/generate_ultimate_stack.py
          
          # í™•ì¸
          ls -F ${{ env.FRONTEND_DIR }}

      # 3. Node.js ì„¤ì • (ìƒì„± í›„ ì‹¤í–‰ë˜ë¯€ë¡œ ê²½ë¡œ ì—ëŸ¬ ì—†ìŒ)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'
        # ì²« ì‹¤í–‰ì‹œ lock íŒŒì¼ ì—†ì–´ì„œ ìºì‹œ ì—ëŸ¬ë‚  ìˆ˜ ìˆìŒ -> ë¬´ì‹œí•˜ê³  ì§„í–‰
        continue-on-error: true 

      # 4. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (ì´ˆëŒ€ëŸ‰ ì„¤ì¹˜)
      - name: ğŸ“¦ Build Frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "ğŸ“¦ Installing Dependencies (Massive)..."
          # lock íŒŒì¼ ì—†ìœ¼ë©´ install, ìˆìœ¼ë©´ ci
          if [ ! -f package-lock.json ]; then npm install; else npm ci; fi
          
          echo "ğŸš€ Building for Production..."
          npm run build
          
          # dist í™•ì¸
          if [ ! -d "dist" ]; then echo "âŒ Build Failed"; exit 1; fi

      # 5. ë°±ì—”ë“œ ì„¤ì¹˜
      - name: ğŸ“¦ Install Server
        working-directory: ${{ env.SERVER_DIR }}
        run: npm install

      # 6. DB ë³´ì•ˆ ì—”ì§„ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
      - name: Run DB Security
        run: |
          pip install bandit requests
          # ê¸°ì¡´ DB ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆë‹¤ë©´ ì‹¤í–‰
          if [ -f scripts/security_db_master.py ]; then python scripts/security_db_master.py; fi

      # =========================================================
      # ğŸš¨ [CRITICAL] Git Force Sync (ê°•ì œ ë™ê¸°í™”)
      # =========================================================
      - name: ğŸš€ Force Git Sync
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "bot@grandops.internal"
          
          # [í•µì‹¬] ê²½ê³  ë©”ì‹œì§€ ë„ê¸°
          git config --global advice.addIgnoredFile false
          
          echo "ğŸ“¦ Staging with FORCE..."
          # ê°•ì œ ì¶”ê°€ (-f)ë¡œ .gitignore ë¬´ì‹œí•˜ê³  ì—…ë¡œë“œ
          git add -f ${{ env.FRONTEND_DIR }}
          git add -f ${{ env.SERVER_DIR }}
          git add -f scripts/
          
          # Data í´ë”ê°€ ìˆë‹¤ë©´ ê°•ì œ ì¶”ê°€
          if [ -d "data" ]; then git add -f data/; fi
          
          if [ -z "$(git status --porcelain)" ]; then
             echo "âœ… Nothing to commit"; exit 0;
          fi
          
          git commit -m "ops: massive genesis generation & fix [skip ci]"
          
          # Rebase & Push Loop
          MAX=10
          COUNT=0
          while [ $COUNT -lt $MAX ]; do
            git pull --rebase origin main || git rebase --abort
            if git push origin main; then break; fi
            sleep 5
            COUNT=$((COUNT+1))
          done

      # 7. ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: full-stack-package
          path: |
            ${{ env.FRONTEND_DIR }}/dist
            ${{ env.SERVER_DIR }}
            data/*.db
          retention-days: 7
