name: ğŸ” Grand Ops Full-Stack Pipeline (DB + React)

on:
  schedule:
    - cron: '*/10 * * * *' # 10ë¶„ ë‹¨ìœ„ ìˆ˜í–‰ (ìš”ì²­ ë°˜ì˜)
  workflow_dispatch:
  push:
    branches: [ "main" ]

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_secure.db'
  FRONTEND_DIR: 'frontend'

permissions:
  contents: write

jobs:
  # ========================================================
  # JOB 1: Backend & Security Infra (ê¸°ì¡´ ë¡œì§ + ê°•í™”)
  # ========================================================
  backend-security-ops:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ops Tools
        run: |
          pip install --upgrade pip
          pip install bandit requests

      # ğŸ Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (DB Master ë“±)
      - name: Run DB Master Engine
        run: |
          if [ -f scripts/security_db_master.py ]; then
            python scripts/security_db_master.py
          fi

  # ========================================================
  # JOB 2: React Frontend Build Pipeline (ì‹ ê·œ ì¶”ê°€)
  # ========================================================
  frontend-react-ops:
    needs: backend-security-ops # ë°±ì—”ë“œ ì ê²€ í›„ ì‹œì‘
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python (for Generator)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 1. âš›ï¸ React ìƒíƒœê³„ ìë™ ìƒì„± (íŒŒì¼/í´ë”/ì„¤ì • ëŒ€ëŸ‰ ë°˜ì˜)
      - name: Generate React Ecosystem
        run: |
          echo "ğŸ—ï¸ Generating React Source Code & Configs..."
          if [ -f scripts/generate_react_core.py ]; then
            python scripts/generate_react_core.py
          else
            # ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì„ ê²½ìš° ì¦‰ì„ ìƒì„± (ë³µêµ¬ ëª¨ë“œ)
            echo "âš ï¸ Generator script missing. Using fallback..."
            mkdir -p scripts
            # (ìœ„ì— ì‘ì„±í•œ íŒŒì´ì¬ ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê±°ë‚˜, ì €ì¥ì†Œì— ìˆë‹¤ê³  ê°€ì •)
            # ì—¬ê¸°ì„œëŠ” íŒŒì¼ì´ ì¡´ì¬í•œë‹¤ê³  ê°€ì •í•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.
          fi
          
          # ìƒì„± í™•ì¸
          ls -R ${{ env.FRONTEND_DIR }}

      # 2. âš¡ Node.js í™˜ê²½ êµ¬ì„±
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # ìµœì‹  LTS ë²„ì „ ì‚¬ìš©
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      # 3. ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ í™œìš© + ëŒ€ëŸ‰ ì„¤ì¹˜)
      - name: Install Dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          if [ ! -f package-lock.json ]; then
            echo "âš ï¸ Generating package-lock.json..."
            npm install --package-lock-only
          fi
          npm ci --prefer-offline --no-audit

      # 4. ğŸ›¡ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë³´ì•ˆ ê°ì‚¬
      - name: React Security Audit
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "ğŸ” Scanning npm modules for vulnerabilities..."
          npm audit --audit-level=critical || echo "âš ï¸ Critical vulnerabilities found (Check logs)"

      # 5. ğŸ—ï¸ React í”„ë¡œë•ì…˜ ë¹Œë“œ (Vite Build)
      - name: Build React Application
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "ğŸš€ Building React App for Production..."
          npm run build
          echo "âœ… Build Complete. Artifacts in 'dist/'"

      # 6. ğŸ“‚ ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ë°°í¬ìš© ì•„í‹°íŒ©íŠ¸)
      - name: Upload Frontend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: react-build-dist
          path: ${{ env.FRONTEND_DIR }}/dist
          retention-days: 5

  # ========================================================
  # JOB 3: Final Synchronization (ìê°€ ì¹˜ìœ  ë° ë™ê¸°í™”)
  # ========================================================
  git-sync-master:
    needs: [backend-security-ops, frontend-react-ops]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Smart Sync Logic
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "bot@grandops.internal"
          
          # React ìƒì„±ë¬¼ ë° ë³€ê²½ì‚¬í•­ ê°ì§€
          git add frontend/ scripts/ data/
          
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… Nothing to commit."
            exit 0
          fi
          
          echo "ğŸ’¾ Committing Operations Update..."
          git commit -m "ops: react ecosystem update & security sync [skip ci]"
          
          # Retry & Rebase Logic (ì¶©ëŒ ë°©ì§€ ìµœì í™”)
          MAX_RETRIES=5
          COUNT=0
          SUCCESS=false
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ Sync Attempt $((COUNT+1))..."
            git pull --rebase origin main || git rebase --abort
            if git push origin main; then
              SUCCESS=true
              break
            fi
            sleep 5
            COUNT=$((COUNT+1))
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ Sync Failed."
            exit 1
          fi
