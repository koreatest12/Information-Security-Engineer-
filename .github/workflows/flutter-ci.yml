name: Flutter Build & Release System

on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ] # v1.0.0 ê°™ì€ íƒœê·¸ê°€ ë‹¬ë¦¬ë©´ ë¦´ë¦¬ìŠ¤ ëª¨ë“œ ì‘ë™
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

# âœ… [ì„¤ì •] í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ê²Œ ì•„ë˜ ê²½ë¡œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”
env:
  FLUTTER_WORKDIR: '.'  # ì˜ˆ: í”„ë¡œì íŠ¸ê°€ ìµœìƒìœ„ì— ìˆìœ¼ë©´ '.', í•˜ìœ„ í´ë”ë©´ './app' ë˜ëŠ” './mobile'
  JAVA_VERSION: '17'
  FLUTTER_CHANNEL: 'stable'

jobs:
  # ---------------------------------------------------
  # 1. í™˜ê²½ ì„¤ì • ë° í’ˆì§ˆ ê²€ì‚¬ (ì—ëŸ¬ ìˆ˜ì • ë°˜ì˜)
  # ---------------------------------------------------
  quality-check:
    name: ğŸ›¡ï¸ Setup & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.FLUTTER_WORKDIR }} # âœ… ì—ëŸ¬ ìˆ˜ì • í•µì‹¬: ì‘ì—… ê²½ë¡œ ì§€ì •

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Upgrade Flutter # âœ… ìš”ì²­ ë°˜ì˜: í”ŒëŸ¬í„° ì—…ê·¸ë ˆì´ë“œ
        run: flutter upgrade

      - name: Install Dependencies
        run: flutter pub get

      - name: Run Analyze
        run: flutter analyze

      - name: Run Tests
        run: flutter test

  # ---------------------------------------------------
  # 2. Android ë¹Œë“œ ë° ë¦¬ì†ŒìŠ¤ ìƒì„±
  # ---------------------------------------------------
  build-android:
    name: ğŸ¤– Build Android
    needs: quality-check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.FLUTTER_WORKDIR }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true
      
      - run: flutter pub get
      
      # APK ë¹Œë“œ (íŒŒì¼ëª…ì— ë²„ì „/í•´ì‹œ ì¶”ê°€)
      - name: Build APK
        run: flutter build apk --release

      # AppBundle ë¹Œë“œ
      - name: Build AppBundle
        run: flutter build appbundle --release

      # âœ… ê²°ê³¼ë¬¼ ì´ë¦„ ë³€ê²½ (ì‹ë³„ ìš©ì´)
      - name: Rename Artifacts
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk app-release.apk
          mv build/app/outputs/bundle/release/app-release.aab app-release.aab

      # ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (Actions íƒ­ ë‹¤ìš´ë¡œë“œìš©)
      - name: Upload Android Files
        uses: actions/upload-artifact@v4
        with:
          name: android-build-files
          path: |
            ${{ env.FLUTTER_WORKDIR }}/app-release.apk
            ${{ env.FLUTTER_WORKDIR }}/app-release.aab

  # ---------------------------------------------------
  # 3. iOS ë¹Œë“œ (ë¦¬ì†ŒìŠ¤ ì••ì¶• í¬í•¨)
  # ---------------------------------------------------
  build-ios:
    name: ğŸ Build iOS
    needs: quality-check
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ${{ env.FLUTTER_WORKDIR }}

    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true
      
      - run: flutter pub get

      # ì„œëª… ì—†ì´ ë¹Œë“œ (CI í…ŒìŠ¤íŠ¸ìš©)
      - name: Build iOS (No CodeSign)
        run: flutter build ios --release --no-codesign

      # âœ… iOS ê²°ê³¼ë¬¼ ì••ì¶• (ë‹¨ì¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•´ .app í´ë”ë¥¼ zipìœ¼ë¡œ ì••ì¶•)
      - name: Compress iOS App
        run: |
          cd build/ios/iphoneos
          zip -r ../../../ios-app-release.zip Runner.app

      - name: Upload iOS Files
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-files
          path: ${{ env.FLUTTER_WORKDIR }}/ios-app-release.zip

  # ---------------------------------------------------
  # 4. ì •ì‹ ë¦´ë¦¬ìŠ¤ ìƒì„± (ë‹¤ìš´ë¡œë“œ ì£¼ì†Œ ì œê³µ)
  # ---------------------------------------------------
  create-release:
    name: ğŸš€ Create Download Links
    needs: [build-android, build-ios]
    if: startsWith(github.ref, 'refs/tags/v') # âœ… 'v'ë¡œ ì‹œì‘í•˜ëŠ” íƒœê·¸ì¼ ë•Œë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-build-files
          
      - name: Download iOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-build-files

      # âœ… GitHub Release ìƒì„± ë° íŒŒì¼ ì—…ë¡œë“œ (ì •ì‹ ì£¼ì†Œ ìƒì„±)
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            app-release.apk
            app-release.aab
            ios-app-release.zip
          body: |
            ## ğŸš€ New Build Released!
            
            **Android Files:**
            - APK (Direct Install): `app-release.apk`
            - AAB (Store Upload): `app-release.aab`
            
            **iOS Files:**
            - Simulator App: `ios-app-release.zip`
            
            *ì´ ë¦´ë¦¬ìŠ¤ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
