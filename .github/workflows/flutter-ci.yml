name: Flutter Auto-Gen & Build System

on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  FLUTTER_CHANNEL: 'stable'
  JAVA_VERSION: '17'
  # í”„ë¡œì íŠ¸ ì´ë¦„ ì„¤ì • (ë¹ˆ í”„ë¡œì íŠ¸ ìƒì„± ì‹œ ì‚¬ìš©)
  PROJECT_NAME: 'my_flutter_app'

jobs:
  build-and-deploy:
    name: ğŸ› ï¸ Auto-Generate & Build
    runs-on: ubuntu-latest
    permissions:
      contents: write  # í”„ë¡œì íŠ¸ íŒŒì¼ ìƒì„± í›„ ì»¤ë°‹ ê¶Œí•œ í•„ìš”

    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Flutter ë¨¼ì € ì„¤ì¹˜ (Javaë³´ë‹¤ ë¨¼ì € ì‹¤í–‰í•´ì•¼ í”„ë¡œì íŠ¸ ìƒì„±ì´ ê°€ëŠ¥)
      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      # 3. [í•µì‹¬ ìˆ˜ì •] í”„ë¡œì íŠ¸ íŒŒì¼/ë””ë ‰í† ë¦¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ë° ìë™ ìƒì„±
      # ì´ ë‹¨ê³„ê°€ 'No file matched' ì—ëŸ¬ë¥¼ ê·¼ë³¸ì ìœ¼ë¡œ í•´ê²°í•©ë‹ˆë‹¤.
      - name: Check & Create Project Files
        id: init_project
        run: |
          if [ ! -f "pubspec.yaml" ]; then
            echo "âš ï¸ pubspec.yaml not found. Initializing new Flutter project..."
            
            # í”ŒëŸ¬í„° í”„ë¡œì íŠ¸ ê°•ì œ ìƒì„± (Android, iOS, Web, Linux, Mac, Windows í¬í•¨)
            flutter create . --org com.example --project-name ${{ env.PROJECT_NAME }}
            
            echo "âœ… Project files generated."
            echo "generated=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Project found. Skipping generation."
            echo "generated=false" >> $GITHUB_OUTPUT
          fi

      # 4. ìƒì„±ëœ íŒŒì¼ í™•ì¸ (ë””ë²„ê¹…ìš©)
      - name: List Files
        run: ls -R

      # 5. Java ì„¤ì • (ì´ì œ android/build.gradle íŒŒì¼ì´ ì¡´ì¬í•˜ë¯€ë¡œ ì—ëŸ¬ ì—†ìŒ)
      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          # íŒŒì¼ì´ ë°©ê¸ˆ ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ ìºì‹œëŠ” ë¹„í™œì„±í™”í•˜ê±°ë‚˜, íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ë™ì‘í•˜ë„ë¡ ì£¼ì˜
          # ì—¬ê¸°ì„œëŠ” ì•ˆì •ì„±ì„ ìœ„í•´ ì²« ì‹¤í–‰ ì‹œ ìºì‹œ ê²½ê³ ë¥¼ ë¬´ì‹œí•˜ë„ë¡ ì„¤ì •
          cache: 'gradle' 
        continue-on-error: true # ìºì‹œ íŒŒì¼ ì—†ì–´ë„ ë¹Œë“œ ì§„í–‰í•˜ë„ë¡ í—ˆìš©

      # 6. ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì—…ê·¸ë ˆì´ë“œ
      - name: Install Dependencies
        run: |
          flutter upgrade
          flutter pub get

      # 7. Android APK ë¹Œë“œ
      - name: Build Android APK
        run: flutter build apk --release

      # 8. Android AppBundle ë¹Œë“œ
      - name: Build Android AppBundle
        run: flutter build appbundle --release

      # 9. ê²°ê³¼ë¬¼ ì •ë¦¬ ë° ì´ë¦„ ë³€ê²½
      - name: Organize Artifacts
        run: |
          mkdir -p release_files
          mv build/app/outputs/flutter-apk/app-release.apk release_files/${{ env.PROJECT_NAME }}-release.apk
          mv build/app/outputs/bundle/release/app-release.aab release_files/${{ env.PROJECT_NAME }}-release.aab

      # 10. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥)
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: complete-build-files
          path: release_files/

      # 11. (ì„ íƒì‚¬í•­) ìƒì„±ëœ ì½”ë“œë¥¼ ì €ì¥ì†Œì— ë‹¤ì‹œ í‘¸ì‹œ
      # ë¹ˆ ì €ì¥ì†Œì˜€ì„ ê²½ìš°, ìƒì„±ëœ í”ŒëŸ¬í„° ì½”ë“œë¥¼ ì €ì¥ì†Œì— ì €ì¥í•©ë‹ˆë‹¤.
      - name: Commit Generated Code
        if: steps.init_project.outputs.generated == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Initialize Flutter project structure [Auto-Generated]"
          git push

  # 12. ì •ì‹ ë¦´ë¦¬ìŠ¤ ë°°í¬ (íƒœê·¸ê°€ ìˆì„ ë•Œë§Œ)
  release:
    name: ğŸš€ Create Release Page
    needs: build-and-deploy
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: complete-build-files
          path: release_files

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_files/*
          body: |
            ## ğŸ“¦ New Version Released
            All necessary service files and directories have been included.
            
            **Download:**
            - APK: `*-release.apk`
            - AAB: `*-release.aab`
