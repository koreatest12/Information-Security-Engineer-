name: Flutter CI/CD Complete Workflow

# íŠ¸ë¦¬ê±°: ë©”ì¸ ë¸Œëœì¹˜ í‘¸ì‹œ ë˜ëŠ” í’€ ë¦¬í€˜ìŠ¤íŠ¸ ì‹œ ì‹¤í–‰
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜ ì¶”ê°€

jobs:
  # 1. í’ˆì§ˆ ê²€ì‚¬ (í…ŒìŠ¤íŠ¸ & ë¦°íŠ¸)
  quality-check:
    name: ğŸ›¡ï¸ Quality Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          
      - name: Install Dependencies
        run: flutter pub get

      - name: Analyze Code (Lint)
        run: flutter analyze

      - name: Run Unit Tests
        run: flutter test

  # 2. Android ë¹Œë“œ (APK & AppBundle)
  build-android:
    name: ğŸ¤– Build Android
    needs: quality-check # í…ŒìŠ¤íŠ¸ í†µê³¼ ì‹œì—ë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Java ì„¤ì • (Android ë¹Œë“œ í•„ìˆ˜)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle' # Gradle ìºì‹± ìë™í™”

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      # APK ë¹Œë“œ (ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ìš©)
      - name: Build APK
        run: flutter build apk --release

      # AppBundle ë¹Œë“œ (ìŠ¤í† ì–´ ë°°í¬ìš©)
      - name: Build AppBundle
        run: flutter build appbundle --release

      # ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (GitHub Actions í™”ë©´ì—ì„œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥)
      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-builds
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab

  # 3. iOS ë¹Œë“œ (ì„œëª… ì—†ì´ ë¹Œë“œ í…ŒìŠ¤íŠ¸)
  build-ios:
    name: ğŸ Build iOS (No-CodeSign)
    needs: quality-check
    runs-on: macos-latest # iOSëŠ” ë°˜ë“œì‹œ macOS í•„ìš”
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      # ì¤‘ìš”: CI í™˜ê²½ì—ì„œ ì¸ì¦ì„œ ì—†ì´ ë¹Œë“œ ì„±ê³µ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ì„œëª… ì œì™¸ ì˜µì…˜ ì‚¬ìš©
      # ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” ì¸ì¦ì„œ ì„¸íŒ…ì´ í•„ìš”í•˜ì§€ë§Œ, CI í†µê³¼ ì—¬ë¶€ í™•ì¸ìš©ìœ¼ë¡œëŠ” ì´ ë°©ë²•ì´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤.
      - name: Build iOS (Simulator Build)
        run: flutter build ios --release --no-codesign

      # ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/Runner.app
