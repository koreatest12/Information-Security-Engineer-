name: ðŸ›¡ï¸ Deep Security Audit (Recursive)

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  audit-rsc-vulnerability:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # [í…ŒìŠ¤íŠ¸ìš©] ìœ„ì—ì„œ ë§Œë“  ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ê°•ì œë¡œ ì·¨ì•½ í™˜ê²½ ì¡°ì„± (ì‹¤ì œ ìš´ì˜ì‹œ ì œê±° ê°€ëŠ¥)
      # - name: ðŸ§ª Generate Vulnerable Files (Test Only)
      #   run: |
      #     mkdir -p scripts
      #     chmod +x scripts/generate_vulnerable_apps.sh
      #     ./scripts/generate_vulnerable_apps.sh

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install Python Helper
        run: pip install packaging

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ•µï¸ Find and Audit All Projects
        id: audit
        run: |
          echo "ðŸ” Searching for package.json files recursively..."
          
          # node_modules ì œì™¸í•˜ê³  package.jsonì´ ìžˆëŠ” ëª¨ë“  ë””ë ‰í† ë¦¬ ì°¾ê¸°
          find . -name "package.json" -not -path "*/node_modules/*" | while read package_file; do
            dir_path=$(dirname "$package_file")
            echo "---------------------------------------------------"
            echo "ðŸ“‚ Detected Project at: $dir_path"
            echo "---------------------------------------------------"
            
            pushd "$dir_path" > /dev/null
            
            # 1. ì˜ì¡´ì„± ì„¤ì¹˜ (Lock íŒŒì¼ ìš°ì„  ìˆœìœ„ ë¡œì§)
            if [ -f "yarn.lock" ]; then
              echo "ðŸ§¶ Installing with Yarn..."
              yarn install --frozen-lockfile --silent || yarn install --silent
            elif [ -f "package-lock.json" ]; then
              echo "ðŸ“¦ Installing with NPM CI..."
              npm ci --silent
            else
              echo "âš ï¸ No lock file. Running npm install..."
              npm install --silent
            fi
            
            # 2. Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ê²½ë¡œ ì¡°ì • í•„ìš”)
            # ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜ëŠ” í•­ìƒ ë£¨íŠ¸ì˜ scripts/ í´ë”ì— ìžˆë‹¤ê³  ê°€ì •
            SCRIPT_PATH="$GITHUB_WORKSPACE/scripts/check_cve_2025.py"
            
            if [ -f "$SCRIPT_PATH" ]; then
              python "$SCRIPT_PATH"
              # ì·¨ì•½ì  ë°œê²¬ ì‹œ ì¢…ë£Œ ì½”ë“œ ìº¡ì²˜ (í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì „ì²´ ì‹¤íŒ¨ ì²˜ë¦¬í•˜ë ¤ë©´ ë¡œì§ ì¶”ê°€ í•„ìš”)
            else
              echo "âŒ Script not found at $SCRIPT_PATH"
            fi
            
            popd > /dev/null
            echo ""
          done
