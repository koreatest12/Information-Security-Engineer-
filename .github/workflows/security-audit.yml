name: ğŸ›¡ï¸ Deep Security Audit & Auto-Fix

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  audit-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ì½”ë“œ ìˆ˜ì •(ì—…ë°ì´íŠ¸) í›„ ì»¤ë°‹ì„ ìœ„í•´ ì“°ê¸° ê¶Œí•œ í•„ìš” (PR ìƒì„± ì‹œ)

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install Python Helper
        run: pip install packaging

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ•µï¸ Find, Audit, and Fix Projects
        id: audit
        run: |
          echo "ğŸ” Scanning recursively for package.json..."
          
          # ì „ì²´ ì‹¤íŒ¨ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ í”Œë˜ê·¸
          GLOBAL_FAILURE=0

          # node_modules ì œì™¸í•˜ê³  package.json ì°¾ê¸°
          find . -name "package.json" -not -path "*/node_modules/*" | while read package_file; do
            dir_path=$(dirname "$package_file")
            echo -e "\n==================================================="
            echo -e "ğŸ“‚ Processing Project: $dir_path"
            echo -e "==================================================="
            
            pushd "$dir_path" > /dev/null
            
            # --- 1. ì´ˆê¸° ì˜ì¡´ì„± ì„¤ì¹˜ ---
            # ì¶©ëŒ ë°©ì§€: --legacy-peer-deps (npm), --ignore-engines (yarn) ì‚¬ìš©í•˜ì—¬ ì„¤ì¹˜ ì—ëŸ¬ ìµœì†Œí™”
            if [ -f "yarn.lock" ]; then
              echo "ğŸ§¶ [Setup] Installing with Yarn..."
              yarn install --frozen-lockfile --ignore-engines --silent || yarn install --ignore-engines --silent
            elif [ -f "package-lock.json" ]; then
              echo "ğŸ“¦ [Setup] Installing with NPM CI..."
              npm ci --legacy-peer-deps --silent
            else
              echo "âš ï¸ [Setup] No lock file. Running npm install..."
              npm install --legacy-peer-deps --silent
            fi
            
            # --- 2. 1ì°¨ ì·¨ì•½ì  ì§„ë‹¨ ---
            SCRIPT_PATH="$GITHUB_WORKSPACE/scripts/check_cve_2025.py"
            python "$SCRIPT_PATH"
            EXIT_CODE=$?

            # --- 3. ì·¨ì•½ì  ë°œê²¬ ì‹œ ìë™ ì—…ê·¸ë ˆì´ë“œ (Auto-Fix) ---
            if [ $EXIT_CODE -ne 0 ]; then
              echo -e "\nğŸ”§ [Fix] Vulnerability detected! Attempting Auto-Upgrade..."
              
              # Reactì™€ Next.jsë¥¼ ìµœì‹  ì•ˆì • ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ì¶©ëŒ ë°©ì§€ í”Œë˜ê·¸ í¬í•¨)
              # ì£¼ì˜: ë©”ì´ì € ë²„ì „ ë³€ê²½(Breaking Change) ê°€ëŠ¥ì„± ìˆìŒ. ë³´ì•ˆì´ ìµœìš°ì„ ì¸ ì„¤ì •.
              
              if [ -f "yarn.lock" ]; then
                echo "ğŸ§¶ Upgrading dependencies via Yarn..."
                # React 19, Next 15 ìµœì‹  ë²„ì „ íƒ€ê²ŸíŒ… (í•„ìš”ì‹œ ë²„ì „ ê³ ì • ê°€ëŠ¥)
                yarn add react@latest react-dom@latest next@latest --ignore-engines
              else
                echo "ğŸ“¦ Upgrading dependencies via NPM..."
                # --legacy-peer-deps: ì˜ì¡´ì„± ì¶©ëŒ ë¬´ì‹œí•˜ê³  ê°•ì œ ì„¤ì¹˜
                # --save-exact: ë²„ì „ì„ ëª…ì‹œì ìœ¼ë¡œ ê³ ì •
                npm install react@latest react-dom@latest next@latest --save-exact --legacy-peer-deps
              fi
              
              echo "âœ… [Fix] Upgrade command executed."

              # --- 4. ì¬ê²€ì¦ (Re-Audit) ---
              echo "ğŸ”„ [Re-Audit] Verifying patch..."
              python "$SCRIPT_PATH"
              RE_CHECK_CODE=$?
              
              if [ $RE_CHECK_CODE -eq 0 ]; then
                echo "ğŸ‰ [Success] Vulnerabilities fixed successfully in $dir_path!"
                # (ì„ íƒì‚¬í•­) ì—¬ê¸°ì„œ git commit ë¡œì§ì„ ì¶”ê°€í•˜ì—¬ ìë™ ì»¤ë°‹ ê°€ëŠ¥
              else
                echo "ğŸš¨ [Fail] Auto-fix failed. Manual intervention required."
                GLOBAL_FAILURE=1
              fi
            else
              echo "âœ… [Clean] No vulnerabilities found."
            fi
            
            popd > /dev/null
          done
          
          # í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•œ í”„ë¡œì íŠ¸ê°€ ìˆë‹¤ë©´ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬
          if [ $GLOBAL_FAILURE -ne 0 ]; then
            echo "âŒ Some projects remain vulnerable."
            exit 1
          fi
