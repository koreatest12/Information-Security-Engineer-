name: ğŸ›¡ï¸ Security Audit (React/Next.js RCE)

on:
  push:
    branches: [ "**" ] # ëª¨ë“  ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ì‹¤í–‰
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * *' # ë§¤ì¼ ìì • ì‹¤í–‰
  workflow_dispatch:

jobs:
  audit-rsc-vulnerability:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install Python Helper
        run: pip install packaging

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # ì¤‘ìš”: ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ìë™ ìºì‹± ì˜µì…˜ ì œê±° (ìˆ˜ë™ ì²˜ë¦¬ ë¡œì§ ì‚¬ìš©)

      - name: ğŸ§ Detect & Install Dependencies
        id: install
        run: |
          if [ ! -f "package.json" ]; then
            echo "::warning::No package.json found. Skipping installation."
            echo "skip_scan=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ -f "yarn.lock" ]; then
            echo "ğŸ§¶ Yarn lock file detected. Installing with Yarn..."
            yarn install --frozen-lockfile || yarn install
          elif [ -f "package-lock.json" ]; then
            echo "ğŸ“¦ NPM lock file detected. Installing with npm ci..."
            npm ci
          else
            echo "âš ï¸ No lock file found. Running npm install to generate dependency tree..."
            # Lock íŒŒì¼ì´ ì—†ìœ¼ë¯€ë¡œ npm installë¡œ ê°•ì œ ì„¤ì¹˜í•˜ì—¬ node_modules ìƒì„±
            npm install
          fi

      - name: ğŸ•µï¸ Run Vulnerability Scanner
        if: steps.install.outputs.skip_scan != 'true'
        run: |
          python scripts/check_cve_2025.py

      # Slack ì•Œë¦¼ ë‹¨ê³„ ì‚­ì œë¨ (ìš”ì²­ ë°˜ì˜)
