name: Bulk Script Health Check
run-name: ğŸ›¡ï¸ ëŒ€ëŸ‰ ìŠ¤í¬ë¦½íŠ¸ ì¼ì¼ ì ê²€ (Total Check)

on:
  schedule:
    - cron: '0 0 * * *' # í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  bulk-execution:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 1. ì˜ì¡´ì„± ì„¤ì¹˜ (requirements.txtê°€ ìˆë‹¤ë©´)
      - name: Install Dependencies
        run: |
          if [ -f scripts/requirements.txt ]; then
            pip install -r scripts/requirements.txt
          fi

      # 2. ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ (í•˜ìœ„ í´ë” í¬í•¨)
      - name: Grant Execute Permissions
        run: chmod -R +x scripts/

      # 3. ëŒ€ëŸ‰ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (í•µì‹¬ ë¡œì§ ìˆ˜ì •)
      - name: Run All Scripts Recursively
        id: execution_step
        run: |
          # ë¡œê·¸ í´ë” ìƒì„±
          mkdir -p execution_logs
          
          # ê²°ê³¼ ìš”ì•½ í—¤ë” ìƒì„±
          echo "## ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "| ê²½ë¡œ/íŒŒì¼ëª… | ìƒíƒœ | ì†Œìš”ì‹œê°„ | ê²°ê³¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: | :---: | :--- |" >> $GITHUB_STEP_SUMMARY
          
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          
          # find ëª…ë ¹ì–´ë¡œ scripts í´ë” í•˜ìœ„ì˜ ëª¨ë“  .py, .sh íŒŒì¼ ê²€ìƒ‰
          # while read ë£¨í”„ë¡œ ì•ˆì „í•˜ê²Œ íŒŒì¼ ì²˜ë¦¬ (íŒŒì¼ëª… ê³µë°± ë“± ëŒ€ì‘)
          find scripts -type f \( -name "*.py" -o -name "*.sh" \) | sort | while read -r file; do
            
            FILENAME=$(basename "$file")
            REL_PATH=${file#scripts/} # scripts/ ì´í›„ ê²½ë¡œë§Œ ì¶”ì¶œ
            LOG_FILE="execution_logs/${FILENAME}.log"
            
            echo "â–¶ï¸ Processing: $file"
            
            START=$(date +%s)
            
            # --- ì‹¤í–‰ ë¡œì§ (ê°•ì œ ì¢…ë£Œ ë°©ì§€ë¥¼ ìœ„í•œ ì¡°ê±´ë¬¸ ì²˜ë¦¬) ---
            if [[ "$file" == *.py ]]; then
              # python ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ 5ë¶„)
              timeout 300s python "$file" > "$LOG_FILE" 2>&1
              EXIT_CODE=$?
            else
              # shell ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ 5ë¶„)
              timeout 300s "$file" > "$LOG_FILE" 2>&1
              EXIT_CODE=$?
            fi
            # ---------------------------------------------------
            
            END=$(date +%s)
            DURATION=$((END - START))
            
            # ê²°ê³¼ íŒë³„ ë° ë¦¬í¬íŒ…
            if [ $EXIT_CODE -eq 0 ]; then
              echo "  âœ… Success"
              echo "| $REL_PATH | âœ… ì„±ê³µ | ${DURATION}s | Pass |" >> $GITHUB_STEP_SUMMARY
              SUCCESS_COUNT=$((SUCCESS_COUNT+1))
              rm "$LOG_FILE" # ì„±ê³µí•œ ë¡œê·¸ëŠ” ì‚­ì œí•˜ì—¬ ìš©ëŸ‰ í™•ë³´
            elif [ $EXIT_CODE -eq 124 ]; then
              echo "  â° Timeout"
              echo "| $REL_PATH | â° íƒ€ì„ì•„ì›ƒ | 300s+ | **Timeout (5m)** |" >> $GITHUB_STEP_SUMMARY
              FAILED_COUNT=$((FAILED_COUNT+1))
            else
              echo "  âŒ Failed (Code: $EXIT_CODE)"
              # ì—ëŸ¬ ë¡œê·¸ ë§ˆì§€ë§‰ í•œ ì¤„ ì¶”ì¶œ
              ERR_MSG=$(tail -n 1 "$LOG_FILE" | cut -c 1-50)...
              echo "| $REL_PATH | âŒ ì‹¤íŒ¨ | ${DURATION}s | \`$ERR_MSG\` |" >> $GITHUB_STEP_SUMMARY
              FAILED_COUNT=$((FAILED_COUNT+1))
            fi
            
          done
          
          # ë£¨í”„ ë°–ì—ì„œëŠ” í™˜ê²½ë³€ìˆ˜ ì „ë‹¬ì´ ê¹Œë‹¤ë¡œìš°ë¯€ë¡œ íŒŒì¼ë¡œ ìƒíƒœ ì €ì¥
          echo "SUCCESS=$SUCCESS_COUNT" > run_status.txt
          echo "FAILED=$FAILED_COUNT" >> run_status.txt

      # 4. ì¢…í•© ê²°ê³¼ íŒì • (ìŠ¤í¬ë¦½íŠ¸ ë£¨í”„ê°€ ëë‚œ ë’¤ ìˆ˜í–‰)
      - name: Finalize Status
        run: |
          source run_status.txt
          echo "Total Success: $SUCCESS"
          echo "Total Failed: $FAILED"
          
          if [ "$FAILED" -gt 0 ]; then
            echo "âš ï¸ $FAILED ê°œì˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            exit 1 # ì—¬ê¸°ì„œ ì›Œí¬í”Œë¡œìš°ë¥¼ ìµœì¢… ì‹¤íŒ¨ ì²˜ë¦¬
          else
            echo "ğŸ‰ ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤."
          fi

      # 5. ì‹¤íŒ¨í•œ ë¡œê·¸ ì—…ë¡œë“œ (ë””ë²„ê¹…ìš©)
      - name: Upload Failure Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-logs
          path: execution_logs/
          retention-days: 3
