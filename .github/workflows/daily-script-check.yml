name: ğŸ›¡ï¸ Ultimate Ops Health Check (Parallel & Auto-Heal)
run-name: ğŸš€ [Parallel] ëŒ€ëŸ‰ ìŠ¤í¬ë¦½íŠ¸ ë³‘ë ¬ ì ê²€ ë° ìê°€ ì¹˜ìœ 

on:
  schedule:
    - cron: '0 0 * * *' # ë§¤ì¼ ìì • ì‹¤í–‰
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰

env:
  # ğŸŒ í™˜ê²½ ë³€ìˆ˜ ë° ê²½ë¡œ ì„¤ì •
  TZ: 'Asia/Seoul'
  RESOURCE_PATH: ${{ github.workspace }}/resources
  DATA_PATH: ${{ github.workspace }}/data
  PYTHONPATH: ${{ github.workspace }}/scripts:${{ github.workspace }}/resources
  MAX_JOBS: 4 # ë³‘ë ¬ ì‹¤í–‰ ê°œìˆ˜ (CPU ì½”ì–´ ìˆ˜ì— ë§ì¶¤)

jobs:
  parallel-integrity-check:
    runs-on: ubuntu-latest
    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: 'koreatest12/Information-Security-Engineer-' # íƒ€ê²Ÿ ë¦¬í¬ì§€í† ë¦¬ ëª…ì‹œ
          token: ${{ secrets.GITHUB_TOKEN }} # (í•„ìš”ì‹œ PAT í† í° ì‚¬ìš©)
          path: '.' # í˜„ì¬ ì‘ì—… ê³µê°„ì— ì²´í¬ì•„ì›ƒ

      # 2. ì‹œìŠ¤í…œ ë„êµ¬ ì„¤ì¹˜ (ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ìœ„í•œ GNU Parallel)
      - name: Install System Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y parallel tree

      # 3. Python ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4. [ì—…ê·¸ë ˆì´ë“œ] ëŒ€ìš©ëŸ‰ ìºì‹œ ì„¤ì • (ë¦¬ì†ŒìŠ¤ ë° Pip)
      - name: Cache Pip & Resources
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ${{ env.RESOURCE_PATH }}
            ${{ env.DATA_PATH }}
          key: ${{ runner.os }}-ops-cache-v2-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-ops-cache-v2-

      # 5. [ì—…ê·¸ë ˆì´ë“œ] ë¦¬ì†ŒìŠ¤ íŒŒì¼ ë° í™˜ê²½ êµ¬ì„± (íŒŒì¼ì´ ì—†ìœ¼ë©´ ëŒ€ëŸ‰ ìƒì„±)
      - name: Provision Resources & Paths
        run: |
          echo "ğŸ“‚ Creating Directory Structures..."
          mkdir -p "$RESOURCE_PATH" "$DATA_PATH" "logs" "scripts"

          # PATHì— ë¦¬ì†ŒìŠ¤ ê²½ë¡œ ì˜êµ¬ ì¶”ê°€
          echo "$RESOURCE_PATH" >> $GITHUB_PATH

          # ëŒ€ìš©ëŸ‰ ë”ë¯¸ ë¦¬ì†ŒìŠ¤ íŒŒì¼ ìƒì„± (ìºì‹œ í…ŒìŠ¤íŠ¸ìš©, ì—†ìœ¼ë©´ ìƒì„±)
          if [ ! -f "$DATA_PATH/security_db_master.dat" ]; then
            echo "âš¡ Generating 10MB Dummy Resource DB..."
            dd if=/dev/zero of="$DATA_PATH/security_db_master.dat" bs=1M count=10
          fi

          # ê³µí†µ ì„¤ì • íŒŒì¼ ìƒì„±
          echo '{"env": "production", "parallel": true}' > "$RESOURCE_PATH/config.json"
          
          echo "âœ… Resources Ready at $RESOURCE_PATH"
          tree -L 2

      # 6. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Python Dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # ê¸°ë³¸ í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
            pip install requests pandas numpy
          fi

      # 7. [í•µì‹¬] ìê°€ ì¹˜ìœ  (Self-Healing): ëˆ„ë½ëœ íŒŒì¼ ìë™ ìƒì„±
      - name: Auto-Heal Missing Files
        run: |
          echo "ğŸ©º Starting Pre-flight Health Check..."
          
          # ëª¨ë“  í•˜ìœ„ ë””ë ‰í† ë¦¬ ìˆœíšŒ
          find . -type d -not -path '*/.*' | while read -r dir; do
            # 1. Python íŒ¨í‚¤ì§€ ì´ˆê¸°í™” íŒŒì¼ (__init__.py) ë³µêµ¬
            if [[ "$dir" == *"/scripts"* ]] || [[ "$dir" == *"/src"* ]]; then
              if [ ! -f "$dir/__init__.py" ]; then
                echo "  â• Healing: Creating __init__.py in $dir"
                touch "$dir/__init__.py"
              fi
            fi

            # 2. ê° í´ë”ì— ìŠ¤í¬ë¦½íŠ¸ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ê¸°ë³¸ ì ê²€ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
            FILE_COUNT=$(find "$dir" -maxdepth 1 -name "*.py" | wc -l)
            if [ "$FILE_COUNT" -eq 0 ] && [ "$dir" != "." ]; then
              echo "  â• Healing: Missing script in $dir. Creating health_check.py"
              cat <<EOF > "$dir/health_check.py"
          import sys, os
          import json
          print(f"âœ… Auto-Generated Health Check for {os.path.basename('$dir')}")
          # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ í™•ì¸
          try:
              with open('${RESOURCE_PATH}/config.json') as f:
                  cfg = json.load(f)
              print("   - Config Load: OK")
          except:
              print("   - Config Load: Failed")
          sys.exit(0)
          EOF
            fi
          done
          echo "âœ… Self-Healing Complete."

      # 8. [í•µì‹¬] ë³‘ë ¬ ì‹¤í–‰ (GNU Parallel)
      - name: Run Scripts in Parallel
        id: parallel_exec
        shell: bash
        run: |
          # ë¡œê·¸ ì €ì¥ì†Œ
          mkdir -p execution_results
          
          echo "ğŸš€ Executing scripts in parallel (Max Jobs: $MAX_JOBS)..."

          # í•¨ìˆ˜ ì •ì˜: ê°œë³„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë¡œì§ (Parallelì— ì „ë‹¬ë¨)
          export RESOURCE_PATH
          export DATA_PATH
          
          run_wrapper() {
            script="$1"
            filename=$(basename "$script")
            logfile="execution_results/${filename}.log"
            metafile="execution_results/${filename}.meta"
            
            start_time=$(date +%s)
            
            # ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ 5ë¶„)
            if [[ "$script" == *.py ]]; then
              timeout 300s python "$script" > "$logfile" 2>&1
            else
              timeout 300s bash "$script" > "$logfile" 2>&1
            fi
            exit_code=$?
            
            end_time=$(date +%s)
            duration=$((end_time - start_time))
            
            # ê²°ê³¼ ë©”íƒ€ë°ì´í„° ì €ì¥ (íŒŒì¼ëª…|ìƒíƒœ|ì‹œê°„|ì¢…ë£Œì½”ë“œ)
            if [ $exit_code -eq 0 ]; then
              echo "$filename|SUCCESS|$duration|$exit_code" > "$metafile"
            elif [ $exit_code -eq 124 ]; then
              echo "$filename|TIMEOUT|$duration|$exit_code" > "$metafile"
            else
              echo "$filename|FAILURE|$duration|$exit_code" > "$metafile"
            fi
          }
          export -f run_wrapper

          # findë¡œ íŒŒì¼ ì°¾ì•„ì„œ parallelë¡œ ë„˜ê¹€
          # ::: ë’¤ì— ì˜¤ëŠ” ì¸ìë“¤ì´ ë³‘ë ¬ë¡œ ì‹¤í–‰ë¨
          find scripts -type f \( -name "*.py" -o -name "*.sh" \) | parallel -j "$MAX_JOBS" run_wrapper {}
          
          echo "âœ… Parallel Execution Finished."

      # 9. ê²°ê³¼ ì§‘ê³„ ë° ë¦¬í¬íŠ¸ ìƒì„± (Scatter-Gather íŒ¨í„´)
      - name: Aggregate Results & Report
        if: always()
        run: |
          echo "## ğŸ›¡ï¸ ë³‘ë ¬ ë³´ì•ˆ ì ê²€ ë¦¬í¬íŠ¸ (koreatest12)" >> $GITHUB_STEP_SUMMARY
          echo "| íŒŒì¼ëª… | ìƒíƒœ | ì†Œìš”ì‹œê°„ | ê²°ê³¼ ìš”ì•½ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: | :---: | :--- |" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_FAIL=0
          
          # ê²°ê³¼ íŒŒì¼ ìˆœíšŒ
          for meta in execution_results/*.meta; do
            [ -e "$meta" ] || continue
            
            # ë°ì´í„° íŒŒì‹±
            IFS='|' read -r FILENAME STATUS DURATION CODE < "$meta"
            LOGFILE="execution_results/${FILENAME}.log"
            
            # ìš”ì•½ ë©”ì‹œì§€ ì¶”ì¶œ (ë§ˆì§€ë§‰ ì¤„)
            MSG=$(tail -n 1 "$LOGFILE" | tr -cd '\11\12\15\40-\176' | cut -c 1-40)
            
            if [ "$STATUS" == "SUCCESS" ]; then
              ICON="âœ…"
            elif [ "$STATUS" == "TIMEOUT" ]; then
              ICON="â°"
              TOTAL_FAIL=$((TOTAL_FAIL+1))
            else
              ICON="âŒ"
              TOTAL_FAIL=$((TOTAL_FAIL+1))
            fi
            
            echo "| **$FILENAME** | $ICON $STATUS | ${DURATION}s | \`$MSG...\` |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "TOTAL_FAIL=$TOTAL_FAIL" >> $GITHUB_ENV
          
          if [ "$TOTAL_FAIL" -gt 0 ]; then
             echo "::warning:: $TOTAL_FAIL ê°œì˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          else
             echo "ğŸ‰ ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ì ê²€ ì™„ë£Œ!"
          fi

      # 10. ì‹¤íŒ¨ ë¡œê·¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-logs
          path: execution_results/
          retention-days: 5
