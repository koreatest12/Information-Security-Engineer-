name: ğŸ›¡ï¸ Ultimate Ops Health Check (Fix: Locks & Dependencies)
run-name: ğŸš€ [Smart Fix] ì˜ì¡´ì„± ìë™ í•´ê²° ë° OS í˜¸í™˜ì„± ì ê²€

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  TZ: 'Asia/Seoul'
  RESOURCE_PATH: ${{ github.workspace }}/resources
  DATA_PATH: ${{ github.workspace }}/data
  PYTHONPATH: ${{ github.workspace }}/scripts:${{ github.workspace }}/resources
  MAX_JOBS: 4 # ë³‘ë ¬ ì‹¤í–‰ ê°œìˆ˜

permissions:
  contents: write
  security-events: write
  actions: read

jobs:
  smart-integrity-check:
    runs-on: ubuntu-latest
    steps:
      # 1. ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: 'koreatest12/Information-Security-Engineer-'
          token: ${{ secrets.GITHUB_TOKEN }}
          path: '.'

      # 2. ì‹œìŠ¤í…œ í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜
      - name: Install System Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y parallel tree

      # 3. Python ì„¤ì • (3.10)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # í• ìºì‹œ í™œì„±í™”

      # 4. [FIX-1] í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°•ì œ ì„¤ì¹˜ (ModuleNotFoundError í•´ê²°)
      - name: Install Critical Dependencies
        run: |
          echo "ğŸ“¦ Installing Core Python Libs..."
          pip install --upgrade pip
          # pandas, requests ë“± ìì£¼ ì“°ì´ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„ ì„¤ì¹˜
          pip install pandas requests faker numpy 
          
          # ê° í´ë”ë³„ requirements.txtê°€ ìˆìœ¼ë©´ ì¶”ê°€ ì„¤ì¹˜
          find . -name "requirements.txt" | while read req; do
             echo "   + Merging dependencies from $req"
             pip install -r "$req" || true
          done

      # 5. [FIX-2] ìŠ¤ë§ˆíŠ¸ ì‹¤í–‰ ë˜í¼ ìƒì„± (OS í˜¸í™˜ì„± ì²´í¬ & ë¡œê¹…)
      - name: Create Smart Execution Wrapper
        run: |
          cat <<'EOF' > smart_runner.sh
          #!/bin/bash
          SCRIPT=$1
          FILENAME=$(basename "$SCRIPT")
          LOGFILE="execution_results/${FILENAME}.log"
          METAFILE="execution_results/${FILENAME}.meta"
          
          START=$(date +%s)
          
          # [OS í˜¸í™˜ì„± ì²´í¬]
          # ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš©ì„ ì½ì–´ì„œ yumì´ ìˆëŠ”ë° ì‹œìŠ¤í…œì— yumì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
          if grep -q "yum" "$SCRIPT" && ! command -v yum &> /dev/null; then
            echo "â­ï¸ SKIPPED: This script requires 'yum' (CentOS/RHEL) but running on Ubuntu." > "$LOGFILE"
            echo "$FILENAME|SKIPPED|0|0" > "$METAFILE"
            exit 0
          fi
          
          # [ì‹¤í–‰ ë¡œì§]
          if [[ "$SCRIPT" == *.py ]]; then
            timeout 300s python "$SCRIPT" > "$LOGFILE" 2>&1
            EXIT_CODE=$?
          else
            chmod +x "$SCRIPT"
            timeout 300s ./$SCRIPT > "$LOGFILE" 2>&1
            EXIT_CODE=$?
          fi
          
          END=$(date +%s)
          DURATION=$((END - START))
          
          # [ê²°ê³¼ ê¸°ë¡]
          if [ $EXIT_CODE -eq 0 ]; then
            echo "$FILENAME|SUCCESS|$DURATION|$EXIT_CODE" > "$METAFILE"
          elif [ $EXIT_CODE -eq 124 ]; then
            echo "$FILENAME|TIMEOUT|$DURATION|$EXIT_CODE" > "$METAFILE"
          else
            echo "$FILENAME|FAILURE|$DURATION|$EXIT_CODE" > "$METAFILE"
          fi
          EOF
          chmod +x smart_runner.sh

      # 6. ë¦¬ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì¤€ë¹„ (ê²°ê³¼ ì €ì¥ì†Œ)
      - name: Prepare Workspace
        run: mkdir -p execution_results "$RESOURCE_PATH" "$DATA_PATH"

      # 7. [FIX-3] ì‹¤í–‰ ê·¸ë£¹ ë¶„ë¦¬ (ë³‘ë ¬ vs ìˆœì°¨)
      # ì‹œìŠ¤í…œ ì„¤ì¹˜(install_*, upgrade_*) ìŠ¤í¬ë¦½íŠ¸ëŠ” ë½ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ ë¶„ë¦¬
      - name: Categorize Scripts
        run: |
          mkdir -p .queue/parallel .queue/sequential
          
          find scripts -type f \( -name "*.py" -o -name "*.sh" \) | while read file; do
            filename=$(basename "$file")
            
            # ì„¤ì¹˜/ì—…ê·¸ë ˆì´ë“œ ìŠ¤í¬ë¦½íŠ¸ëŠ” ìˆœì°¨ ì‹¤í–‰ ê·¸ë£¹ìœ¼ë¡œ ì´ë™
            if [[ "$filename" == *"install_"* ]] || [[ "$filename" == *"upgrade_"* ]]; then
              echo "$file" >> .queue/sequential_list.txt
            else
              echo "$file" >> .queue/parallel_list.txt
            fi
          done

      # 8. ì•ˆì „í•œ ìŠ¤í¬ë¦½íŠ¸: ë³‘ë ¬ ì‹¤í–‰ (Parallel)
      - name: Run Logic Scripts (Parallel)
        id: run_parallel
        run: |
          if [ -f .queue/parallel_list.txt ]; then
            echo "ğŸš€ Running Logic Scripts in Parallel..."
            cat .queue/parallel_list.txt | parallel -j "$MAX_JOBS" ./smart_runner.sh {}
          else
            echo "â„¹ï¸ No parallel scripts found."
          fi

      # 9. ìœ„í—˜í•œ ìŠ¤í¬ë¦½íŠ¸: ìˆœì°¨ ì‹¤í–‰ (Sequential) - APT Lock ë°©ì§€
      - name: Run Install Scripts (Sequential)
        if: always()
        run: |
          if [ -f .queue/sequential_list.txt ]; then
            echo "ğŸ¢ Running System Scripts Sequentially (to avoid APT locks)..."
            while read script; do
              echo "   â–¶ï¸ Running: $script"
              ./smart_runner.sh "$script"
            done < .queue/sequential_list.txt
          fi

      # 10. ê²°ê³¼ ì§‘ê³„ ë° ë¦¬í¬íŠ¸ (ìˆ˜ì •ëœ ë¡œì§)
      - name: Aggregate & Report
        if: always()
        run: |
          echo "## ğŸ›¡ï¸ ìµœì¢… ìˆ˜ì •ëœ ë³´ì•ˆ ì ê²€ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "| íŒŒì¼ëª… | ìƒíƒœ | ì‹œê°„ | ë¹„ê³  |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: | :---: | :--- |" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_FAIL=0
          
          for meta in execution_results/*.meta; do
            [ -e "$meta" ] || continue
            IFS='|' read -r FILENAME STATUS DURATION CODE < "$meta"
            LOGFILE="execution_results/${FILENAME}.log"
            
            # ë¡œê·¸ í•œ ì¤„ ìš”ì•½
            MSG=$(head -n 1 "$LOGFILE" | cut -c 1-50)
            
            if [ "$STATUS" == "SUCCESS" ]; then
              ICON="âœ…"
            elif [ "$STATUS" == "SKIPPED" ]; then
              ICON="âšª" # ìŠ¤í‚µ ì•„ì´ì½˜
              MSG="OS Incompatible (Skipped Safe)"
            elif [ "$STATUS" == "TIMEOUT" ]; then
              ICON="â°"
              TOTAL_FAIL=$((TOTAL_FAIL+1))
            else
              ICON="âŒ"
              TOTAL_FAIL=$((TOTAL_FAIL+1))
              # ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ë‚´ìš©ì„ ì¡°ê¸ˆ ë” ë³´ì—¬ì¤Œ
              MSG=$(tail -n 1 "$LOGFILE" | tr -cd '\11\12\15\40-\176' | cut -c 1-40)
            fi
            
            echo "| **$FILENAME** | $ICON $STATUS | ${DURATION}s | \`$MSG...\` |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "TOTAL_FAIL=$TOTAL_FAIL" >> $GITHUB_ENV
          
          if [ "$TOTAL_FAIL" -gt 0 ]; then
             echo "::error:: $TOTAL_FAIL ê°œì˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—¬ì „íˆ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
             # ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ë¥¼ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë§Œë“¤ê³  ì‹¶ë‹¤ë©´ exit 1, ì•„ë‹ˆë©´ exit 0
             # exit 1 
          fi

      # 11. ë¡œê·¸ ì—…ë¡œë“œ
      - name: Upload Execution Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fixed-execution-logs
          path: execution_results/
          retention-days: 7
