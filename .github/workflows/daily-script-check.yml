name: Robust Daily Scripts Health Check
run-name: ðŸ›¡ï¸ ì¼ì¼ ëŒ€ëŸ‰ ìŠ¤í¬ë¦½íŠ¸ ì ê²€ - ${{ github.event_name == 'schedule' && 'ì •ê¸° ì‹¤í–‰' || 'ìˆ˜ë™ ì‹¤í–‰' }}

on:
  schedule:
    - cron: '0 0 * * *' # í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  bulk-check:
    runs-on: ubuntu-latest
    # ê¶Œí•œ ì„¤ì • (ì´ìŠˆ ìƒì„±ì´ë‚˜ ì½”ë“œ í‘¸ì‹œê°€ í•„ìš” ì—†ë‹¤ë©´ readë§Œ ìžˆì–´ë„ ë¨)
    permissions:
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # pip ìºì‹± ê¸°ëŠ¥ í™œì„±í™”ë¡œ ì†ë„ í–¥ìƒ

      # ì˜ì¡´ì„± ì„¤ì¹˜ (requirements.txtê°€ ìžˆìœ¼ë©´ ì„¤ì¹˜, ì—†ìœ¼ë©´ ë„˜ì–´ê°)
      - name: Install Dependencies
        run: |
          if [ -f scripts/requirements.txt ]; then
            echo "Installing dependencies from scripts/requirements.txt..."
            pip install -r scripts/requirements.txt
          else
            echo "No requirements.txt found. Skipping."
          fi

      - name: Grant Execute Permissions
        run: chmod +x scripts/*

      # í•µì‹¬: ëŒ€ëŸ‰ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë° ë¡œê·¸ ë¶„ë¦¬
      - name: Run All Scripts with Robust Error Handling
        id: run_scripts
        continue-on-error: true # ì´ ë‹¨ê³„ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‹¨ê³„(ë¡œê·¸ ì—…ë¡œë“œ)ë¡œ ì§„í–‰
        run: |
          # ë¡œê·¸ ì €ìž¥ì„ ìœ„í•œ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p logs
          
          # GitHub Summary í—¤ë” ìž‘ì„±
          echo "## ðŸ“Š ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê²°ê³¼ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "| íŒŒì¼ëª… | ìƒíƒœ | ì†Œìš” ì‹œê°„ | ë¹„ê³  |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: | :---: | :--- |" >> $GITHUB_STEP_SUMMARY
          
          FAILED_COUNT=0
          TOTAL_COUNT=0
          
          # scripts í´ë” ìˆœíšŒ
          for file in scripts/*; do
            # íŒŒì¼ ì²´í¬ ë° ì œì™¸ ì¡°ê±´
            if [ ! -f "$file" ] || [[ "$file" == *"requirements.txt" ]]; then
              continue
            fi
            
            TOTAL_COUNT=$((TOTAL_COUNT+1))
            FILENAME=$(basename "$file")
            LOG_FILE="logs/${FILENAME}.log"
            
            echo "Processing: $FILENAME"
            
            START_TIME=$(date +%s)
            
            # ì‹¤í–‰ ë¡œì§ (íƒ€ìž„ì•„ì›ƒ 300ì´ˆ/5ë¶„ ì„¤ì •)
            # set +eë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì‰˜ì´ ì¢…ë£Œë˜ì§€ ì•Šë„ë¡ í•¨
            set +e
            
            if [[ "$file" == *.py ]]; then
              timeout 300s python "$file" > "$LOG_FILE" 2>&1
              EXIT_CODE=$?
            elif [[ "$file" == *.sh ]]; then
              timeout 300s ./"$file" > "$LOG_FILE" 2>&1
              EXIT_CODE=$?
            else
              timeout 300s ./"$file" > "$LOG_FILE" 2>&1
              EXIT_CODE=$?
            fi
            
            set -e # ë‹¤ì‹œ ì—ëŸ¬ ê²€ì¶œ ëª¨ë“œ ë³µê·€ (ìŠ¤í¬ë¦½íŠ¸ ì™¸ë¶€ ë¡œì§ ë³´í˜¸)
            
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            
            # ê²°ê³¼ íŒë³„
            if [ $EXIT_CODE -eq 0 ]; then
              echo "âœ… $FILENAME Success (${DURATION}s)"
              echo "| $FILENAME | âœ… ì„±ê³µ | ${DURATION}s | - |" >> $GITHUB_STEP_SUMMARY
              # ì„±ê³µí•œ ë¡œê·¸ëŠ” êµ³ì´ ë‚¨ê¸°ì§€ ì•Šê³  ì‚­ì œ (ìš©ëŸ‰ ì ˆì•½)
              rm "$LOG_FILE"
            elif [ $EXIT_CODE -eq 124 ]; then
              echo "â° $FILENAME Timed out"
              echo "| $FILENAME | â° íƒ€ìž„ì•„ì›ƒ | 300s+ | 5ë¶„ ì´ˆê³¼ë¡œ ê°•ì œ ì¢…ë£Œ |" >> $GITHUB_STEP_SUMMARY
              FAILED_COUNT=$((FAILED_COUNT+1))
            else
              echo "âŒ $FILENAME Failed (Code: $EXIT_CODE)"
              # ì—ëŸ¬ ë¡œê·¸ì˜ ë§ˆì§€ë§‰ 3ì¤„ë§Œ ìš”ì•½ì— í‘œì‹œ
              ERROR_TAIL=$(tail -n 3 "$LOG_FILE" | tr '\n' ' ')
              echo "| $FILENAME | âŒ ì‹¤íŒ¨ | ${DURATION}s | \`$ERROR_TAIL\` |" >> $GITHUB_STEP_SUMMARY
              FAILED_COUNT=$((FAILED_COUNT+1))
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ ì¢…í•© ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "- ì´ ìŠ¤í¬ë¦½íŠ¸: $TOTAL_COUNT ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹¤íŒ¨: $FAILED_COUNT ê°œ" >> $GITHUB_STEP_SUMMARY
          
          # ì‹¤íŒ¨ ê±´ìˆ˜ë¥¼ output ë³€ìˆ˜ë¡œ ì €ìž¥ (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì°¸ì¡° ê°€ëŠ¥)
          echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
          
          if [ $FAILED_COUNT -gt 0 ]; then
            echo "Warning: $FAILED_COUNT scripts failed."
            exit 1 # ìµœì¢…ì ìœ¼ë¡œëŠ” ì‹¤íŒ¨ë¡œ ë§ˆí‚¹í•˜ì—¬ ì•Œë¦¼ ë°œì†¡
          fi

      # ì‹¤íŒ¨í•œ ìŠ¤í¬ë¦½íŠ¸ì˜ ë¡œê·¸ë§Œ ëª¨ì•„ì„œ ì—…ë¡œë“œ (ë””ë²„ê¹…ìš©)
      - name: Upload Error Logs
        if: failure() || steps.run_scripts.outputs.failed_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-report
          path: logs/
          retention-days: 5
