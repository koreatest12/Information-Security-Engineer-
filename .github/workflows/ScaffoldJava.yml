name: "üèóÔ∏è Ultimate Scaffold: App + Infra + Security"

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project Name'
        required: true
        default: 'enterprise-platform'
      java_group_id:
        description: 'Java Group ID'
        required: true
        default: 'com.corp.platform'
      cloud_provider:
        description: 'Target Cloud (aws/azure/gcp)'
        required: true
        default: 'aws'

permissions:
  contents: write

jobs:
  generate-architecture:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: üè≠ Generate All-in-One Structure
        run: |
          PROJECT_ROOT="${{ inputs.project_name }}"
          JAVA_PKG_PATH=$(echo "${{ inputs.java_group_id }}" | tr '.' '/')
          
          mkdir -p $PROJECT_ROOT
          cd $PROJECT_ROOT

          echo ">>> 1. Creating Application Layers (Java/Python)..."
          # (Í∏∞Ï°¥ Java/Python/Docker ÏÉùÏÑ± Î°úÏßÅÏùÄ ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄÎêòÎÇò, Í≥µÍ∞Ñ Ï†àÏïΩÏùÑ ÏúÑÌï¥ ÏÉùÎûµÌïòÍ≥† Ïù∏ÌîÑÎùº Î∂ÄÎ∂ÑÏóê ÏßëÏ§ëÌï©ÎãàÎã§)
          # Ïã§Ï†ú Íµ¨ÌòÑ ÏãúÏóêÎäî Ïù¥Ï†Ñ ÎãµÎ≥ÄÏùò Java/Python ÏÉùÏÑ± ÏΩîÎìúÍ∞Ä Ïó¨Í∏∞Ïóê Ìè¨Ìï®Îê©ÎãàÎã§.
          
          # ... [Previous Java/Python/Docker Generation Code] ...
          # Ìé∏ÏùòÎ•º ÏúÑÌï¥ ÎîîÎ†âÌÜ†Î¶¨Îßå Ïû¨ÏÉùÏÑ±Ìï©ÎãàÎã§.
          mkdir -p backend-java/src/main/resources
          mkdir -p backend-python/app
          touch backend-java/Dockerfile backend-python/Dockerfile docker-compose.yml

          # ======================================================
          # 4. INFRASTRUCTURE & SECURITY (New Feature)
          # ======================================================
          echo ">>> üõ°Ô∏è Generating Infrastructure & Firewall configurations..."
          
          INFRA_DIR="infrastructure"
          mkdir -p $INFRA_DIR/terraform
          mkdir -p $INFRA_DIR/scripts
          mkdir -p $INFRA_DIR/ansible

          # ------------------------------------------------------
          # 4-A. Terraform: Cloud Server & Security Group (Firewall)
          # ------------------------------------------------------
          # [File] main.tf (AWS Provider & EC2)
          cat <<EOF > $INFRA_DIR/terraform/main.tf
          provider "aws" {
            region = "ap-northeast-2"
          }

          resource "aws_instance" "app_server" {
            ami           = "ami-0c9c942bd7bf113a2" # Ubuntu 22.04 LTS Example
            instance_type = "t3.medium"
            key_name      = var.key_name
            
            security_groups = [aws_security_group.app_firewall.name]

            tags = {
              Name = "${{ inputs.project_name }}-server"
            }
          }
          EOF

          # [File] security.tf (Firewall Rules)
          cat <<EOF > $INFRA_DIR/terraform/security.tf
          resource "aws_security_group" "app_firewall" {
            name        = "${{ inputs.project_name }}-sg"
            description = "Allow Web and SSH traffic"

            # Inbound Rule: SSH
            ingress {
              from_port   = 22
              to_port     = 22
              protocol    = "tcp"
              cidr_blocks = ["0.0.0.0/0"] # Change this to specific IP for security
            }

            # Inbound Rule: Java Spring Boot
            ingress {
              from_port   = 8080
              to_port     = 8080
              protocol    = "tcp"
              cidr_blocks = ["0.0.0.0/0"]
            }

            # Inbound Rule: Python FastAPI
            ingress {
              from_port   = 8000
              to_port     = 8000
              protocol    = "tcp"
              cidr_blocks = ["0.0.0.0/0"]
            }

            # Outbound Rule: Allow All
            egress {
              from_port   = 0
              to_port     = 0
              protocol    = "-1"
              cidr_blocks = ["0.0.0.0/0"]
            }
          }
          EOF

          # ------------------------------------------------------
          # 4-B. Shell Scripts: Manual Server Setup & OS Firewall
          # ------------------------------------------------------
          
          # [Script] install_dependencies.sh (Server Installation)
          cat <<EOF > $INFRA_DIR/scripts/install_dependencies.sh
          #!/bin/bash
          # Run as root
          echo ">>> üì¶ Updating System and Installing Dependencies..."
          apt-get update && apt-get upgrade -y
          
          # 1. Install Java (OpenJDK 17)
          apt-get install -y openjdk-17-jdk
          
          # 2. Install Python & Pip
          apt-get install -y python3 python3-pip python3-venv
          
          # 3. Install Docker
          curl -fsSL https://get.docker.com -o get-docker.sh
          sh get-docker.sh
          usermod -aG docker ubuntu
          
          # 4. Install Docker Compose
          apt-get install -y docker-compose-plugin
          
          echo ">>> ‚úÖ Installation Complete!"
          java -version
          python3 --version
          docker --version
          EOF
          chmod +x $INFRA_DIR/scripts/install_dependencies.sh

          # [Script] setup_firewall.sh (UFW - Ubuntu Firewall)
          cat <<EOF > $INFRA_DIR/scripts/setup_firewall.sh
          #!/bin/bash
          # Run as root
          echo ">>> üõ°Ô∏è Configuring System Firewall (UFW)..."
          
          # Reset UFW
          ufw --force reset
          
          # Default Policies
          ufw default deny incoming
          ufw default allow outgoing
          
          # Allow SSH (Port 22) - Essential!
          ufw allow 22/tcp
          
          # Allow App Ports
          ufw allow 8080/tcp comment 'Spring Boot'
          ufw allow 8000/tcp comment 'FastAPI'
          
          # Allow Database (Optional, generic)
          # ufw allow 5432/tcp 
          
          # Enable Firewall
          echo "y" | ufw enable
          
          echo ">>> üî• Firewall Status:"
          ufw status verbose
          EOF
          chmod +x $INFRA_DIR/scripts/setup_firewall.sh

      - name: üöÄ Commit Infrastructure Code
        run: |
          git config --global user.name "Infra Bot"
          git config --global user.email "infra@bot.com"
          git add .
          git commit -m "üöß Add Infrastructure: Terraform & Setup Scripts" || echo "No changes to commit"
          git push
