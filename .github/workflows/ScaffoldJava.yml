name: "üèóÔ∏è Mega-Scaffold: Java, Python, Docker & Resources"

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project Name (Root Folder)'
        required: true
        default: 'hybrid-platform'
      java_group_id:
        description: 'Java Group ID'
        required: true
        default: 'com.example.platform'
      spring_boot_version:
        description: 'Spring Boot Version'
        required: true
        default: '3.2.0'
      python_version:
        description: 'Python Version'
        required: true
        default: '3.10'

permissions:
  contents: write

jobs:
  generate-full-stack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: üè≠ Generate Comprehensive Architecture
        run: |
          # --- [Configuration] ---
          PROJECT_ROOT="${{ inputs.project_name }}"
          JAVA_PKG_PATH=$(echo "${{ inputs.java_group_id }}" | tr '.' '/')
          
          echo ">>> üöÄ Starting Mega-Scaffolding for $PROJECT_ROOT..."
          mkdir -p $PROJECT_ROOT
          cd $PROJECT_ROOT

          # ======================================================
          # 1. JAVA SPRING BOOT (Production Ready Structure)
          # ======================================================
          echo ">>> ‚òï Building Java Spring Boot Environment..."
          JAVA_ROOT="backend-java"
          mkdir -p $JAVA_ROOT/src/main/java/$JAVA_PKG_PATH/controller
          mkdir -p $JAVA_ROOT/src/main/java/$JAVA_PKG_PATH/service
          mkdir -p $JAVA_ROOT/src/main/java/$JAVA_PKG_PATH/dto
          mkdir -p $JAVA_ROOT/src/main/java/$JAVA_PKG_PATH/repository
          mkdir -p $JAVA_ROOT/src/main/resources
          mkdir -p $JAVA_ROOT/src/test/java/$JAVA_PKG_PATH

          # [File] pom.xml (Real Dependencies)
          cat <<EOF > $JAVA_ROOT/pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0" 
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <parent>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-parent</artifactId>
              <version>${{ inputs.spring_boot_version }}</version>
              <relativePath/>
            </parent>
            <groupId>${{ inputs.java_group_id }}</groupId>
            <artifactId>backend-java</artifactId>
            <version>1.0.0-SNAPSHOT</version>
            <name>backend-java</name>
            <properties>
              <java.version>17</java.version>
            </properties>
            <dependencies>
              <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-web</artifactId>
              </dependency>
              <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-actuator</artifactId>
              </dependency>
              <dependency>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
                <optional>true</optional>
              </dependency>
              <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-test</artifactId>
                <scope>test</scope>
              </dependency>
            </dependencies>
            <build>
              <plugins>
                <plugin>
                  <groupId>org.springframework.boot</groupId>
                  <artifactId>spring-boot-maven-plugin</artifactId>
                </plugin>
              </plugins>
            </build>
          </project>
          EOF

          # [File] Application.java
          cat <<EOF > $JAVA_ROOT/src/main/java/$JAVA_PKG_PATH/BackendApplication.java
          package ${{ inputs.java_group_id }};
          import org.springframework.boot.SpringApplication;
          import org.springframework.boot.autoconfigure.SpringBootApplication;
          @SpringBootApplication
          public class BackendApplication {
              public static void main(String[] args) {
                  SpringApplication.run(BackendApplication.class, args);
              }
          }
          EOF

          # [File] application.yml
          cat <<EOF > $JAVA_ROOT/src/main/resources/application.yml
          server:
            port: 8080
          spring:
            application:
              name: java-backend-service
          management:
            endpoints:
              web:
                exposure:
                  include: health,info,metrics
          EOF

          # [File] Dockerfile (Java Multi-stage)
          cat <<EOF > $JAVA_ROOT/Dockerfile
          # Stage 1: Build
          FROM maven:3.9-eclipse-temurin-17 AS builder
          WORKDIR /app
          COPY pom.xml .
          COPY src ./src
          RUN mvn clean package -DskipTests

          # Stage 2: Run
          FROM eclipse-temurin:17-jre
          WORKDIR /app
          COPY --from=builder /app/target/*.jar app.jar
          EXPOSE 8080
          ENTRYPOINT ["java", "-jar", "app.jar"]
          EOF

          # ======================================================
          # 2. PYTHON (FastAPI/Data Structure)
          # ======================================================
          echo ">>> üêç Building Python Environment..."
          PY_ROOT="backend-python"
          mkdir -p $PY_ROOT/app/routers
          mkdir -p $PY_ROOT/app/models
          mkdir -p $PY_ROOT/app/utils
          mkdir -p $PY_ROOT/tests

          # [File] requirements.txt
          cat <<EOF > $PY_ROOT/requirements.txt
          fastapi>=0.95.0
          uvicorn>=0.22.0
          pandas>=2.0.0
          numpy>=1.24.0
          python-dotenv>=1.0.0
          requests>=2.31.0
          EOF

          # [File] main.py
          cat <<EOF > $PY_ROOT/app/main.py
          from fastapi import FastAPI
          app = FastAPI(title="Python Service")

          @app.get("/")
          def read_root():
              return {"message": "Hello from Python Service"}
          
          @app.get("/health")
          def health_check():
              return {"status": "ok"}
          EOF

          # [File] Dockerfile (Python)
          cat <<EOF > $PY_ROOT/Dockerfile
          FROM python:${{ inputs.python_version }}-slim
          WORKDIR /app
          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt
          COPY app ./app
          ENV PYTHONPATH=/app
          EXPOSE 8000
          CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
          EOF

          # ======================================================
          # 3. DOCKER ORCHESTRATION & RESOURCES
          # ======================================================
          echo ">>> üê≥ Building Docker Compose & Common Resources..."
          
          # [File] docker-compose.yml
          cat <<EOF > docker-compose.yml
          version: '3.8'
          services:
            java-service:
              build: ./$JAVA_ROOT
              ports:
                - "8080:8080"
              environment:
                - SPRING_PROFILES_ACTIVE=dev
              networks:
                - app-network

            python-service:
              build: ./$PY_ROOT
              ports:
                - "8000:8000"
              environment:
                - PYTHONUNBUFFERED=1
              networks:
                - app-network
                
            # Database (Optional Placeholder)
            postgres-db:
              image: postgres:15-alpine
              environment:
                POSTGRES_USER: admin
                POSTGRES_PASSWORD: password
                POSTGRES_DB: appdb
              ports:
                - "5432:5432"
              networks:
                - app-network
                
          networks:
            app-network:
              driver: bridge
          EOF

          # [Scripts] Build & Run Helpers
          mkdir -p scripts
          
          # build.sh
          cat <<EOF > scripts/build_all.sh
          #!/bin/bash
          echo "Building Java and Python containers..."
          docker-compose build
          EOF
          chmod +x scripts/build_all.sh
          
          # run.sh
          cat <<EOF > scripts/run_dev.sh
          #!/bin/bash
          echo "Starting stack..."
          docker-compose up -d
          EOF
          chmod +x scripts/run_dev.sh

          # [Resources] Common Directories
          mkdir -p resources/configs
          mkdir -p resources/secrets
          mkdir -p resources/data/input
          mkdir -p resources/data/output
          
          # Git Ignore
          cat <<EOF > .gitignore
          target/
          *.class
          __pycache__/
          *.pyc
          .env
          venv/
          .idea/
          .vscode/
          *.log
          EOF

      - name: üöÄ Commit and Push Generated Stack
        run: |
          git config --global user.name "Actions Bot"
          git config --global user.email "bot@github.com"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes."
          else
            git commit -m "üöß Initialize Full Stack: Java(SB), Python, Docker, Compose"
            git push
          fi
