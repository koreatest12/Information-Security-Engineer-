name: Grand Unified Full-Stack Pipeline (Silent & Auto-Gen)

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  # [핵심] 경고(Warning)를 에러로 취급하지 않음 & 메모리 최적화
  CI: false
  NODE_OPTIONS: "--max-old-space-size=4096 --openssl-legacy-provider"
  # Maven 로그 최소화
  MAVEN_OPTS: "-Dorg.slf4j.simpleLogger.defaultLogLevel=error"

jobs:
  # ------------------------------------------------------------------
  # [JOB 1] 인프라 대량 생성 (Generator Phase)
  # Java(Spring Boot), Node(React), Docker, DB 설정 파일을 모두 생성합니다.
  # ------------------------------------------------------------------
  generate-infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Maven 프로젝트 설정 파일(pom.xml) 대량 생성
      - name: Generate pom.xml (Maven Build File)
        run: |
          mkdir -p logs
          if [ ! -f "pom.xml" ]; then
            cat <<EOF > pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.company</groupId>
            <artifactId>enterprise-app</artifactId>
            <version>1.0.0</version>
            <parent>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-parent</artifactId>
                <version>3.2.0</version>
            </parent>
            <properties><java.version>17</java.version></properties>
            <dependencies>
                <dependency><groupId>org.springframework.boot</groupId><artifactId>spring-boot-starter-web</artifactId></dependency>
                <dependency><groupId>org.springframework.boot</groupId><artifactId>spring-boot-starter-data-jpa</artifactId></dependency>
                <dependency><groupId>org.postgresql</groupId><artifactId>postgresql</artifactId><scope>runtime</scope></dependency>
                <dependency><groupId>org.projectlombok</groupId><artifactId>lombok</artifactId><optional>true</optional></dependency>
                <dependency><groupId>org.springframework.boot</groupId><artifactId>spring-boot-starter-test</artifactId><scope>test</scope></dependency>
            </dependencies>
            <build><plugins><plugin><groupId>org.springframework.boot</groupId><artifactId>spring-boot-maven-plugin</artifactId></plugin></plugins></build>
          </project>
          EOF
          fi

      # 2. Java 디렉토리 및 소스 코드 대량 생성
      - name: Generate Java Source Code
        run: |
          # 디렉토리 생성
          mkdir -p src/main/java/com/company/app/controller
          mkdir -p src/main/java/com/company/app/service
          mkdir -p src/main/java/com/company/app/model
          mkdir -p src/main/resources
          mkdir -p src/test/java/com/company/app

          # Main App
          if [ ! -f "src/main/java/com/company/app/EnterpriseApplication.java" ]; then
             echo "package com.company.app; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; @SpringBootApplication public class EnterpriseApplication { public static void main(String[] a) { SpringApplication.run(EnterpriseApplication.class, a); } }" > src/main/java/com/company/app/EnterpriseApplication.java
          fi
          
          # Controller
          if [ ! -f "src/main/java/com/company/app/controller/HealthController.java" ]; then
             echo "package com.company.app.controller; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RestController; @RestController public class HealthController { @GetMapping(\"/\") public String check() { return \"System Operational\"; } }" > src/main/java/com/company/app/controller/HealthController.java
          fi

          # Service
          if [ ! -f "src/main/java/com/company/app/service/BusinessLogic.java" ]; then
             echo "package com.company.app.service; import org.springframework.stereotype.Service; @Service public class BusinessLogic { public void process() { System.out.println(\"Processing data...\"); } }" > src/main/java/com/company/app/service/BusinessLogic.java
          fi

      # 3. DB 설정 및 Dockerfile 생성
      - name: Generate Config & Dockerfile
        run: |
          # application.properties
          if [ ! -f "src/main/resources/application.properties" ]; then
             echo "server.port=8080" > src/main/resources/application.properties
             echo "spring.datasource.url=jdbc:postgresql://localhost:5432/mydb" >> src/main/resources/application.properties
             echo "spring.datasource.username=postgres" >> src/main/resources/application.properties
             echo "spring.datasource.password=password" >> src/main/resources/application.properties
             echo "spring.jpa.hibernate.ddl-auto=update" >> src/main/resources/application.properties
          fi

          # Dockerfile
          if [ ! -f "Dockerfile" ]; then
             echo "FROM eclipse-temurin:17-jdk-alpine" > Dockerfile
             echo "COPY target/*.jar app.jar" >> Dockerfile
             echo "ENTRYPOINT [\"java\",\"-jar\",\"/app.jar\"]" >> Dockerfile
          fi

      # 4. React(Node) 인프라 생성
      - name: Generate React Infrastructure
        run: |
          mkdir -p public src_front
          
          # package.json
          if [ ! -f "package.json" ]; then
            npm init -y > /dev/null 2>&1
            npm install react react-dom react-scripts serve --save > /dev/null 2>&1
            npm pkg set scripts.build="react-scripts build" > /dev/null 2>&1
          fi

          # React Source
          [ ! -f "public/index.html" ] && echo "<!DOCTYPE html><html><body><div id='root'></div></body></html>" > public/index.html
          [ ! -f "src/index.js" ] && echo "console.log('Generated');" > src/index.js

      # 5. 생성된 모든 파일을 아티팩트로 저장 (Job 2로 전달)
      - name: Upload Full Stack Source
        uses: actions/upload-artifact@v4
        with:
          name: full-source-code
          path: .

  # ------------------------------------------------------------------
  # [JOB 2] 통합 빌드 및 무소음 실행 (Silent Execution Phase)
  # ------------------------------------------------------------------
  build-and-execute:
    needs: generate-infrastructure
    runs-on: ubuntu-latest
    
    # DB 서비스 연결 (PostgreSQL)
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: mydb
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # 1. 생성된 소스 코드 다운로드
      - name: Download Source Code
        uses: actions/download-artifact@v4
        with:
          name: full-source-code

      # 2. Java 환경 설정 (Maven 캐시 활성화)
      # pom.xml이 존재하므로 setup-java가 정상적으로 캐시를 인식함
      - name: Setup Java (Fix Maven Cache)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # 3. Node 환경 설정
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 4. [핵심] Maven 의존성 미리 받기 & 캐시 채우기
      # "Maven cache not found" 에러를 해결하는 결정적 단계
      - name: Populate Maven Cache
        run: |
          echo ">>> [CACHE] Resolving Maven dependencies..."
          mvn dependency:go-offline -B -q

      # 5. [핵심] NPM 설정 (무소음 모드)
      - name: Configure NPM Silence
        run: |
          npm config set loglevel error
          npm config set audit false
          npm config set fund false
          echo ">>> NPM is configured to be silent."

      # 6. 빌드 수행 (Java + React) - 로그 숨김
      - name: Silent Build
        run: |
          echo ">>> [BUILD] Building Java Backend..."
          # -q 옵션으로 로그 최소화
          mvn clean package -DskipTests -q
          
          echo ">>> [BUILD] Building React Frontend..."
          # Warning 무시 및 로그 숨김
          npm install --legacy-peer-deps --silent > /dev/null 2>&1
          npm run build > /dev/null 2>&1
          
          echo ">>> All Builds Completed Successfully."

      # 7. 통합 실행 및 검증
      - name: Start Services & Verify
        run: |
          # Java 실행 (백그라운드, 로그 파일로 리다이렉션)
          nohup java -jar target/*.jar > logs/backend.log 2>&1 &
          
          # React 실행
          nohup npx serve -s build -l 3000 > logs/frontend.log 2>&1 &
          
          echo ">>> Waiting for services (15s)..."
          sleep 15
          
          # 검증 로직
          echo ">>> Verifying Endpoints..."
          
          if curl -s -I http://localhost:8080 | grep "200"; then
             echo "✅ Java Backend: ONLINE"
          else
             echo "⚠️ Java Backend: Check logs"
          fi
          
          if curl -s -I http://localhost:3000 | grep "200"; then
             echo "✅ React Frontend: ONLINE"
          else
             echo "⚠️ React Frontend: Check logs"
          fi

      # 8. 최종 결과물 업로드
      - name: Upload Deployment Bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-bundle
          path: |
            target/*.jar
            build/
            logs/
            Dockerfile
