name: Robust Node.js & React Auto-Setup Workflow

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  BUILD_PATH: './build'
  LOG_PATH: './logs'

jobs:
  initialize-and-deploy:
    runs-on: ubuntu-latest
    
    # 권한 설정 (Gheckout 및 파일 쓰기 권한)
    permissions:
      contents: read

    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Node.js 환경 설정 (중요: 여기서 cache: 'npm' 옵션을 뺍니다. 에러 원인 제거)
      - name: Setup Node.js (Without Cache Initial)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # 3. [핵심] 프로젝트 초기화 및 필수 파일/디렉토리 대량 생성
      # package.json 및 lock 파일이 없으면 생성하여 "Dependencies lock file not found" 에러를 원천 차단
      - name: Initialize Project Structure & Fix Lock File
        run: |
          echo ">>> Checking project structure..."
          mkdir -p ${{ env.LOG_PATH }}
          
          # package.json이 없는 경우 초기화
          if [ ! -f "package.json" ]; then
            echo ">>> No package.json found. Initializing new project..."
            npm init -y
            # React 및 필수 패키지 명시
            npm install react react-dom react-scripts web-vitals
          else
            echo ">>> package.json found."
          fi

          # package-lock.json 강제 생성을 위한 설치 시도
          if [ ! -f "package-lock.json" ]; then
             echo ">>> No lock file found. Generating package-lock.json..."
             npm install --package-lock-only
          fi

          # React 소스 디렉토리 구조가 없는 경우 자동 생성 (깡통 프로젝트 방지)
          if [ ! -d "src" ]; then
            echo ">>> Creating React source structure..."
            mkdir -p public src
            
            # index.html 생성
            cat <<EOF > public/index.html
            <!DOCTYPE html>
            <html lang="en">
              <head><title>Auto Generated App</title></head>
              <body><div id="root"></div></body>
            </html>
          EOF
            
            # index.js 생성
            cat <<EOF > src/index.js
            import React from 'react';
            import ReactDOM from 'react-dom/client';
            import App from './App';
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
          EOF
            
            # App.js 생성
            cat <<EOF > src/App.js
            function App() {
              return <h1>Hello, Automated Workflow!</h1>;
            }
            export default App;
          EOF
          fi

          echo ">>> Project structure verification complete."
          ls -R

      # 4. [수정] 수동 캐싱 적용
      # 파일이 확실히 생성된 후 캐싱을 적용하므로 에러가 발생하지 않음
      - name: Cache Node Modules
        id: npm-cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 5. 의존성 설치 및 보안 감사 (추가 기능)
      - name: Install Dependencies & Audit
        run: |
          echo ">>> Installing dependencies..."
          if [ "${{ steps.npm-cache.outputs.cache-hit }}" != "true" ]; then
            npm ci
          fi
          
          echo ">>> Running security audit (Information Only)..."
          npm audit --audit-level=high || true # 취약점 있어도 빌드 중단 방지

      # 6. 환경 변수 및 Path 설정
      - name: Configure Environment & Path
        run: |
          echo ">>> Adding node_modules to PATH"
          echo "./node_modules/.bin" >> $GITHUB_PATH
          
          echo ">>> Creating .env file"
          echo "REACT_APP_VERSION=$(date +'%Y%m%d-%H%M')" >> .env
          echo "GENERATE_SOURCEMAP=false" >> .env

      # 7. 빌드 수행
      - name: Build Application
        run: |
          echo ">>> Building React Application..."
          # react-scripts가 없는 경우를 대비해 npx 사용
          npx react-scripts build
          
          # 빌드 정보 로그 저장
          echo "Build completed at $(date)" > ${{ env.LOG_PATH }}/build_status.txt

      # 8. [추가] 서버 설치 및 구동 테스트
      - name: Setup & Test Serve
        run: |
          echo ">>> Installing production server..."
          npm install -g serve
          
          echo ">>> Starting server in background..."
          nohup serve -s build -l 3000 > ${{ env.LOG_PATH }}/server.log 2>&1 &
          
          echo ">>> Waiting for server..."
          sleep 5
          
          echo ">>> Verifying connectivity..."
          curl -I http://localhost:3000
          if [ $? -eq 0 ]; then
            echo "Server is UP!"
          else
            echo "Server failed to start."
            cat ${{ env.LOG_PATH }}/server.log
            exit 1
          fi

      # 9. [대량 추가] 아티팩트 업로드 (결과물 저장)
      # 빌드된 파일과 로그를 GitHub 웹 콘솔에서 다운로드 가능하게 함
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: ${{ env.BUILD_PATH }}
          retention-days: 5

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        if: always() # 에러가 나도 로그는 업로드
        with:
          name: process-logs
          path: ${{ env.LOG_PATH }}
