name: Massive File Generation & Maven Cache Fix

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

jobs:
  # [JOB 1] 파일 및 구조 대량 생성 (Generator)
  generate-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      status: success
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Maven 프로젝트 설정 파일(pom.xml) 대량 생성
      - name: Generate pom.xml (Maven Build File)
        run: |
          echo ">>> [GEN] Creating pom.xml..."
          if [ ! -f "pom.xml" ]; then
            cat <<EOF > pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.company</groupId>
            <artifactId>enterprise-app</artifactId>
            <version>1.0.0</version>
            <parent>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-parent</artifactId>
                <version>3.2.0</version>
            </parent>
            <properties>
                <java.version>17</java.version>
            </properties>
            <dependencies>
                <dependency>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-web</artifactId>
                </dependency>
                <dependency>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-data-jpa</artifactId>
                </dependency>
                <dependency>
                    <groupId>org.postgresql</groupId>
                    <artifactId>postgresql</artifactId>
                    <scope>runtime</scope>
                </dependency>
                <dependency>
                    <groupId>org.projectlombok</groupId>
                    <artifactId>lombok</artifactId>
                    <optional>true</optional>
                </dependency>
                <dependency>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-test</artifactId>
                    <scope>test</scope>
                </dependency>
            </dependencies>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-maven-plugin</artifactId>
                    </plugin>
                </plugins>
            </build>
          </project>
          EOF
          fi

      # 2. Java 디렉토리 구조 대량 생성
      - name: Create Java Directory Structure
        run: |
          echo ">>> [GEN] Creating Folders..."
          mkdir -p src/main/java/com/company/app/controller
          mkdir -p src/main/java/com/company/app/service
          mkdir -p src/main/java/com/company/app/model
          mkdir -p src/main/resources
          mkdir -p src/test/java/com/company/app

      # 3. Java 소스 코드 파일 대량 추가
      - name: Generate Java Source Files
        run: |
          # 3-1. Main Application
          echo ">>> [GEN] Creating Application.java..."
          cat <<EOF > src/main/java/com/company/app/EnterpriseApplication.java
          package com.company.app;
          import org.springframework.boot.SpringApplication;
          import org.springframework.boot.autoconfigure.SpringBootApplication;
          @SpringBootApplication
          public class EnterpriseApplication {
              public static void main(String[] args) {
                  SpringApplication.run(EnterpriseApplication.class, args);
              }
          }
          EOF

          # 3-2. Controller
          echo ">>> [GEN] Creating Controller..."
          cat <<EOF > src/main/java/com/company/app/controller/HealthController.java
          package com.company.app.controller;
          import org.springframework.web.bind.annotation.GetMapping;
          import org.springframework.web.bind.annotation.RestController;
          @RestController
          public class HealthController {
              @GetMapping("/")
              public String check() { return "System Operational"; }
          }
          EOF

          # 3-3. Service (Dummy)
          echo ">>> [GEN] Creating Service..."
          cat <<EOF > src/main/java/com/company/app/service/BusinessLogic.java
          package com.company.app.service;
          import org.springframework.stereotype.Service;
          @Service
          public class BusinessLogic {
              public void process() { System.out.println("Processing data..."); }
          }
          EOF

      # 4. 설정 파일 및 Dockerfile 생성
      - name: Generate Config & Dockerfile
        run: |
          echo ">>> [GEN] Creating application.properties..."
          cat <<EOF > src/main/resources/application.properties
          server.port=8080
          spring.datasource.url=jdbc:postgresql://localhost:5432/mydb
          spring.datasource.username=postgres
          spring.datasource.password=password
          spring.jpa.hibernate.ddl-auto=update
          EOF

          echo ">>> [GEN] Creating Dockerfile..."
          cat <<EOF > Dockerfile
          FROM eclipse-temurin:17-jdk-alpine
          VOLUME /tmp
          COPY target/*.jar app.jar
          ENTRYPOINT ["java","-jar","/app.jar"]
          EOF

      # 5. 생성된 파일들을 아티팩트로 저장 (다음 Job으로 전달)
      - name: Upload Generated Files
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: .

  # [JOB 2] 빌드 및 캐시 초기화 (Build & Fix Cache)
  build-and-cache:
    needs: generate-infrastructure
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: mydb
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # 1. 생성된 파일 다운로드
      - name: Download Project Files
        uses: actions/download-artifact@v4
        with:
          name: project-files

      # 2. Java 설정 (Maven 캐시 옵션 활성화)
      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven' # 이 옵션이 이제 pom.xml을 찾아서 작동합니다.

      # 3. [핵심] Maven 의존성 강제 다운로드 (캐시 생성용)
      # "Cache not found"를 해결하기 위해 의존성을 미리 받습니다.
      - name: Resolve Dependencies (Populate Cache)
        run: |
          echo ">>> Downloading Maven dependencies to populate cache..."
          mvn dependency:go-offline -B
          
      # 4. 빌드 수행
      - name: Build Application
        run: |
          echo ">>> Building JAR file..."
          mvn clean package -DskipTests
          
          echo ">>> Verify Output..."
          ls -lh target/*.jar

      # 5. 실행 테스트
      - name: Test Execution
        run: |
          nohup java -jar target/*.jar &
          sleep 10
          curl -I http://localhost:8080

      # 6. 최종 결과물 업로드
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
