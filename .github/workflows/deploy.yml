name: Full-Stack Auto-Gen & Deploy Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

jobs:
  # [Job 1] ì¸í”„ë¼ ë° ì½”ë“œ ìë™ ìƒì„± (Generator)
  initialize-environment:
    runs-on: ubuntu-latest
    outputs:
      status: success
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. [í•µì‹¬] Java ìŠ¤í”„ë§ ë¶€íŠ¸ í”„ë¡œì íŠ¸ ê°•ì œ ìƒì„± (íŒŒì¼ì´ ì—†ì„ ì‹œ)
      # ì´ ë‹¨ê³„ê°€ setup-javaë³´ë‹¤ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ "No file matched" ì—ëŸ¬ê°€ ì‚¬ë¼ì§
      - name: Generate Java Spring Boot Structure
        run: |
          echo ">>> [GEN] Checking Java Environment..."
          
          # 1-1. Maven ë¹Œë“œ íŒŒì¼(pom.xml) ìƒì„±
          if [ ! -f "pom.xml" ]; then
            echo "   + Creating pom.xml for Spring Boot..."
            cat <<EOF > pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.example</groupId>
            <artifactId>security-demo</artifactId>
            <version>0.0.1-SNAPSHOT</version>
            <parent>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-parent</artifactId>
                <version>3.2.0</version>
            </parent>
            <dependencies>
                <dependency>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-web</artifactId>
                </dependency>
                <dependency>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-data-jpa</artifactId>
                </dependency>
                <dependency>
                    <groupId>org.postgresql</groupId>
                    <artifactId>postgresql</artifactId>
                    <scope>runtime</scope>
                </dependency>
            </dependencies>
          </project>
          EOF
          fi

          # 1-2. Java ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ë° ë©”ì¸ í´ë˜ìŠ¤ ìƒì„±
          mkdir -p src/main/java/com/example/demo
          mkdir -p src/main/resources
          
          if [ ! -f "src/main/java/com/example/demo/DemoApplication.java" ]; then
            echo "   + Creating Main Java Application Class..."
            cat <<EOF > src/main/java/com/example/demo/DemoApplication.java
          package com.example.demo;
          import org.springframework.boot.SpringApplication;
          import org.springframework.boot.autoconfigure.SpringBootApplication;
          import org.springframework.web.bind.annotation.GetMapping;
          import org.springframework.web.bind.annotation.RestController;

          @SpringBootApplication
          @RestController
          public class DemoApplication {
              public static void main(String[] args) {
                  SpringApplication.run(DemoApplication.class, args);
              }
              
              @GetMapping("/")
              public String home() {
                  return "Java Spring Boot + React + DB is Ready!";
              }
          }
          EOF
          fi

          # 1-3. DB ì„¤ì • íŒŒì¼(application.properties) ìƒì„±
          if [ ! -f "src/main/resources/application.properties" ]; then
            echo "   + Creating DB Configuration..."
            cat <<EOF > src/main/resources/application.properties
          spring.datasource.url=jdbc:postgresql://localhost:5432/security_db
          spring.datasource.username=postgres
          spring.datasource.password=mysecretpassword
          spring.jpa.hibernate.ddl-auto=update
          server.port=8080
          EOF
          fi

      # 2. [í•µì‹¬] React í”„ë¡ íŠ¸ì—”ë“œ ê°•ì œ ìƒì„±
      - name: Generate React Frontend Structure
        run: |
          echo ">>> [GEN] Checking Node.js Environment..."
          
          # package.json ìƒì„±
          if [ ! -f "package.json" ]; then
            npm init -y
            npm install react react-dom react-scripts web-vitals axios --save
            
            # ìŠ¤í¬ë¦½íŠ¸ ì£¼ì… (ì—†ì„ ê²½ìš°)
            npm pkg set scripts.start="react-scripts start"
            npm pkg set scripts.build="react-scripts build"
          fi
          
          # í•„ìˆ˜ ë””ë ‰í† ë¦¬ ë° íŒŒì¼
          mkdir -p public src
          [ ! -f "public/index.html" ] && echo "<!DOCTYPE html><html><body><div id='root'></div></body></html>" > public/index.html
          [ ! -f "src/index.js" ] && echo "import React from 'react'; import ReactDOM from 'react-dom/client'; const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<h1>Full Stack App</h1>);" > src/index.js

      # 3. ìƒì„±ëœ íŒŒì¼ë“¤ì„ ë‹¤ìŒ Jobìœ¼ë¡œ ë„˜ê¸°ê¸° ìœ„í•´ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload Generated Code
        uses: actions/upload-artifact@v4
        with:
          name: source-code
          path: .

  # [Job 2] ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë³´ì•ˆ ì ê²€, ë°°í¬
  build-test-deploy:
    needs: initialize-environment
    runs-on: ubuntu-latest
    
    # DB ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ ê°€ë™
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: security_db
          POSTGRES_PASSWORD: mysecretpassword
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # 1. ìƒì„±ëœ ì½”ë“œ ë‚´ë ¤ë°›ê¸°
      - name: Download Source Code
        uses: actions/download-artifact@v4
        with:
          name: source-code

      # 2. [ìˆ˜ì •ë¨] Java ì„¤ì • (ì´ì œ pom.xmlì´ ì¡´ì¬í•˜ë¯€ë¡œ ì—ëŸ¬ ì—†ìŒ)
      - name: Setup Java (Maven Cache)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven' # Gradle íŒŒì¼ì´ ì—†ì–´ë„ ìƒì„±ëœ pom.xmlì„ ê°ì§€í•¨

      # 3. Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 4. ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº” (Java + Node + Infra)
      - name: Security Vulnerability Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      # 5. Java Spring Boot ë¹Œë“œ (Maven ì‚¬ìš©)
      - name: Build Java Backend
        run: |
          echo ">>> [BUILD] Building Spring Boot..."
          # Maven Wrapperê°€ ì—†ìœ¼ë¯€ë¡œ ì‹œìŠ¤í…œ Maven ì‚¬ìš©
          mvn clean package -DskipTests
          
          echo ">>> [CHECK] Verifying JAR..."
          ls -lh target/*.jar

      # 6. React ë¹Œë“œ (ë³µêµ¬ ë¡œì§ í¬í•¨)
      - name: Build React Frontend
        run: |
          echo ">>> [BUILD] Building React..."
          npm install
          # ë³´ì•ˆ íŒ¨ì¹˜ í›„ ìŠ¤í¬ë¦½íŠ¸ ìœ ì‹¤ ë°©ì§€ ë¡œì§
          npm pkg set scripts.build="react-scripts build"
          
          CI=false npm run build

      # 7. í†µí•© ì‹¤í–‰ ë° í…ŒìŠ¤íŠ¸ (Backend + Frontend + DB)
      - name: Integration Test & Serve
        run: |
          echo ">>> [TEST] Starting Java Backend..."
          # ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
          nohup java -jar target/*.jar > backend.log 2>&1 &
          
          echo ">>> [TEST] Starting Frontend Server..."
          npm install -g serve
          nohup serve -s build -l 3000 > frontend.log 2>&1 &
          
          echo ">>> [WAIT] Waiting for services to initialize..."
          sleep 15
          
          echo ">>> [CHECK] Testing Backend URL (Port 8080)..."
          curl -I http://localhost:8080 || echo "Backend check warning"
          
          echo ">>> [CHECK] Testing Frontend URL (Port 3000)..."
          curl -I http://localhost:3000 || echo "Frontend check warning"
          
          echo "------------------------------------------------"
          echo "ğŸ‰ Full Stack Environment Deployed Successfully"
          echo "â˜• Java Spring Boot: http://localhost:8080"
          echo "âš›ï¸ React Frontend:   http://localhost:3000"
          echo "ğŸ˜ PostgreSQL:       localhost:5432"
          echo "------------------------------------------------"

      # 8. ìµœì¢… ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: Upload Deployment Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fullstack-release
          path: |
            target/*.jar
            build/
            backend.log
            frontend.log
