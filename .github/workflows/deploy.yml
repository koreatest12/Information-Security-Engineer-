name: Enterprise Full-Stack Security & Build Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

jobs:
  # [Job 1] ë³´ì•ˆ ì·¨ì•½ì  ì •ë°€ ì§„ë‹¨ (Java, DB, Node, OS)
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      # 1. [ì¶”ê°€] Java ë° DB ê´€ë ¨ ì·¨ì•½ì  ìŠ¤ìº” (Trivy)
      # íŒŒì¼ ì‹œìŠ¤í…œ ì „ì²´ë¥¼ ìŠ¤ìº”í•˜ì—¬ Java .jar, npm lock, SQL ì„¤ì • íŒŒì¼ ë“±ì˜ ì·¨ì•½ì ì„ ì°¾ìŠµë‹ˆë‹¤.
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          exit-code: '0' # ì·¨ì•½ì ì´ ë°œê²¬ë˜ì–´ë„ ë¹Œë“œë¥¼ ë©ˆì¶”ì§€ ì•Šê³  ë¦¬í¬íŠ¸ë§Œ ìƒì„± (ìš´ì˜ìš©)
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  # [Job 2] í†µí•© ë¹Œë“œ ë° ì„œë¹„ìŠ¤ ë°°í¬
  build-and-deploy:
    needs: security-audit
    runs-on: ubuntu-latest
    
    # 2. [ì¶”ê°€] í•„ìˆ˜ DB ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ (PostgreSQL)
    # ì‹¤ì œ DBê°€ ë„ëŠ” í™˜ê²½ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: mysecretpassword
          POSTGRES_DB: security_db
        ports:
          - 5432:5432
        # DBê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” í—¬ìŠ¤ ì²´í¬ ì˜µì…˜
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      # 3. [ì¶”ê°€] Java í™˜ê²½ ì„¤ì • (Java 17 LTS)
      - name: Setup Java Development Kit (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle' # ë˜ëŠ” 'maven'

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4. [í•µì‹¬ ìˆ˜ì •] ìŠ¤ë§ˆíŠ¸ ì„¤ì¹˜ & ìŠ¤í¬ë¦½íŠ¸ ë³µêµ¬ (Smart Restore)
      - name: Initialize & Restore Build Scripts
        run: |
          echo ">>> [INIT] Checking Project Status..."
          
          # package.jsonì´ ì—†ìœ¼ë©´ ìƒì„±
          if [ ! -f "package.json" ]; then
            npm init -y
          fi

          # [ì¤‘ìš”] ì´ì „ ë¡œê·¸ì˜ ì›ì¸: audit fix --forceê°€ react-scriptsë¥¼ ì§€ì›€
          # í•´ê²°: react-scriptsê°€ ì—†ìœ¼ë©´ ê°•ì œë¡œ ë‹¤ì‹œ ì„¤ì¹˜
          echo ">>> [CHECK] Verifying critical dependencies..."
          if [ ! -d "node_modules/react-scripts" ]; then
             echo "   ! react-scripts missing. Re-installing..."
             npm install react-scripts --save-dev
          fi

          # [ì¤‘ìš”] 'scripts' í•­ëª©ì— buildê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ì£¼ì…
          echo ">>> [CHECK] Verifying package.json scripts..."
          if ! grep -q '"build":' package.json; then
             echo "   ! Build script missing. Injecting..."
             npm pkg set scripts.start="react-scripts start"
             npm pkg set scripts.build="react-scripts build"
             npm pkg set scripts.test="react-scripts test"
             npm pkg set scripts.eject="react-scripts eject"
          fi

          # í•„ìˆ˜ React íŒŒì¼ ìƒì„±
          mkdir -p src public
          [ ! -f "src/index.js" ] && echo "import React from 'react'; import ReactDOM from 'react-dom/client'; const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<h1>Security App</h1>);" > src/index.js
          [ ! -f "public/index.html" ] && echo "<!DOCTYPE html><html><body><div id='root'></div></body></html>" > public/index.html

      # 5. ìºì‹œ ì„¤ì • (ì•ˆì •ëœ í‚¤ ì‚¬ìš©)
      - name: Cache Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-integrated-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
             ${{ runner.os }}-node-integrated-

      # 6. ì˜ì¡´ì„± ì„¤ì¹˜ (ì•ˆì „ ëª¨ë“œ)
      - name: Install Dependencies (Safe Mode)
        run: |
          # force ì˜µì…˜ ì ˆëŒ€ ê¸ˆì§€. ì¼ë°˜ install ì‚¬ìš©.
          npm install
          
          # TypeScript ë²„ì „ ì¶©ëŒ ë°©ì§€
          npm install typescript --save-dev

      # 7. [ì¶”ê°€] DB ì—°ê²° í…ŒìŠ¤íŠ¸ (Connectivity Check)
      - name: Check Database Connection
        run: |
          echo ">>> [DB] Checking connection to PostgreSQL..."
          # pg-isready íˆ´ ì„¤ì¹˜ (Ubuntu ê¸°ë³¸ íŒ¨í‚¤ì§€)
          sudo apt-get install -y postgresql-client
          
          if PGPASSWORD=mysecretpassword psql -h localhost -U postgres -d security_db -c '\q'; then
             echo "âœ… Database Connection Successful!"
          else
             echo "âŒ Database Connection Failed!"
             exit 1
          fi

      # 8. ë¹Œë“œ ìˆ˜í–‰
      - name: Build Application
        env:
          CI: false # ê²½ê³  ë¬´ì‹œ
          NODE_OPTIONS: "--openssl-legacy-provider"
        run: |
          echo ">>> [BUILD] Executing Build..."
          npm run build
          
          echo ">>> [INFO] Build Size:"
          du -sh build/

      # 9. ì„œë²„ êµ¬ë™ ë° URL ì¶œë ¥
      - name: Deploy & Service URL
        run: |
          npm install -g serve
          
          echo ">>> [SERVER] Starting Background Service..."
          nohup serve -s build -l 3000 > server.log 2>&1 &
          sleep 5
          
          echo "---------------------------------------------"
          echo "ğŸš€ Deployment Successful!"
          echo "ğŸ“¡ Service URL: http://localhost:3000"
          echo "ğŸ“Š DB Service: localhost:5432 (PostgreSQL)"
          echo "---------------------------------------------"
          
          # ìµœì¢… ì—°ê²° í™•ì¸
          curl -I http://localhost:3000

      # 10. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (Trivy ë¦¬í¬íŠ¸ í¬í•¨)
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-bundle
          path: |
            build/
            server.log
            package.json
