name: ğŸ¤– Security Material Auto-Collector

on:
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ (ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜)
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

env:
  TZ: 'Asia/Seoul' # í•œêµ­ ì‹œê°„ ì„¤ì •

permissions:
  contents: write

jobs:
  collect-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 5 # 5ë¶„ ì´ìƒ ê±¸ë¦¬ë©´ ê°•ì œ ì¢…ë£Œ (ë¹„ìš© ì ˆê°)
    
    steps:
      # 1. ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (ì „ì²´ íˆìŠ¤í† ë¦¬ í¬í•¨)
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # 2. [FIX] ì˜ì¡´ì„± íŒŒì¼ ìë™ ìƒì„± (ì—ëŸ¬ í•´ê²° í•µì‹¬)
      # requirements.txt íŒŒì¼ì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ìƒì„±í•˜ì—¬ setup-python ì—ëŸ¬ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
      - name: Ensure requirements.txt exists
        run: |
          if [ ! -f requirements.txt ]; then
            echo "requests" > requirements.txt
            echo "âœ… Created requirements.txt automatically."
          else
            echo "âœ… requirements.txt already exists."
          fi

      # 3. íŒŒì´ì¬ ì„¤ì • (ì´ì œ requirements.txtê°€ ìˆìœ¼ë¯€ë¡œ ìºì‹± ì„±ê³µ)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # ìºì‹± ê¸°ëŠ¥ í™œì„±í™”

      # 4. ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      # 5. ìŠ¤í¬ë¦½íŠ¸ í´ë” ë° íŒŒì¼ ì•ˆì „ í™•ì¸ (ì—†ìœ¼ë©´ ìë™ ìƒì„±)
      - name: Ensure Script Exists
        run: |
          if [ ! -d "scripts" ]; then
            mkdir scripts
            echo "ğŸ“‚ Created scripts directory."
          fi
          # ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì´ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì²´í¬ (ì‹¤ì œ ë¡œì§ì€ repoì— ìˆì–´ì•¼ í•¨)
          if [ ! -f "scripts/fetch_security_news.py" ]; then
            echo "âš ï¸ Warning: fetch_security_news.py not found! Skipping execution."
            exit 0
          fi

      # 6. ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Run Collection Script
        run: |
          python scripts/fetch_security_news.py

      # 7. ìŠ¤ë§ˆíŠ¸ ì»¤ë°‹ (ë´‡ ê¸°ë¡ ë®ì–´ì“°ê¸° & ì‚¬ìš©ì ê¸°ë¡ ë³´ì¡´)
      - name: Smart Commit & Clean History
        run: |
          git config --global user.name "SecurityBot"
          git config --global user.email "bot@noreply.github.com"
          
          # ì›ê²© ì €ì¥ì†Œ ìµœì‹  ìƒíƒœ ë°˜ì˜ (Rebase)
          git pull --rebase origin main || echo "Already up to date"

          # ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
          git add .
          
          # ë³€ê²½ì‚¬í•­ ì²´í¬
          if git diff --staged --quiet; then
            echo "âœ… No changes detected. Skipping commit."
            exit 0
          fi

          # ë§ˆì§€ë§‰ ì»¤ë°‹ ì‘ì„±ì í™•ì¸
          LAST_AUTHOR=$(git log -1 --pretty=format:'%an')
          CURRENT_TIME=$(date "+%Y-%m-%d %H:%M:%S")
          
          echo "ğŸ” Last Commit Author: $LAST_AUTHOR"

          if [ "$LAST_AUTHOR" == "SecurityBot" ]; then
            echo "â™»ï¸ Detected previous Bot commit. Overwriting (Amending) to save space..."
            # ë´‡ì´ ì‘ì„±í•œ ì´ì „ ì»¤ë°‹ì„ ìˆ˜ì •(--amend)í•˜ì—¬ ë®ì–´ì“°ê¸°
            git commit --amend -m "docs: [LIVE] security dashboard updated ($CURRENT_TIME)"
            
            # ê°•ì œ í‘¸ì‹œ (ì´ì „ ê¸°ë¡ ì‚­ì œ)
            git push --force origin main
          else
            echo "ğŸ†• Detected Human commit. Creating a new commit..."
            # ì‚¬ëŒì´ ì‘ì„±í•œ ì»¤ë°‹ ìœ„ì— ìƒˆë¡œ ìŒ“ê¸°
            git commit -m "docs: update security dashboard ($CURRENT_TIME)"
            git push origin main
          fi
