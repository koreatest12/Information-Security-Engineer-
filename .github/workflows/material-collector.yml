name: ğŸš€ Official Release & Deploy

on:
  # 1. íƒœê·¸ê°€ í‘¸ì‹œë˜ë©´ ìë™ ë¦´ë¦¬ì¦ˆ (ì˜ˆ: v1.0.0, v2.1.3)
  push:
    tags:
      - "v*.*.*"
  
  # 2. ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ë°°í¬ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      title:
        description: 'Release Title'
        required: false
        default: 'Regular Security Update'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    name: ğŸ“¦ Build & Publish Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. í™˜ê²½ êµ¬ì„± (DB ë° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í™˜ê²½)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests
          fi

      # 2. ìµœì‹  ë°ì´í„°(DB) í™•ë³´ (ë°°í¬ ì§ì „ í•œ ë²ˆ ë” ì—…ë°ì´íŠ¸)
      - name: Refresh Security Data
        run: |
          # ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆë‹¤ë©´ ì‹¤í–‰í•˜ì—¬ ìµœì‹  ìƒíƒœë¡œ DB ê°±ì‹ 
          if [ -f scripts/security_db_master.py ]; then
            echo "ğŸ”„ Refreshing DB for release..."
            python scripts/security_db_master.py
          else
            echo "âš ï¸ Script not found. Proceeding with existing data."
          fi

      # 3. ë°°í¬ìš© ì•„í‹°íŒ©íŠ¸ ì••ì¶• (Source Code ì œì™¸, ì•Œì§œë°°ê¸°ë§Œ)
      - name: Package Assets
        run: |
          echo "ğŸ“¦ Zipping artifacts..."
          mkdir -p release_assets
          
          # DB íŒŒì¼ ë³µì‚¬
          if [ -f data/security_archive.db ]; then
            cp data/security_archive.db release_assets/
          fi
          
          # í•™ìŠµ ìë£Œ(MD) ë° ìŠ¤í¬ë¦½íŠ¸ ì••ì¶•
          zip -r release_assets/Security_Study_Materials.zip scripts/ SECURITY.md README.md
          
          # ë¬´ê²°ì„± ê²€ì¦ì„ ìœ„í•œ í•´ì‹œ íŒŒì¼ ìƒì„± (ì „ë¬¸ê°€ê¸‰ ê¸°ëŠ¥)
          cd release_assets
          sha256sum * > checksums.txt
          cd ..

      # 4. ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìë™ ìƒì„± ë° ë°°í¬
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          # ìˆ˜ë™ ì‹¤í–‰ì´ë©´ ì…ë ¥ëœ ë²„ì „ì„, íƒœê·¸ ì‹¤í–‰ì´ë©´ íƒœê·¸ëª…ì„ ì‚¬ìš©
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: ${{ github.event.inputs.title || github.ref_name }}
          
          # ì´ì „ ë¦´ë¦¬ì¦ˆì™€ì˜ ì°¨ì´ì (Commit Log)ì„ ìë™ìœ¼ë¡œ ìš”ì•½í•´ì¤Œ
          generate_release_notes: true
          
          # ì²¨ë¶€í•  íŒŒì¼ë“¤ (DB, ì••ì¶•íŒŒì¼, ì²´í¬ì„¬)
          files: |
            release_assets/security_archive.db
            release_assets/Security_Study_Materials.zip
            release_assets/checksums.txt
            
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. (ì„ íƒì‚¬í•­) ë°°í¬ ì™„ë£Œ ìŠ¬ë™/ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ì‹œë®¬ë ˆì´ì…˜
      - name: Deploy Notification
        run: |
          echo "âœ… Release ${{ github.event.inputs.version || github.ref_name }} has been deployed successfully!"
          echo "ğŸ”— Download URL: https://github.com/${{ github.repository }}/releases"
