name: ğŸ¤– Security Material Auto-Collector

on:
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

env:
  TZ: 'Asia/Seoul' # í•œêµ­ ì‹œê°„ ì„¤ì •

permissions:
  contents: write

jobs:
  collect-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 5 # 5ë¶„ ë„˜ì–´ê°€ë©´ ê°•ì œ ì¢…ë£Œ
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # íˆìŠ¤í† ë¦¬ ì¡°ì‘ì„ ìœ„í•´ ì „ì²´ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸° (í•„ìˆ˜)

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install requests

      - name: Run Collection Script
        run: |
          python scripts/fetch_security_news.py

      - name: Smart Commit & Clean History
        run: |
          git config --global user.name "SecurityBot"
          git config --global user.email "bot@noreply.github.com"
          
          # 1. ìµœì‹  ìƒíƒœ ê°€ì ¸ì˜¤ê¸° (ì¶©ëŒ ë°©ì§€)
          git pull --rebase origin main || echo "Already up to date"

          # 2. ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
          git add .
          
          # 3. ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
          if git diff --staged --quiet; then
            echo "âœ… No changes detected. Skipping commit."
            exit 0
          fi

          # 4. ë§ˆì§€ë§‰ ì»¤ë°‹ ì‘ì„±ì í™•ì¸
          LAST_AUTHOR=$(git log -1 --pretty=format:'%an')
          CURRENT_TIME=$(date "+%Y-%m-%d %H:%M:%S")
          
          echo "ğŸ” Last Commit Author: $LAST_AUTHOR"

          if [ "$LAST_AUTHOR" == "SecurityBot" ]; then
            echo "â™»ï¸ Detected previous Bot commit. Overwriting (Amending) to save space..."
            # ì´ì „ ì»¤ë°‹ì„ ë®ì–´ì“°ê¸° (--amend) í•˜ì—¬ íˆìŠ¤í† ë¦¬ê°€ ìŒ“ì´ì§€ ì•Šê²Œ í•¨
            git commit --amend -m "docs: [LIVE] security dashboard updated ($CURRENT_TIME)"
            
            # ê°•ì œ í‘¸ì‹œ (ì´ì „ ê¸°ë¡ ì‚­ì œ ë° ê°±ì‹ )
            git push --force origin main
          else
            echo "ğŸ†• Detected Human commit. Creating a new commit..."
            # ì‚¬ëŒì´ ì“´ ê¸€ì€ ë³´ì¡´í•˜ê³  ê·¸ ìœ„ì— ìƒˆ ì»¤ë°‹ ì‘ì„±
            git commit -m "docs: update security dashboard ($CURRENT_TIME)"
            git push origin main
          fi
