name: "ğŸ›ï¸ Grand Universal System Sentinel"

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:
    inputs:
      strict_mode:
        description: 'ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš°ë¥¼ Error ì²˜ë¦¬í• ê¹Œìš”?'
        required: true
        default: 'true'
        type: boolean

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  enterprise-monitor:
    name: "ğŸ©º Full Stack Inspection"
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1. ê¸°ë³¸ í™˜ê²½ ì„¤ì •
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 2. í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install requests pytz urllib3 safety bandit flake8 jinja2

      # =========================================================
      # ğŸ—ï¸ [ëŒ€ëŸ‰ ìƒì„± 1] ì—”í„°í”„ë¼ì´ì¦ˆ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ë¦½
      # =========================================================
      - name: ğŸ“‚ Initialize Infrastructure
        run: |
          echo ">>> Building Directory Architecture..."
          mkdir -p config
          mkdir -p scripts/server
          mkdir -p templates
          mkdir -p logs
          mkdir -p docs
          mkdir -p reports/raw
          mkdir -p reports/security
          mkdir -p reports/html
          
          echo "âœ… Architecture ready."
          tree . || ls -R

      # =========================================================
      # ğŸ‘» [ëŒ€ëŸ‰ ìƒì„± 2] ê°€ìƒ ë°±ì—”ë“œ(Mock Server) ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      # =========================================================
      - name: ğŸ‘» Create Mock Backend Service
        run: |
          # ìë°” ìŠ¤í”„ë§ ë¶€íŠ¸ ì„œë²„ í‰ë‚´ë¥¼ ë‚´ëŠ” íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸
          cat << 'EOF' > scripts/server/mock_backend.py
          from http.server import BaseHTTPRequestHandler, HTTPServer
          import json
          import time

          class MockHandler(BaseHTTPRequestHandler):
              def do_GET(self):
                  if self.path == "/actuator/health":
                      self.send_response(200)
                      self.send_header('Content-type', 'application/json')
                      self.end_headers()
                      self.wfile.write(json.dumps({"status": "UP", "details": "Java Backend Mock"}).encode())
                  else:
                      self.send_response(404)
                      self.end_headers()

          def run(server_class=HTTPServer, handler_class=MockHandler, port=8080):
              server_address = ('', port)
              httpd = server_class(server_address, handler_class)
              print(f"ğŸ‘» Mock Backend running on port {port}...")
              httpd.serve_forever()

          if __name__ == "__main__":
              run()
          EOF

      # =========================================================
      # ğŸš€ [ì‹¤í–‰] ê°€ìƒ ë°±ì—”ë“œ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ (ì˜¤ë¥˜ í•´ê²° í•µì‹¬)
      # =========================================================
      - name: ğŸ”Œ Start Background Services
        run: |
          # 8080 í¬íŠ¸ì— ê°€ìƒ ì„œë²„ë¥¼ ë°±ê·¸ë¼ìš´ë“œ(&)ë¡œ ì‹¤í–‰
          nohup python scripts/server/mock_backend.py > logs/backend.log 2>&1 &
          echo ">>> Waiting for services to initialize..."
          sleep 3 # ì„œë²„ êµ¬ë™ ëŒ€ê¸°

      # =========================================================
      # âš™ï¸ [ëŒ€ëŸ‰ ìƒì„± 3] ì„¤ì • ë° í…œí”Œë¦¿ íŒŒì¼ ìƒì„±
      # =========================================================
      - name: âš™ï¸ Generate Configs & Templates
        run: |
          # 1. íƒ€ê²Ÿ ì„¤ì • (ì´ì œ localhost:8080 ì ‘ì† ê°€ëŠ¥)
          cat << EOF > config/targets.json
          [
            {
              "name": "Local Java Backend",
              "url": "http://localhost:8080/actuator/health",
              "tier": "critical"
            },
            {
              "name": "Public API (Google)",
              "url": "https://www.google.com",
              "tier": "low"
            },
            {
              "name": "External Auth",
              "url": "https://httpbin.org/status/200",
              "tier": "critical"
            }
          ]
          EOF

          # 2. HTML ë¦¬í¬íŠ¸ í…œí”Œë¦¿ ë¶„ë¦¬ (Jinja2 ìŠ¤íƒ€ì¼)
          cat << 'EOF' > templates/dashboard.html
          <!DOCTYPE html>
          <html>
          <head>
              <title>System Sentinel Report</title>
              <style>
                  body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f4f6f9; }
                  .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  h1 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
                  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                  th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                  th { background-color: #f8f9fa; color: #555; }
                  .status-up { color: green; font-weight: bold; }
                  .status-down { color: red; font-weight: bold; }
                  .footer { margin-top: 30px; font-size: 0.8em; color: #777; text-align: center; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ©º System Health Dashboard</h1>
                  <p><b>Inspection Time:</b> {{ timestamp }}</p>
                  <p><b>Total Targets:</b> {{ total_count }} | <b>Failures:</b> {{ fail_count }}</p>
                  
                  <table>
                      <thead>
                          <tr>
                              <th>Service Name</th>
                              <th>URL</th>
                              <th>Status</th>
                              <th>Latency</th>
                              <th>SSL Info</th>
                          </tr>
                      </thead>
                      <tbody>
                          {% for row in rows %}
                          <tr>
                              <td>{{ row.name }}</td>
                              <td><small>{{ row.url }}</small></td>
                              <td class="{{ 'status-up' if row.status == 'UP' else 'status-down' }}">{{ row.status }}</td>
                              <td>{{ row.latency_ms }} ms</td>
                              <td>{{ row.ssl_days }}</td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
                  <div class="footer">Generated by GitHub Actions Universal Sentinel</div>
              </div>
          </body>
          </html>
          EOF
          
          # 3. ë¬¸ì„œí™” íŒŒì¼ ìƒì„±
          cat << EOF > docs/README.md
          # System Health Artifacts
          ì´ ì•„ì¹´ì´ë¸ŒëŠ” ìë™í™”ëœ í—¬ìŠ¤ ì²´í¬ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
          
          - **reports/html/**: ì›¹ ë¸Œë¼ìš°ì €ìš© ëŒ€ì‹œë³´ë“œ
          - **reports/raw/**: ë°ì´í„° ë¶„ì„ìš© JSON
          - **logs/**: ì‹¤í–‰ ë¡œê·¸ ë° ë°±ì—”ë“œ ë¡œê·¸
          EOF

      # =========================================================
      # ğŸ“ [ëŒ€ëŸ‰ ìƒì„± 4] ë©”ì¸ ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸ (Jinja2 ì ìš©)
      # =========================================================
      - name: ğŸ“ Generate Robust Monitor Script
        run: |
          cat << 'EOF' > scripts/monitor.py
          import json
          import requests
          import time
          import sys
          import os
          import ssl
          import socket
          import logging
          from datetime import datetime
          from jinja2 import Environment, FileSystemLoader
          from requests.adapters import HTTPAdapter
          from urllib3.util.retry import Retry

          # --- ë¡œê¹… ì„¤ì • ---
          logging.basicConfig(
              level=logging.INFO,
              format='%(asctime)s | %(levelname)s | %(message)s',
              handlers=[
                  logging.FileHandler('logs/app.log', encoding='utf-8'),
                  logging.StreamHandler()
              ]
          )
          logger = logging.getLogger()

          # --- ì„¤ì • ë¡œë“œ ---
          with open('config/targets.json', 'r') as f:
              TARGETS = json.load(f)

          def check_ssl(url):
              try:
                  if not url.startswith("https"): return True, "N/A"
                  hostname = url.split("//")[-1].split("/")[0].split(":")[0]
                  context = ssl.create_default_context()
                  with socket.create_connection((hostname, 443), timeout=3) as sock:
                      with context.wrap_socket(sock, server_hostname=hostname) as ssock:
                          cert = ssock.getpeercert()
                          not_after = datetime.strptime(cert['notAfter'], '%b %d %H:%M:%S %Y %Z')
                          remaining = (not_after - datetime.utcnow()).days
                          return True, f"{remaining} days"
              except Exception as e:
                  return False, str(e)[:10]

          def get_session():
              s = requests.Session()
              retries = Retry(total=3, backoff_factor=0.3, status_forcelist=[500, 502, 503, 504])
              s.mount('http://', HTTPAdapter(max_retries=retries))
              s.mount('https://', HTTPAdapter(max_retries=retries))
              return s

          # --- ë©”ì¸ ë¡œì§ ---
          results = []
          session = get_session()
          fail_count = 0

          logger.info(">>> Starting Health Check...")

          for t in TARGETS:
              start = time.time()
              item = {
                  "name": t['name'],
                  "url": t['url'],
                  "status": "DOWN",
                  "latency_ms": 0,
                  "ssl_days": "N/A"
              }
              
              try:
                  resp = session.get(t['url'], timeout=5)
                  item['latency_ms'] = round((time.time() - start) * 1000, 2)

                  if resp.status_code == 200:
                      item['status'] = "UP"
                  else:
                      item['status'] = f"ERR_{resp.status_code}"
                      fail_count += 1
                  
                  ssl_ok, ssl_msg = check_ssl(t['url'])
                  item['ssl_days'] = ssl_msg
                  if not ssl_ok: item['status'] = "SSL_FAIL"

              except Exception as e:
                  item['status'] = "CONN_FAIL"
                  item['ssl_days'] = str(e)[:15]
                  fail_count += 1
                  logger.error(f"Failed {t['name']}: {e}")

              logger.info(f"Checked {item['name']}: {item['status']}")
              results.append(item)

          # --- ë¦¬í¬íŠ¸ ìƒì„± (JSON & CSV) ---
          with open('reports/raw/data.json', 'w') as f:
              json.dump(results, f, indent=4)
          
          with open('reports/raw/summary.csv', 'w') as f:
              f.write("Name,Status,Latency\n")
              for r in results:
                  f.write(f"{r['name']},{r['status']},{r['latency_ms']}\n")

          # --- ë¦¬í¬íŠ¸ ìƒì„± (HTML via Jinja2) ---
          env = Environment(loader=FileSystemLoader('templates'))
          template = env.get_template('dashboard.html')
          html_out = template.render(
              rows=results,
              timestamp=datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
              total_count=len(results),
              fail_count=fail_count
          )
          
          with open('reports/html/dashboard.html', 'w', encoding='utf-8') as f:
              f.write(html_out)

          logger.info(">>> All reports generated.")
          
          # í™˜ê²½ë³€ìˆ˜ë¥¼ í†µí•´ GitHub Summaryì— ì“¸ ë°ì´í„° ì¶œë ¥
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as fh:
              fh.write("### ğŸ©º Health Check Summary\n")
              fh.write("| Service | Status | Latency |\n|---|---|---|\n")
              for r in results:
                  icon = "âœ…" if r['status'] == "UP" else "âŒ"
                  fh.write(f"| {icon} {r['name']} | **{r['status']}** | {r['latency_ms']}ms |\n")

          # Strict Mode ì²´í¬ (ì‹¤íŒ¨ê°€ ìˆìœ¼ë©´ exit 1)
          strict_mode = os.getenv("STRICT_MODE", "true").lower() == "true"
          if fail_count > 0 and strict_mode:
              logger.error("!!! Critical failures detected !!!")
              sys.exit(1)
          else:
              logger.info(">>> System Stable (or Strict Mode OFF)")
          EOF

      # =========================================================
      # ğŸ•µï¸ [ì‹¤í–‰] ëª¨ë‹ˆí„°ë§ ìˆ˜í–‰
      # =========================================================
      - name: ğŸš€ Execute Monitor Script
        env:
          STRICT_MODE: ${{ inputs.strict_mode }}
        run: python scripts/monitor.py

      # =========================================================
      # ğŸ“¤ [ë§ˆë¬´ë¦¬] ê²°ê³¼ë¬¼ ì—…ë¡œë“œ ë° ì´ìŠˆ ì²˜ë¦¬
      # =========================================================
      - name: ğŸ“¦ Archive All Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: enterprise-report-pack
          path: |
            logs/
            reports/
            config/
            docs/
            scripts/
          retention-days: 7

      - name: ğŸ« Incident Ticket
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let logBody = '';
            try { logBody = fs.readFileSync('reports/raw/summary.csv', 'utf8'); } catch(e) {}
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Production Incident: Health Check Failed',
              body: `### Critical System Failure\n\n**CSV Snapshot:**\n\`\`\`csv\n${logBody}\n\`\`\`\nPlease check the dashboard artifact.`,
              labels: ['incident', 'high-priority']
            });
