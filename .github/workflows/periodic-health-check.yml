name: "â° 20-Min Health Check & Reporting"

on:
  schedule:
    - cron: '*/20 * * * *' # ë§¤ 20ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:       # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: read
  issues: write            # ì‹¤íŒ¨ ì‹œ ì´ìŠˆ ìƒì„±ì„ ìœ„í•œ ê¶Œí•œ í•„ìˆ˜

jobs:
  health-monitor:
    name: "ğŸ©º Monitor Services"
    runs-on: ubuntu-latest
    timeout-minutes: 10    # íƒ€ì„ì•„ì›ƒ ì„¤ì •
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install requests pytz

      - name: ğŸ“ Generate Robust Health Check Script
        run: |
          # Python ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ë“¤ì—¬ì“°ê¸° ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ëª…í™•í•œ EOF ì‚¬ìš©)
          cat << 'EOF' > check_status.py
          import requests
          import sys
          import time
          from datetime import datetime
          import pytz

          # [ì„¤ì •] íƒ€ê²Ÿ ì„œë¹„ìŠ¤ ëª©ë¡
          TARGETS = [
              {
                  "name": "Java Backend", 
                  "url": "http://localhost:8080/actuator/health", 
                  "mock": True 
              },
              {
                  "name": "Python API", 
                  "url": "http://localhost:8000/health", 
                  "mock": True 
              }
          ]

          KST = pytz.timezone('Asia/Seoul')
          now = datetime.now(KST).strftime('%Y-%m-%d %H:%M:%S')

          log_lines = []
          def log(msg):
              print(msg)
              log_lines.append(msg)

          log(f"=== ğŸ©º Health Check Report [{now}] ===")
          log(f"{'SERVICE':<20} | {'STATUS':<10} | {'LATENCY':<10} | {'MESSAGE'}")
          log("-" * 65)

          all_success = True

          for target in TARGETS:
              start_time = time.time()
              status_code = 0
              msg = "Unknown"
              latency = "0ms"
              is_up = False

              try:
                  if target["mock"]:
                      time.sleep(0.1) 
                      status_code = 200
                      msg = "Alive (Mock)"
                      is_up = True
                  else:
                      response = requests.get(target["url"], timeout=3)
                      status_code = response.status_code
                      if status_code == 200:
                          msg = "Alive"
                          is_up = True
                      else:
                          msg = f"Error {status_code}"
                          is_up = False
                  
              except Exception as e:
                  msg = f"Connection Fail: {str(e)[:20]}..."
                  is_up = False
              
              latency = f"{(time.time() - start_time) * 1000:.2f}ms"
              status_str = "âœ… UP" if is_up else "âŒ DOWN"
              
              log(f"{target['name']:<20} | {status_str:<10} | {latency:<10} | {msg}")

              if not is_up:
                  all_success = False

          with open("health_report.log", "w", encoding="utf-8") as f:
              f.write("\n".join(log_lines))

          if not all_success:
              log("\n!!! CRITICAL: Some services are DOWN !!!")
              sys.exit(1)
          
          log("\n>>> All Systems Operational.")
          EOF

      - name: ğŸ©º Run Health Check
        id: run-check
        run: python check_status.py

      # [ìˆ˜ì •ë¨] ì´ì „ ì½”ë“œì—ì„œ ëˆ„ë½ë˜ì—ˆë˜ ìŠ¤í… ì´ë¦„(- name)ì„ ì¶”ê°€í•˜ì—¬ ë¬¸ë²• ì˜¤ë¥˜ í•´ê²°
      - name: ğŸ“¤ Upload Check Report Artifact
        if: always() # ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë¡œê·¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: health-check-report
          path: health_report.log
          if-no-files-found: warn

      - name: ğŸš¨ Create Incident Issue on Failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          TITLE="ğŸš¨ [Incident] Service Health Check Failed - $TIMESTAMP"
          BODY="### âš ï¸ Service Down Detected\n\nOne or more services failed the health check at **$TIMESTAMP**.\n\nPlease check the [Action Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n\n**Quick Report:**\n\`\`\`\n$(cat health_report.log)\n\`\`\`"
          
          gh issue create --title "$TITLE" --body "$BODY" --label "incident"
