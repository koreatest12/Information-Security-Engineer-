name: "â° 20-Min Health Check & Reporting"

on:
  schedule:
    - cron: '*/20 * * * *' # ë§¤ 20ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:       # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: read
  issues: write            # ì‹¤íŒ¨ ì‹œ ì´ìŠˆ ìƒì„±ì„ ìœ„í•œ ê¶Œí•œ ì¶”ê°€

jobs:
  health-monitor:
    name: "ğŸ©º Monitor Services"
    runs-on: ubuntu-latest
    
    # íƒ€ì„ì•„ì›ƒ ì„¤ì • (ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ ë°©ì§€)
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # íŒ¨í‚¤ì§€ ìºì‹± ì¶”ê°€

      - name: Install Dependencies
        run: |
          pip install requests pytz
          # pytz: ì‹œê°„ëŒ€ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì¶”ê°€

      - name: ğŸ“ Generate Robust Health Check Script
        run: |
          # Python ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ë“¤ì—¬ì“°ê¸° ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ëª…í™•í•œ EOF ì‚¬ìš©)
          cat << 'EOF' > check_status.py
          import requests
          import sys
          import time
          from datetime import datetime
          import pytz

          # ---------------------------------------------------------
          # [ì„¤ì •] ì‹¤ì œ ìš´ì˜ URLì€ GitHub Secretsë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
          # ì˜ˆ: os.environ.get("PROD_URL_JAVA", "http://localhost:8080...")
          # ---------------------------------------------------------
          TARGETS = [
              {
                  "name": "Java Backend", 
                  "url": "http://localhost:8080/actuator/health", 
                  "mock": True # ë°°í¬ í›„ Falseë¡œ ë³€ê²½ ë° ì‹¤ì œ URL ì…ë ¥
              },
              {
                  "name": "Python API", 
                  "url": "http://localhost:8000/health", 
                  "mock": True # ë°°í¬ í›„ Falseë¡œ ë³€ê²½ ë° ì‹¤ì œ URL ì…ë ¥
              }
          ]

          # í•œêµ­ ì‹œê°„ ì„¤ì •
          KST = pytz.timezone('Asia/Seoul')
          now = datetime.now(KST).strftime('%Y-%m-%d %H:%M:%S')

          log_lines = []
          def log(msg):
              print(msg)
              log_lines.append(msg)

          log(f"=== ğŸ©º Health Check Report [{now}] ===")
          log(f"{'SERVICE':<20} | {'STATUS':<10} | {'LATENCY':<10} | {'MESSAGE'}")
          log("-" * 65)

          all_success = True

          for target in TARGETS:
              start_time = time.time()
              status_code = 0
              msg = "Unknown"
              latency = "0ms"
              is_up = False

              try:
                  if target["mock"]:
                      # Mock í…ŒìŠ¤íŠ¸ (ì„±ê³µ ì‹œë®¬ë ˆì´ì…˜)
                      time.sleep(0.1) 
                      status_code = 200
                      msg = "Alive (Mock)"
                      is_up = True
                  else:
                      # ì‹¤ì œ ìš”ì²­ (3ì´ˆ íƒ€ì„ì•„ì›ƒ)
                      response = requests.get(target["url"], timeout=3)
                      status_code = response.status_code
                      if status_code == 200:
                          msg = "Alive"
                          is_up = True
                      else:
                          msg = f"Error {status_code}"
                          is_up = False
                  
              except Exception as e:
                  msg = f"Connection Fail: {str(e)[:20]}..."
                  is_up = False
              
              # ë ˆì´í„´ì‹œ ê³„ì‚°
              latency = f"{(time.time() - start_time) * 1000:.2f}ms"
              
              # ê²°ê³¼ ì¶œë ¥
              status_str = "âœ… UP" if is_up else "âŒ DOWN"
              log(f"{target['name']:<20} | {status_str:<10} | {latency:<10} | {msg}")

              if not is_up:
                  all_success = False

          # ë¡œê·¸ íŒŒì¼ ì €ì¥
          with open("health_report.log", "w", encoding="utf-8") as f:
              f.write("\n".join(log_lines))

          if not all_success:
              log("\n!!! CRITICAL: Some services are DOWN !!!")
              sys.exit(1) # ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬
          
          log("\n>>> All Systems Operational.")
          EOF

      - name: ğŸ©º Run Health Check
        id: run-check
        run: python check_status.py

      # [ì¶”ê°€ ê¸°ëŠ¥ 1] ì ê²€ ê²°ê³¼ ë¡œê·¸ë¥¼ Artifactë¡œ ì—…ë¡œë“œ (ì„±ê³µ/ì‹¤íŒ¨ ìƒê´€ì—†ì´ ìˆ˜í–‰)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-check-report
          path: health_report.log

      # [ì¶”ê°€ ê¸°ëŠ¥ 2] ì‹¤íŒ¨ ì‹œ GitHub Issue ìë™ ìƒì„± (ì•Œë¦¼ ëŒ€ìš©)
      - name: ğŸš¨ Create Incident Issue on Failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # í˜„ì¬ ì‹œê°„
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          
          # ì´ìŠˆ ì œëª© ë° ë‚´ìš© ìƒì„±
          TITLE="ğŸš¨ [Incident] Service Health Check Failed - $TIMESTAMP"
          BODY="### âš ï¸ Service Down Detected\n\nOne or more services failed the health check at **$TIMESTAMP**.\n\nPlease check the [Action Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n\n**Quick Report:**\n\`\`\`\n$(cat health_report.log)\n\`\`\`"
          
          # ì¤‘ë³µ ì´ìŠˆ ë°©ì§€ ë¡œì§ (ì˜µì…˜: ì´ë¯¸ ì—´ë¦° ì´ìŠˆê°€ ìˆìœ¼ë©´ ì½”ë©˜íŠ¸ë§Œ ë‹¬ê¸° ë“± ê³ ë„í™” ê°€ëŠ¥)
          gh issue create --title "$TITLE" --body "$BODY" --label "incident"
