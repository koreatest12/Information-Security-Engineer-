name: "â° 20-Min Periodic Health Check"

on:
  schedule:
    - cron: '*/20 * * * *' # ë§¤ 20ë¶„ë§ˆë‹¤ ì‹¤í–‰ (0, 20, 40)
  workflow_dispatch:       # í•„ìš”ì‹œ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install Requests
        run: pip install requests

      - name: ğŸ©º Run Health Check Script
        run: |
          echo ">>> Starting 20-minute Health Check..."
          
          # íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¦‰ì„ì—ì„œ ìƒì„±í•˜ì—¬ ì‹¤í–‰
          cat <<EOF > check_status.py
          import requests
          import sys

          # ì‹¤ì œ ìš´ì˜ ì¤‘ì¸ ì„œë²„ ì£¼ì†Œ (ë°°í¬ í›„ URLë¡œ êµì²´ í•„ìš”)
          # ì˜ˆì‹œë¡œ ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© ì„¤ì •ì„ ê°€ì •í•˜ê±°ë‚˜, ì™¸ë¶€ URLì„ ì…ë ¥
          TARGETS = [
              {"name": "Java Backend", "url": "http://localhost:8080/actuator/health", "mock": True},
              {"name": "Python API", "url": "http://localhost:8000/health", "mock": True}
          ]

          success = True
          
          print(f"{'SERVICE':<15} | {'STATUS':<10} | {'MESSAGE'}")
          print("-" * 40)

          for target in TARGETS:
              try:
                  # ì‹¤ì œ ë°°í¬ í™˜ê²½ì´ ì•„ë‹ˆë¯€ë¡œ GitHub Actionsì—ì„œëŠ” Mock ì²˜ë¦¬ ì˜ˆì‹œ
                  if target["mock"]:
                      status_code = 200
                      msg = "Alive (Mock Test)"
                  else:
                      response = requests.get(target["url"], timeout=5)
                      status_code = response.status_code
                      msg = "Alive" if status_code == 200 else f"Error {status_code}"
                  
                  print(f"{target['name']:<15} | {status_code:<10} | {msg}")
                  
                  if status_code != 200:
                      success = False
              except Exception as e:
                  print(f"{target['name']:<15} | FAIL       | {str(e)}")
                  success = False

          if not success:
              sys.exit(1) # ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì—ëŸ¬ ë°œìƒì‹œí‚´
          EOF
          
          python check_status.py

      - name: ğŸ”” Notify on Failure (Optional)
        if: failure()
        run: echo "::error:: One or more services are down! Please check the logs."
