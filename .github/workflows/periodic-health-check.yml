name: "ğŸ—ï¸ Enterprise Grade Health Check System"

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'production'

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  system-monitor:
    name: "ğŸ©º Full System Inspection"
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1. ê¸°ë³¸ í™˜ê²½ ì„¤ì •
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 2. í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install requests pytz urllib3 safety bandit flake8 jinja2

      # =========================================================
      # ğŸ“‚ [ëŒ€ëŸ‰ ìƒì„± 1] ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ë¦½
      # =========================================================
      - name: ğŸ“‚ Create Massive Directory Structure
        run: |
          echo ">>> Initializing Directory Structure..."
          
          # ë©”ì¸ ë””ë ‰í† ë¦¬ë“¤ ìƒì„±
          mkdir -p config
          mkdir -p scripts
          mkdir -p logs
          mkdir -p archive
          
          # ë¦¬í¬íŠ¸ í•˜ìœ„ ë””ë ‰í† ë¦¬ ìƒì„± (êµ¬ì¡°í™”)
          mkdir -p reports/raw
          mkdir -p reports/security
          mkdir -p reports/html
          
          echo "âœ… Directory structure created successfully."
          tree . || ls -R  # êµ¬ì¡° í™•ì¸ìš© (treeê°€ ì—†ìœ¼ë©´ ls -R)

      # =========================================================
      # ğŸ“„ [ëŒ€ëŸ‰ ìƒì„± 2] ì„¤ì • íŒŒì¼(Config) ë¶„ë¦¬ ìƒì„±
      # =========================================================
      - name: âš™ï¸ Generate Configuration Files
        env:
          ENV_TARGETS: ${{ secrets.TARGET_URLS }} # ì‹œí¬ë¦¿ ì—†ìœ¼ë©´ ì•„ë˜ ê¸°ë³¸ê°’ ì‚¬ìš©
        run: |
          # targets.json íŒŒì¼ ìƒì„± (ì™¸ë¶€ ì„¤ì • íŒŒì¼ ì‹œë®¬ë ˆì´ì…˜)
          cat << EOF > config/targets.json
          [
            {
              "name": "Core Backend API",
              "url": "http://localhost:8080/actuator/health",
              "tier": "critical"
            },
            {
              "name": "Auth Service",
              "url": "https://httpbin.org/status/200",
              "tier": "critical"
            },
            {
              "name": "Legacy System",
              "url": "https://www.google.com",
              "tier": "low"
            }
          ]
          EOF
          
          # settings.ini íŒŒì¼ ìƒì„± (ì„ê³„ê°’ ì„¤ì •)
          cat << EOF > config/settings.ini
          [Thresholds]
          latency_warning_ms = 1500
          latency_critical_ms = 5000
          ssl_expiry_days = 30
          retry_count = 3
          EOF
          
          echo "âœ… Config files generated in /config"

      # =========================================================
      # ğŸ›¡ï¸ [ëŒ€ëŸ‰ ìƒì„± 3] ë³´ì•ˆ ì ê²€ ìˆ˜í–‰ ë° íŒŒì¼ ì €ì¥
      # =========================================================
      - name: ğŸ›¡ï¸ Run Security Scans & Save Logs
        run: |
          echo ">>> Running SAST & SCA Checks..."
          
          # 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì·¨ì•½ì  ì ê²€ -> íŒŒì¼ë¡œ ì €ì¥
          safety check --full-report > reports/security/safety_report.txt || true
          
          # 2. í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ì €ì¥ (ì¦ì  ìë£Œ)
          ls -alR > reports/security/filesystem_structure.txt
          
          echo "âœ… Security reports saved in /reports/security"

      # =========================================================
      # ğŸ [ëŒ€ëŸ‰ ìƒì„± 4] ë©”ì¸ íŒŒì´ì¬ ë¡œì§ íŒŒì¼ ìƒì„±
      # =========================================================
      - name: ğŸ“ Generate Main Python Script
        run: |
          cat << 'EOF' > scripts/monitor.py
          import json
          import requests
          import time
          import sys
          import os
          import ssl
          import socket
          import pytz
          import logging
          from datetime import datetime
          from requests.adapters import HTTPAdapter
          from urllib3.util.retry import Retry
          import configparser

          # --- [1] ë¡œê¹… ì„¤ì • (íŒŒì¼ ë° ì½˜ì†” ë™ì‹œ ì¶œë ¥) ---
          logger = logging.getLogger()
          logger.setLevel(logging.INFO)
          formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')

          # íŒŒì¼ ë¡œê·¸ í•¸ë“¤ëŸ¬
          file_handler = logging.FileHandler('logs/app.log', encoding='utf-8')
          file_handler.setFormatter(formatter)
          logger.addHandler(file_handler)

          # ì½˜ì†” ë¡œê·¸ í•¸ë“¤ëŸ¬
          stream_handler = logging.StreamHandler()
          stream_handler.setFormatter(formatter)
          logger.addHandler(stream_handler)

          # --- [2] ì„¤ì • ë¡œë“œ ---
          try:
              with open('config/targets.json', 'r') as f:
                  TARGETS = json.load(f)
              logger.info(f"Loaded {len(TARGETS)} targets from config.")
          except Exception as e:
              logger.error(f"Failed to load config: {e}")
              sys.exit(1)

          # --- [3] í—¬í¼ í•¨ìˆ˜ ì •ì˜ ---
          def check_ssl(url):
              try:
                  hostname = url.split("//")[-1].split("/")[0].split(":")[0]
                  context = ssl.create_default_context()
                  with socket.create_connection((hostname, 443), timeout=3) as sock:
                      with context.wrap_socket(sock, server_hostname=hostname) as ssock:
                          cert = ssock.getpeercert()
                          not_after = datetime.strptime(cert['notAfter'], '%b %d %H:%M:%S %Y %Z')
                          remaining = (not_after - datetime.utcnow()).days
                          return True, remaining
              except:
                  return False, 0

          def get_session():
              s = requests.Session()
              retries = Retry(total=3, backoff_factor=0.5)
              s.mount('http://', HTTPAdapter(max_retries=retries))
              s.mount('https://', HTTPAdapter(max_retries=retries))
              return s

          # --- [4] ë©”ì¸ ì ê²€ ë£¨í”„ ---
          results = []
          session = get_session()
          has_failure = False

          logger.info(">>> Starting Health Check Loop")

          for t in TARGETS:
              start = time.time()
              res_data = {
                  "name": t['name'],
                  "url": t['url'],
                  "status": "DOWN",
                  "latency_ms": 0,
                  "ssl_days": "N/A",
                  "timestamp": datetime.now().isoformat()
              }
              
              try:
                  resp = session.get(t['url'], timeout=5)
                  latency = (time.time() - start) * 1000
                  res_data['latency_ms'] = round(latency, 2)

                  if resp.status_code == 200:
                      res_data['status'] = "UP"
                  else:
                      res_data['status'] = f"ERR_{resp.status_code}"
                      has_failure = True
                      
                  # SSL Check
                  if t['url'].startswith("https"):
                      ok, days = check_ssl(t['url'])
                      res_data['ssl_days'] = days if ok else "FAIL"

              except Exception as e:
                  res_data['status'] = "CONN_FAIL"
                  logger.error(f"Target {t['name']} failed: {e}")
                  has_failure = True

              logger.info(f"Check: {res_data['name']} -> {res_data['status']} ({res_data['latency_ms']}ms)")
              results.append(res_data)

          # --- [5] ê²°ê³¼ íŒŒì¼ ëŒ€ëŸ‰ ìƒì„± ---
          
          # 5-1. JSON Raw Data ì €ì¥
          with open('reports/raw/data.json', 'w') as f:
              json.dump(results, f, indent=4)
          
          # 5-2. CSV ë¦¬í¬íŠ¸ ìƒì„± (ì—‘ì…€ìš©)
          with open('reports/summary.csv', 'w') as f:
              f.write("Name,URL,Status,Latency(ms),SSL(days)\n")
              for r in results:
                  f.write(f"{r['name']},{r['url']},{r['status']},{r['latency_ms']},{r['ssl_days']}\n")

          # 5-3. HTML ëŒ€ì‹œë³´ë“œ ìƒì„± (ì‹œê°í™”)
          html_content = f"""
          <html>
          <head><title>System Status</title></head>
          <body style="font-family: sans-serif;">
              <h1>ğŸ©º System Health Report</h1>
              <p>Generated at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
              <table border="1" cellpadding="10" style="border-collapse: collapse; width: 80%;">
                  <tr style="background-color: #f2f2f2;">
                      <th>Service</th><th>Status</th><th>Latency</th><th>SSL Days</th>
                  </tr>
          """
          for r in results:
              color = "#d4edda" if r['status'] == "UP" else "#f8d7da"
              html_content += f"""
                  <tr style="background-color: {color};">
                      <td>{r['name']}</td>
                      <td><b>{r['status']}</b></td>
                      <td>{r['latency_ms']}ms</td>
                      <td>{r['ssl_days']}</td>
                  </tr>
              """
          html_content += "</table></body></html>"
          
          with open('reports/html/dashboard.html', 'w') as f:
              f.write(html_content)

          logger.info(">>> All reports generated successfully.")
          
          if has_failure:
              sys.exit(1)
          EOF
          
          # Bandit(ì½”ë“œ ë³´ì•ˆ ê²€ì‚¬) ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
          bandit -r scripts/monitor.py -f txt -o reports/security/bandit_report.txt || true

      # 3. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: ğŸš€ Execute Monitor Script
        run: python scripts/monitor.py

      # =========================================================
      # ğŸ“¤ [ëŒ€ëŸ‰ ìƒì„± 5] ìƒì„±ëœ ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œ
      # =========================================================
      - name: ğŸ“¦ Upload All Generated Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-system-report
          path: |
            logs/
            reports/
            config/
            scripts/
          retention-days: 5 # 5ì¼ê°„ ë³´ê´€

      # 4. ì‹¤íŒ¨ ì‹œ ì´ìŠˆ ìƒì„± (ë¡œê·¸ íŒŒì¼ ë‚´ìš© ì²¨ë¶€)
      - name: ğŸ« Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let logBody = '';
            try {
              // ìƒì„±ëœ ë¡œê·¸ íŒŒì¼ì„ ì½ì–´ì„œ ì´ìŠˆ ë³¸ë¬¸ì— ì²¨ë¶€
              logBody = fs.readFileSync('reports/summary.csv', 'utf8');
            } catch (e) { logBody = 'No log available'; }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ System Monitor Alert',
              body: `### Critical Failure Detected\n\n**CSV Summary:**\n\`\`\`csv\n${logBody}\n\`\`\`\n\nPlease check the [Artifacts] for full HTML and JSON reports.`,
              labels: ['incident']
            });
