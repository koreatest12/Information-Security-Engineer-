name: "ğŸŒŒ Galaxy-Class System Overseer"

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:
    inputs:
      maintenance_mode:
        description: 'ìœ ì§€ë³´ìˆ˜ ëª¨ë“œ í™œì„±í™” (ê²½ê³  ë¬´ì‹œ)'
        type: boolean
        default: false

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  mission-control:
    name: "ğŸ›°ï¸ Mission Control Center"
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      # 1. ê¸°ì§€ êµ¬ì¶• (í™˜ê²½ ì„¤ì •)
      - name: ğŸ“¥ Initialize Base
        uses: actions/checkout@v4

      - name: ğŸ Equip Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Modules
        run: |
          pip install requests pytz urllib3 jinja2 pandas colorama

      # =========================================================
      # ğŸ—ï¸ [ëŒ€ëŸ‰ ìƒì„± 1] ëª¨ë“ˆí˜• ë””ë ‰í† ë¦¬ ì•„í‚¤í…ì²˜ ì„¤ê³„
      # =========================================================
      - name: ğŸ—ï¸ Construct Infrastructure
        run: |
          echo ">>> Terraforming Directories..."
          
          # ì‹œìŠ¤í…œ ì½”ì–´
          mkdir -p system/core
          mkdir -p system/config
          mkdir -p system/templates
          
          # ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤
          mkdir -p data/raw
          mkdir -p data/processed
          mkdir -p data/history
          
          # ë¡œê·¸ ë° ë¦¬í¬íŠ¸ ì„¼í„°
          mkdir -p logs/services
          mkdir -p reports/dashboard
          mkdir -p reports/incidents
          
          echo "âœ… Infrastructure Ready."
          ls -R

      # =========================================================
      # ğŸ­ [ëŒ€ëŸ‰ ìƒì„± 2] ë©€í‹° ì„œë¹„ìŠ¤ Mock ì„œë²„ (ì•ˆì •ì„± í™•ë³´)
      # =========================================================
      - name: ğŸ­ Deploy Multi-Service Mock Simulator
        run: |
          # 3ê°œì˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¥¼ í‰ë‚´ë‚´ëŠ” ë‹¨ì¼ Mock ì„œë²„
          cat << 'EOF' > system/core/mock_universe.py
          from http.server import BaseHTTPRequestHandler, HTTPServer
          import json
          import random
          import time
          from urllib.parse import urlparse

          class UniverseHandler(BaseHTTPRequestHandler):
              def do_GET(self):
                  path = urlparse(self.path).path
                  
                  # ì‘ë‹µ í—¤ë” ê³µí†µ
                  self.send_response(200)
                  self.send_header('Content-type', 'application/json')
                  self.end_headers()
                  
                  # ë¼ìš°íŒ… ë¡œì§
                  if path == "/api/core/health":
                      resp = {"service": "Core-Backend", "status": "UP", "load": "low"}
                  elif path == "/api/auth/status":
                      # ê°„í—ì  ì§€ì—° ì‹œë®¬ë ˆì´ì…˜ (ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸ìš©)
                      time.sleep(0.1) 
                      resp = {"service": "Auth-Server", "status": "UP", "users_online": 150}
                  elif path == "/api/payment/check":
                      resp = {"service": "Payment-Gateway", "status": "UP", "gateway": "Stripe"}
                  else:
                      resp = {"error": "Not Found"}
                  
                  self.wfile.write(json.dumps(resp).encode())

          def run(port=8080):
              server = HTTPServer(('', port), UniverseHandler)
              print(f"ğŸŒŒ Mock Universe running on port {port}...")
              server.serve_forever()

          if __name__ == "__main__":
              run()
          EOF

      - name: ğŸš€ Launch Background Satellites
        run: |
          # ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ & ë¡œê·¸ ë¶„ë¦¬
          nohup python system/core/mock_universe.py > logs/services/mock_server.log 2>&1 &
          echo ">>> Waiting for satellites to orbit..."
          sleep 3

      # =========================================================
      # âš™ï¸ [ëŒ€ëŸ‰ ìƒì„± 3] ì§€ëŠ¥í˜• ì„¤ì • íŒŒì¼ (í‹°ì–´ ì‹œìŠ¤í…œ ë„ì…)
      # =========================================================
      - name: âš™ï¸ Generate Strategy Config
        run: |
          # Critical: ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¥ì•  ì²˜ë¦¬
          # Warning: ì‹¤íŒ¨ ì‹œ ê²½ê³ ë§Œ ì¶œë ¥ (ë°°í¬ ì¤‘ë‹¨ ì•ˆ í•¨)
          cat << EOF > system/config/targets.json
          [
            {
              "id": "srv-001",
              "name": "Core Backend",
              "url": "http://localhost:8080/api/core/health",
              "tier": "Critical",
              "timeout": 2
            },
            {
              "id": "srv-002",
              "name": "Auth Service",
              "url": "http://localhost:8080/api/auth/status",
              "tier": "Critical",
              "timeout": 3
            },
            {
              "id": "srv-003",
              "name": "Payment Gateway",
              "url": "http://localhost:8080/api/payment/check",
              "tier": "Warning",
              "timeout": 5
            },
            {
              "id": "srv-ext-001",
              "name": "External Google DNS",
              "url": "https://dns.google",
              "tier": "Warning",
              "timeout": 5
            }
          ]
          EOF

      # =========================================================
      # ğŸ“¡ [ëŒ€ëŸ‰ ìƒì„± 4] ìˆ˜ì§‘ê¸° (Collector) ëª¨ë“ˆ ìƒì„±
      # =========================================================
      - name: ğŸ“¡ Create Data Collector Module
        run: |
          cat << 'EOF' > system/core/collector.py
          import requests
          import json
          import time
          import os
          from datetime import datetime
          from requests.adapters import HTTPAdapter
          from urllib3.util.retry import Retry

          def get_session():
              s = requests.Session()
              # 503 ì—ëŸ¬ ë°œìƒ ì‹œ ë°±ì˜¤í”„ ì „ëµ ê°•í™” (0.5ì´ˆ -> 1ì´ˆ -> 2ì´ˆ)
              retries = Retry(total=3, backoff_factor=1, status_forcelist=[500, 502, 503, 504])
              s.mount('http://', HTTPAdapter(max_retries=retries))
              s.mount('https://', HTTPAdapter(max_retries=retries))
              return s

          def run_collection():
              with open('system/config/targets.json', 'r') as f:
                  targets = json.load(f)
              
              session = get_session()
              raw_data = []
              
              print(f">>> Collecting metrics for {len(targets)} targets...")
              
              for t in targets:
                  start = time.time()
                  result = {
                      "id": t['id'],
                      "name": t['name'],
                      "tier": t['tier'],
                      "url": t['url'],
                      "status": "UNKNOWN",
                      "code": 0,
                      "latency": 0.0,
                      "timestamp": datetime.now().isoformat()
                  }
                  
                  try:
                      resp = session.get(t['url'], timeout=t['timeout'])
                      result['latency'] = round((time.time() - start) * 1000, 2)
                      result['code'] = resp.status_code
                      
                      if resp.status_code == 200:
                          result['status'] = "UP"
                      else:
                          result['status'] = "DOWN"
                          
                  except Exception as e:
                      result['status'] = "ERROR"
                      result['error_msg'] = str(e)[:50]
                      print(f"âš ï¸ Error collecting {t['name']}: {e}")

                  raw_data.append(result)
                  print(f"   Checked [{t['tier']}] {t['name']}: {result['status']} ({result['latency']}ms)")

              # Raw ë°ì´í„° ì €ì¥
              os.makedirs('data/raw', exist_ok=True)
              with open('data/raw/latest_scan.json', 'w') as f:
                  json.dump(raw_data, f, indent=4)
              
              print(">>> Collection Complete.")

          if __name__ == "__main__":
              run_collection()
          EOF

      # =========================================================
      # ğŸ§  [ëŒ€ëŸ‰ ìƒì„± 5] ë¶„ì„ê¸° (Analyzer) ëª¨ë“ˆ ìƒì„±
      # =========================================================
      - name: ğŸ§  Create Logic Analyzer Module
        run: |
          cat << 'EOF' > system/core/analyzer.py
          import json
          import sys
          import os

          def analyze():
              with open('data/raw/latest_scan.json', 'r') as f:
                  data = json.load(f)
              
              report = {
                  "total": len(data),
                  "up": 0,
                  "down": 0,
                  "critical_failures": [],
                  "warning_failures": []
              }
              
              for item in data:
                  if item['status'] == 'UP':
                      report['up'] += 1
                  else:
                      report['down'] += 1
                      if item['tier'] == 'Critical':
                          report['critical_failures'].append(item)
                      else:
                          report['warning_failures'].append(item)
              
              # ë¶„ì„ ê²°ê³¼ ì €ì¥
              os.makedirs('data/processed', exist_ok=True)
              with open('data/processed/analysis_result.json', 'w') as f:
                  json.dump(report, f, indent=4)
              
              print(">>> Analysis Summary:")
              print(f"   Total: {report['total']}, UP: {report['up']}, DOWN: {report['down']}")
              print(f"   Critical Failures: {len(report['critical_failures'])}")
              print(f"   Warning Failures: {len(report['warning_failures'])}")
              
              # ì¢…ë£Œ ì½”ë“œ ê²°ì • (Criticalì¼ ë•Œë§Œ ì‹¤íŒ¨ ì²˜ë¦¬)
              if len(report['critical_failures']) > 0:
                  sys.exit(1)
              else:
                  sys.exit(0)

          if __name__ == "__main__":
              try:
                  analyze()
              except SystemExit as e:
                  # ëª¨ë“ˆ ì‹¤í–‰ ì‹œ ë°”ë¡œ ì¢…ë£Œë˜ì§€ ì•Šë„ë¡ ì˜ˆì™¸ ì²˜ë¦¬ í›„ ìƒíƒœ ì½”ë“œ ì „ë‹¬ìš© íŒŒì¼ ìƒì„±
                  with open('data/processed/exit_code', 'w') as f:
                      f.write(str(e.code))
          EOF

      # =========================================================
      # ğŸ“° [ëŒ€ëŸ‰ ìƒì„± 6] ë¦¬í¬í„° (Reporter) ëª¨ë“ˆ ìƒì„± (HTML/MD)
      # =========================================================
      - name: ğŸ“° Create Report Generator Module
        run: |
          cat << 'EOF' > system/core/reporter.py
          import json
          import os
          from datetime import datetime

          def generate_reports():
              with open('data/raw/latest_scan.json', 'r') as f:
                  raw = json.load(f)
              with open('data/processed/analysis_result.json', 'r') as f:
                  analysis = json.load(f)

              # 1. GitHub Summary (Markdown) ìƒì„±
              md_lines = ["### ğŸ›°ï¸ System Status Report"]
              md_lines.append(f"**Time:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} UTC")
              
              if analysis['critical_failures']:
                  md_lines.append("\n#### ğŸš¨ Critical Issues")
                  for fail in analysis['critical_failures']:
                      md_lines.append(f"- ğŸ”´ **{fail['name']}** ({fail['url']}) : {fail['status']}")
              
              if analysis['warning_failures']:
                  md_lines.append("\n#### âš ï¸ Warnings (Non-Blocking)")
                  for fail in analysis['warning_failures']:
                      md_lines.append(f"- ğŸŸ¡ **{fail['name']}** : {fail.get('error_msg', 'Check Logs')}")

              md_lines.append("\n#### ğŸ“Š Details")
              md_lines.append("| Service | Tier | Status | Latency |")
              md_lines.append("|---|---|---|---|")
              
              for item in raw:
                  icon = "âœ…" if item['status'] == "UP" else ("ğŸ”´" if item['tier'] == "Critical" else "ğŸŸ¡")
                  md_lines.append(f"| {icon} {item['name']} | {item['tier']} | **{item['status']}** | {item['latency']}ms |")
              
              summary_content = "\n".join(md_lines)
              
              # GitHub Actions Summary í™˜ê²½ë³€ìˆ˜ì— ì“°ê¸°
              if "GITHUB_STEP_SUMMARY" in os.environ:
                  with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as f:
                      f.write(summary_content)
              
              # 2. Incident Report (ì¥ì•  ë°œìƒ ì‹œ)
              if analysis['critical_failures']:
                  with open('reports/incidents/incident_alert.md', 'w') as f:
                      f.write(f"# ğŸ”¥ Critical Incident Alert\n\n{summary_content}")

              print(">>> Reports Generated.")

          if __name__ == "__main__":
              generate_reports()
          EOF

      # =========================================================
      # ğŸ”¥ [ì‹¤í–‰] ëª¨ë“ˆ ìˆœì°¨ ì‹¤í–‰ (íŒŒì´í”„ë¼ì¸)
      # =========================================================
      - name: ğŸ“¡ Run Collector
        run: python system/core/collector.py

      - name: ğŸ§  Run Analyzer
        id: analyzer_step
        run: |
          python system/core/analyzer.py
          EXIT_CODE=$(cat data/processed/exit_code)
          echo "analyzer_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        continue-on-error: true # ë¦¬í¬íŠ¸ ìƒì„±ì„ ìœ„í•´ ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨ ë°©ì§€

      - name: ğŸ“° Run Reporter
        run: python system/core/reporter.py

      # =========================================================
      # ğŸ [ì¢…ë£Œ] ìµœì¢… ê²°ê³¼ íŒë‹¨ ë° ì•„í‹°íŒ©íŠ¸ ì €ì¥
      # =========================================================
      - name: ğŸ“¦ Archive System Data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: galaxy-system-logs
          path: |
            system/
            data/
            logs/
            reports/

      - name: ğŸš¦ Final Status Check
        if: steps.analyzer_step.outputs.analyzer_exit_code != '0'
        run: |
          echo "â›” Critical System Failure Detected."
          exit 1
