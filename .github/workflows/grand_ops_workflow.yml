name: Grand Ops Unified Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ops-execution:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì•¼ rebase ê°€ëŠ¥

      # 2. íŒŒì´ì¬ í™˜ê²½ ì„¤ì • (ì‚¬ìš©ì ìŠ¤í¬ë¦½íŠ¸ìš©)
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      # 3. Docker Buildx ì„¤ì • (ì´ë¯¸ì§€ ë¹Œë“œìš©)
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. í†µí•© ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: ğŸ” Grant Permissions
        run: chmod +x ./universal_ops_manager.sh

      # 5. ëŒ€í†µí•© ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (OS ì—…ê·¸ë ˆì´ë“œ, ë¹Œë“œ, ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë“±)
      - name: ğŸš€ Run Universal Ops Manager
        run: ./universal_ops_manager.sh
        env:
          TERM: xterm-256color # ì»¬ëŸ¬ ë¡œê·¸ ì¶œë ¥ ì§€ì›

      # 6. Git ì¶©ëŒ ìë™ í•´ê²° ë° ì»¤ë°‹ (ì—ëŸ¬ ë°©ì§€ í•µì‹¬ ë¡œì§)
      - name: ğŸ”„ Sync and Commit Infrastructure State
        run: |
          git config --global user.name "Grand-Ops-Bot"
          git config --global user.email "ops-bot@example.com"
          
          echo "ğŸ” Checking for changes..."
          git add data/ .cache/ config/ || echo "Nothing to add"
          
          # ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì¢…ë£Œí•˜ì§€ ì•Šê³  ë„˜ì–´ê°
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit."
          else
            git commit -m "ops: auto-update infrastructure state [skip ci]"
            
            echo "ğŸ”„ Pulling latest changes (Rebase Strategy)..."
            # ì›ê²© ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì™€ì„œ ë¡œì»¬ ì»¤ë°‹ ìœ„ì— ì¬ì ìš© (ì¶©ëŒ ë°©ì§€)
            git pull --rebase origin main || git pull origin main --no-edit
            
            echo "ğŸš€ Pushing changes..."
            git push origin main
          fi
