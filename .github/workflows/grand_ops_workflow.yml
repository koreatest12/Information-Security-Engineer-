name: Grand Ops Unified Pipeline (Auto-Generate & Run)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ops-execution:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì „ì²´ ì´ë ¥ í¬í•¨)
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. íŒŒì´ì¬ í™˜ê²½ ì„¤ì •
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      # 3. Docker Buildx ì„¤ì •
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. [í•µì‹¬ ìˆ˜ì •] í†µí•© ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ìë™ ìƒì„± (íŒŒì¼ì´ ì—†ì–´ë„ ìë™ ìƒì„±ë¨)
      - name: ğŸ›  Generate Universal Ops Manager Script
        run: |
          cat << 'EOF' > universal_ops_manager.sh
          #!/bin/bash
          set -euo pipefail

          # --- CONFIGURATION ---
          WORKSPACE_DIR="${PWD}"
          DATA_DIR="${WORKSPACE_DIR}/data"
          CACHE_DIR="${WORKSPACE_DIR}/.cache"
          SCRIPTS_DIR="${WORKSPACE_DIR}/scripts"
          LOG_FILE="${DATA_DIR}/ops_execution.log"
          IMAGE_NAME="grand-ops-image"
          
          # --- UTILS ---
          log() {
              timestamp=$(date "+%Y-%m-%d %H:%M:%S")
              echo -e "\033[0;32m[${timestamp}] [OPS]\033[0m $1"
              if [ -d "${DATA_DIR}" ]; then echo "[${timestamp}] [OPS] $1" >> "${LOG_FILE}"; fi
          }

          # --- 1. OS DETECTION & UPGRADE ---
          detect_and_upgrade_os() {
              log "ğŸ” Detecting OS..."
              if [ -f /etc/os-release ]; then . /etc/os-release; OS_NAME=$ID; else OS_NAME="unknown"; fi
              log "Detected OS: ${OS_NAME}"
              
              # CI í™˜ê²½ì—ì„œëŠ” sudoê°€ ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ë™ì‘í•˜ê±°ë‚˜ rootì„
              case "${OS_NAME}" in
                  ubuntu|debian)
                      sudo apt-get update -y
                      # ì‹œê°„ ì ˆì•½ì„ ìœ„í•´ upgradeëŠ” í•„ìš”í•œ ê²½ìš°ë§Œ ì£¼ì„ í•´ì œ
                      # sudo apt-get upgrade -y 
                      ;;
                  alpine)
                      apk update ;;
                  *)
                      log "âš ï¸ Unknown OS or Upgrade skipped for efficiency." ;;
              esac
          }

          # --- 2. ENVIRONMENT SETUP ---
          setup_environment() {
              log "ğŸ›  Setting up directories..."
              mkdir -p "${DATA_DIR}" "${CACHE_DIR}" "${SCRIPTS_DIR}"
              touch "${CACHE_DIR}/last_run_$(date +%Y%m%d).lock"
              log "âœ… Directories ready: ${DATA_DIR}, ${CACHE_DIR}"
          }

          # --- 3. DOCKER BUILD ---
          build_image() {
              if [ -f "Dockerfile" ]; then
                  log "ğŸ³ Building Docker Image..."
                  docker build -t "${IMAGE_NAME}:latest" . || log "âš ï¸ Docker build warning"
              else
                  log "â„¹ï¸ No Dockerfile found. Skipping."
              fi
          }

          # --- 4. EXECUTE SCRIPTS ---
          run_scripts() {
              log "ğŸ“œ Executing scripts in ${SCRIPTS_DIR}..."
              # ìŠ¤í¬ë¦½íŠ¸ í´ë”ê°€ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ ì‹¤í–‰
              if [ "$(ls -A ${SCRIPTS_DIR} 2>/dev/null)" ]; then
                  for script in "${SCRIPTS_DIR}"/*; do
                      [ -f "$script" ] || continue
                      filename=$(basename "$script")
                      log "â–¶ï¸ Running: $filename"
                      
                      if [[ "$filename" == *.sh ]]; then
                          chmod +x "$script"
                          bash "$script" || log "âŒ Script failed: $filename"
                      elif [[ "$filename" == *.py ]]; then
                          python3 "$script" || log "âŒ Script failed: $filename"
                      fi
                  done
              else
                  log "â„¹ï¸ No custom scripts found in scripts/ directory."
              fi
          }

          # --- MAIN ---
          main() {
              detect_and_upgrade_os
              setup_environment
              build_image
              run_scripts
              log "ğŸ‰ Workflow Completed."
          }
          main
          EOF

      # 5. ê¶Œí•œ ë¶€ì—¬ ë° ì‹¤í–‰ (íŒŒì¼ì´ ì´ì œ í™•ì‹¤íˆ ì¡´ì¬í•¨)
      - name: ğŸš€ Run Universal Ops Manager
        run: |
          chmod +x ./universal_ops_manager.sh
          ./universal_ops_manager.sh
        env:
          TERM: xterm-256color

      # 6. [ì—ëŸ¬ ë°©ì§€] Git ë™ê¸°í™” ë° ì¶©ëŒ ìë™ í•´ê²° (Rebase ì „ëµ)
      - name: ğŸ”„ Sync and Commit Infrastructure State
        if: always() # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë¡œê·¸ ì €ì¥ì„ ìœ„í•´ ì‹¤í–‰
        run: |
          git config --global user.name "Grand-Ops-Bot"
          git config --global user.email "ops-bot@noreply.github.com"
          
          echo "ğŸ” Checking for artifacts..."
          git add data/ .cache/ config/ scripts/ || echo "Warning: Some paths not found"
          
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit."
          else
            git commit -m "ops: auto-provision & migration sync [skip ci]"
            
            echo "ğŸ”„ Handling remote changes (Rebase)..."
            # ì‹¤íŒ¨ ì‹œ ê°•ì œë¡œ rebase ì‹œë„í•˜ì—¬ ë³‘í•©
            git pull --rebase origin main || (git rebase --abort && git pull origin main --no-edit)
            
            echo "ğŸš€ Pushing final state..."
            git push origin main
          fi
