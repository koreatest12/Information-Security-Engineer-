name: ğŸ›¡ï¸ Security DB Master V7 (Auto-Init & Massive Ops)
on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  # [í•µì‹¬] ëŒ€ê·œëª¨ êµ¬ì¡°ë¥¼ ìœ„í•œ ê¸°ë³¸ ê²½ë¡œ ì •ì˜
  BASE_DATA_DIR: 'data'
  BACKUP_ROOT: 'backup'
  CONFIG_ROOT: 'config'
  SCRIPTS_ROOT: 'scripts'
  # [ìºì‹œ] ì»¤ìŠ¤í…€ ìºì‹œ ë””ë ‰í† ë¦¬ ì§€ì •
  APP_CACHE_DIR: '.app_core_cache'
  # [ë³´ì•ˆ] ì•”í˜¸í™” í‚¤
  SECURE_KEY: "SuperSecretKey!@#OpsMasterV7" 

permissions:
  contents: write

jobs:
  # 1. ì¸í”„ë¼ ì´ˆê¸°í™” ë° í™˜ê²½ êµ¬ì„± (New Core Logic)
  init-and-setup:
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-restore.outputs.cache-hit }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # [NEW] 1. ë™ì  í™˜ê²½ ë³€ìˆ˜ ë° PATH ëŒ€ëŸ‰ ì£¼ì…
      - name: ğŸŒ Inject Environment Paths & Variables
        run: |
          echo "Setting up Global Environment Paths..."
          # ìŠ¤í¬ë¦½íŠ¸ í´ë”ë¥¼ ì‹œìŠ¤í…œ PATHì— ì¶”ê°€ (ì–´ë””ì„œë“  ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ)
          echo "$GITHUB_WORKSPACE/$SCRIPTS_ROOT" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH
          
          # ëŸ°íƒ€ì„ ë³€ìˆ˜ ì„¤ì •
          echo "EXECUTION_ID=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
          echo "MAX_DB_CONNECTIONS=50" >> $GITHUB_ENV
          
          # Python ê²½ë¡œ ìµœì í™”
          echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      # [NEW] 2. ëŒ€ê·œëª¨ ë””ë ‰í† ë¦¬ ê³„ì¸µ êµ¬ì¡° ìë™ ìƒì„±
      - name: ğŸ“‚ Initialize Massive Directory Hierarchy
        run: |
          echo "ğŸ—ï¸ Constructing Infrastructure Tree..."
          
          # ë°ì´í„° ê³„ì¸µ
          mkdir -p $BASE_DATA_DIR/{live_db,archive,logs/audit,logs/error,temp}
          
          # ë°±ì—… ê³„ì¸µ (ê³„ì¸µí™”ëœ ë°±ì—… êµ¬ì¡°)
          mkdir -p $BACKUP_ROOT/{daily,weekly,monthly,encrypted_storage}
          
          # ì„¤ì • ë° ìŠ¤í¬ë¦½íŠ¸ ê³„ì¸µ
          mkdir -p $CONFIG_ROOT/{engine,security,rules}
          mkdir -p $SCRIPTS_ROOT/utils
          mkdir -p bin
          
          # ìºì‹œ ë””ë ‰í† ë¦¬
          mkdir -p $APP_CACHE_DIR
          
          echo "âœ… Directory Tree Created Successfully."
          tree . -d -L 3 || echo "âš ï¸ Tree command not found, skipping visualization."

      # [NEW] 3. ì´ˆê¸° ì„¤ì • íŒŒì¼ ë° ë”ë¯¸ ë°ì´í„° ëŒ€ëŸ‰ ìƒì„± (ì—†ëŠ” ê²½ìš°)
      - name: ğŸ“„ Generate Base Config & Files
        run: |
          # DB ì„¤ì • íŒŒì¼ ìƒì„±
          if [ ! -f "$CONFIG_ROOT/engine/db_conf.json" ]; then
            echo '{"engine": "sqlite3", "mode": "wal", "timeout": 5000}' > "$CONFIG_ROOT/engine/db_conf.json"
          fi
          
          # ë³´ì•ˆ ê·œì¹™ íŒŒì¼ ìƒì„±
          if [ ! -f "$CONFIG_ROOT/rules/firewall.rules" ]; then
            echo "ALLOW 127.0.0.1" > "$CONFIG_ROOT/rules/firewall.rules"
            echo "DENY ALL" >> "$CONFIG_ROOT/rules/firewall.rules"
          fi
          
          # ë¡œê·¸ íŒŒì¼ ì´ˆê¸°í™”
          touch $BASE_DATA_DIR/logs/audit/access.log
          touch $BASE_DATA_DIR/logs/error/error.log

      # [NEW] 4. ì»¤ìŠ¤í…€ ìºì‹œ ì‹œìŠ¤í…œ ì ìš© (ì†ë„ ìµœì í™”)
      - name: ğŸ’¾ Restore Custom Application Cache
        id: cache-restore
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.APP_CACHE_DIR }}
            ~/.cache/pip
          # config í´ë” ë‚´ìš©ì´ ë°”ë€Œë©´ ìºì‹œ ê°±ì‹ 
          key: ${{ runner.os }}-app-v7-${{ hashFiles('config/**') }}
          restore-keys: |
            ${{ runner.os }}-app-v7-

  # 2. ë©”ì¸ ë³´ì•ˆ ë¡œì§ ë° DB ìš´ì˜
  secure-ops-execution:
    needs: init-and-setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # ì´ˆê¸°í™” ë‹¨ê³„ì—ì„œ ìƒì„±ëœ êµ¬ì¡° ë‹¤ì‹œ í™•ì¸ (Gitì— ì—†ì–´ë„ ëŸ°íƒ€ì„ ìƒì„± ë³´ì¥)
      - name: â™»ï¸ Re-Verify Structure
        run: |
          mkdir -p data/{live_db,logs/audit} backup/encrypted_storage config/engine

      - name: ğŸ›¡ï¸ Install Security Tools & Upgrade System
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlcipher libsqlite3-dev tree
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # [PATH í…ŒìŠ¤íŠ¸] ìœ„ì—ì„œ ì¶”ê°€í•œ PATHê°€ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
      - name: ğŸ§ª Verify Environment Path
        run: |
          echo "Testing custom script execution from PATH..."
          # ì„ì‹œ ì‹¤í–‰ íŒŒì¼ ìƒì„±
          echo '#!/bin/bash' > scripts/test_cmd.sh
          echo 'echo "âœ… PATH works! Executed without full path."' >> scripts/test_cmd.sh
          chmod +x scripts/test_cmd.sh
          
          # PATHì— scriptsê°€ ì¶”ê°€ë˜ì—ˆìœ¼ë¯€ë¡œ ./scripts/test_cmd.sh ì—†ì´ ë°”ë¡œ ì‹¤í–‰ ì‹œë„
          # (GitHub Actions í™˜ê²½ ì „íŒŒ ì œí•œìœ¼ë¡œ ì¸í•´ exportê°€ í•„ìš”í•  ìˆ˜ ìˆìŒ. ì—¬ê¸°ì„  ëª…ì‹œì  í˜¸ì¶œ ë³‘í–‰)
          export PATH=$PATH:$(pwd)/scripts
          test_cmd.sh || ./scripts/test_cmd.sh

      - name: ğŸ”„ Auto-Upgrade Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install --upgrade -r requirements.txt
            pip freeze > requirements.txt
          else
            echo "requests" > requirements.txt
            pip install -r requirements.txt
          fi

      # DB ì‘ì—… (ê²½ë¡œ ë³€ìˆ˜ í™œìš©)
      - name: ğŸš€ Run DB Engine
        run: |
          DB_FILE="$BASE_DATA_DIR/grand_ops_secure.db"
          if [ -f scripts/security_db_master.py ]; then
             python scripts/security_db_master.py
          fi
          
          # DB ìµœì í™” (Vacuum)
          if [ -f "$DB_FILE" ]; then
            sqlite3 "$DB_FILE" "VACUUM;"
            sqlite3 "$DB_FILE" "PRAGMA integrity_check;"
          fi

      # [ì•”í˜¸í™”] ëŒ€ëŸ‰ ìƒì„±ëœ ë°±ì—… í´ë” í™œìš©
      - name: ğŸ”’ Encrypt & Move to Storage
        run: |
          DB_FILE="$BASE_DATA_DIR/grand_ops_secure.db"
          TARGET_DIR="$BACKUP_ROOT/encrypted_storage"
          
          if [ -f "$DB_FILE" ]; then
            gpg --batch --yes --passphrase "$SECURE_KEY" -c -o "$TARGET_DIR/secure_db_$(date +%s).gpg" "$DB_FILE"
            echo "âœ… DB Encrypted and stored in $TARGET_DIR"
          fi

      # [ì—…ë¡œë“œ] ì•”í˜¸í™”ëœ í´ë” ì „ì²´ ì—…ë¡œë“œ
      - name: Upload Secured Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: secure-storage-v7
          path: backup/encrypted_storage/
          retention-days: 3

      # [Git Sync] ë³€ê²½ëœ êµ¬ì¡° ë° íŒŒì¼ ë™ê¸°í™”
      - name: ğŸ”„ Smart Git Sync (V7 Structure)
        run: |
          git config --global user.name "Infra-Master-Bot"
          git config --global user.email "bot@infra-v7.com"
          git config --global --add safe.directory $GITHUB_WORKSPACE

          # ìƒˆë¡œ ìƒì„±ëœ ë””ë ‰í† ë¦¬ êµ¬ì¡° ì¤‘ gitkeepì´ í•„ìš”í•œ ë¶€ë¶„ ì²˜ë¦¬ (ë¹ˆ í´ë”ëŠ” gitì— ì•ˆ ì˜¬ë¼ê°€ë¯€ë¡œ)
          find . -type d -empty -not -path "./.git/*" -exec touch {}/.gitkeep \;

          echo "ğŸ“¦ Staging Massive Changes..."
          git add -A
          
          if [ -z "$(git status --porcelain)" ]; then
             echo "âœ… No changes needed."
             exit 0
          fi
          
          echo "ğŸ’¾ Committing Infrastructure Update..."
          git commit -m "infra: v7 structure update & cache init [skip ci]"

          # Retry Logic
          MAX_RETRIES=10
          COUNT=0
          while [ $COUNT -lt $MAX_RETRIES ]; do
            if git pull --rebase origin main; then
                echo "  âœ… Pull successful."
                if git push origin main; then
                    echo "ğŸš€ Push successful!"
                    exit 0
                fi
            else
                git rebase --abort || true
            fi
            sleep 5
            COUNT=$((COUNT+1))
          done
          exit 1
