name: ğŸ” Security DB Master Pipeline V9 (Force Sync Fix)

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_secure.db'
  BACKUP_DIR: 'backup'
  CONFIG_DIR: 'config'

permissions:
  contents: write

jobs:
  infra-provisioning-and-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install bandit
      
      - name: Pre-flight Secret Scan
        run: |
          echo "ğŸ” Starting Secret Scan..."
          # DB íŒŒì¼ê³¼ ë°±ì—… íŒŒì¼ì€ ìŠ¤ìº” ì œì™¸
          if grep -rE "AWS_ACCESS_KEY|PRIVATE_KEY" . \
            --exclude-dir={.git,.github,data,backup,scripts,config} \
            --exclude={*.db,*.bak,*.md,*.sql,*.json} -I; then
            echo "âŒ CRITICAL: Secret found!"
            exit 1
          fi

  db-lifecycle-management:
    needs: infra-provisioning-and-check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false # [FIX] ê¸°ì¡´ ë¡œì»¬ íŒŒì¼ ì‚­ì œ ë°©ì§€

      - name: Fix Git Ownership
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Setup Environment
        run: |
          python -m pip install --upgrade pip
          if [ ! -f requirements.txt ]; then echo "requests" > requirements.txt; fi
          pip install -r requirements.txt

      - name: Run DB Master Engine (V9)
        run: |
           if [ -f scripts/security_db_master.py ]; then
             python scripts/security_db_master.py
           else
             echo "âŒ Error: Master Script Missing!"
             exit 1
           fi

      - name: Generate Audit Report
        run: |
          echo "=== ğŸ©º DB Health Check Report (Force Sync) ===" > audit_log.txt
          date >> audit_log.txt
          if [ -f "$DB_PATH" ]; then
            sqlite3 "$DB_PATH" "PRAGMA integrity_check;" >> audit_log.txt
            echo "ğŸ“Š Dependency Tracked Count:" >> audit_log.txt
            sqlite3 "$DB_PATH" "SELECT count(*) FROM dependency_tracker;" >> audit_log.txt
          fi

      - name: Upload Secure Audit Logs (No DB File)
        uses: actions/upload-artifact@v4
        with:
          name: secure-audit-logs
          path: audit_log.txt
          retention-days: 1

      # [CORE FIX] Force Add Strategy
      - name: Smart Commit & Push (Force Override)
        run: |
          git config --global user.name "DB-Master-Bot"
          git config --global user.email "bot@infra.com"
          
          echo "ğŸ“¦ Staging artifacts (Forcing Ignored Files)..."
          
          # [FIX] .gitignoreì— ìˆì–´ë„ ê°•ì œë¡œ(-f) ì¶”ê°€í•˜ì—¬ ì—ëŸ¬ í•´ê²°
          # DB íŒŒì¼, SQL ìŠ¤ëƒ…ìƒ·, ì„¤ì • íŒŒì¼ë“¤ì„ ê°•ì œë¡œ ì¶”ì 
          git add -f data/*.db data/*.sql config/*.lock config/*.json
          
          # ë³€ê²½ ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ (DB ë°”ì´ë„ˆë¦¬ê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸)
          if [ -z "$(git status --porcelain)" ]; then
             echo "âœ… No changes to commit. Exiting."
             exit 0
          fi
          
          echo "ğŸ’¾ Committing local changes..."
          git commit -m "ops: force sync & dependency update [skip ci]"
          
          # Retry Logic for Push
          MAX_RETRIES=5
          DELAY=5
          COUNT=0
          SUCCESS=false
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ Sync Attempt $((COUNT+1))/$MAX_RETRIES..."
            
            # Rebase ì‹œë„
            if git pull --rebase origin main; then
                echo "  âœ… Pull successful."
            else
                echo "  âš ï¸ Pull failed. Reverting rebase..."
                git rebase --abort || true
                sleep $DELAY
                COUNT=$((COUNT+1))
                continue
            fi
            
            # Push ì‹œë„
            if git push origin main; then
                echo "ğŸš€ Push successful!"
                SUCCESS=true
                break
            else
                echo "  âš ï¸ Push failed. Retrying..."
            fi
            
            COUNT=$((COUNT+1))
            sleep $DELAY
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ Critical: Sync failed after multiple attempts."
            exit 1
          fi
