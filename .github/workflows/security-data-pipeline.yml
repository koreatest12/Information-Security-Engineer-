name: ğŸ” Security DB Master Pipeline V5 (Sync-Fixed)

on:
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ ì£¼ê¸°
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false # [ë³€ê²½] DB ì‘ì—… ì¤‘ë‹¨ ë°©ì§€ë¥¼ ìœ„í•´ falseë¡œ ë³€ê²½ ê¶Œì¥

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_secure.db'
  BACKUP_DIR: 'backup'
  CONFIG_DIR: 'config'

permissions:
  contents: write

jobs:
  # 1. ì¸í”„ë¼ ì¤€ë¹„ ë° ë³´ì•ˆ ê²€ì‚¬ (ê¸°ì¡´ê³¼ ë™ì¼)
  infra-provisioning-and-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Security Tools
        run: pip install bandit

      # [Security] ì½”ë“œ ë³´ì•ˆ ë¶„ì„ (ê²½ê³ ë§Œ ë°œìƒ, ì¤‘ë‹¨ X)
      - name: Run Code Security Analysis
        run: |
          if [ -d "scripts" ]; then
            bandit -r scripts/ -ll || echo "âš ï¸ Bandit Check Finished with warnings"
          fi

      # [Security] ë¹„ë°€í‚¤ ìŠ¤ìº” (ì˜ˆì™¸ ì²˜ë¦¬ ì™„ë²½ ì ìš©)
      - name: Pre-flight Secret Scan
        run: |
          echo "ğŸ” Starting Secret Scan..."
          if grep -rE "AWS_ACCESS_KEY|PRIVATE_KEY|sk_live_[0-9a-zA-Z]+" . \
            --exclude-dir={.git,.github,data,backup,scripts,config} \
            --exclude={*.db,*.bak,*.md,*.sql,*.json} \
            -I; then
            echo "âŒ CRITICAL: Potential secret found!"
            exit 1
          else
            echo "âœ… Secret Check Passed."
          fi

  # 2. DB ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬ ë° ê°•ë ¥í•œ ë™ê¸°í™”
  db-lifecycle-management:
    needs: infra-provisioning-and-check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (Rebase í•„ìˆ˜)

      - name: Fix Git Ownership
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Setup & Provision Environment
        run: |
          echo "ğŸ—ï¸ Provisioning Server Environment..."
          python -m pip install --upgrade pip
          if [ ! -f requirements.txt ]; then echo "requests" > requirements.txt; fi
          pip install -r requirements.txt
          chmod +x scripts/*.py || true

      # DB Master Engine ì‹¤í–‰
      - name: Run DB Master Engine (Migration & Ops)
        run: |
           if [ -f scripts/security_db_master.py ]; then
             python scripts/security_db_master.py
           else
             echo "âŒ Error: Master Script Missing!"
             exit 1
           fi

      # DB ë¬´ê²°ì„± ê²€ì¦
      - name: Validate & Optimize DB
        run: |
          echo "=== ğŸ©º DB Health Check Report ===" > audit_log.txt
          if [ -f "$DB_PATH" ]; then
            sqlite3 "$DB_PATH" "VACUUM;"
            sqlite3 "$DB_PATH" "PRAGMA integrity_check;" >> audit_log.txt
            echo "ğŸ“Š Table Stats:" >> audit_log.txt
            sqlite3 "$DB_PATH" "SELECT count(*) FROM security_logic;" >> audit_log.txt
          fi

      # ë°±ì—… ìƒì„±
      - name: Manage Backups
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          if [ -f "$DB_PATH" ]; then
            cp "$DB_PATH" "$BACKUP_DIR/db_$TIMESTAMP.bak"
          fi
          cd $BACKUP_DIR && ls -t *.bak | tail -n +6 | xargs -r rm --

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: db-snapshot
          path: |
            data/grand_ops_secure.db
            data/schema_snapshot.sql
            config/db_engine_conf.json
          retention-days: 7

      # [CORE UPDATE] ìê°€ ì¹˜ìœ í˜• Git ë™ê¸°í™” ì—”ì§„ (Self-Healing Sync)
      - name: Smart Commit & Push (Retry Logic)
        run: |
          git config --global user.name "DB-Master-Bot"
          git config --global user.email "bot@infra.com"
          
          echo "ğŸ“¦ Staging changes..."
          # ëª¨ë“  ë³€ê²½ ì‚¬í•­(ì‚­ì œ í¬í•¨) ìŠ¤í…Œì´ì§•
          git add -A
          
          # ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
          if [ -z "$(git status --porcelain)" ]; then
             echo "âœ… No changes to commit. Exiting."
             exit 0
          fi
          
          # 1. ë¨¼ì € ë¡œì»¬ ì»¤ë°‹ (ì´ê²ƒì´ í•µì‹¬: Pull ì „ì— ì»¤ë°‹í•´ì•¼ íŒŒì¼ì´ ë³´í˜¸ë¨)
          echo "ğŸ’¾ Committing local changes..."
          git commit -m "ops: auto-provision & migration sync [skip ci]"
          
          # 2. ì¬ì‹œë„ ë£¨í”„ (Retry Loop for Push)
          MAX_RETRIES=5
          DELAY=5
          COUNT=0
          SUCCESS=false
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ Attempting to Sync with Remote (Try $((COUNT+1))/$MAX_RETRIES)..."
            
            # (A) ì›ê²© ë³€ê²½ì‚¬í•­ ê°€ì ¸ì™€ì„œ ë‚´ ì»¤ë°‹ ìœ„ì— ì¬ì •ë ¬ (Rebase)
            # --rebase ì „ëµ: ë‚´ ì»¤ë°‹ì„ ìµœì‹  ì›ê²© ì»¤ë°‹ ë’¤ë¡œ ì˜®ê¹€ (ì¶©ëŒ ìµœì†Œí™”)
            if git pull --rebase origin main; then
                echo "  âœ… Pull successful."
            else
                echo "  âš ï¸ Pull failed (Conflict?). Resetting and retrying..."
                # ì‹¤íŒ¨ ì‹œ Rebase ì¤‘ë‹¨ í›„ ë‹¤ì‹œ ì‹œë„
                git rebase --abort || true
                sleep $DELAY
                COUNT=$((COUNT+1))
                continue
            fi
            
            # (B) í‘¸ì‹œ ì‹œë„
            if git push origin main; then
                echo "ğŸš€ Push successful!"
                SUCCESS=true
                break
            else
                echo "  âš ï¸ Push failed (Non-fast-forward). Retrying..."
            fi
            
            # (C) ì‹¤íŒ¨ ì‹œ ëŒ€ê¸° í›„ ë°˜ë³µ
            COUNT=$((COUNT+1))
            sleep $DELAY
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ Critical: Failed to push changes after $MAX_RETRIES attempts."
            exit 1
          fi
