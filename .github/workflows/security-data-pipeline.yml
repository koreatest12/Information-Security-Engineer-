name: ğŸ” Security DB Master Pipeline V3

on:
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ë§ˆë‹¤ DB ì—…ë°ì´íŠ¸ ë° ë°±ì—…
  workflow_dispatch:      # ê´€ë¦¬ì ìˆ˜ë™ ì‹¤í–‰

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/security_archive.db'
  BACKUP_DIR: 'backup'

permissions:
  contents: write

jobs:
  # 1. ê³ ë„í™”ëœ ì‚¬ì „ ë³´ì•ˆ ê²€ì‚¬
  pre-flight-security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Advanced Secret Scan
        run: |
          echo "ğŸ” Starting Pre-flight Security Scan..."
          # .git, .github, data, backup í´ë”ëŠ” ê²€ì‚¬ ì œì™¸ (ì˜¤íƒ ë°©ì§€)
          if grep -rE "AWS_ACCESS_KEY|PRIVATE_KEY|sk_live_[0-9a-zA-Z]+" . \
            --exclude-dir={.git,.github,data,backup} \
            --exclude=*.db \
            --exclude=*.bak; then
            echo "âŒ CRITICAL: Potential secret found in source code!"
            exit 1
          else
            echo "âœ… Pre-flight Security Check Passed."
          fi

  # 2. DB êµ¬ì¶•, ë°ì´í„° ì ì¬ ë° ë°±ì—…
  database-operations:
    needs: pre-flight-security-check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # [Fix] Git ê¶Œí•œ ë¬¸ì œ ì‚¬ì „ ë°©ì§€ (Dubious Ownership Error Fix)
      - name: Fix Git Permissions
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      # í™˜ê²½ ë° íŒŒì¼ ìê°€ ë³µêµ¬
      - name: Ensure Environment
        run: |
          mkdir -p data backup scripts
          
          if [ ! -f requirements.txt ]; then
            echo "requests>=2.31.0" > requirements.txt
          fi
          
          # ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì„ ê²½ìš° ìë™ ìƒì„± (ì´ì „ ë‹¨ê³„ ëˆ„ë½ ëŒ€ë¹„)
          if [ ! -f scripts/security_db_master.py ]; then
            echo "âš ï¸ Script missing. Creating placeholder to prevent failure..."
            # (ì—¬ê¸°ì— ì‹¤ì œ íŒŒì´ì¬ ì½”ë“œë¥¼ ë„£ì„ ìˆ˜ë„ ìˆìœ¼ë‚˜, íŒŒì¼ì´ ìˆë‹¤ê³  ê°€ì •)
            touch scripts/security_db_master.py 
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # DB ë°±ì—… ìƒì„± (ì‘ì—… ì „ ìŠ¤ëƒ…ìƒ·)
      - name: Create Pre-Job Backup
        run: |
          if [ -f "$DB_PATH" ]; then
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            cp "$DB_PATH" "$BACKUP_DIR/security_archive_$TIMESTAMP.bak"
            
            # ë°±ì—… íŒŒì¼ 5ê°œë§Œ ìœ ì§€ (ìš©ëŸ‰ ê´€ë¦¬)
            cd $BACKUP_DIR
            ls -t *.bak | tail -n +6 | xargs -r rm --
            echo "âœ… Backup created."
          fi

      # DB ë§ˆìŠ¤í„° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Run DB Master Engine
        run: |
           if [ -s scripts/security_db_master.py ]; then
             python scripts/security_db_master.py
           else
             echo "âš ï¸ Script is empty or missing. Skipping execution."
           fi

      # ê°ì‚¬ ë¡œê·¸(Audit Log) ìƒì„±
      - name: Verify & Audit
        run: |
          echo "=== ğŸ›¡ï¸ DB Audit Report ($(date)) ===" > audit_log.txt
          if [ -f "$DB_PATH" ]; then
            # sqlite3 ëª…ë ¹ì–´ê°€ ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ê°€ ë©ˆì¶”ì§€ ì•Šë„ë¡ ì²˜ë¦¬
            sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM security_logic;" >> audit_log.txt || echo "DB Check Skipped"
          else
            echo "âš ï¸ DB File not found." >> audit_log.txt
          fi

      # DB íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload DB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-database
          path: data/security_archive.db
          retention-days: 7

      # [í•µì‹¬ ìˆ˜ì •] ê°•ì œ ì»¤ë°‹ ì ìš© (Force Add)
      - name: Commit DB & Backups
        run: |
          git config --global user.name "SecurityDB-Bot"
          git config --global user.email "bot@db-master.com"
          
          git pull --rebase origin main || true
          
          # [FIX] .gitignoreì— ì˜í•´ ë¬´ì‹œëœ íŒŒì¼ë“¤ì„ ê°•ì œë¡œ(-f) ìŠ¤í…Œì´ì§• ì˜ì—­ì— ì¶”ê°€
          echo "ğŸš€ Force adding database and backups..."
          git add -f data/
          git add -f backup/
          git add audit_log.txt
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸ (Untracked íŒŒì¼ í¬í•¨)
          if [ -z "$(git status --porcelain)" ]; then 
            echo "âœ… Data is up to date (No changes)."
            exit 0
          fi
          
          # íˆìŠ¤í† ë¦¬ ë®ì–´ì“°ê¸° (Amend) ì „ëµ
          LAST_AUTHOR=$(git log -1 --pretty=format:'%an')
          
          if [ "$LAST_AUTHOR" == "SecurityDB-Bot" ]; then
             git commit --amend -m "db(sync): update security archive & backup [skip ci]"
             git push --force origin main
          else
             git commit -m "db(sync): update security archive & backup"
             git push origin main
          fi
