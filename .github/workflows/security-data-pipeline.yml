name: ğŸ” Security DB Master Pipeline V3 (Enhanced)

on:
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/security_archive.db'
  BACKUP_DIR: 'backup'

permissions:
  contents: write

jobs:
  # 1. ê³ ë„í™”ëœ ì‚¬ì „ ë³´ì•ˆ ê²€ì‚¬ ë° ì½”ë“œ ë¬´ê²°ì„± ì²´í¬
  pre-flight-security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # [NEW] Python ì½”ë“œ ë³´ì•ˆ ì·¨ì•½ì  ì •ë°€ ì§„ë‹¨ (Bandit)
      - name: Set up Python for Security Scan
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Security Linters
        run: pip install bandit

      - name: Run Python Security Analysis
        # ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ ìì²´ì˜ ë³´ì•ˆ ì·¨ì•½ì (í•˜ë“œì½”ë”©ëœ ì•”í˜¸ ë“±)ì„ ì „ë¬¸ ë„êµ¬ë¡œ ê²€ì‚¬
        # -ll: ì¤‘ìš”ë„ê°€ ë‚®ì€ ë¡œê·¸ëŠ” ë¬´ì‹œ
        run: |
          if [ -d "scripts" ]; then
            bandit -r scripts/ -ll || echo "âš ï¸ Bandit found issues, please review logs."
          fi

      # [FIXED] ì…¸ ê¸°ë°˜ ì‹œí¬ë¦¿ ìŠ¤ìº” (ì˜¤íƒì§€ ë°©ì§€ ì ìš©)
      - name: Advanced Secret Scan (Shell)
        run: |
          echo "ğŸ” Starting Pre-flight Security Scan..."
          
          # [í•µì‹¬ ìˆ˜ì •] 
          # 1. scripts í´ë” ì œì™¸: ë³€ìˆ˜ëª…ì´ë‚˜ ì •ê·œì‹ íŒ¨í„´ íƒì§€ ë°©ì§€
          # 2. *.md íŒŒì¼ ì œì™¸: ë¬¸ì„œ ë‚´ ì„¤ëª… í…ìŠ¤íŠ¸ íƒì§€ ë°©ì§€
          # 3. grep ì˜µì…˜: -I (ì´ì§„ íŒŒì¼ ë¬´ì‹œ) ì¶”ê°€
          
          if grep -rE "AWS_ACCESS_KEY|PRIVATE_KEY|sk_live_[0-9a-zA-Z]+" . \
            --exclude-dir={.git,.github,data,backup,scripts} \
            --exclude={*.db,*.bak,*.md} \
            -I; then
            
            echo "âŒ CRITICAL: Potential secret found in source code!"
            echo "âš ï¸  Note: scripts/ folder and .md files are excluded to prevent false positives."
            exit 1
          else
            echo "âœ… Pre-flight Security Check Passed."
          fi

  # 2. DB êµ¬ì¶•, ìµœì í™”, ë°ì´í„° ì ì¬ ë° ë°±ì—…
  database-operations:
    needs: pre-flight-security-check
    runs-on: ubuntu-latest
    timeout-minutes: 10 # DB ìµœì í™” ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ëŠ˜ë¦¼

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fix Git Permissions
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Ensure Environment
        run: |
          mkdir -p data backup scripts
          
          if [ ! -f requirements.txt ]; then
            echo "requests>=2.31.0" > requirements.txt
          fi
          
          # ìŠ¤í¬ë¦½íŠ¸ ëˆ„ë½ ë°©ì§€ìš© ë”ë¯¸ íŒŒì¼ ìƒì„± (í•„ìš” ì‹œ)
          if [ ! -f scripts/security_db_master.py ]; then
            echo "print('Running DB Master...')" > scripts/security_db_master.py
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # [Smart Backup] ë³€ê²½ ì „ ìŠ¤ëƒ…ìƒ· (ë¡œí…Œì´ì…˜ ì ìš©)
      - name: Create Pre-Job Backup
        run: |
          if [ -f "$DB_PATH" ]; then
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            cp "$DB_PATH" "$BACKUP_DIR/security_archive_$TIMESTAMP.bak"
            
            # ë°±ì—… íŒŒì¼ 5ê°œë§Œ ìœ ì§€ (ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ)
            cd $BACKUP_DIR
            ls -t *.bak | tail -n +6 | xargs -r rm --
            echo "âœ… Backup rotation completed."
          fi

      # [Core] DB ë§ˆìŠ¤í„° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Run DB Master Engine
        run: |
           if [ -s scripts/security_db_master.py ]; then
             python scripts/security_db_master.py
           else
             echo "âš ï¸ Script is empty or missing."
           fi

      # [NEW] DB ìµœì í™” ë° ë¬´ê²°ì„± ê²€ì¦ (ê°•ë ¥í•œ ê¸°ëŠ¥ ì¶”ê°€)
      - name: Optimize & Verify DB Integrity
        run: |
          echo "=== ğŸ›¡ï¸ DB Health Check ($(date)) ===" > audit_log.txt
          
          if [ -f "$DB_PATH" ]; then
            # 1. VACUUM: DB íŒŒì¼ í¬ê¸° ìµœì í™” ë° ë‹¨í¸í™” ì œê±°
            echo "ğŸ§¹ Running VACUUM (Optimization)..."
            sqlite3 "$DB_PATH" "VACUUM;"
            
            # 2. Integrity Check: ë°ì´í„° ì†ìƒ ì—¬ë¶€ ì •ë°€ ê²€ì‚¬
            echo "ğŸ©º Checking Integrity..."
            INTEGRITY=$(sqlite3 "$DB_PATH" "PRAGMA integrity_check;")
            
            if [ "$INTEGRITY" != "ok" ]; then
              echo "âŒ CRITICAL: DB CORRUPTION DETECTED!" >> audit_log.txt
              echo "The database file is corrupted. Stopping workflow to prevent bad commit."
              exit 1
            else
              echo "âœ… DB Integrity Check: OK" >> audit_log.txt
            fi

            # 3. Record Count
            COUNT=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM security_logic;" 2>/dev/null || echo "0")
            echo "ğŸ“Š Total Security Logic Records: $COUNT" >> audit_log.txt
            
          else
            echo "âš ï¸ DB File not found. Skipping optimization." >> audit_log.txt
          fi

      - name: Upload DB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-database
          path: data/security_archive.db
          retention-days: 7

      # [Update] Git Commit ë¡œì§ (ë¬´í•œ ë£¨í”„ ë°©ì§€ ë° ì•ˆì „í•œ ì»¤ë°‹)
      - name: Commit DB & Backups
        run: |
          git config --global user.name "SecurityDB-Bot"
          git config --global user.email "bot@db-master.com"
          
          git pull --rebase origin main || true
          
          echo "ğŸš€ Staging files..."
          # ê°•ì œ ì¶”ê°€: .gitignore ë¬´ì‹œí•˜ê³  DB íŒŒì¼ í¬í•¨
          git add -f data/security_archive.db
          git add -f backup/*.bak
          git add audit_log.txt
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if [ -z "$(git status --porcelain)" ]; then
             echo "âœ… Data is up to date (No changes detected)."
             exit 0
          fi
          
          # Amend ì „ëµ (ì»¤ë°‹ íˆìŠ¤í† ë¦¬ ê¹”ë”í•˜ê²Œ ìœ ì§€)
          LAST_AUTHOR=$(git log -1 --pretty=format:'%an')
          
          if [ "$LAST_AUTHOR" == "SecurityDB-Bot" ]; then
             echo "ğŸ”„ Amending last bot commit..."
             git commit --amend -m "db(sync): update security archive & backup [skip ci]"
             git push --force origin main
          else
             echo "ğŸ’¾ Creating new commit..."
             git commit -m "db(sync): update security archive & backup"
             git push origin main
          fi
