name: ğŸ” Security DB Master Pipeline V8 (Defense & Dep-Submit)

on:
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ ì£¼ê¸° ì‹¤í–‰
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_secure.db'
  BACKUP_DIR: 'backup'
  CONFIG_DIR: 'config'

permissions:
  contents: write # ë´‡ì´ ì¢…ì†ì„± íŒŒì¼ ë° DBë¥¼ í‘¸ì‹œí•˜ê¸° ìœ„í•´ í•„ìš”

jobs:
  # 1. ì¸í”„ë¼ ì¤€ë¹„, ë³´ì•ˆ ê²€ì‚¬, ì¢…ì†ì„± ë¶„ì„
  infra-provisioning-and-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # [Security] ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ë¦¬ìŠ¤íŠ¸ ë³´ì•ˆ ìŠ¤ìº”
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install bandit
      
      - name: Run Code Security Analysis
        run: |
          if [ -d "scripts" ]; then
            bandit -r scripts/ -ll || echo "âš ï¸ Warning: Issues found but proceeding."
          fi

      - name: Pre-flight Secret Scan
        run: |
          echo "ğŸ” Starting Secret Scan..."
          if grep -rE "AWS_ACCESS_KEY|PRIVATE_KEY" . \
            --exclude-dir={.git,.github,data,backup,scripts,config} \
            --exclude={*.db,*.bak,*.md,*.sql,*.json} -I; then
            echo "âŒ CRITICAL: Secret found!"
            exit 1
          fi

  # 2. DB ì—”ì§„ ì‹¤í–‰ ë° ë‹¤ìš´ë¡œë“œ ì°¨ë‹¨ ë¡œì§
  db-lifecycle-management:
    needs: infra-provisioning-and-check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fix Git Ownership
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Setup Environment
        run: |
          python -m pip install --upgrade pip
          if [ ! -f requirements.txt ]; then echo "requests" > requirements.txt; fi
          pip install -r requirements.txt

      # DB Master Engine ì‹¤í–‰ (ì¢…ì†ì„± ìë™ ì œì¶œ í¬í•¨)
      - name: Run DB Master Engine (V8)
        run: |
           if [ -f scripts/security_db_master.py ]; then
             python scripts/security_db_master.py
           else
             echo "âŒ Error: Master Script Missing!"
             exit 1
           fi

      # DB ë¬´ê²°ì„± ë° í†µê³„ ë¦¬í¬íŠ¸ ìƒì„±
      - name: Generate Audit Report
        run: |
          echo "=== ğŸ©º DB Health Check Report (Secure) ===" > audit_log.txt
          date >> audit_log.txt
          if [ -f "$DB_PATH" ]; then
            sqlite3 "$DB_PATH" "PRAGMA integrity_check;" >> audit_log.txt
            echo "ğŸ“Š Dependency Tracked Count:" >> audit_log.txt
            sqlite3 "$DB_PATH" "SELECT count(*) FROM dependency_tracker;" >> audit_log.txt
          fi

      # [DEFENSE] ì™¸ë¶€ ë‹¤ìš´ë¡œë“œ ì°¨ë‹¨ ì •ì±… ì ìš©
      # DB íŒŒì¼(.db)ì€ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œí•˜ì§€ ì•ŠìŒ -> Actions íƒ­ì—ì„œ ë‹¤ìš´ë¡œë“œ ë¶ˆê°€
      # ì˜¤ì§ ë¡œê·¸ íŒŒì¼ë§Œ í—ˆìš©
      - name: Upload Secure Audit Logs (No DB File)
        uses: actions/upload-artifact@v4
        with:
          name: secure-audit-logs
          path: audit_log.txt
          retention-days: 1 # ìµœì†Œ ë³´ê´€ ê¸°ê°„ ì„¤ì •

      # [CORE] ìê°€ ì¹˜ìœ í˜• Git ë™ê¸°í™” (ì¢…ì†ì„± íŒŒì¼ ìë™ ì»¤ë°‹)
      - name: Smart Commit & Push (Auto-Dependency Submit)
        run: |
          git config --global user.name "DB-Master-Bot"
          git config --global user.email "bot@infra.com"
          
          echo "ğŸ“¦ Staging artifacts..."
          # DB íŒŒì¼, SQL ìŠ¤ëƒ…ìƒ·, ì¢…ì†ì„± íŒŒì¼(Lock/Graph) ëª¨ë‘ ìŠ¤í…Œì´ì§•
          git add data/*.db data/*.sql config/*.lock config/*.json
          
          if [ -z "$(git status --porcelain)" ]; then
             echo "âœ… No changes to commit. Exiting."
             exit 0
          fi
          
          echo "ğŸ’¾ Committing local changes (DB & Dependencies)..."
          git commit -m "ops: auto-provision & dependency snapshot [skip ci]"
          
          # Retry Logic for Push
          MAX_RETRIES=5
          DELAY=5
          COUNT=0
          SUCCESS=false
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ Sync Attempt $((COUNT+1))/$MAX_RETRIES..."
            
            if git pull --rebase origin main; then
                echo "  âœ… Pull successful."
            else
                echo "  âš ï¸ Pull failed. Reverting rebase..."
                git rebase --abort || true
                sleep $DELAY
                COUNT=$((COUNT+1))
                continue
            fi
            
            if git push origin main; then
                echo "ğŸš€ Push successful!"
                SUCCESS=true
                break
            else
                echo "  âš ï¸ Push failed. Retrying..."
            fi
            
            COUNT=$((COUNT+1))
            sleep $DELAY
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ Critical: Sync failed."
            exit 1
          fi
