name: ğŸ” Security DB Master Pipeline V10 (Stash-Fix)

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_secure.db'

permissions:
  contents: write

jobs:
  db-master-ops:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false # ê¸°ì¡´ íŒŒì¼ ë³´ì¡´

      - name: Fix Git Ownership
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Run Ops Engine (V10)
        run: |
          if [ -f scripts/security_db_master.py ]; then
            python scripts/security_db_master.py
          else
            # ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì„ ê²½ìš° ìë™ ìƒì„± (ë³µêµ¬ ëª¨ë“œ)
            echo "âš ï¸ Script missing, creating dummy for continuity..."
            mkdir -p data config
            touch data/grand_ops_secure.db
          fi

      # [DEFENSE] ì™¸ë¶€ ìœ ì¶œ ë°©ì§€: ë¡œê·¸ë§Œ ì—…ë¡œë“œí•˜ê³  DBëŠ” ì œì™¸
      - name: Upload Secure Logs
        uses: actions/upload-artifact@v4
        with:
          name: execution-logs
          path: config/*.sig # ì„œëª… íŒŒì¼ë§Œ ì—…ë¡œë“œ í™•ì¸
          retention-days: 1

      # [CORE FIX] Unstaged Changes Error Solution
      - name: Smart Sync (Stash & Rebase Protocol)
        run: |
          # 1. ë´‡ ê³„ì • ì„¤ì •
          git config --global user.name "DB-Master-Bot"
          git config --global user.email "bot@grand-ops.com"
          
          echo "ğŸ“¦ Staging Critical Assets..."
          # ê°•ì œ ì¶”ê°€ (-f)ë¡œ .gitignore ë¬´ì‹œí•˜ê³  í•µì‹¬ ìì‚° í™•ë³´
          git add -f data/*.db config/*.sig config/*.lock
          
          # ë³€ê²½ì‚¬í•­ ì²´í¬
          if [ -z "$(git status --porcelain)" ]; then
             echo "âœ… No critical changes to sync."
             exit 0
          fi
          
          # 2. ì»¤ë°‹ (ë¡œì»¬ ì €ì¥)
          echo "ğŸ’¾ Committing changes..."
          git commit -m "ops: auto-maintenance & integrity sign [skip ci]"
          
          # 3. [CRITICAL FIX] ì”ì—¬ íŒŒì¼ ì²­ì†Œ (Stash)
          # ì»¤ë°‹ë˜ì§€ ì•Šì€ ë‚˜ë¨¸ì§€ íŒŒì¼ë“¤(ë¡œê·¸, ì„ì‹œ íŒŒì¼ ë“±)ì´ Rebaseë¥¼ ë°©í•´í•˜ì§€ ì•Šë„ë¡ ì¹˜ì›Œë²„ë¦¼
          echo "ğŸ§¹ Stashing leftover debris to allow Clean Rebase..."
          git stash --include-untracked
          
          # 4. ë™ê¸°í™” ë£¨í”„ (Rebase Loop)
          MAX_RETRIES=5
          DELAY=5
          COUNT=0
          SUCCESS=false
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ Sync Attempt $((COUNT+1))/$MAX_RETRIES..."
            
            # ê¹¨ë—í•œ ìƒíƒœì—ì„œ Rebase ì‹œë„
            if git pull --rebase origin main; then
                echo "  âœ… Pull (Rebase) successful."
                
                # Push ì‹œë„
                if git push origin main; then
                    echo "ğŸš€ Push successful!"
                    SUCCESS=true
                    break
                else
                    echo "  âš ï¸ Push failed (Remote moved). Retrying..."
                fi
            else
                echo "  âš ï¸ Rebase failed (Conflict?). Aborting and retrying..."
                git rebase --abort || true
            fi
            
            sleep $DELAY
            COUNT=$((COUNT+1))
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ Sync Failed. Forcing reset to protect local DB next run."
            exit 1
          fi
