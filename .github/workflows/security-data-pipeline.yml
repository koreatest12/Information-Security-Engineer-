name: ğŸ” Security DB Master Pipeline V2

on:
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ë§ˆë‹¤ DB ì—…ë°ì´íŠ¸ ë° ë°±ì—…
  workflow_dispatch:      # ê´€ë¦¬ì ìˆ˜ë™ ì‹¤í–‰

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/security_archive.db'
  BACKUP_DIR: 'backup'

permissions:
  contents: write

jobs:
  # 1. ê³ ë„í™”ëœ ì‚¬ì „ ë³´ì•ˆ ê²€ì‚¬ (Self-Detection ë°©ì§€ ì ìš©)
  pre-flight-security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Advanced Secret Scan (Self-Correction)
        run: |
          echo "ğŸ” Starting Pre-flight Security Scan..."
          
          # [Fix] --exclude-dir={.git,.github} ì¶”ê°€
          # .git(íˆìŠ¤í† ë¦¬)ê³¼ .github(ì›Œí¬í”Œë¡œìš° ì •ì˜ íŒŒì¼)ë¥¼ ì œì™¸í•˜ì—¬ 
          # ê²€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ìê¸° ìì‹ ì„ ìœ ì¶œë¡œ ì˜¤ì§„í•˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
          
          if grep -rE "AWS_ACCESS_KEY|PRIVATE_KEY|sk_live_[0-9a-zA-Z]+" . --exclude-dir={.git,.github} --exclude=*.db; then
            echo "âŒ CRITICAL: Potential secret found in source code!"
            echo "::error::Secrets detected! Pipeline aborted to prevent leakage."
            exit 1
          else
            echo "âœ… Pre-flight Security Check Passed. No plaintext secrets found."
          fi

  # 2. DB êµ¬ì¶•, ë°ì´í„° ì ì¬ ë° ë°±ì—…
  database-operations:
    needs: pre-flight-security-check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # [Upgrade] ì˜ì¡´ì„± ë° ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ìê°€ ë³µêµ¬ (Self-Healing)
      - name: Ensure Environment
        run: |
          # 1. ë°ì´í„° ë° ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p data backup scripts
          
          # 2. requirements.txt ìƒì„±
          if [ ! -f requirements.txt ]; then
            echo "requests>=2.31.0" > requirements.txt
          fi

          # 3. DB Master ìŠ¤í¬ë¦½íŠ¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ì—†ìœ¼ë©´ ì—ëŸ¬)
          if [ ! -f scripts/security_db_master.py ]; then
            echo "âš ï¸ scripts/security_db_master.py not found!"
            echo "Please ensure the python script is committed."
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # [Upgrade] DB ë°±ì—… ìƒì„± (ì‘ì—… ì „ ìŠ¤ëƒ…ìƒ·)
      - name: Create Pre-Job Backup
        run: |
          if [ -f "$DB_PATH" ]; then
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            cp "$DB_PATH" "$BACKUP_DIR/security_archive_$TIMESTAMP.bak"
            
            # ë°±ì—… íŒŒì¼ 5ê°œë§Œ ìœ ì§€í•˜ê³  ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ (ìš©ëŸ‰ ê´€ë¦¬)
            cd $BACKUP_DIR
            ls -t *.bak | tail -n +6 | xargs -r rm --
            echo "âœ… Backup created: security_archive_$TIMESTAMP.bak"
          else
            echo "â„¹ï¸ No existing DB found. Skipping backup."
          fi

      # [í•µì‹¬] DB ë§ˆìŠ¤í„° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Run DB Master Engine
        run: python scripts/security_db_master.py

      # [Upgrade] ë¬´ê²°ì„± ê²€ì¦ ë° ê°ì‚¬ ë¡œê·¸(Audit Log) ìƒì„±
      - name: Verify & Audit
        run: |
          echo "=== ğŸ›¡ï¸ DB Audit Report ($(date)) ===" > audit_log.txt
          
          # í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ ë° ë°ì´í„° ê°œìˆ˜ í™•ì¸
          if [ -f "$DB_PATH" ]; then
            POLICY_COUNT=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM security_logic;")
            RESOURCE_COUNT=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM external_resources;")
            
            echo "ğŸ“Š Policy Records: $POLICY_COUNT" >> audit_log.txt
            echo "ğŸ“Š Resource Records: $RESOURCE_COUNT" >> audit_log.txt
            
            # ìµœê·¼ ì¶”ê°€ëœ ë¦¬ì†ŒìŠ¤ 3ê±´ ì¡°íšŒ
            echo -e "\n[Recent Resources]" >> audit_log.txt
            sqlite3 -header -column "$DB_PATH" "SELECT name, status, latency_ms FROM external_resources ORDER BY id DESC LIMIT 3;" >> audit_log.txt
            
            cat audit_log.txt
          else
            echo "âš ï¸ DB File creation failed!"
            exit 1
          fi

      # [Upgrade] DB íŒŒì¼ì„ GitHub Artifactë¡œ ì—…ë¡œë“œ (ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•˜ê²Œ í•¨)
      - name: Upload DB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-database
          path: data/security_archive.db
          retention-days: 7

      # [ìŠ¤ë§ˆíŠ¸ ì»¤ë°‹] DB ë° ë°±ì—… íŒŒì¼ ì €ì¥
      - name: Commit DB & Backups
        run: |
          git config --global user.name "SecurityDB-Bot"
          git config --global user.email "bot@db-master.com"
          
          git pull --rebase origin main || true
          
          # DB íŒŒì¼, ë°±ì—… í´ë”, ê°ì‚¬ ë¡œê·¸ ì¶”ê°€
          git add data/ backup/ audit_log.txt
          
          if git diff --staged --quiet; then
            echo "âœ… Data is up to date."
            exit 0
          fi
          
          # íˆìŠ¤í† ë¦¬ ë®ì–´ì“°ê¸° (Amend) ì „ëµ ì‚¬ìš©
          LAST_AUTHOR=$(git log -1 --pretty=format:'%an')
          
          if [ "$LAST_AUTHOR" == "SecurityDB-Bot" ]; then
             git commit --amend -m "db(sync): update security archive & backup [skip ci]"
             git push --force origin main
          else
             git commit -m "db(sync): update security archive & backup"
             git push origin main
          fi
