name: ğŸ›¡ï¸ Grand Ops: Auto-Generate, Fix & Deploy

on:
  push:
    branches: [ "**" ]
  schedule:
    - cron: '*/30 * * * *' # 30ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:

permissions:
  contents: write       # íŒŒì¼ ìƒì„± ë° ì»¤ë°‹ ê¶Œí•œ
  security-events: write
  actions: read

jobs:
  # ==================================================================================
  # JOB 1: ğŸ—ï¸ í•„ìˆ˜ íŒŒì¼ ëŒ€ëŸ‰ ìƒì„± ë° í™˜ê²½ ì´ˆê¸°í™” (Initialization)
  # ==================================================================================
  initialize-environment:
    name: 1. Initialize & Fix Permissions
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Generate Essential Project Files (Mass Creation)
        run: |
          echo ">>> ğŸ—ï¸ Project Structure Generation Started..."

          # 1. Frontend Service (Vulnerable Next.js 15.0.0)
          mkdir -p services/frontend
          cat <<EOF > services/frontend/package.json
          {
            "name": "frontend-service",
            "version": "1.0.0",
            "scripts": { "build": "next build" },
            "dependencies": {
              "next": "15.0.0", 
              "react": "19.0.0",
              "react-dom": "19.0.0"
            }
          }
          EOF
          # Frontend í•„ìˆ˜ íŒŒì¼ ìƒì„±
          touch services/frontend/next.config.js
          touch services/frontend/README.md

          # 2. Backend Service (Vulnerable React SSR)
          mkdir -p services/backend
          cat <<EOF > services/backend/package.json
          {
            "name": "backend-api",
            "version": "0.5.0",
            "dependencies": {
              "express": "^4.18.2",
              "react": "19.0.0",
              "react-server-dom-webpack": "19.0.0"
            }
          }
          EOF
          touch services/backend/server.js

          # 3. Admin Panel (Safe Version - For Comparison)
          mkdir -p services/admin
          cat <<EOF > services/admin/package.json
          {
            "name": "admin-panel",
            "version": "2.1.0",
            "dependencies": {
              "next": "15.0.5",
              "react": "19.0.1",
              "react-dom": "19.0.1"
            }
          }
          EOF

          # 4. Scanner Script (Python)
          mkdir -p scripts
          cat <<EOF > scripts/check_vuln.py
          import json, sys, os
          from packaging import version

          def check():
              try:
                  if not os.path.exists("package.json"): return 0
                  with open("package.json") as f: data = json.load(f)
                  deps = data.get("dependencies", {})
                  
                  # ê°„ë‹¨í•œ ì·¨ì•½ ë²„ì „ ì²´í¬ ë¡œì§
                  vuln = False
                  if "react" in deps and deps["react"] == "19.0.0": vuln = True
                  if "next" in deps and deps["next"] == "15.0.0": vuln = True
                  
                  if vuln:
                      print(f"ğŸš¨ VULNERABLE detected in {os.getcwd()}")
                      sys.exit(1) # Fail code
                  else:
                      print(f"âœ… Safe: {os.getcwd()}")
                      sys.exit(0)
              except Exception as e:
                  print(f"âš ï¸ Error: {e}")
                  sys.exit(0)

          if __name__ == "__main__": check()
          EOF

          echo ">>> âœ… All files generated successfully."

      - name: ğŸ” Fix File Permissions (Critical)
        run: |
          echo ">>> ğŸ”§ Fixing Permissions..."
          chmod -R 755 .
          chmod +x scripts/check_vuln.py
          ls -R

      # ìƒì„±ëœ íŒŒì¼ë“¤ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì €ì¥í•˜ì—¬ ë‹¤ìŒ Jobìœ¼ë¡œ ì „ë‹¬
      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: .
          include-hidden-files: true

  # ==================================================================================
  # JOB 2: ğŸš‘ ì„œë¹„ìŠ¤ë³„ ì§„ë‹¨ ë° ìë™ íŒ¨ì¹˜ (Recursive Fix)
  # ==================================================================================
  audit-and-patch:
    name: 2. Recursive Security Audit
    needs: initialize-environment
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: project-files
          path: .

      - name: ğŸ” Restore Permissions
        run: chmod -R 755 .

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install packaging

      - name: ğŸ•µï¸ Find Projects & Auto-Fix
        id: fix_loop
        run: |
          echo "ğŸ” Starting Recursive Scan..."
          
          # package.jsonì´ ìˆëŠ” ëª¨ë“  ë””ë ‰í† ë¦¬ íƒìƒ‰ (node_modules ì œì™¸)
          find . -name "package.json" -not -path "*/node_modules/*" | while read package_file; do
            dir_path=$(dirname "$package_file")
            echo -e "\n---------------------------------------------------"
            echo -e "ğŸ“‚ Processing Service: $dir_path"
            echo -e "---------------------------------------------------"
            
            pushd "$dir_path" > /dev/null
            
            # 1. ê¶Œí•œ ì¬í™•ì¸
            chmod 644 package.json
            
            # 2. íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ì—ëŸ¬ ë¬´ì‹œ ì˜µì…˜ í•„ìˆ˜)
            echo "ğŸ“¦ Installing Dependencies..."
            if [ -f "yarn.lock" ]; then
              yarn install --ignore-engines --silent || echo "âš ï¸ Yarn install warning (Ignored)"
            else
              npm install --legacy-peer-deps --no-audit --silent || echo "âš ï¸ NPM install warning (Ignored)"
            fi

            # 3. ì§„ë‹¨ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            # ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œëŠ” ë£¨íŠ¸ ê¸°ì¤€ ì ˆëŒ€ ê²½ë¡œë¡œ ì°¸ì¡°
            python $GITHUB_WORKSPACE/scripts/check_vuln.py
            EXIT_CODE=$?

            # 4. ì·¨ì•½ì  ë°œê²¬ ì‹œ íŒ¨ì¹˜
            if [ $EXIT_CODE -ne 0 ]; then
              echo "ğŸ”§ Vulnerability found! Applying Patch..."
              
              # ê°•ì œ ì—…ë°ì´íŠ¸ (React 19.0.1, Next 15.0.5 ì•ˆì „ ë²„ì „)
              npm install react@19.0.1 react-dom@19.0.1 next@15.0.5 --save-exact --legacy-peer-deps
              
              echo "âœ… Patch Applied to $dir_path"
            fi
            
            popd > /dev/null
          done

      - name: ğŸ’¾ Commit Changes (Self-Healing)
        run: |
          git config --global user.name "Security Ops Bot"
          git config --global user.email "secops@bot.local"
          
          # ë³€ê²½ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [[ `git status --porcelain` ]]; then
            git add .
            git commit -m "ğŸ›¡ï¸ Auto-Generated & Patched Vulnerable Services"
            git push origin HEAD:${{ github.ref }} || echo "âš ï¸ Push failed (Permission or Branch protection)"
          else
            echo "âœ¨ No changes to commit."
          fi

  # ==================================================================================
  # JOB 3: ğŸš€ ì„œë²„ ì—…ê·¸ë ˆì´ë“œ ì‹œë®¬ë ˆì´ì…˜ (Server Upgrade)
  # ==================================================================================
  server-upgrade:
    name: 3. Server Upgrade & Deploy
    needs: audit-and-patch
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: ğŸ“¡ Check System Status
        run: echo "All Security Checks Passed. Proceeding to Upgrade..."

      - name: ğŸ”„ Rolling Upgrade (Blue/Green)
        run: |
          services=("frontend-service" "backend-api" "admin-panel")
          
          for svc in "${services[@]}"; do
            echo "ğŸš€ Upgrading Service: [$svc]"
            echo "   -> ğŸ›‘ Draining connections..."
            sleep 1
            echo "   -> â¬‡ï¸  Pulling patched artifact..."
            echo "   -> â–¶ï¸  Restarting container..."
            sleep 1
            echo "   -> âœ… [$svc] is now Live (Version: Patched)"
          done

      - name: ğŸ“Š Final Report
        run: |
          echo "### âœ… Security Audit & Upgrade Complete" >> $GITHUB_STEP_SUMMARY
          echo "Files Generated, Permissions Fixed, Vulnerabilities Patched." >> $GITHUB_STEP_SUMMARY
