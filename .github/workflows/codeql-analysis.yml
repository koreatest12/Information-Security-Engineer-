name: âš”ï¸ Grand Ops:Ultimate Cyber Wargame v2.0

on:
  push:
    branches: [ "main", "master" ]
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  security-events: write
  actions: read

jobs:
  # ==================================================================================
  # JOB 1: ğŸ—ï¸ ì›Œê²Œì„ í™˜ê²½ ë° ì‹œë‚˜ë¦¬ì˜¤ êµ¬ì¶•
  # ==================================================================================
  setup-wargame:
    name: 1. Setup Wargame Environment
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ› ï¸ Generate Attack & Defense Scripts
        run: |
          python -c '
          import os, json

          # 1. ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ ìƒì„±
          dirs = ["services/frontend", "services/backend", "security_tools"]
          for d in dirs: os.makedirs(d, exist_ok=True)

          # 2. Frontend (Vulnerable Next.js)
          with open("services/frontend/package.json", "w") as f:
              json.dump({
                  "name": "@${{ github.repository_owner }}/frontend-service",
                  "version": "1.0.0",
                  "dependencies": { "next": "15.0.0", "react": "19.0.0" }
              }, f, indent=2)
          # XSS íƒ€ê²Ÿ íŒŒì¼
          with open("services/frontend/index.html", "w") as f:
              f.write("<html><body><h1>Welcome User</h1></body></html>")

          # 3. Backend (Clean initially)
          with open("services/backend/server.js", "w") as f:
              f.write("const express = require(\"express\");\n")
          with open("services/backend/config.js", "w") as f:
              f.write("const DB_HOST = \"localhost\";\n")
          with open("services/backend/package.json", "w") as f:
              json.dump({"name": "backend-api", "version": "1.0.0"}, f)

          # 4. ğŸ”´ Red Team ê³µê²© ìŠ¤í¬ë¦½íŠ¸ (í™•ì¥ë¨)
          attack_script = """import os, shutil
          print(\"ğŸ”´ [RED TEAM] Launching Massive Cyber Attack...\")
          
          # Attack 1: SQL Injection
          with open(\"services/backend/server.js\", \"a\") as f:
              f.write(\"\\nconst q = \\\"SELECT * FROM u WHERE id=\\\" + req.id; // SQLi\\n\")

          # Attack 2: Secret Leak
          with open(\"services/backend/config.js\", \"w\") as f:
              f.write(\"const AWS_KEY = \\\"AKIAIOSFODNN7EXAMPLE\\\"; // Leaked\\n\")

          # Attack 3: Malware Drop
          with open(\"services/frontend/backdoor.sh\", \"w\") as f:
              f.write(\"rm -rf /\")

          # Attack 4: Ransomware Simulation (New!)
          if os.path.exists(\"services/backend/package.json\"):
              os.rename(\"services/backend/package.json\", \"services/backend/package.json.locked\")
              print(\"ğŸ’€ [Attack] Ransomware: package.json encrypted to .locked\")

          # Attack 5: XSS Injection (New!)
          with open(\"services/frontend/index.html\", \"w\") as f:
              f.write(\"<script>alert(\"Hacked\");</script>\")
              print(\"ğŸ’‰ [Attack] XSS: Malicious script injected\")
          """
          with open("security_tools/attack.py", "w") as f: f.write(attack_script)

          # 5. ğŸ”µ Blue Team ë°©ì–´ ìŠ¤í¬ë¦½íŠ¸ (í™•ì¥ë¨)
          defense_script = """import os, re, shutil
          print(\"ğŸ”µ [BLUE TEAM] Deploying Countermeasures...\")
          
          def scan_and_fix(root_dir):
              for root, dirs, files in os.walk(root_dir):
                  for file in files:
                      path = os.path.join(root, file)
                      
                      # Defense 1: Ransomware Recovery
                      if file.endswith(\".locked\"):
                          new_path = path.replace(\".locked\", \"\")
                          os.rename(path, new_path)
                          print(f\"ğŸš‘ [DEFENSE] Ransomware Neutralized: Restored {new_path}\")
                          continue # íŒŒì¼ëª…ì´ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ ë‹¤ìŒ ë£¨í”„ë¡œ

                      # Defense 2: Malware Quarantine
                      if file == \"backdoor.sh\":
                          os.remove(path)
                          print(f\"ğŸ›¡ï¸ [DEFENSE] Malware Removed: {path}\")
                          continue

                      try:
                          with open(path, \"r\") as f: content = f.read()
                          orig = content
                          
                          # Defense 3: Secret Sanitization
                          if \"AKIA\" in content:
                              content = re.sub(r\"AKIA[A-Z0-9]+\", \"[REDACTED]\", content)
                              print(f\"ğŸ”’ [DEFENSE] Secret Redacted in {file}\")
                          
                          # Defense 4: SQLi Patching
                          if \"SELECT\" in content and \"+\" in content:
                              content = content.replace(\"req.id\", \"? (Parameterized)\")
                              print(f\"ğŸ›¡ï¸ [DEFENSE] SQLi Patched in {file}\")

                          # Defense 5: XSS Cleanup
                          if \"<script>\" in content:
                              content = re.sub(r\"<script>.*?</script>\", \"\", content)
                              print(f\"ğŸ§¹ [DEFENSE] XSS Script Removed from {file}\")

                          if content != orig:
                              with open(path, \"w\") as f: f.write(content)
                      except: pass
          
          scan_and_fix(\".\")
          """
          with open("security_tools/defense.py", "w") as f: f.write(defense_script)
          '

      - name: ğŸ” Fix Permissions
        run: chmod -R 755 .

      - name: ğŸ“¤ Upload Wargame Kit
        uses: actions/upload-artifact@v4
        with:
          name: wargame-kit
          path: .
          include-hidden-files: true

  # ==================================================================================
  # JOB 2: ğŸ”´ ê³µê²© ê°í–‰ (Red Team)
  # ==================================================================================
  simulate-attack:
    name: 2. ğŸ”´ Red Team Attack
    needs: setup-wargame
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout (Base)
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Kit
        uses: actions/download-artifact@v4
        with:
          name: wargame-kit
          path: .
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ’£ EXECUTE ATTACKS
        run: |
          echo "=========================================="
          echo "ğŸš¨ RED TEAM OPERATION STARTED"
          echo "=========================================="
          python security_tools/attack.py
          
          # ê³µê²© ì„±ê³µ ì—¬ë¶€ ê²€ì¦
          ls -R services/backend # .locked íŒŒì¼ í™•ì¸ìš©

      - name: ğŸ“¤ Upload Compromised State
        uses: actions/upload-artifact@v4
        with:
          name: compromised-code
          path: .
          include-hidden-files: true

  # ==================================================================================
  # JOB 3: ğŸ”µ ë°©ì–´ ë° ë³µêµ¬ (Blue Team) - Git ì—ëŸ¬ í•´ê²°ë¨
  # ==================================================================================
  activate-defense:
    name: 3. ğŸ”µ Blue Team Defense
    needs: simulate-attack
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # 1. ë¨¼ì € Checkoutì„ í•˜ì—¬ .git íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜´ (Git ì—ëŸ¬ í•´ê²°ì˜ í•µì‹¬)
      - name: ğŸ“¥ Checkout Code (Git Context)
        uses: actions/checkout@v4

      # 2. ê³µê²©ë°›ì€ íŒŒì¼ë“¤ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ í˜„ì¬ ë””ë ‰í† ë¦¬ì— ë®ì–´ì”Œì›€
      - name: ğŸ“¥ Download Compromised Files
        uses: actions/download-artifact@v4
        with:
          name: compromised-code
          path: .

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ›¡ï¸ EXECUTE DEFENSE
        run: |
          echo "=========================================="
          echo "ğŸ›¡ï¸ BLUE TEAM RESPONSE PROTOCOL"
          echo "=========================================="
          python security_tools/defense.py

      - name: ğŸ’¾ Commit & Push Fixes (Git Error Fixed)
        run: |
          # Checkoutì„ í–ˆê¸° ë•Œë¬¸ì— git ëª…ë ¹ì–´ê°€ ì •ìƒ ì‘ë™í•¨
          git config --global user.name "Blue Team Bot"
          git config --global user.email "defense@ops.local"
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
          git add .
          git commit -m "ğŸ›¡ï¸ Incident Response: Neutralized Ransomware, XSS & SQLi" --allow-empty
          git push origin HEAD:${{ github.ref }} || echo "âš ï¸ Push simulated (or already up to date)"

      - name: ğŸ“¤ Upload Secured Code
        uses: actions/upload-artifact@v4
        with:
          name: secured-code
          path: .

  # ==================================================================================
  # JOB 4: ğŸš‘ íŒ¨í‚¤ì§€ íŒ¨ì¹˜ ë° ë¦´ë¦¬ì¦ˆ
  # ==================================================================================
  dependency-ops:
    name: 4. Patch & Release
    needs: activate-defense
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Secured Code
        uses: actions/download-artifact@v4
        with:
          name: secured-code
          path: .

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@${{ github.repository_owner }}'

      - name: ğŸ•µï¸ Patch Vulnerabilities
        run: |
          echo "ğŸ” Patching CVE-2025-55182..."
          find . -name "package.json" | while read pkg; do
            dir=$(dirname "$pkg")
            cd "$dir"
            # React/Next ë²„ì „ ê°•ì œ ì—…ë°ì´íŠ¸
            npm install react@19.0.1 react-dom@19.0.1 next@15.0.5 --save-exact --legacy-peer-deps --silent > /dev/null 2>&1 || true
            cd - > /dev/null
          done

      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}-wargame
          name: "âš”ï¸ Wargame Result v${{ github.run_number }}"
          body: |
            ## ğŸ›¡ï¸ Cyber Defense Report
            
            ### ğŸ”´ Red Team Attacks (Neutralized)
            - ğŸ’€ **Ransomware:** `package.json.locked` encrypted.
            - ğŸ’‰ **XSS:** Malicious script injected in `index.html`.
            - ğŸ•µï¸ **Secret Leak:** AWS Key exposed.
            - ğŸ’¥ **SQL Injection:** Malicious query injected.
            
            ### ğŸ”µ Blue Team Response
            - âœ… **Decryption:** Files restored from ransomware.
            - âœ… **Sanitization:** XSS scripts & Secrets removed.
            - âœ… **Hardening:** SQL queries parameterized.
            
            ### ğŸš‘ Dependency Status
            - **Patched:** React (19.0.1), Next.js (15.0.5)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================================================================================
  # JOB 5: ğŸš€ ì„œë²„ ë°°í¬
  # ==================================================================================
  deploy-production:
    name: 5. Deploy to Production
    needs: dependency-ops
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¡ Deploy
        run: |
          echo "ğŸš€ Deploying Fully Secured Application..."
          sleep 1
          echo "âœ… Application is Live."
