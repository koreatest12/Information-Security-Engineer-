name: âš”ï¸ Grand Ops:Cyber Attack & Defense Simulation

on:
  push:
    branches: [ "main", "master" ]
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  security-events: write
  actions: read

jobs:
  # ==================================================================================
  # JOB 1: ğŸ—ï¸ ì›Œê²Œì„ í™˜ê²½ êµ¬ì¶• (Wargame Setup)
  # ==================================================================================
  setup-wargame:
    name: 1. Setup Cyber Wargame Env
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ› ï¸ Generate Vulnerable Apps & Attack Scripts
        run: |
          python -c '
          import os, json

          # 1. ë””ë ‰í† ë¦¬ ìƒì„±
          dirs = ["services/frontend", "services/backend", "services/admin", "security_tools"]
          for d in dirs: os.makedirs(d, exist_ok=True)

          # 2. Frontend (Vulnerable Next.js)
          with open("services/frontend/package.json", "w") as f:
              json.dump({
                  "name": "@${{ github.repository_owner }}/frontend-service",
                  "version": "1.0.0",
                  "dependencies": { "next": "15.0.0", "react": "19.0.0" }
              }, f, indent=2)

          # 3. Backend (Clean initially)
          with open("services/backend/server.js", "w") as f:
              f.write("const express = require(\"express\");\nconst app = express();\n")
          
          with open("services/backend/package.json", "w") as f:
              json.dump({"name": "backend-api", "version": "1.0.0"}, f)

          # 4. ğŸ”´ Red Team ê³µê²© ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          attack_script = """import os
          print(\"ğŸ”´ [RED TEAM] Initiating Cyber Attacks...\")
          
          # Attack 1: SQL Injection ì‚½ì…
          with open(\"services/backend/server.js\", \"a\") as f:
              f.write(\"\\n// MALICIOUS CODE INJECTED\\n\")
              f.write(\"const query = \\\"SELECT * FROM users WHERE id = \\\" + req.body.id; // SQLi Vulnerability\\n\")
          print(\"âš ï¸  [Attack] SQL Injection code injected into server.js\")

          # Attack 2: Secret Key ìœ ì¶œ
          with open(\"services/backend/config.js\", \"w\") as f:
              f.write(\"const AWS_KEY = \\\"AKIAIOSFODNN7EXAMPLE\\\"; // Leaked Key\\n\")
          print(\"âš ï¸  [Attack] AWS Access Key leaked in config.js\")

          # Attack 3: Malware Drop
          with open(\"services/frontend/malware.sh\", \"w\") as f:
              f.write(\"rm -rf / --no-preserve-root # Malicious Payload\")
          print(\"âš ï¸  [Attack] Malware dropped: malware.sh\")
          """
          with open("security_tools/attack.py", "w") as f: f.write(attack_script)

          # 5. ğŸ”µ Blue Team ë°©ì–´ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          defense_script = """import os, re
          print(\"ğŸ”µ [BLUE TEAM] Starting Security Scan & Auto-Remediation...\")
          
          def scan_and_fix(root_dir):
              threats_neutralized = 0
              
              for root, dirs, files in os.walk(root_dir):
                  for file in files:
                      path = os.path.join(root, file)
                      
                      # Defense 1: Malware Detection (File Name)
                      if file == \"malware.sh\":
                          os.remove(path)
                          print(f\"ğŸ›¡ï¸  [DEFENSE] Malware Removed: {path}\")
                          threats_neutralized += 1
                          continue
                      
                      try:
                          with open(path, \"r\") as f: content = f.read()
                          original_content = content
                          
                          # Defense 2: Secret Scanning (Regex)
                          if \"AKIA\" in content:
                              content = re.sub(r\"AKIA[A-Z0-9]+\", \"[REDACTED_SECRET]\", content)
                              print(f\"ğŸ›¡ï¸  [DEFENSE] Secret Sanitized in: {path}\")
                          
                          # Defense 3: SQL Injection Detection
                          if \"SELECT * FROM\" in content and \"+\" in content:
                              content = content.replace(\"req.body.id\", \"? (Parameterized)\")
                              content = content.replace(\"// SQLi Vulnerability\", \"// Fixed by Blue Team\")
                              print(f\"ğŸ›¡ï¸  [DEFENSE] SQL Injection Patched in: {path}\")

                          if content != original_content:
                              with open(path, \"w\") as f: f.write(content)
                              threats_neutralized += 1
                      except: pass
                      
              if threats_neutralized > 0:
                  print(f\"âœ… Total Threats Neutralized: {threats_neutralized}\")
                  # exit 0 (Success)
              else:
                  print(\"âœ… System Clean.\")

          scan_and_fix(\".\")
          """
          with open("security_tools/defense.py", "w") as f: f.write(defense_script)
          '

      - name: ğŸ” Fix Permissions
        run: chmod -R 755 .

      - name: ğŸ“¤ Upload Wargame Kit
        uses: actions/upload-artifact@v4
        with:
          name: wargame-kit
          path: .
          include-hidden-files: true

  # ==================================================================================
  # JOB 2: ğŸ”´ ê°€ìƒ ë³´ì•ˆ ê³µê²© ê°í–‰ (Red Team Attack)
  # ==================================================================================
  simulate-attack:
    name: 2. ğŸ”´ Red Team Attack Simulation
    needs: setup-wargame
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Download Wargame Kit
        uses: actions/download-artifact@v4
        with:
          name: wargame-kit
          path: .
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ’£ EXECUTE ATTACKS
        run: |
          echo "=========================================="
          echo "ğŸš¨ SECURITY ALERT: SIMULATED ATTACKS DETECTED"
          echo "=========================================="
          python security_tools/attack.py
          
          echo "ğŸ‘€ Verifying Damage..."
          if [ -f "services/frontend/malware.sh" ]; then echo "âŒ Malware exists!"; fi
          grep "AKIA" services/backend/config.js || true

      - name: ğŸ“¤ Upload Compromised State
        uses: actions/upload-artifact@v4
        with:
          name: compromised-code
          path: .

  # ==================================================================================
  # JOB 3: ğŸ”µ ë³´ì•ˆ ë°©ì–´ ë° ë³µêµ¬ (Blue Team Defense)
  # ==================================================================================
  activate-defense:
    name: 3. ğŸ”µ Blue Team Defense & Response
    needs: simulate-attack
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“¥ Download Compromised Code
        uses: actions/download-artifact@v4
        with:
          name: compromised-code
          path: .

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ›¡ï¸ ACTIVATE DEFENSE PROTOCOLS
        run: |
          echo "=========================================="
          echo "ğŸ›¡ï¸ SECURITY SYSTEM: SCANNING & REMEDIATING"
          echo "=========================================="
          python security_tools/defense.py

      - name: ğŸ” Verify Remediation
        run: |
          echo "ğŸ” Double Checking..."
          if [ ! -f "services/frontend/malware.sh" ]; then echo "âœ… Malware successfully removed."; else echo "âŒ Malware removal failed!"; exit 1; fi
          if grep -q "REDACTED" services/backend/config.js; then echo "âœ… Secrets successfully redacted."; else echo "âŒ Secret leak persists!"; exit 1; fi

      - name: ğŸ’¾ Commit Security Fixes
        run: |
          git config --global user.name "Blue Team Bot"
          git config --global user.email "defense@ops.local"
          git add .
          git commit -m "ğŸ›¡ï¸ Incident Response: Neutralized Red Team Attacks" --allow-empty
          git push origin HEAD:${{ github.ref }} || echo "âš ï¸ Push skipped (Simulated)"

      - name: ğŸ“¤ Upload Secured Code
        uses: actions/upload-artifact@v4
        with:
          name: secured-code
          path: .

  # ==================================================================================
  # JOB 4: ğŸš‘ ì·¨ì•½ì  ì§„ë‹¨ ë° íŒ¨í‚¤ì§€ ë¦´ë¦¬ì¦ˆ (Dependency Ops)
  # ==================================================================================
  dependency-ops:
    name: 4. Dependency Patch & Release
    needs: activate-defense
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: ğŸ“¥ Download Secured Code
        uses: actions/download-artifact@v4
        with:
          name: secured-code
          path: .
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@${{ github.repository_owner }}'

      - name: ğŸ•µï¸ Check & Patch CVEs (React/Next)
        run: |
          echo "ğŸ” Scanning for CVE-2025-55182..."
          # React/Next ì·¨ì•½ì  íŒ¨ì¹˜ ë¡œì§ (ê¸°ì¡´ ê¸°ëŠ¥)
          find . -name "package.json" | while read pkg; do
            dir=$(dirname "$pkg")
            cd "$dir"
            if grep -q "19.0.0" package.json; then
              echo "ğŸ”§ Patching vulnerable dependencies in $dir..."
              npm install react@19.0.1 react-dom@19.0.1 next@15.0.5 --save-exact --legacy-peer-deps --silent > /dev/null 2>&1
            fi
            cd - > /dev/null
          done

      - name: ğŸ“¦ Publish & Tag Release
        run: |
          echo "ğŸš€ Publishing Secure Packages..."
          # ì‹œë®¬ë ˆì´ì…˜: ì‹¤ì œ ë°°í¬ëŠ” ê¶Œí•œ í•„ìš”í•˜ë¯€ë¡œ echoë¡œ ëŒ€ì²´
          echo "npm publish --access public" 
          
      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}-secured
          name: "ğŸ›¡ï¸ Secure Release v${{ github.run_number }}"
          body: |
            ## âš”ï¸ Cyber Wargame Report
            - **Red Team Attacks:** Detected & Neutralized (SQLi, Secrets, Malware)
            - **Dependency Status:** Patched (CVE-2025-55182)
            - **System Status:** ğŸŸ¢ OPERATIONAL
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================================================================================
  # JOB 5: ğŸš€ ìµœì¢… ì„œë²„ ë°°í¬ (Deployment)
  # ==================================================================================
  deploy-production:
    name: 5. Deploy to Production
    needs: dependency-ops
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¡ Deploying Secure Artifacts
        run: |
          echo "âœ… All Security Protocols Passed."
          echo "ğŸš€ Deploying to Production Servers..."
          echo "   -> Updating Containers..."
          echo "   -> Health Check: OK"
          echo "ğŸ‰ Deployment Complete!"
