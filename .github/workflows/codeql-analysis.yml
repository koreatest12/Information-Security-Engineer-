name: ‚öîÔ∏è Grand Ops:Ultimate Cyber Wargame (v4 Stable)

on:
  push:
    branches: [ "**" ]
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

# üöÄ ÎèôÏãúÏÑ± Ï†úÏñ¥: Ï§ëÎ≥µ Ïã§Ìñâ Ïãú Í∏∞Ï°¥ ÏûëÏóÖ Ï∑®ÏÜå
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  security-events: write
  actions: read

jobs:
  # ==================================================================================
  # JOB 1: üèóÔ∏è ÏõåÍ≤åÏûÑ ÌôòÍ≤Ω Íµ¨Ï∂ï & Î≥¥Í≥†ÏÑú ÏãúÏûë
  # ==================================================================================
  setup-wargame:
    name: 1. Setup & Report Init
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üìù Initialize Report
        run: |
          echo "# ‚öîÔ∏è Grand Ops: Cyber Wargame Report" > WARGAME_REPORT.md
          echo "### üìÖ Execution Date: $(date)" >> WARGAME_REPORT.md
          echo "---" >> WARGAME_REPORT.md
          echo "## üèóÔ∏è Phase 1: Environment Setup" >> WARGAME_REPORT.md
          echo "- ‚úÖ Environment Initialized" >> WARGAME_REPORT.md
          echo "- ‚úÖ Python 3.10 & Node.js Ready" >> WARGAME_REPORT.md

      - name: üõ†Ô∏è Generate Logic (Generator)
        run: |
          mkdir -p .github/scripts
          cat << 'EOF' > .github/scripts/generator.py
          import os, json
          
          dirs = ["services/frontend", "services/backend", "services/admin", "security_tools"]
          for d in dirs: os.makedirs(d, exist_ok=True)
          
          # Frontend
          with open("services/frontend/package.json", "w") as f:
              json.dump({"name": "@my-org/frontend", "version": "1.0.0", "dependencies": {"next": "15.0.0", "react": "19.0.0"}}, f, indent=2)
          with open("services/frontend/index.html", "w") as f:
              f.write("<html><body><h1>Welcome to Cyber Range</h1></body></html>")
          
          # Backend
          with open("services/backend/server.js", "w") as f:
              f.write("const express = require('express');\n")
          with open("services/backend/config.js", "w") as f:
              f.write("const DB = 'production';\n")
          with open("services/backend/package.json", "w") as f:
              json.dump({"name": "backend-api", "version": "1.0.0"}, f)

          # Attack Tools
          with open("security_tools/attack.py", "w") as f:
              f.write("""import os, sys
          log = []
          def log_msg(msg):
              print(msg)
              log.append(msg)
          
          log_msg('üî¥ [RED TEAM] Launching Attacks...')
          # SQL Injection
          with open('services/backend/server.js', 'a') as f:
              f.write('\\nconst q = \"SELECT * FROM u WHERE id=\" + req.id; // SQLi\\n')
          log_msg('- üíâ Injected SQLi vulnerability')
          
          # Ransomware
          if os.path.exists('services/backend/package.json'):
              os.rename('services/backend/package.json', 'services/backend/package.json.locked')
              log_msg('- üíÄ Executed Ransomware (package.json locked)')
          
          # XSS
          with open('services/frontend/index.html', 'w') as f:
              f.write('<script>alert(\"Hacked\");</script>')
          log_msg('- üï∏Ô∏è Injected XSS payload')

          # Save Log for Report
          with open('attack_summary.txt', 'w') as f:
              f.write('\\n'.join(log))
          """)

          # Defense Tools
          with open("security_tools/defense.py", "w") as f:
              f.write("""import os, re
          log = []
          def log_msg(msg):
              print(msg)
              log.append(msg)

          log_msg('üîµ [BLUE TEAM] Defense Protocol Initiated...')
          def scan(root_dir):
              for root, dirs, files in os.walk(root_dir):
                  for file in files:
                      path = os.path.join(root, file)
                      # Anti-Ransomware
                      if file.endswith('.locked'):
                          new = path.replace('.locked', '')
                          os.rename(path, new)
                          log_msg(f'- üöë Restored Ransomware file: {file}')
                          continue
                      
                      try:
                          with open(path, 'r') as f: content = f.read()
                          orig = content
                          
                          # SQLi Patch
                          if 'SELECT' in content and '+' in content:
                              content = content.replace('req.id', '?')
                              log_msg(f'- üõ°Ô∏è Patched SQL Injection in {file}')
                          # XSS Clean
                          if '<script>' in content:
                              content = re.sub(r'<script>.*?</script>', '', content)
                              log_msg(f'- üßπ Removed XSS from {file}')
                              
                          if content != orig:
                              with open(path, 'w') as f: f.write(content)
                      except: pass
          scan('.')
          with open('defense_summary.txt', 'w') as f:
              f.write('\\n'.join(log))
          """)
          EOF
          python .github/scripts/generator.py

      - name: üóúÔ∏è Compress State (v4 Optimized)
        # Ï§ëÏöî: v4ÏóêÏÑúÎèÑ ÌååÏùº Í∞úÏàòÍ∞Ä ÎßéÏúºÎ©¥ ÎäêÎ†§ÏßÄÎØÄÎ°ú ÏïïÏ∂ï ÌïÑÏàò
        # WARGAME_REPORT.md ÌååÏùºÎèÑ Ìï®Íªò ÏïïÏ∂ï
        run: |
          tar --exclude='.git' --exclude='.github' --exclude='node_modules' -czf game_state_v1.tar.gz services security_tools WARGAME_REPORT.md

      - name: üì§ Upload Artifact (v4)
        uses: actions/upload-artifact@v4
        with:
          name: game-state-v1
          path: game_state_v1.tar.gz
          retention-days: 1

  # ==================================================================================
  # JOB 2: üî¥ Í≥µÍ≤© Î∞è Î≥¥Í≥†ÏÑú ÏóÖÎç∞Ïù¥Ìä∏
  # ==================================================================================
  simulate-attack:
    name: 2. üî¥ Red Team Attack
    needs: setup-wargame
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: üì• Download State (v4)
        uses: actions/download-artifact@v4
        with:
          name: game-state-v1
          path: .

      - name: üìÇ Extract State
        run: tar -xzf game_state_v1.tar.gz && rm game_state_v1.tar.gz

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: üí£ EXECUTE ATTACKS
        run: python security_tools/attack.py

      - name: üìù Update Report
        run: |
          echo "" >> WARGAME_REPORT.md
          echo "## üî¥ Phase 2: Red Team Operations" >> WARGAME_REPORT.md
          echo "```text" >> WARGAME_REPORT.md
          cat attack_summary.txt >> WARGAME_REPORT.md
          echo "```" >> WARGAME_REPORT.md
          rm attack_summary.txt

      - name: üì¶ Re-Archive
        run: tar -czf game_state_v2.tar.gz services security_tools WARGAME_REPORT.md

      - name: üì§ Upload Artifact (v4)
        uses: actions/upload-artifact@v4
        with:
          name: game-state-v2
          path: game_state_v2.tar.gz

  # ==================================================================================
  # JOB 3: üîµ Î∞©Ïñ¥, Î≥µÍµ¨ Î∞è Î≥¥Í≥†ÏÑú Ï†ÄÏû• (Git Push)
  # ==================================================================================
  activate-defense:
    name: 3. üîµ Blue Team & Report Save
    needs: simulate-attack
    runs-on: ubuntu-latest
    permissions:
      contents: write # Î¶¨Ìè¨Ìä∏ Ïª§Î∞ãÏùÑ ÏúÑÌïú Í∂åÌïú
    steps:
      - name: üì• Checkout (For Git Push)
        uses: actions/checkout@v4

      - name: üì• Download Compromised State (v4)
        uses: actions/download-artifact@v4
        with:
          name: game-state-v2
          path: workspace

      - name: üìÇ Extract & Restore
        run: |
          tar -xzf workspace/game_state_v2.tar.gz
          rm -rf workspace

      - name: üõ°Ô∏è EXECUTE DEFENSE
        run: python security_tools/defense.py

      - name: üìù Finalize Report
        run: |
          echo "" >> WARGAME_REPORT.md
          echo "## üîµ Phase 3: Blue Team Response" >> WARGAME_REPORT.md
          echo "```text" >> WARGAME_REPORT.md
          cat defense_summary.txt >> WARGAME_REPORT.md
          echo "```" >> WARGAME_REPORT.md
          echo "---" >> WARGAME_REPORT.md
          echo "**Status:** ‚úÖ System Secured & Recovered" >> WARGAME_REPORT.md
          rm defense_summary.txt

      - name: üíæ Commit Report to Repo
        # ÏöîÏ≤≠ÌïòÏã† ÎåÄÎ°ú .github/workflows Í≤ΩÎ°úÏóê Î≥¥Í≥†ÏÑú Ï†ÄÏû•
        run: |
          git config --global user.name "Grand Ops Bot"
          git config --global user.email "bot@grandops.local"
          
          # Î≥¥Í≥†ÏÑú Ï†ÄÏû• ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
          mkdir -p .github/workflows/reports
          
          # ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÍ∞Ä Ï∞çÌûå ÌååÏùºÎ™ÖÏúºÎ°ú Ïù¥Îèô
          REPORT_NAME="Wargame_Report_${{ github.run_number }}.md"
          mv WARGAME_REPORT.md .github/workflows/reports/$REPORT_NAME
          
          # ÏÜåÏä§ ÏΩîÎìú Î≥µÍµ¨ Î∞è Î¶¨Ìè¨Ìä∏ Ïª§Î∞ã
          git add .
          
          # [skip ci]Î•º Ï∂îÍ∞ÄÌïòÏó¨ Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ
          git commit -m "üìù Add Wargame Report #${{ github.run_number }} [skip ci]" --allow-empty
          git push origin HEAD:${{ github.ref }}

      - name: üì¶ Archive Secured State
        run: tar -czf game_state_v3.tar.gz services security_tools

      - name: üì§ Upload Secured State (v4)
        uses: actions/upload-artifact@v4
        with:
          name: game-state-v3
          path: game_state_v3.tar.gz

  # ==================================================================================
  # JOB 4: üöë Ìå®Ïπò Î∞è Î¶¥Î¶¨Ï¶à
  # ==================================================================================
  dependency-ops:
    name: 4. Patch & Release
    needs: activate-defense
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: üì• Download Secured State
        uses: actions/download-artifact@v4
        with:
          name: game-state-v3
          path: workspace
      
      - name: üìÇ Extract
        run: tar -xzf workspace/game_state_v3.tar.gz

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üïµÔ∏è Patch Vulnerabilities
        run: |
          find services -name "package.json" | while read pkg; do
            dir=$(dirname "$pkg")
            cd "$dir"
            if [ -f "package.json" ]; then
               npm install --no-audit --no-fund --package-lock-only || true
            fi
            cd - > /dev/null
          done

      - name: üè∑Ô∏è Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}-stable
          name: "üõ°Ô∏è Stable Release v${{ github.run_number }}"
          body: "See .github/workflows/reports/Wargame_Report_${{ github.run_number }}.md for details."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
