name: âš”ï¸ Grand Ops: Ultimate Cyber Wargame (Stable)

on:
  push:
    branches: [ "**" ]
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

# ğŸš€ ë™ì‹œì„± ì œì–´: ë™ì¼ ë¸Œëœì¹˜ ì¤‘ë³µ ì‹¤í–‰ ì‹œ ê¸°ì¡´ ì‘ì—… ì·¨ì†Œ (ì˜¤ë¥˜ ë° ìì› ë‚­ë¹„ ë°©ì§€)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  security-events: write
  actions: read

env:
  ARTIFACT_NAME: wargame-state-archive

jobs:
  # ==================================================================================
  # JOB 1: ğŸ—ï¸ ì›Œê²Œì„ í™˜ê²½ êµ¬ì¶• (Setup)
  # ==================================================================================
  setup-wargame:
    name: 1. Setup Wargame Env
    runs-on: ubuntu-latest
    timeout-minutes: 5 # ë¬´í•œ ëŒ€ê¸° ë°©ì§€
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4 # v4ê°€ Python setupì—ì„œëŠ” ì•ˆì •ì 
        with:
          python-version: '3.10'

      - name: ğŸ› ï¸ Generate Logic (Generator)
        run: |
          mkdir -p .github/scripts
          # ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
          cat << 'EOF' > .github/scripts/generator.py
          import os, json
          
          # ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
          dirs = ["services/frontend", "services/backend", "services/admin", "security_tools"]
          for d in dirs: os.makedirs(d, exist_ok=True)
          
          # Frontend (Next.js Dummy)
          with open("services/frontend/package.json", "w") as f:
              json.dump({"name": "@my-org/frontend", "version": "1.0.0", "dependencies": {"next": "15.0.0", "react": "19.0.0"}}, f, indent=2)
          with open("services/frontend/index.html", "w") as f:
              f.write("<html><body><h1>Welcome to Cyber Range</h1></body></html>")
          
          # Backend (Express Dummy)
          with open("services/backend/server.js", "w") as f:
              f.write("const express = require('express');\n")
          with open("services/backend/config.js", "w") as f:
              f.write("const DB = 'production';\n")
          with open("services/backend/package.json", "w") as f:
              json.dump({"name": "backend-api", "version": "1.0.0"}, f)

          # Attack Script (Red Team)
          with open("security_tools/attack.py", "w") as f:
              f.write("""import os
          print('ğŸ”´ [RED TEAM] Launching Attacks...')
          # SQL Injection
          with open('services/backend/server.js', 'a') as f:
              f.write('\\nconst q = \"SELECT * FROM u WHERE id=\" + req.id; // SQLi\\n')
          # Secret Leak
          with open('services/backend/config.js', 'w') as f:
              f.write('const AWS_KEY = \"AKIAIOSFODNN7EXAMPLE\"; // Leaked\\n')
          # Ransomware Simulation
          if os.path.exists('services/backend/package.json'):
              os.rename('services/backend/package.json', 'services/backend/package.json.locked')
              print('ğŸ’€ [Attack] Ransomware Encrypted package.json')
          # XSS
          with open('services/frontend/index.html', 'w') as f:
              f.write('<script>alert(\"Hacked\");</script>')
          """)

          # Defense Script (Blue Team)
          with open("security_tools/defense.py", "w") as f:
              f.write("""import os, re
          print('ğŸ”µ [BLUE TEAM] Defense Protocol Initiated...')
          def scan(root_dir):
              for root, dirs, files in os.walk(root_dir):
                  for file in files:
                      path = os.path.join(root, file)
                      # Anti-Ransomware
                      if file.endswith('.locked'):
                          new = path.replace('.locked', '')
                          os.rename(path, new)
                          print(f'ğŸš‘ Restored: {new}')
                          continue
                      try:
                          with open(path, 'r') as f: content = f.read()
                          orig = content
                          # Secret Sanitization
                          if 'AKIA' in content:
                              content = re.sub(r'AKIA[A-Z0-9]+', '[REDACTED]', content)
                          # SQLi Patch
                          if 'SELECT' in content and '+' in content:
                              content = content.replace('req.id', '?')
                          # XSS Clean
                          if '<script>' in content:
                              content = re.sub(r'<script>.*?</script>', '', content)
                          if content != orig:
                              with open(path, 'w') as f: f.write(content)
                              print(f'ğŸ›¡ï¸ Secured: {file}')
                      except: pass
          scan('.')
          """)
          EOF
          
          # ì‹¤í–‰
          python .github/scripts/generator.py

      - name: ğŸ—œï¸ Compress Game State (Tarball Strategy)
        # [í•µì‹¬] íŒŒì¼ ê°œìˆ˜ì™€ ê´€ê³„ì—†ì´ ë‹¨ì¼ íŒŒì¼ë¡œ ì••ì¶•í•˜ì—¬ ì—…ë¡œë“œ ì‹¤íŒ¨ í™•ë¥  99% ì œê±°
        # .git ë“± ë¶ˆí•„ìš”í•œ ì‹œìŠ¤í…œ íŒŒì¼ ì œì™¸
        run: |
          tar --exclude='.git' --exclude='.github' --exclude='node_modules' -czf game_state.tar.gz services security_tools

      - name: ğŸ“¤ Upload Wargame Kit (Stable v3)
        # v4 ëŒ€ì‹  ì•ˆì •ì ì¸ v3 ì‚¬ìš©
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: game_state.tar.gz
          retention-days: 1

  # ==================================================================================
  # JOB 2: ğŸ”´ ê³µê²© ê°í–‰ (Red Team)
  # ==================================================================================
  simulate-attack:
    name: 2. ğŸ”´ Red Team Attack
    needs: setup-wargame
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Download Game State (Stable v3)
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: workspace # ë³„ë„ í´ë”ì— ë‹¤ìš´ë¡œë“œ (ì¶©ëŒ ë°©ì§€)

      - name: ğŸ“‚ Extract Game State
        run: |
          if [ -f "workspace/game_state.tar.gz" ]; then
            tar -xzf workspace/game_state.tar.gz
            echo "âœ… Game state loaded."
          else
            echo "âŒ Artifact Download Failed!"
            exit 1
          fi

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ’£ EXECUTE ATTACKS
        run: |
          echo "ğŸš¨ RED TEAM ATTACK START"
          python security_tools/attack.py

      - name: ğŸ“¦ Re-Archive Compromised State
        run: tar -czf compromised_state.tar.gz services security_tools

      - name: ğŸ“¤ Upload Compromised State
        uses: actions/upload-artifact@v3
        with:
          name: compromised-state
          path: compromised_state.tar.gz

  # ==================================================================================
  # JOB 3: ğŸ”µ ë°©ì–´ ë° ë³µêµ¬ (Blue Team)
  # ==================================================================================
  activate-defense:
    name: 3. ğŸ”µ Blue Team Defense
    needs: simulate-attack
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      # Git Historyë¥¼ ìœ„í•´ Checkout í•„ìš”
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Compromised State (Stable v3)
        uses: actions/download-artifact@v3
        with:
          name: compromised-state
          path: workspace

      - name: ğŸ“‚ Extract Compromised Files
        run: |
          # ê¸°ì¡´ íŒŒì¼ ìœ„ì— ë®ì–´ì“°ê¸° (workspace í´ë”ì—ì„œ êº¼ë‚´ì˜´)
          tar -xzf workspace/compromised_state.tar.gz
          rm -rf workspace

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ›¡ï¸ EXECUTE DEFENSE
        run: |
          echo "ğŸ›¡ï¸ BLUE TEAM DEFENSE START"
          python security_tools/defense.py

      - name: ğŸ’¾ Commit & Push Fixes
        run: |
          git config --global user.name "Blue Team Bot"
          git config --global user.email "defense@ops.local"
          git add .
          git commit -m "ğŸ›¡ï¸ Incident Response: System Secured" --allow-empty
          git push origin HEAD:${{ github.ref }} || echo "âš ï¸ Push skipped (Simulated)"

      - name: ğŸ“¦ Archive Secured State
        run: tar -czf secured_state.tar.gz services security_tools

      - name: ğŸ“¤ Upload Secured Code
        uses: actions/upload-artifact@v3
        with:
          name: secured-state
          path: secured_state.tar.gz

  # ==================================================================================
  # JOB 4: ğŸš‘ íŒ¨í‚¤ì§€ íŒ¨ì¹˜ ë° ë¦´ë¦¬ì¦ˆ
  # ==================================================================================
  dependency-ops:
    name: 4. Patch & Release
    needs: activate-defense
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: ğŸ“¥ Download Secured State (Stable v3)
        uses: actions/download-artifact@v3
        with:
          name: secured-state
          path: workspace
      
      - name: ğŸ“‚ Extract Secured Files
        run: tar -xzf workspace/secured_state.tar.gz

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3 # v3ê°€ í˜¸í™˜ì„±ì´ ë” ì¢‹ì„ ìˆ˜ ìˆìŒ
        with:
          node-version: '20'

      - name: ğŸ•µï¸ Patch Vulnerabilities
        run: |
          echo "ğŸ” Patching Dependencies..."
          # ì•„í‹°íŒ©íŠ¸ë¡œ node_modulesë¥¼ ì˜®ê¸°ì§€ ì•Šê³  ì—¬ê¸°ì„œ ì‹ ê·œ ì„¤ì¹˜ (ê°€ì¥ í™•ì‹¤í•¨)
          find services -name "package.json" | while read pkg; do
            dir=$(dirname "$pkg")
            cd "$dir"
            if [ -f "package.json" ]; then
               echo "Installing in $dir"
               # --no-audit ë“±ìœ¼ë¡œ ì†ë„ í–¥ìƒ ë° ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ìµœì†Œí™”
               npm install --no-audit --no-fund --package-lock-only || true
            fi
            cd - > /dev/null
          done

      - name: ğŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}-stable
          name: "ğŸ›¡ï¸ Stable Release v${{ github.run_number }}"
          body: "Auto-generated secure release."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================================================================================
  # JOB 5: ğŸš€ ì„œë²„ ë°°í¬ (Simulation)
  # ==================================================================================
  deploy-production:
    name: 5. Deploy to Production
    needs: dependency-ops
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¡ Deploy Signal
        run: echo "ğŸš€ Deploying Fully Secured Application to Production Cluster..."
