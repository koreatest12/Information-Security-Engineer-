name: âš”ï¸ Grand Ops:Ultimate Cyber Wargame (Stable)

on:
  push:
    branches: [ "**" ]
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  security-events: write
  actions: read

jobs:
  # ==================================================================================
  # JOB 1: ğŸ—ï¸ ì›Œê²Œì„ í™˜ê²½ êµ¬ì¶• (Setup)
  # ==================================================================================
  setup-wargame:
    name: 1. Setup Wargame Env
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ› ï¸ Generate Logic (Shared Script)
        # ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•˜ì—¬ í›„ì† Jobì—ì„œë„ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ í•¨
        run: |
          mkdir -p .github/scripts
          cat << 'EOF' > .github/scripts/generator.py
          import os, json
          # 1. ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
          dirs = ["services/frontend", "services/backend", "services/admin", "security_tools"]
          for d in dirs: os.makedirs(d, exist_ok=True)
          # 2. Frontend (Vulnerable Next.js)
          with open("services/frontend/package.json", "w") as f:
              json.dump({
                  "name": "@my-org/frontend-service",
                  "version": "1.0.0",
                  "dependencies": { "next": "15.0.0", "react": "19.0.0" }
              }, f, indent=2)
          with open("services/frontend/index.html", "w") as f:
              f.write("<html><body><h1>Welcome</h1></body></html>")
          # 3. Backend
          with open("services/backend/server.js", "w") as f:
              f.write("const express = require('express');\n")
          with open("services/backend/config.js", "w") as f:
              f.write("const DB = 'production';\n")
          with open("services/backend/package.json", "w") as f:
              json.dump({"name": "backend-api", "version": "1.0.0"}, f)
          # 4. ê³µê²© ìŠ¤í¬ë¦½íŠ¸ (Red Team)
          with open("security_tools/attack.py", "w") as f:
              f.write("""import os, time
          print('ğŸ”´ [RED TEAM] Launching Attacks...')
          
          # SQL Injection
          with open('services/backend/server.js', 'a') as f:
              f.write('\\nconst q = \"SELECT * FROM u WHERE id=\" + req.id; // SQLi\\n')
          # Secret Leak
          with open('services/backend/config.js', 'w') as f:
              f.write('const AWS_KEY = \"AKIAIOSFODNN7EXAMPLE\"; // Leaked\\n')
          # Malware
          with open('services/frontend/backdoor.sh', 'w') as f:
              f.write('rm -rf /')
          # Ransomware
          if os.path.exists('services/backend/package.json'):
              os.rename('services/backend/package.json', 'services/backend/package.json.locked')
              print('ğŸ’€ [Attack] Ransomware Encrypted package.json')
          # XSS
          with open('services/frontend/index.html', 'w') as f:
              f.write('<script>alert(\"Hacked\");</script>')
          """)
          # 5. ë°©ì–´ ìŠ¤í¬ë¦½íŠ¸ (Blue Team)
          with open("security_tools/defense.py", "w") as f:
              f.write("""import os, re, shutil
          print('ğŸ”µ [BLUE TEAM] Defense Protocol Initiated...')
          def scan(root_dir):
              for root, dirs, files in os.walk(root_dir):
                  for file in files:
                      path = os.path.join(root, file)
                      # Anti-Ransomware
                      if file.endswith('.locked'):
                          new = path.replace('.locked', '')
                          os.rename(path, new)
                          print(f'ğŸš‘ Restored: {new}')
                          continue
                      
                      # Anti-Malware
                      if file == 'backdoor.sh':
                          os.remove(path)
                          print(f'ğŸ›¡ï¸ Deleted Malware: {path}')
                          continue
                      
                      try:
                          with open(path, 'r') as f: content = f.read()
                          orig = content
                          
                          # Secret Sanitization
                          if 'AKIA' in content:
                              content = re.sub(r'AKIA[A-Z0-9]+', '[REDACTED]', content)
                              print(f'ğŸ”’ Secret Redacted in {file}')
                          # SQLi Patch
                          if 'SELECT' in content and '+' in content:
                              content = content.replace('req.id', '?')
                              print(f'ğŸ›¡ï¸ SQLi Patched in {file}')
                          # XSS Clean
                          if '<script>' in content:
                              content = re.sub(r'<script>.*?</script>', '', content)
                              print(f'ğŸ§¹ XSS Removed from {file}')
                          if content != orig:
                              with open(path, 'w') as f: f.write(content)
                      except: pass
          scan('.')
          """)
          EOF
          
          # ìƒì„±ê¸° ì‹¤í–‰
          python .github/scripts/generator.py
      - name: ğŸ” Fix Permissions
        run: chmod -R 755 .

      - name: ğŸ“¤ Upload Wargame Kit (Reliable Upload)
        uses: actions/upload-artifact@v4
        with:
          name: wargame-kit
          path: .
          include-hidden-files: true
          compression-level: 0 # ì••ì¶• ì—†ì´ ë¹ ë¥´ê²Œ ì—…ë¡œë“œí•˜ì—¬ ì˜¤ë¥˜ ê°ì†Œ

  # ==================================================================================
  # JOB 2: ğŸ”´ ê³µê²© ê°í–‰ (Red Team) - Fallback ë¡œì§ ì¶”ê°€ë¨
  # ==================================================================================
  simulate-attack:
    name: 2. ğŸ”´ Red Team Attack
    needs: setup-wargame
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â³ Wait for Storage Consistency
        run: sleep 5 # ì•„í‹°íŒ©íŠ¸ ì €ì¥ì†Œ ë™ê¸°í™”ë¥¼ ìœ„í•œ ëŒ€ê¸°

      - name: ğŸ“¥ Download Kit (With Fallback)
        id: download
        uses: actions/download-artifact@v4
        with:
          name: wargame-kit
          path: .
        continue-on-error: true # ì‹¤íŒ¨í•´ë„ ë©ˆì¶”ì§€ ì•ŠìŒ

      - name: ğŸš‘ Fallback Generation (If Download Fails)
        if: steps.download.outcome == 'failure'
        run: |
          echo "âš ï¸ Artifact download failed! Regenerating Wargame Kit locally..."
          # Job 1ì—ì„œ ë§Œë“  ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë‹¤ì‹œ ë§Œë“­ë‹ˆë‹¤ (ì™„ì „í•œ ìê°€ ì¹˜ìœ )
          mkdir -p .github/scripts
          # (ìœ„ì™€ ë™ì¼í•œ generator ì½”ë“œë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ê±°ë‚˜, Checkoutëœ ì½”ë“œì— ìˆë‹¤ë©´ ì‹¤í–‰)
          # ì—¬ê¸°ì„œëŠ” Checkoutëœ ì½”ë“œì— .github/scripts/generator.pyê°€ ì—†ìœ¼ë¯€ë¡œ ê°„ì†Œí™”ëœ ìƒì„± ë¡œì§ ì‹¤í–‰
          python -c "import os; dirs=['services/frontend','services/backend','security_tools']; [os.makedirs(d, exist_ok=True) for d in dirs]"
          # ê³µê²©/ë°©ì–´ íˆ´ ê°•ì œ ìƒì„± (íŒŒì¼ ë³µêµ¬)
          echo "print('ğŸ”´ Fallback Attack')" > security_tools/attack.py
          echo "print('ğŸ”µ Fallback Defense')" > security_tools/defense.py
          # ì‹¤ì œë¡œëŠ” checkoutëœ ë ˆí¬ì§€í† ë¦¬ì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì»¤ë°‹í•´ë‘ëŠ” ê²ƒì´ ê°€ì¥ ì¢‹ìœ¼ë‚˜, 
          # ì—¬ê¸°ì„œëŠ” ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ê°„ë‹¨í•œ íŒŒì¼ì„ ìƒì„±í•˜ì—¬ íë¦„ì„ ìœ ì§€í•¨.
          touch services/backend/server.js
          touch services/frontend/index.html
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ’£ EXECUTE ATTACKS
        run: |
          echo "=========================================="
          echo "ğŸš¨ RED TEAM OPERATION STARTED"
          echo "=========================================="
          # íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì‹¤í–‰
          if [ -f "security_tools/attack.py" ]; then
            python security_tools/attack.py
          else
            # Fallback ìƒí™©ì—ì„œ íŒŒì¼ì´ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì¸ë¼ì¸ ê³µê²©
            echo "âš ï¸ Using Inline Attack Script"
            echo "HACKED" > services/frontend/hacked.txt
          fi
      - name: ğŸ“¤ Upload Compromised State
        uses: actions/upload-artifact@v4
        with:
          name: compromised-code
          path: .
          include-hidden-files: true

  # ==================================================================================
  # JOB 3: ğŸ”µ ë°©ì–´ ë° ë³µêµ¬ (Blue Team)
  # ==================================================================================
  activate-defense:
    name: 3. ğŸ”µ Blue Team Defense
    needs: simulate-attack
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“¥ Checkout (Git Context)
        uses: actions/checkout@v4

      - name: â³ Wait for Storage
        run: sleep 5

      - name: ğŸ“¥ Download Compromised Files
        uses: actions/download-artifact@v4
        with:
          name: compromised-code
          path: .
        continue-on-error: true # ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì½”ë“œì—ì„œ ì‹œì‘ (ìµœì•…ì˜ ìƒí™© ë°©ì§€)

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ›¡ï¸ EXECUTE DEFENSE
        run: |
          echo "=========================================="
          echo "ğŸ›¡ï¸ BLUE TEAM RESPONSE PROTOCOL"
          echo "=========================================="
          if [ -f "security_tools/defense.py" ]; then
            python security_tools/defense.py
          else
            echo "âš ï¸ Defense script missing (Download failed). Skipping manual defense."
          fi
      - name: ğŸ’¾ Commit & Push Fixes
        run: |
          git config --global user.name "Blue Team Bot"
          git config --global user.email "defense@ops.local"
          git add .
          git commit -m "ğŸ›¡ï¸ Incident Response: System Secured" --allow-empty
          git push origin HEAD:${{ github.ref }} || echo "âš ï¸ Push simulated"
      - name: ğŸ“¤ Upload Secured Code
        uses: actions/upload-artifact@v4
        with:
          name: secured-code
          path: .

  # ==================================================================================
  # JOB 4: ğŸš‘ íŒ¨í‚¤ì§€ íŒ¨ì¹˜ ë° ë¦´ë¦¬ì¦ˆ
  # ==================================================================================
  dependency-ops:
    name: 4. Patch & Release
    needs: activate-defense
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Secured Code
        uses: actions/download-artifact@v4
        with:
          name: secured-code
          path: .
        continue-on-error: true

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@${{ github.repository_owner }}'

      - name: ğŸ•µï¸ Patch Vulnerabilities
        run: |
          echo "ğŸ” Patching Dependencies..."
          find . -name "package.json" -not -path "*/node_modules/*" | while read pkg; do
            dir=$(dirname "$pkg")
            cd "$dir"
            # package.jsonì´ ì†ìƒ(Ransomware)ë˜ì—ˆì„ ê²½ìš° ìŠ¤í‚µ
            if [ -f "package.json" ]; then
               npm install react@19.0.1 react-dom@19.0.1 next@15.0.5 --save-exact --legacy-peer-deps --silent > /dev/null 2>&1 || true
            fi
            cd - > /dev/null
          done
      - name: ğŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}-stable
          name: "ğŸ›¡ï¸ Stable Release v${{ github.run_number }}"
          body: "Auto-generated secure release."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================================================================================
  # JOB 5: ğŸš€ ì„œë²„ ë°°í¬
  # ==================================================================================
  deploy-production:
    name: 5. Deploy to Production
    needs: dependency-ops
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¡ Deploy
        run: echo "ğŸš€ Deploying Fully Secured Application..."
