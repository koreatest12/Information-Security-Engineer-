name: "ðŸ›¡ï¸ CodeQL Grand Security Analysis (v4)"

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master" ]
  schedule:
    - cron: '30 1 * * 0'
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false # í•œ ì–¸ì–´ê°€ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ëŠ” ê³„ì† ì§„í–‰ (ì¤‘ë‹¨ ì—†ìŒ)
      matrix:
        language: [ 'java-kotlin', 'python' ]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # [Update] CodeQL Action v3 -> v4
    - name: Initialize CodeQL (v4)
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        # ë³´ì•ˆ ë° í’ˆì§ˆ ì¿¼ë¦¬ ëª¨ë‘ ì ìš©
        queries: security-and-quality

    # [Logic] ìŠ¤í‚µ í‘œì‹œ ì—†ì´ ë‚´ë¶€ì ìœ¼ë¡œ ë¶„ê¸° ì²˜ë¦¬í•˜ëŠ” ìŠ¤ë§ˆíŠ¸ ë¹Œë“œ ìŠ¤í…
    - name: ðŸ› ï¸ Smart Environment Setup & Build
      run: |
        echo ">>> Starting Build Process for: ${{ matrix.language }}"
        
        # ---------------------------------------------------
        # CASE 1: JAVA-KOTLIN (Spring Boot)
        # ---------------------------------------------------
        if [[ "${{ matrix.language }}" == "java-kotlin" ]]; then
          echo ">>> â˜• Detected Java Environment."
          
          # Java ë²„ì „ ì„¸íŒ… (ëª…ì‹œì )
          echo "Setting up JDK 17..."
          export JAVA_HOME=$JAVA_HOME_17_X64
          
          # Maven ë¹Œë“œ ìˆ˜í–‰
          if [ -d "backend-java" ]; then
            echo "Building backend-java module..."
            mvn clean package -f backend-java/pom.xml -DskipTests -B
          elif [ -f "pom.xml" ]; then
             echo "Building root project..."
             mvn clean package -DskipTests -B
          else
             echo "::warning:: No pom.xml found. Depending on Autobuild."
          fi
        
        # ---------------------------------------------------
        # CASE 2: PYTHON (FastAPI)
        # ---------------------------------------------------
        elif [[ "${{ matrix.language }}" == "python" ]]; then
          echo ">>> ðŸ Detected Python Environment."
          
          echo "Upgrading pip..."
          python -m pip install --upgrade pip
          
          # ì˜ì¡´ì„± íŒŒì¼ ì°¾ê¸° ë° ì„¤ì¹˜
          if [ -f "backend-python/requirements.txt" ]; then
            echo "Installing dependencies from backend-python..."
            pip install -r backend-python/requirements.txt
          elif [ -f "requirements.txt" ]; then
            echo "Installing root dependencies..."
            pip install -r requirements.txt
          else
            echo "::notice:: No requirements.txt found. Skipping dependency install."
          fi
        fi
        
        echo ">>> âœ… Build/Setup Phase Complete."

    # [Update] CodeQL Autobuild v3 -> v4
    # JavaëŠ” ìœ„ì—ì„œ ìˆ˜ë™ ë¹Œë“œí–ˆìœ¼ë¯€ë¡œ Pythonë§Œ ìžë™ ë¹Œë“œ ì‚¬ìš© (ì¶©ëŒ ë°©ì§€ ë¡œì§ í¬í•¨)
    - name: Autobuild (v4)
      if: matrix.language != 'java-kotlin'
      uses: github/codeql-action/autobuild@v4

    # [Update] CodeQL Analyze v3 -> v4
    - name: Perform CodeQL Analysis (v4)
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{ matrix.language }}"
