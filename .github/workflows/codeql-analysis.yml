name: âš”ï¸ Grand Ops Server Lifecycle & Upgrade Master v11

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  security-events: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  manage-grand-ops-lifecycle:
    name: ğŸš€ Server Installation & Upgrade Ops
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code (Auto-Sync Ready)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ› ï¸ Initialize Omni-Installer Engine
        run: |
          mkdir -p ops_control/installer_engine
          
          # [í•µì‹¬] ë²”ìš© ì„¤ì¹˜ ë° ì—…ê·¸ë ˆì´ë“œ í•¨ìˆ˜ ì •ì˜
          # ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ëª¨ë“  ì„œë²„ ì„¤ì¹˜ì˜ í‘œì¤€ì´ ë©ë‹ˆë‹¤.
          cat <<EOF > ops_control/installer_engine/omni_installer.sh
          #!/bin/bash
          
          SERVICE_NAME=\$1
          VERSION=\$2
          TYPE=\$3 # (app, db, security)
          
          BASE_DIR="servers/\$TYPE/\$SERVICE_NAME"
          BACKUP_DIR="backups/\$SERVICE_NAME/\$(date +%Y%m%d_%H%M%S)"
          
          echo "--------------------------------------------------"
          echo "ğŸ”§ Process Initiated: \$SERVICE_NAME (Target: v\$VERSION)"
          
          # 1. ì—…ê·¸ë ˆì´ë“œ ê°ì§€ ë° ë°±ì—… (Upgrade & Backup)
          if [ -d "\$BASE_DIR" ]; then
            echo "âš ï¸  Existing installation detected. Starting Backup..."
            mkdir -p \$BACKUP_DIR
            cp -r \$BASE_DIR/* \$BACKUP_DIR/
            echo "âœ… Backup Secure: \$BACKUP_DIR"
            echo "ğŸ”„ Upgrading from existing version to v\$VERSION..."
          else
            echo "ğŸ†• New Installation Mode Activated."
          fi
          
          # 2. í‘œì¤€ ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„± (Standard Directory Provisioning)
          mkdir -p \$BASE_DIR/bin
          mkdir -p \$BASE_DIR/conf
          mkdir -p \$BASE_DIR/logs
          mkdir -p \$BASE_DIR/data
          
          # 3. ë°”ì´ë„ˆë¦¬ ë° ì„¤ì • íŒŒì¼ ì„¤ì¹˜ (Simulation)
          echo "Binary Data for \$SERVICE_NAME v\$VERSION" > \$BASE_DIR/bin/\$SERVICE_NAME.bin
          echo "Config Standard v\$VERSION" > \$BASE_DIR/conf/\$SERVICE_NAME.conf
          echo "Installation Date: \$(date)" > \$BASE_DIR/install_receipt.txt
          
          # 4. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (Inventory Update)
          echo "{\"\$SERVICE_NAME\": \"\$VERSION\"}" >> inventory/server_manifest.json
          
          echo "âœ¨ \$SERVICE_NAME v\$VERSION Installation/Upgrade Complete."
          echo "--------------------------------------------------"
          EOF
          
          chmod +x ops_control/installer_engine/omni_installer.sh
          
          # ì¸ë²¤í† ë¦¬ í´ë” ìƒì„±
          mkdir -p inventory
          echo "{}" > inventory/server_manifest.json

      - name: ğŸ—ï¸ Execute Massive Server Installation & Upgrade
        run: |
          INSTALLER="./ops_control/installer_engine/omni_installer.sh"
          
          echo "ğŸš€ Starting Grand Ops Massive Deployment..."
          
          # --- [Tier 1: Web & Application Servers] ---
          $INSTALLER "nginx_gateway" "1.24.0" "app"
          $INSTALLER "auth_service" "2.1.0" "app"
          $INSTALLER "payment_core" "3.5.2" "app"
          $INSTALLER "frontend_ui" "5.0.0" "app"
          
          # --- [Tier 2: Database Systems] ---
          $INSTALLER "postgresql_primary" "15.4" "db"
          $INSTALLER "redis_cache" "7.0" "db"
          $INSTALLER "mongodb_analytics" "6.0" "db"
          
          # --- [Tier 3: Security & Monitoring Arsenal] ---
          $INSTALLER "sqlmap_scanner" "1.7.0" "security"
          $INSTALLER "acra_firewall" "0.94.0" "security"
          $INSTALLER "prometheus_monitor" "2.45.0" "security"
          $INSTALLER "grafana_dashboard" "10.0.0" "security"
          
          # --- [Tier 4: Download & Collector Nodes (ê¸°ì¡´ ê¸°ëŠ¥ í†µí•©)] ---
          $INSTALLER "download_node" "8.1" "infra"
          $INSTALLER "central_collector" "4.0" "infra"

      - name: ğŸš¨ Simulate Urgent Security Upgrade (Patching)
        run: |
          INSTALLER="./ops_control/installer_engine/omni_installer.sh"
          
          echo "ğŸ“¢ ALERT: Critical Vulnerability Found in Nginx!"
          echo "âš¡ Executing Emergency Patch..."
          
          # ê¸°ì¡´ ì„¤ì¹˜ëœ Nginx ìœ„ì— ìƒˆë¡œìš´ ë²„ì „ì„ ë®ì–´ì“°ê¸° (ìë™ ë°±ì—… íŠ¸ë¦¬ê±°)
          $INSTALLER "nginx_gateway" "1.25.1-PATCHED" "app"
          
          # ë¡œê·¸ í™•ì¸
          ls -R backups/nginx_gateway

      - name: ğŸ“Š Generate Installation & Upgrade Report
        run: |
          REPORT_PATH="reports/daily_ops/Grand_Ops_Lifecycle_Report_v11.md"
          mkdir -p reports/daily_ops
          
          echo "# ğŸ—ï¸ Grand Ops Server Lifecycle Report v11" > $REPORT_PATH
          echo "### ğŸ“… Execution Date: $(date)" >> $REPORT_PATH
          
          echo "## ğŸ“¦ Installed Inventory" >> $REPORT_PATH
          echo '```json' >> $REPORT_PATH
          cat inventory/server_manifest.json >> $REPORT_PATH
          echo '```' >> $REPORT_PATH
          
          echo "## ğŸ”„ Upgrade Actions (Backups Created)" >> $REPORT_PATH
          find backups -type d -name "20*" >> $REPORT_PATH

      - name: ğŸ’¾ Commit & Push with Auto-Repair Loop (v11)
        run: |
          git config --global user.name "Grand Ops Commander"
          git config --global user.email "commander@grandops.io"
          
          git add .
          git commit -m "ğŸš€ Grand Ops: Server Lifecycle & Upgrade System v11 [skip ci]" || echo "No changes"
          
          # --- Auto-Repair Logic (Resilience) ---
          MAX_RETRIES=10
          RETRY_COUNT=0
          SUCCESS=false
          CURRENT_BRANCH=${{ github.ref_name }}
          git config pull.rebase true
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT+1)): Syncing..."
            if git pull --rebase origin $CURRENT_BRANCH; then
              echo "âœ… Rebase OK."
            else
              git rebase --abort
              git pull origin $CURRENT_BRANCH -X theirs --no-rebase
            fi
            
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            
            if git push origin HEAD:$CURRENT_BRANCH; then
              SUCCESS=true
              break
            else
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT+1))
            fi
          done
          
          if [ "$SUCCESS" = false ]; then exit 1; fi
