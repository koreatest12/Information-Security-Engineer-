name: "ğŸ›¡ï¸ CodeQL Grand Security Analysis"

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master" ]
  schedule:
    - cron: '30 1 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ ìƒˆë²½ 1ì‹œ 30ë¶„ ì •ê¸° ì •ë°€ ì ê²€

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        # ìš°ë¦¬ê°€ ìƒì„±í•œ í”„ë¡œì íŠ¸ì˜ í•µì‹¬ ì–¸ì–´ 2ê°€ì§€ë¥¼ ë³‘ë ¬ë¡œ ë¶„ì„
        language: [ 'java-kotlin', 'python' ]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. CodeQL ì´ˆê¸°í™” (ë³´ì•ˆ ê°•ë„: ìµœìƒ)
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        # 'security-and-quality'ëŠ” ë³´ì•ˆ ì·¨ì•½ì ë¿ë§Œ ì•„ë‹ˆë¼ ì½”ë“œ í’ˆì§ˆ(ë²„ê·¸, ë‚˜ìœ íŒ¨í„´)ê¹Œì§€ ê²€ì‚¬í•¨
        queries: security-and-quality

    # 2. Java (Spring Boot) ìˆ˜ë™ ë¹Œë“œ ì„¤ì •
    # ì•ì„œ ìƒì„±í•œ 'backend-java' í´ë” êµ¬ì¡°ë¥¼ ì¸ì‹í•˜ê¸° ìœ„í•´ ìˆ˜ë™ ë¹Œë“œ ì ìš©
    - name: Build Java Application
      if: matrix.language == 'java-kotlin'
      run: |
        echo ">>> â˜• Building Java Spring Boot for CodeQL analysis..."
        # backend-java ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if [ -d "backend-java" ]; then
          mvn clean package -f backend-java/pom.xml -DskipTests -B
        else
          echo "::warning:: 'backend-java' directory not found. Using root pom.xml if exists."
          mvn clean package -DskipTests -B
        fi

    # 3. Python ì˜ì¡´ì„± ì„¤ì¹˜ (ë¶„ì„ ì •í™•ë„ í–¥ìƒ)
    # CodeQLì´ Python ì½”ë“œë¥¼ ë” ì˜ ì´í•´í•˜ë„ë¡ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•´ì¤ë‹ˆë‹¤.
    - name: Install Python Dependencies
      if: matrix.language == 'python'
      run: |
        echo ">>> ğŸ Installing Python dependencies for analysis..."
        python -m pip install --upgrade pip
        if [ -f "backend-python/requirements.txt" ]; then
          pip install -r backend-python/requirements.txt
        elif [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi

    # 4. ìë™ ë¹Œë“œ (JavaëŠ” ìœ„ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ í–ˆìœ¼ë¯€ë¡œ Pythonë§Œ í•´ë‹¹)
    # Pythonì€ ì»´íŒŒì¼ì´ í•„ìš” ì—†ì§€ë§Œ, ì´ ë‹¨ê³„ê°€ ë¶„ì„ í™˜ê²½ì„ ì •ë¦¬í•´ì¤ë‹ˆë‹¤.
    - name: Autobuild
      if: matrix.language != 'java-kotlin'
      uses: github/codeql-action/autobuild@v3

    # 5. ë¶„ì„ ìˆ˜í–‰ ë° ê²°ê³¼ ì—…ë¡œë“œ
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{ matrix.language }}"
