name: Conflict Fix & Auto-Gen Ops Pipeline

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 18 * * 0'
  workflow_dispatch:

jobs:
  # ====================================================
  # JOB 1: Script Preparation (Remote Check OR Auto-Gen)
  # ====================================================
  prepare-scripts:
    name: ðŸ› ï¸ Script Preparation
    runs-on: ubuntu-latest
    outputs:
      source: ${{ steps.check_source.outputs.source }}
    steps:
      - name: ðŸ“¥ Check Remote Repository (SSL Fix Applied)
        id: checkout
        continue-on-error: true
        run: |
          # Use raw git commands to bypass Action SSL strictness
          git config --global http.sslVerify false
          git clone --depth 1 --filter=blob:none --sparse https://github.com/koreatest12/Information-Security-Engineer-.git target_repo || echo "Git clone failed, proceeding to auto-gen."
          
          if [ -d "target_repo" ]; then
            cd target_repo
            git sparse-checkout set scripts
            cd ..
          fi

      - name: ðŸ” Determine Source & Auto-Generate
        id: check_source
        run: |
          mkdir -p final_scripts
          
          # 1. Check if remote scripts exist
          if [ -d "target_repo/scripts" ] && [ "$(ls -A target_repo/scripts)" ]; then
            echo "âœ… Found scripts in remote repository."
            cp target_repo/scripts/*.sh final_scripts/
            echo "source=remote" >> $GITHUB_OUTPUT
          else
            # 2. Auto-Generate Scripts (Using printf to avoid Heredoc errors)
            echo "âš ï¸ No scripts found! Activating [Auto-Gen Protocol]."
            
            # (A) System Info
            printf '#!/bin/bash\n' > final_scripts/01_sys_info.sh
            printf 'echo "ðŸ“Š [Auto-Gen] System Info Check"\n' >> final_scripts/01_sys_info.sh
            printf 'echo "Hostname: $(hostname)"\n' >> final_scripts/01_sys_info.sh
            printf 'echo "Kernel: $(uname -r)"\n' >> final_scripts/01_sys_info.sh
            printf 'df -h /\n' >> final_scripts/01_sys_info.sh

            # (B) Security Audit
            printf '#!/bin/bash\n' > final_scripts/02_security_audit.sh
            printf 'echo "ðŸ›¡ï¸ [Auto-Gen] Security Audit"\n' >> final_scripts/02_security_audit.sh
            printf 'if command -v ss &> /dev/null; then ss -tuln; else echo "ss command not found"; fi\n' >> final_scripts/02_security_audit.sh
            printf 'echo "Root Check:"\n' >> final_scripts/02_security_audit.sh
            printf "grep 'x:0:' /etc/passwd\n" >> final_scripts/02_security_audit.sh

            # (C) Cleanup Simulation
            printf '#!/bin/bash\n' > final_scripts/03_cleanup.sh
            printf 'echo "ðŸ§¹ [Auto-Gen] Log Cleanup Simulation"\n' >> final_scripts/03_cleanup.sh
            printf 'find /var/log -type f -name "*.log" -exec echo "Would compress: {}" \\;\n' >> final_scripts/03_cleanup.sh
            
            echo "âœ… 3 Emergency Scripts Generated."
            echo "source=generated" >> $GITHUB_OUTPUT
          fi
          
          chmod +x final_scripts/*.sh

      - name: ðŸ“¤ Upload Script Artifact
        uses: actions/upload-artifact@v4
        with:
          name: raw-scripts-bundle
          path: final_scripts/
          retention-days: 1

  # ====================================================
  # JOB 2: Matrix Security Ops (Conflict Fixed)
  # ====================================================
  execute-security-ops:
    name: Matrix:Security Ops Execution
    needs: prepare-scripts
    runs-on: ubuntu-latest
    
    timeout-minutes: 360
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            image: ubuntu:latest
            # Ubuntu uses apt-get (No --allowerasing needed)
            pre_req: "apt-get update && apt-get install -y ca-certificates git curl openssl sudo"
            update_cmd: "apt-get dist-upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'"
            
          - os: centos
            image: quay.io/centos/centos:stream9
            # CentOS: Added --allowerasing to fix curl-minimal conflict
            pre_req: "dnf install -y --allowerasing ca-certificates git curl openssl sudo && update-ca-trust force-enable"
            update_cmd: "dnf update -y --security --allowerasing || dnf update -y --allowerasing"
            
          - os: amzn
            image: amazonlinux:2023
            # Amazon Linux: Added --allowerasing to fix curl-minimal conflict
            pre_req: "yum install -y --allowerasing ca-certificates git curl openssl sudo && update-ca-trust force-enable"
            update_cmd: "yum update -y --security --allowerasing || yum update -y --allowerasing"

    container:
      image: ${{ matrix.image }}
      env:
        DEBIAN_FRONTEND: noninteractive
        GIT_SSL_NO_VERIFY: "true"

    steps:
      # 1. Install Prerequisites (Crucial Fix for Git/Curl)
      - name: ðŸ”’ Pre-Flight:Install Certs & Tools (Conflict Fix)
        run: |
          echo "=========================================="
          echo "ðŸš‘ Installing Prerequisites on ${{ matrix.os }}..."
          echo "   * Applying '--allowerasing' to fix curl conflicts"
          echo "=========================================="
          
          # Execute the command defined in the matrix
          ${{ matrix.pre_req }}
          
          # Verify Git installation
          git --version || echo "âŒ Git install failed"
          
          # Disable strict SSL for git
          git config --global http.sslVerify false
          git config --global --add safe.directory '*'

      # 2. Heartbeat Monitor
      - name: ðŸ’“ Start Heartbeat
        run: (while true; do echo "ðŸ’“ [Alive] System running... $(date)"; sleep 60; done) &

      # 3. Download Scripts from Job 1
      - name: ðŸ“¥ Download Executable Scripts
        uses: actions/download-artifact@v4
        with:
          name: raw-scripts-bundle
          path: exec_scripts

      # 4. Apply System Security Patches
      - name: ðŸ›¡ï¸ Apply System Security Patches
        run: |
          echo "Applying Security Patches on ${{ matrix.os }}..."
          ${{ matrix.update_cmd }}
          echo "âœ… System Secured."

      # 5. Execute Scripts
      - name: â–¶ï¸ Execute Security Scripts
        run: |
          chmod +x exec_scripts/*.sh
          echo "Executing scripts..."
          
          if [ -d "exec_scripts" ] && [ "$(ls -A exec_scripts)" ]; then
            for script in exec_scripts/*.sh; do
              echo "----------------------------------------"
              echo "ðŸ“œ Running: $(basename "$script")"
              set +e
              sudo "$script"
              echo "----------------------------------------"
            done
          else
            echo "âŒ No scripts found in artifact!"
            ls -R
            exit 1
          fi

  # ====================================================
  # JOB 3: Packaging & Upload
  # ====================================================
  package-artifacts:
    name: Package Artifacts
    needs: [prepare-scripts, execute-security-ops]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“¥ Download Original Scripts
        uses: actions/download-artifact@v4
        with:
          name: raw-scripts-bundle
          path: deployment_pack/scripts

      - name: ðŸ“¦ Bundle Artifacts
        run: |
          echo "# Ops Report" > deployment_pack/README.md
          echo "Date: $(date)" >> deployment_pack/README.md
          tar -czvf ops_result.tar.gz deployment_pack/

      - name: ðŸ“¤ Upload Final Package
        uses: actions/upload-artifact@v4
        with:
          name: ops-scripts-package
          path: ops_result.tar.gz
