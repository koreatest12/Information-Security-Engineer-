name: System Ops (Test & Build Only)

on:
  # 1. 코드 수정 시 테스트
  push:
    branches: [ "main" ]
    paths: [ "scripts/**" ]
  
  # 2. 정기 실행 (서버 업데이트 대신 스크립트 건전성 체크용으로 변경됨)
  schedule:
    - cron: '0 18 * * 0'

  # 3. 수동 실행
  workflow_dispatch:

jobs:
  # ====================================================
  # JOB 1: 스크립트 무결성 테스트 (가상 환경에서 실행)
  # 비밀번호 없이 GitHub 서버 내에서 작동
  # ====================================================
  test-scripts:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            image: ubuntu:latest
            script: setup_ubuntu.sh
            pkg_mgr: apt-get
          - os: centos
            image: quay.io/centos/centos:stream9
            script: setup_centos.sh
            pkg_mgr: dnf
          - os: amzn
            image: amazonlinux:2023
            script: setup_amzn.sh
            pkg_mgr: yum

    container:
      image: ${{ matrix.image }}

    steps:
      - uses: actions/checkout@v4

      # 테스트를 위한 최소한의 도구 설치
      - name: Install Dependencies for Test
        run: |
          if [ "${{ matrix.pkg_mgr }}" == "apt-get" ]; then
            apt-get update && apt-get install -y sudo git curl
          else
            ${{ matrix.pkg_mgr }} install -y sudo git tar gzip which findutils
          fi

      - name: Grant Permission
        run: chmod +x scripts/${{ matrix.script }}

      # 실제 설치 테스트 (오류 발생 시에도 전체 워크플로우가 멈추지 않도록 설정)
      - name: Run Install Script (Simulation)
        run: ./scripts/${{ matrix.script }}
        continue-on-error: true

  # ====================================================
  # JOB 2: 배포 패키지 생성 (SSH 접속 제거 -> 아티팩트 업로드)
  # 서버 연결 대신 실행 가능한 스크립트를 ZIP으로 묶어 업로드함
  # ====================================================
  package-scripts:
    needs: test-scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare Scripts
        run: |
          mkdir -p deploy_package
          cp scripts/*.sh deploy_package/
          chmod +x deploy_package/*.sh
          echo "Scripts are ready for manual deployment."

      # GitHub Actions 실행 결과 화면에서 파일을 다운로드 받을 수 있게 업로드
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-setup-scripts
          path: deploy_package/
          retention-days: 5
