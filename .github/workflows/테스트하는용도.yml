name: Remote Scripts Execution & Security Patch Ops

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 18 * * 0' # ë§¤ì£¼ ì¼ìš”ì¼ 18:00 UTC ì‹¤í–‰
  workflow_dispatch:

jobs:
  # ====================================================
  # JOB: ë³´ì•ˆ íŒ¨ì¹˜ ë° ì™¸ë¶€ ë¦¬í¬ì§€í† ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
  # ====================================================
  execute-security-ops:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            image: ubuntu:latest
            pkg_cmd: "apt-get install -y"
            # [ë³´ì•ˆ ê°•í™”] dist-upgradeë¡œ ì»¤ë„ ë° ì˜ì¡´ì„± ë³€ê²½ ë³´ì•ˆ íŒ¨ì¹˜ê¹Œì§€ ëª¨ë‘ ì ìš©
            update_cmd: "apt-get update -y && apt-get dist-upgrade -y"
            extra_flags: ""
            
          - os: centos
            image: quay.io/centos/centos:stream9
            pkg_cmd: "dnf install -y"
            # [ë³´ì•ˆ ê°•í™”] ìµœì‹  ë³´ì•ˆ íŒ¨ì¹˜ë¥¼ í¬í•¨í•œ ì „ì²´ ì—…ë°ì´íŠ¸ ìˆ˜í–‰
            update_cmd: "dnf update -y --security || dnf update -y"
            extra_flags: "--allowerasing"
            
          - os: amzn
            image: amazonlinux:2023
            pkg_cmd: "yum install -y"
            # [ë³´ì•ˆ ê°•í™”] Amazon Linux ë³´ì•ˆ ì—…ë°ì´íŠ¸ ì ìš©
            update_cmd: "yum update -y --security || yum update -y"
            extra_flags: "--allowerasing"

    container:
      image: ${{ matrix.image }}

    steps:
      # 1. [ì‹œìŠ¤í…œ ì¤€ë¹„] Checkout ë° ê¸°ë³¸ ë„êµ¬ ì„¤ì¹˜
      - name: Pre-flight:Install Git & Tar
        run: |
          echo "ðŸš€ Starting Pre-flight checks on ${{ matrix.os }}..."
          # íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì—…ë°ì´íŠ¸
          ${{ matrix.update_cmd }}
          ${{ matrix.pkg_cmd }} ${{ matrix.extra_flags }} git tar
          echo "âœ… Basic tools installed."

      # 2. [íƒ€ê²Ÿ ë¦¬í¬ì§€í† ë¦¬] scripts í´ë”ë§Œ ê°€ì ¸ì˜¤ê¸° (Sparse Checkout)
      - name: Checkout Remote Repository Scripts
        uses: actions/checkout@v4
        with:
          repository: koreatest12/Information-Security-Engineer-
          ref: main
          path: target_repo
          sparse-checkout: |
            scripts

      # 3. [ê²½ë¡œ ì •ë¦¬] ì‹¤í–‰ í™˜ê²½ êµ¬ì„±
      - name: Setup Script Directory
        run: |
          mkdir -p local_scripts
          if [ -d "target_repo/scripts" ]; then
            cp -r target_repo/scripts/* local_scripts/
            echo "âœ… Scripts fetched from remote repository."
            ls -al local_scripts/
          else
            echo "âš ï¸ Warning: 'scripts' directory not found."
            echo '#!/bin/bash' > local_scripts/placeholder.sh
            echo 'echo "No remote scripts found. Skipping."' >> local_scripts/placeholder.sh
          fi
          chmod +x local_scripts/*.sh

      # 4. [ì˜ì¡´ì„± ì„¤ì¹˜] í•„ìˆ˜ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: Install System Dependencies
        run: |
          echo "ðŸ“¦ Installing system dependencies..."
          ${{ matrix.pkg_cmd }} ${{ matrix.extra_flags }} sudo curl wget which findutils
          echo "âœ… Dependencies installed successfully."

      # 5. [ê¸°ëŠ¥ ì¶”ê°€] ë³´ì•ˆ íŒ¨ì¹˜ ë° ì‹œìŠ¤í…œ ê°•í™” ìž‘ì—… (Security Patching)
      - name: ðŸ›¡ï¸ Apply System Security Patches & Upgrade
        run: |
          echo "=========================================="
          echo "ðŸ›¡ï¸ Starting Security Patching Process on ${{ matrix.os }}..."
          echo "=========================================="
          
          # OSë³„ ë³´ì•ˆ íŒ¨ì¹˜ ëª…ë ¹ì–´ ì‹¤í–‰ (Matrixì—ì„œ ì •ì˜ë¨)
          ${{ matrix.update_cmd }}
          
          echo "âœ… Security Patches Applied."
          echo "   - OS Kernel & Packages are up-to-date."
          echo "   - Vulnerability fixes applied."
          echo "=========================================="

      # 6. [ì‹œìŠ¤í…œ ì •ë³´] íŒ¨ì¹˜ í›„ ìƒíƒœ í™•ì¸
      - name: Report System Information
        run: |
          echo "========================================"
          echo "Target OS: ${{ matrix.os }}"
          if [ -f /etc/os-release ]; then
            cat /etc/os-release | grep PRETTY_NAME
          fi
          echo "Kernel: $(uname -r)"
          echo "Date: $(date)"
          echo "========================================"

      # 7. [ì¼ê´„ ì‹¤í–‰] ê°€ì ¸ì˜¨ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Execute All Fetched Scripts
        run: |
          echo "â–¶ï¸ Starting execution of remote scripts..."
          
          count=$(ls -1 local_scripts/*.sh 2>/dev/null | wc -l)
          if [ "$count" != "0" ]; then
            for script in local_scripts/*.sh; do
              echo "----------------------------------------"
              echo "ðŸ“œ Executing: $(basename "$script")"
              echo "----------------------------------------"
              
              # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ë³´ì•ˆ íŒ¨ì¹˜ ì™„ë£Œëœ í™˜ê²½ì—ì„œ ìˆ˜í–‰ë¨)
              sudo "$script" && echo "âœ… Success: $(basename "$script")" || echo "âŒ Failed: $(basename "$script")"
            done
          else
            echo "âš ï¸ No .sh files found to execute."
          fi
          echo "----------------------------------------"
          echo "ðŸ All operations finished."

  # ====================================================
  # JOB 2: ì‹¤í–‰ ê²°ê³¼ë¬¼ ì•„ì¹´ì´ë¹™
  # ====================================================
  package-artifacts:
    needs: execute-security-ops
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout Remote Repository for Archiving
        uses: actions/checkout@v4
        with:
          repository: koreatest12/Information-Security-Engineer-
          ref: main
          path: archived_repo
          sparse-checkout: scripts

      - name: Archive Scripts
        run: |
          mkdir -p deployment_pack
          if [ -d "archived_repo/scripts" ]; then
            cp -r archived_repo/scripts deployment_pack/
          else
            echo "No scripts found." > deployment_pack/README.txt
          fi
          tar -czvf scripts_bundle.tar.gz deployment_pack/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: executed-scripts-bundle
          path: scripts_bundle.tar.gz
