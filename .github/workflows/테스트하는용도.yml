name: Long-Run Security Ops & Artifact Pipeline

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 18 * * 0' # ë§¤ì£¼ ì¼ìš”ì¼ 18:00 UTC
  workflow_dispatch:

jobs:
  # ====================================================
  # JOB 1: ë§¤íŠ¸ë¦­ìŠ¤ ê¸°ë°˜ ë³´ì•ˆ ìš´ì˜ (ìž¥ì‹œê°„ ìˆ˜í–‰ ë³´ìž¥)
  # ====================================================
  execute-security-ops:
    name: ë§¤íŠ¸ë¦­ìŠ¤:ë³´ì•ˆ ìš´ì˜ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    # [í•µì‹¬] ìž¥ì‹œê°„ ìˆ˜í–‰ì„ ìœ„í•œ íƒ€ìž„ì•„ì›ƒ 6ì‹œê°„ ì„¤ì • (ê¸°ë³¸ê°’ ë°©ì§€)
    timeout-minutes: 360
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            image: ubuntu:latest
            pkg_cmd: "apt-get install -y"
            # [ë³´ì•ˆ+ë¬´ì¸] ì‚¬ìš©ìž ìž…ë ¥ ëŒ€ê¸° ë°©ì§€ ì˜µì…˜ ì¶”ê°€
            update_cmd: "apt-get update -y && apt-get dist-upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'"
            extra_flags: "--no-install-recommends"
            
          - os: centos
            image: quay.io/centos/centos:stream9
            pkg_cmd: "dnf install -y"
            update_cmd: "dnf update -y --security || dnf update -y"
            extra_flags: "--allowerasing"
            
          - os: amzn
            image: amazonlinux:2023
            pkg_cmd: "yum install -y"
            update_cmd: "yum update -y --security || yum update -y"
            extra_flags: "--allowerasing"

    container:
      image: ${{ matrix.image }}
      # [í•µì‹¬] Ubuntuì—ì„œ ëŒ€í™”í˜• í”„ë¡¬í”„íŠ¸(ë©ˆì¶¤ í˜„ìƒ) ë°©ì§€
      env:
        DEBIAN_FRONTEND: noninteractive

    steps:
      # 1. í•˜íŠ¸ë¹„íŠ¸ ì‹œìž‘ (ì¶œë ¥ ì—†ìŒìœ¼ë¡œ ì¸í•œ íƒ€ìž„ì•„ì›ƒ ë°©ì§€)
      - name: ðŸ’“ Start Heartbeat Monitor
        run: |
          echo "Starting Heartbeat to prevent idle timeout..."
          # ë°±ê·¸ë¼ìš´ë“œì—ì„œ 60ì´ˆë§ˆë‹¤ ìƒì¡´ ë¡œê·¸ ì¶œë ¥
          (while true; do echo "ðŸ’“ [System Alive] Job is running... $(date)"; sleep 60; done) &
          echo "âœ… Heartbeat started."

      # 2. ì‹œìŠ¤í…œ ê¸°ë³¸ ë„êµ¬ ì„¤ì¹˜ (ìž¬ì‹œë„ ë¡œì§ ì ìš©)
      - name: ðŸš€ Pre-flight:ì‹œìŠ¤í…œ ë„êµ¬ ì„¤ì¹˜ (Retry applied)
        run: |
          echo "Installing basic tools on ${{ matrix.os }}..."
          
          # ë„¤íŠ¸ì›Œí¬ ë¶ˆì•ˆì • ëŒ€ë¹„ ìž¬ì‹œë„ í•¨ìˆ˜
          retry_cmd() {
            local n=1
            local max=5
            local delay=10
            while true; do
              "$@" && break || {
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "âš ï¸ Command failed. Attempt $n/$max. Retrying in ${delay}s..."
                  sleep $delay;
                else
                  echo "âŒ The command has failed after $n attempts."
                  return 1
                fi
              }
            done
          }
          
          retry_cmd ${{ matrix.update_cmd }}
          retry_cmd ${{ matrix.pkg_cmd }} ${{ matrix.extra_flags }} git tar sudo curl wget which findutils
          
          echo "âœ… Basic tools installed."

      # 3. ì›ê²© ë¦¬í¬ì§€í† ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: ðŸ“¥ ì›ê²© ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/checkout@v4
        with:
          repository: koreatest12/Information-Security-Engineer-
          ref: main
          path: target_repo
          sparse-checkout: |
            scripts

      # 4. ì‹¤í–‰ í™˜ê²½ êµ¬ì„±
      - name: ðŸ“‚ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤€ë¹„
        run: |
          mkdir -p local_scripts
          if [ -d "target_repo/scripts" ]; then
            cp -r target_repo/scripts/* local_scripts/
            echo "âœ… Scripts loaded."
          else
            echo "âš ï¸ Scripts not found. Creating placeholder."
            echo '#!/bin/bash' > local_scripts/placeholder.sh
            echo 'echo "Placeholder script running."' >> local_scripts/placeholder.sh
          fi
          chmod +x local_scripts/*.sh

      # 5. [í•µì‹¬] ëŒ€ê·œëª¨ ë³´ì•ˆ íŒ¨ì¹˜ (ìž¥ì‹œê°„ ì†Œìš” ì˜ˆìƒ)
      - name: ðŸ›¡ï¸ ì‹œìŠ¤í…œ ë³´ì•ˆ íŒ¨ì¹˜ ì ìš© (Long-Running Patch)
        run: |
          echo "=========================================="
          echo "ðŸ›¡ï¸ ${{ matrix.os }} ëŒ€ê·œëª¨ ë³´ì•ˆ íŒ¨ì¹˜ ì‹œìž‘"
          echo "   (This process may take a while...)"
          echo "=========================================="
          
          start_time=$(date +%s)
          
          # ì—…ë°ì´íŠ¸ ëª…ë ¹ì–´ ì‹¤í–‰ (Matrix ì •ì˜)
          ${{ matrix.update_cmd }}
          
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          
          echo "âœ… Security Patches Applied."
          echo "â±ï¸ Total Patch Time: ${duration} seconds"

      # 6. ìŠ¤í¬ë¦½íŠ¸ ì¼ê´„ ì‹¤í–‰ (ì˜¤ë¥˜ ë¬´ì‹œ ë° ì§€ì† ìˆ˜í–‰)
      - name: â–¶ï¸ ë³´ì•ˆ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
          echo "Running scripts..."
          count=$(ls -1 local_scripts/*.sh 2>/dev/null | wc -l)
          
          if [ "$count" != "0" ]; then
            for script in local_scripts/*.sh; do
              echo "----------------------------------------"
              echo "ðŸ“œ Executing: $(basename "$script")"
              
              # ìŠ¤í¬ë¦½íŠ¸ í•˜ë‚˜ê°€ ì‹¤íŒ¨í•´ë„ ì „ì²´ Jobì€ ê³„ì† ìˆ˜í–‰ë˜ë„ë¡ ì„¤ì •
              # set +e (ì—ëŸ¬ ë°œìƒ ì‹œ ì¢…ë£Œ ë°©ì§€)
              set +e
              sudo "$script"
              exit_code=$?
              set -e
              
              if [ $exit_code -eq 0 ]; then
                echo "âœ… Success: $(basename "$script")"
              else
                echo "âš ï¸ Warning: $(basename "$script") failed with exit code $exit_code (Continuing...)"
              fi
              echo "----------------------------------------"
            done
          fi

  # ====================================================
  # JOB 2: ì‹¤í–‰ ê²°ê³¼ë¬¼ íŒ¨í‚¤ì§•
  # ====================================================
  package-artifacts:
    name: íŒ¨í‚¤ì§€ ì•„í‹°íŒ©íŠ¸
    needs: execute-security-ops
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 60 # ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œë„ ë„‰ë„‰í•˜ê²Œ ì„¤ì •
    
    steps:
      - name: ðŸ“¥ ì•„í‹°íŒ©íŠ¸ìš© ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ
        uses: actions/checkout@v4
        with:
          repository: koreatest12/Information-Security-Engineer-
          ref: main
          path: archived_repo
          sparse-checkout: scripts

      - name: ðŸ“¦ ìŠ¤í¬ë¦½íŠ¸ ë²ˆë“¤ë§
        run: |
          mkdir -p deployment_pack
          if [ -d "archived_repo/scripts" ]; then
            cp -r archived_repo/scripts deployment_pack/
          else
            echo "No scripts." > deployment_pack/README.txt
          fi
          tar -czvf scripts_bundle.tar.gz deployment_pack/

      - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: executed-scripts-bundle
          path: scripts_bundle.tar.gz
