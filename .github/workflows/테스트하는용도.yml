name: SSL Fix & Auto-Gen Script Ops Pipeline

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 18 * * 0'
  workflow_dispatch:

jobs:
  # ====================================================
  # JOB 1: ìŠ¤í¬ë¦½íŠ¸ í™•ë³´ (ì›ê²© í™•ì¸ OR ìžë™ ìƒì„±)
  # ====================================================
  prepare-scripts:
    name: ðŸ› ï¸ ìŠ¤í¬ë¦½íŠ¸ í™•ë³´ ë° ìƒì„±
    runs-on: ubuntu-latest
    outputs:
      source: ${{ steps.check_source.outputs.source }}
    steps:
      - name: ðŸ“¥ ì›ê²© ë¦¬í¬ì§€í† ë¦¬ í™•ì¸ (Host í™˜ê²½)
        id: checkout
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: koreatest12/Information-Security-Engineer-
          ref: main
          path: target_repo
          sparse-checkout: scripts

      - name: ðŸ” ìŠ¤í¬ë¦½íŠ¸ ìœ ë¬´ íŒë³„ ë° ìžë™ ìƒì„±
        id: check_source
        run: |
          mkdir -p final_scripts
          
          # 1. ì›ê²© ë¦¬í¬ì§€í† ë¦¬ í™•ì¸
          if [ -d "target_repo/scripts" ] && [ "$(ls -A target_repo/scripts)" ]; then
            echo "âœ… ì›ê²© ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ ë°œê²¬."
            cp target_repo/scripts/*.sh final_scripts/
            echo "source=remote" >> $GITHUB_OUTPUT
          else
            # 2. [ë¹„ìƒ] ìŠ¤í¬ë¦½íŠ¸ ë¶€ìž¬ ì‹œ ìžë™ ìƒì„± í”„ë¡œí† ì½œ ê°€ë™
            echo "âš ï¸ ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ! [ìžë™ ìƒì„± í”„ë¡œí† ì½œ] ê°€ë™."
            
            # (A) ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì ê²€
            cat > final_scripts/01_sys_info.sh <<-'EOF'
            #!/bin/bash
            echo "ðŸ“Š [Auto-Gen] System Info Check"
            echo "Hostname: $(hostname)"
            echo "Kernel: $(uname -r)"
            echo "Disk:"
            df -h /
            EOF

            # (B) ë„¤íŠ¸ì›Œí¬/ë³´ì•ˆ ì ê²€
            cat > final_scripts/02_security_audit.sh <<-'EOF'
            #!/bin/bash
            echo "ðŸ›¡ï¸ [Auto-Gen] Security Audit"
            if command -v ss &> /dev/null; then ss -tuln; else echo "No ss command"; fi
            echo "Root Check:"
            grep 'x:0:' /etc/passwd
            EOF

            # (C) ë¡œê·¸ ì •ë¦¬ ì‹œë®¬ë ˆì´ì…˜
            cat > final_scripts/03_cleanup.sh <<-'EOF'
            #!/bin/bash
            echo "ðŸ§¹ [Auto-Gen] Log Cleanup Simulation"
            find /var/log -type f -name "*.log" -exec echo "Would compress: {}" \;
            EOF
            
            echo "âœ… 3ê°œì˜ ë¹„ìƒìš© ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ."
            echo "source=generated" >> $GITHUB_OUTPUT
          fi
          
          chmod +x final_scripts/*.sh

      - name: ðŸ“¤ ìŠ¤í¬ë¦½íŠ¸ ì•„í‹°íŒ©íŠ¸ ì €ìž¥
        uses: actions/upload-artifact@v4
        with:
          name: raw-scripts-bundle
          path: final_scripts/
          retention-days: 1

  # ====================================================
  # JOB 2: ë§¤íŠ¸ë¦­ìŠ¤ ê¸°ë°˜ ë³´ì•ˆ íŒ¨ì¹˜ ë° ì‹¤í–‰ (SSL ì—ëŸ¬ ìˆ˜ì •ë¨)
  # ====================================================
  execute-security-ops:
    name: ë§¤íŠ¸ë¦­ìŠ¤:ë³´ì•ˆ ìš´ì˜ ì‹¤í–‰
    needs: prepare-scripts
    runs-on: ubuntu-latest
    
    timeout-minutes: 999 # ìž¥ì‹œê°„ ìˆ˜í–‰ ë³´ìž¥
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            image: ubuntu:latest
            pkg_cmd: "apt-get install -y"
            # Ubuntu: ca-certificates í•„ìˆ˜ ì„¤ì¹˜
            pre_req: "apt-get update && apt-get install -y ca-certificates git curl openssl"
            update_cmd: "apt-get dist-upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'"
            
          - os: centos
            image: quay.io/centos/centos:stream9
            pkg_cmd: "dnf install -y"
            # CentOS: ca-certificates ì—…ë°ì´íŠ¸
            pre_req: "dnf install -y ca-certificates git curl openssl && update-ca-trust force-enable"
            update_cmd: "dnf update -y --security || dnf update -y"
            extra_flags: "--allowerasing"
            
          - os: amzn
            image: amazonlinux:2023
            pkg_cmd: "yum install -y"
            # Amazon Linux: ca-certificates ì—…ë°ì´íŠ¸
            pre_req: "yum install -y ca-certificates git curl openssl && update-ca-trust force-enable"
            update_cmd: "yum update -y --security || yum update -y"
            extra_flags: "--allowerasing"

    container:
      image: ${{ matrix.image }}
      env:
        DEBIAN_FRONTEND: noninteractive
        # [í•µì‹¬] Git SSL ê²€ì¦ ë¬¸ì œ ë°œìƒ ì‹œ ë””ë²„ê¹…ì„ ìœ„í•œ ì˜µì…˜
        GIT_SSL_NO_VERIFY: "true"

    steps:
      # 1. [Fix] SSL ì¸ì¦ì„œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì‚¬ì „ ì„¤ì¹˜ ë‹¨ê³„
      # Checkout ì•¡ì…˜ ì‹¤í–‰ 'ì „'ì— ì¸ì¦ì„œë¥¼ ë¨¼ì € ì„¤ì¹˜í•´ì•¼ í•¨
      - name: ðŸ”’ Pre-Checkout:SSL ì¸ì¦ì„œ ë° í•„ìˆ˜ ë„êµ¬ ê¸´ê¸‰ ì„¤ì¹˜
        run: |
          echo "=========================================="
          echo "ðŸš‘ [Emergency] Installing CA Certificates..."
          echo "=========================================="
          
          # Matrixì— ì •ì˜ëœ ì‚¬ì „ ì„¤ì¹˜ ëª…ë ¹ì–´ ì‹¤í–‰ (ca-certificates ì„¤ì¹˜)
          ${{ matrix.pre_req }}
          
          # Git ê¸€ë¡œë²Œ ì„¤ì •: SSL ê²€ì¦ ì‹¤íŒ¨ ì‹œ ìš°íšŒ ì„¤ì • (ìµœí›„ì˜ ìˆ˜ë‹¨)
          git config --global http.sslVerify false
          git config --global --add safe.directory '*'
          
          echo "âœ… CA Certificates installed & Git configured."
          
          # ì—°ê²° í…ŒìŠ¤íŠ¸
          curl -I https://github.com || echo "âš ï¸ Warning: GitHub connectivity check failed, but proceeding."

      # 2. í•˜íŠ¸ë¹„íŠ¸ ì‹œìž‘ (íƒ€ìž„ì•„ì›ƒ ë°©ì§€)
      - name: ðŸ’“ Start Heartbeat
        run: (while true; do echo "ðŸ’“ [Alive] System running... $(date)"; sleep 60; done) &

      # 3. [ì„ íƒ] ì›ê²© ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ (ì´ì œ ì—ëŸ¬ ì•ˆ ë‚¨)
      # ìŠ¤í¬ë¦½íŠ¸ê°€ ì•„í‹°íŒ©íŠ¸ë¡œ ë„˜ì–´ì˜¤ì§€ë§Œ, ë¦¬í¬ì§€í† ë¦¬ ì ‘ê·¼ì´ í•„ìš”í•œ ê²½ìš°ë¥¼ ìœ„í•´ ìœ ì§€
      - name: ðŸ“¥ ì›ê²© ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ (SSL Fixed)
        uses: actions/checkout@v4
        with:
          repository: koreatest12/Information-Security-Engineer-
          ref: main
          path: target_repo
          sparse-checkout: scripts
        continue-on-error: true # ì‹¤íŒ¨í•´ë„ ì•„í‹°íŒ©íŠ¸ê°€ ìžˆìœ¼ë¯€ë¡œ ì§„í–‰

      # 4. ì•„í‹°íŒ©íŠ¸(ì¤€ë¹„ëœ ìŠ¤í¬ë¦½íŠ¸) ë‹¤ìš´ë¡œë“œ
      - name: ðŸ“¥ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: raw-scripts-bundle
          path: exec_scripts

      # 5. ë³´ì•ˆ íŒ¨ì¹˜ ì ìš©
      - name: ðŸ›¡ï¸ ì‹œìŠ¤í…œ ë³´ì•ˆ íŒ¨ì¹˜ ì ìš©
        run: |
          echo "Applying Security Patches on ${{ matrix.os }}..."
          ${{ matrix.update_cmd }}
          echo "âœ… System Secured."

      # 6. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: â–¶ï¸ ë³´ì•ˆ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
          chmod +x exec_scripts/*.sh
          echo "Executing scripts..."
          
          # íŒŒì¼ ì¡´ìž¬ ì—¬ë¶€ ìž¬í™•ì¸
          if [ -d "exec_scripts" ] && [ "$(ls -A exec_scripts)" ]; then
            for script in exec_scripts/*.sh; do
              echo "----------------------------------------"
              echo "ðŸ“œ Running: $(basename "$script")"
              set +e
              sudo "$script"
              echo "----------------------------------------"
            done
          else
            echo "âš ï¸ No scripts to execute in exec_scripts/"
            # ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ì‹œ ëŒ€ë¹„: target_repo í™•ì¸
            if [ -d "target_repo/scripts" ]; then
               echo "ðŸ”„ Fallback: Running scripts from checkout..."
               chmod +x target_repo/scripts/*.sh
               for script in target_repo/scripts/*.sh; do
                 sudo "$script"
               done
            fi
          fi

  # ====================================================
  # JOB 3: ê²°ê³¼ íŒ¨í‚¤ì§• ë° ì—…ë¡œë“œ
  # ====================================================
  package-artifacts:
    name: íŒ¨í‚¤ì§€ ì•„í‹°íŒ©íŠ¸
    needs: [prepare-scripts, execute-security-ops]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“¥ ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: raw-scripts-bundle
          path: deployment_pack/scripts

      - name: ðŸ“¦ ì•„í‹°íŒ©íŠ¸ íŒ¨í‚¤ì§•
        run: |
          echo "# Ops Report" > deployment_pack/README.md
          echo "Date: $(date)" >> deployment_pack/README.md
          tar -czvf ops_result.tar.gz deployment_pack/

      - name: ðŸ“¤ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ops-scripts-package
          path: ops_result.tar.gz
