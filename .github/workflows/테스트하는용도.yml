name: Advanced System Ops & Execution

on:
  push:
    branches: [ "main" ]
    paths: [ "scripts/**" ]
  schedule:
    - cron: '0 18 * * 0'
  workflow_dispatch:

jobs:
  # ====================================================
  # JOB: ë‹¤ì¤‘ OS í™˜ê²½ êµ¬ì¶•, ì˜ì¡´ì„± í•´ê²°, ìŠ¤í¬ë¦½íŠ¸ ì¼ê´„ ì‹¤í–‰
  # ====================================================
  execute-scripts:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            image: ubuntu:latest
            pkg_cmd: "apt-get install -y"
            update_cmd: "apt-get update -y"
            # UbuntuëŠ” ì¶©ëŒì´ ì ìœ¼ë¯€ë¡œ ê¸°ë³¸ ì˜µì…˜
            extra_flags: ""
            
          - os: centos
            image: quay.io/centos/centos:stream9
            pkg_cmd: "dnf install -y"
            update_cmd: "dnf update -y"
            # [í•µì‹¬ ìˆ˜ì •] curl-minimal ì¶©ëŒ í•´ê²°ì„ ìœ„í•´ íŒ¨í‚¤ì§€ êµì²´ í—ˆìš©
            extra_flags: "--allowerasing"
            
          - os: amzn
            image: amazonlinux:2023
            pkg_cmd: "yum install -y"
            update_cmd: "yum update -y"
            # [í•µì‹¬ ìˆ˜ì •] Amazon Linux ì¶©ëŒ í•´ê²°
            extra_flags: "--allowerasing"

    container:
      image: ${{ matrix.image }}

    steps:
      # 1. [ì‹œìŠ¤í…œ ì¤€ë¹„] Checkoutì„ ìœ„í•œ ìµœì†Œ ë„êµ¬ ì„¤ì¹˜ (Git, Tar)
      - name: Pre-flight:Install Git & Tar
        run: |
          echo "ğŸš€ Starting Pre-flight checks on ${{ matrix.os }}..."
          ${{ matrix.update_cmd }}
          
          # íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €ë³„ ì˜µì…˜ ì ìš©í•˜ì—¬ ì„¤ì¹˜
          ${{ matrix.pkg_cmd }} ${{ matrix.extra_flags }} git tar
          
          echo "âœ… Basic tools installed."

      # 2. ì†ŒìŠ¤ ì½”ë“œ ë‹¤ìš´ë¡œë“œ
      - uses: actions/checkout@v4

      # 3. [ì˜ì¡´ì„± ì„¤ì¹˜] í…ŒìŠ¤íŠ¸ ë° ì‹¤í–‰ì— í•„ìš”í•œ ë„êµ¬ ì„¤ì¹˜ (Sudo, Curl, Wget ë“±)
      - name: Install System Dependencies (Fixing Conflicts)
        run: |
          echo "ğŸ“¦ Installing system dependencies..."
          
          # ì¶©ëŒ í•´ê²° í”Œë˜ê·¸(--allowerasing)ê°€ ì—¬ê¸°ì„œ ì‘ë™í•¨
          ${{ matrix.pkg_cmd }} ${{ matrix.extra_flags }} sudo curl wget which findutils
          
          echo "âœ… Dependencies installed successfully."

      # 4. [ì‹œìŠ¤í…œ ì •ë³´] ë””ë²„ê¹…ì„ ìœ„í•œ í™˜ê²½ ì •ë³´ ì¶œë ¥
      - name: Report System Information
        run: |
          echo "========================================"
          echo "OS Info:"
          cat /etc/os-release | grep PRETTY_NAME
          echo "Kernel:"
          uname -r
          echo "User:"
          whoami
          echo "========================================"

      # 5. [íŒŒì¼ ê²€ì¦] ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ìœ ë¬´ í™•ì¸ ë° ê¶Œí•œ ë¶€ì—¬
      - name: Prepare Script Directory
        run: |
          mkdir -p scripts
          
          # ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ë”ë¯¸ íŒŒì¼ ìƒì„± (ì—ëŸ¬ ë°©ì§€)
          if [ -z "$(ls -A scripts/*.sh 2>/dev/null)" ]; then
             echo "âš ï¸ No .sh files found. Creating a placeholder."
             echo '#!/bin/bash' > scripts/example_setup.sh
             echo 'echo "ğŸ‰ This is a placeholder script running on $(hostname)"' >> scripts/example_setup.sh
          fi
          
          # ëª¨ë“  ì‰˜ ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x scripts/*.sh
          echo "âœ… Permissions granted to scripts."

      # 6. [ëŒ€ëŸ‰ ì‹¤í–‰] scripts í´ë” ë‚´ì˜ ëª¨ë“  .sh íŒŒì¼ ìˆœì°¨ ì‹¤í–‰
      - name: Execute All Scripts in Directory
        run: |
          echo "â–¶ï¸ Starting execution of scripts..."
          
          # scripts í´ë” ë‚´ì˜ ëª¨ë“  .sh íŒŒì¼ì„ ì°¾ì•„ì„œ ì‹¤í–‰
          for script in scripts/*.sh; do
            if [ -f "$script" ]; then
              echo "----------------------------------------"
              echo "ğŸ“œ Running: $script"
              echo "----------------------------------------"
              
              # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ì˜¤ë¥˜ê°€ ë‚˜ë„ ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì§„í–‰í•˜ë ¤ë©´ || true ì¶”ê°€)
              # sudoë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ ë£¨íŠ¸ ê¶Œí•œ ì‹¤í–‰ ì‹œë®¬ë ˆì´ì…˜
              sudo "$script" && echo "âœ… Success: $script" || echo "âŒ Failed: $script"
              
            fi
          done
          echo "----------------------------------------"
          echo "ğŸ All scripts execution attempted."

  # ====================================================
  # JOB 2: ì‹¤í–‰ ê²°ê³¼ë¬¼(ìŠ¤í¬ë¦½íŠ¸ë“¤) íŒ¨í‚¤ì§• ë° ì—…ë¡œë“œ
  # ====================================================
  package-artifacts:
    needs: execute-scripts
    runs-on: ubuntu-latest
    if: always() # í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ë„ ì•„í‹°íŒ©íŠ¸ëŠ” ë‚¨ê¸°ë„ë¡ ì„¤ì •
    steps:
      - uses: actions/checkout@v4
      
      - name: Archive Scripts
        run: |
          mkdir -p deployment_pack
          cp -r scripts deployment_pack/
          tar -czvf scripts_bundle.tar.gz deployment_pack/
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-scripts
          path: scripts_bundle.tar.gz
          retention-days: 5
