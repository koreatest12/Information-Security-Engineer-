name: Fixed Syntax Auto-Gen Ops Pipeline

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 18 * * 0'
  workflow_dispatch:

jobs:
  # ====================================================
  # JOB 1: ìŠ¤í¬ë¦½íŠ¸ í™•ë³´ (ì›ê²© í™•ì¸ OR ìžë™ ìƒì„±)
  # ====================================================
  prepare-scripts:
    name: ðŸ› ï¸ ìŠ¤í¬ë¦½íŠ¸ í™•ë³´ ë° ìƒì„±
    runs-on: ubuntu-latest
    outputs:
      source: ${{ steps.check_source.outputs.source }}
    steps:
      - name: ðŸ“¥ ì›ê²© ë¦¬í¬ì§€í† ë¦¬ í™•ì¸ (SSL Fix ì ìš©)
        id: checkout
        continue-on-error: true
        run: |
          # Checkout ì•¡ì…˜ ëŒ€ì‹  ì§ì ‘ git ëª…ë ¹ì–´ë¡œ ì‹œë„ (SSL ì—ëŸ¬ íšŒí”¼ ë° ìœ ì—°ì„± í™•ë³´)
          git config --global http.sslVerify false
          git clone --depth 1 --filter=blob:none --sparse https://github.com/koreatest12/Information-Security-Engineer-.git target_repo || echo "Git clone failed, proceeding to auto-gen."
          
          if [ -d "target_repo" ]; then
            cd target_repo
            git sparse-checkout set scripts
            cd ..
          fi

      - name: ðŸ” ìŠ¤í¬ë¦½íŠ¸ ìœ ë¬´ íŒë³„ ë° ìžë™ ìƒì„±
        id: check_source
        run: |
          mkdir -p final_scripts
          
          # 1. ì›ê²© ë¦¬í¬ì§€í† ë¦¬ í™•ì¸
          if [ -d "target_repo/scripts" ] && [ "$(ls -A target_repo/scripts)" ]; then
            echo "âœ… ì›ê²© ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ ë°œê²¬."
            cp target_repo/scripts/*.sh final_scripts/
            echo "source=remote" >> $GITHUB_OUTPUT
          else
            # 2. [ë¹„ìƒ] ìŠ¤í¬ë¦½íŠ¸ ë¶€ìž¬ ì‹œ ìžë™ ìƒì„± (EOF ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ printf ì‚¬ìš©)
            echo "âš ï¸ ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ! [ìžë™ ìƒì„± í”„ë¡œí† ì½œ] ê°€ë™."
            
            # (A) ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì ê²€ (Here-doc ëŒ€ì‹  printf ì‚¬ìš©ìœ¼ë¡œ ë¬¸ë²• ì—ëŸ¬ ë°©ì§€)
            printf '#!/bin/bash\n' > final_scripts/01_sys_info.sh
            printf 'echo "ðŸ“Š [Auto-Gen] System Info Check"\n' >> final_scripts/01_sys_info.sh
            printf 'echo "Hostname: $(hostname)"\n' >> final_scripts/01_sys_info.sh
            printf 'echo "Kernel: $(uname -r)"\n' >> final_scripts/01_sys_info.sh
            printf 'df -h /\n' >> final_scripts/01_sys_info.sh

            # (B) ë„¤íŠ¸ì›Œí¬/ë³´ì•ˆ ì ê²€
            printf '#!/bin/bash\n' > final_scripts/02_security_audit.sh
            printf 'echo "ðŸ›¡ï¸ [Auto-Gen] Security Audit"\n' >> final_scripts/02_security_audit.sh
            printf 'if command -v ss &> /dev/null; then ss -tuln; else echo "No ss command"; fi\n' >> final_scripts/02_security_audit.sh
            printf 'echo "Root Check:"\n' >> final_scripts/02_security_audit.sh
            printf "grep 'x:0:' /etc/passwd\n" >> final_scripts/02_security_audit.sh

            # (C) ë¡œê·¸ ì •ë¦¬ ì‹œë®¬ë ˆì´ì…˜
            printf '#!/bin/bash\n' > final_scripts/03_cleanup.sh
            printf 'echo "ðŸ§¹ [Auto-Gen] Log Cleanup Simulation"\n' >> final_scripts/03_cleanup.sh
            printf 'find /var/log -type f -name "*.log" -exec echo "Would compress: {}" \\;\n' >> final_scripts/03_cleanup.sh
            
            echo "âœ… 3ê°œì˜ ë¹„ìƒìš© ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ."
            echo "source=generated" >> $GITHUB_OUTPUT
          fi
          
          chmod +x final_scripts/*.sh
          ls -l final_scripts/

      - name: ðŸ“¤ ìŠ¤í¬ë¦½íŠ¸ ì•„í‹°íŒ©íŠ¸ ì €ìž¥
        uses: actions/upload-artifact@v4
        with:
          name: raw-scripts-bundle
          path: final_scripts/
          retention-days: 1

  # ====================================================
  # JOB 2: ë§¤íŠ¸ë¦­ìŠ¤ ê¸°ë°˜ ë³´ì•ˆ íŒ¨ì¹˜ ë° ì‹¤í–‰
  # ====================================================
  execute-security-ops:
    name: ë§¤íŠ¸ë¦­ìŠ¤:ë³´ì•ˆ ìš´ì˜ ì‹¤í–‰
    needs: prepare-scripts # Job 1ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë¨
    runs-on: ubuntu-latest
    
    timeout-minutes: 999
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            image: ubuntu:latest
            # Ubuntu: ca-certificates ì„¤ì¹˜ ë° Git ì„¤ì¹˜
            pre_req: "apt-get update && apt-get install -y ca-certificates git curl openssl sudo"
            update_cmd: "apt-get dist-upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'"
            
          - os: centos
            image: quay.io/centos/centos:stream9
            # CentOS: ì¸ì¦ì„œ ì—…ë°ì´íŠ¸
            pre_req: "dnf install -y ca-certificates git curl openssl sudo && update-ca-trust force-enable"
            update_cmd: "dnf update -y --security || dnf update -y"
            
          - os: amzn
            image: amazonlinux:2023
            # Amazon Linux: ì¸ì¦ì„œ ì—…ë°ì´íŠ¸
            pre_req: "yum install -y ca-certificates git curl openssl sudo && update-ca-trust force-enable"
            update_cmd: "yum update -y --security || yum update -y"

    container:
      image: ${{ matrix.image }}
      env:
        DEBIAN_FRONTEND: noninteractive
        GIT_SSL_NO_VERIFY: "true"

    steps:
      # 1. SSL ì¸ì¦ì„œ ë° í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ (ê°€ìž¥ ë¨¼ì € ì‹¤í–‰)
      - name: ðŸ”’ Pre-Flight:SSL ì¸ì¦ì„œ ë° ë„êµ¬ ì„¤ì¹˜
        run: |
          echo "Installing prerequisites..."
          ${{ matrix.pre_req }}
          git config --global http.sslVerify false
          git config --global --add safe.directory '*'

      # 2. í•˜íŠ¸ë¹„íŠ¸ ì‹œìž‘
      - name: ðŸ’“ Start Heartbeat
        run: (while true; do echo "ðŸ’“ [Alive] System running... $(date)"; sleep 60; done) &

      # 3. ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ (Job 1ì—ì„œ ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸)
      - name: ðŸ“¥ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: raw-scripts-bundle
          path: exec_scripts

      # 4. ë³´ì•ˆ íŒ¨ì¹˜ ì ìš©
      - name: ðŸ›¡ï¸ ì‹œìŠ¤í…œ ë³´ì•ˆ íŒ¨ì¹˜ ì ìš©
        run: |
          echo "Applying Security Patches on ${{ matrix.os }}..."
          ${{ matrix.update_cmd }}
          echo "âœ… System Secured."

      # 5. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: â–¶ï¸ ë³´ì•ˆ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
          chmod +x exec_scripts/*.sh
          echo "Executing scripts..."
          
          if [ -d "exec_scripts" ] && [ "$(ls -A exec_scripts)" ]; then
            for script in exec_scripts/*.sh; do
              echo "----------------------------------------"
              echo "ðŸ“œ Running: $(basename "$script")"
              set +e
              sudo "$script"
              echo "----------------------------------------"
            done
          else
            echo "âŒ No scripts found in artifact!"
            ls -R
            exit 1
          fi

  # ====================================================
  # JOB 3: ê²°ê³¼ íŒ¨í‚¤ì§• ë° ì—…ë¡œë“œ
  # ====================================================
  package-artifacts:
    name: íŒ¨í‚¤ì§€ ì•„í‹°íŒ©íŠ¸
    needs: [prepare-scripts, execute-security-ops]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“¥ ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: raw-scripts-bundle
          path: deployment_pack/scripts

      - name: ðŸ“¦ ì•„í‹°íŒ©íŠ¸ íŒ¨í‚¤ì§•
        run: |
          echo "# Ops Report" > deployment_pack/README.md
          echo "Date: $(date)" >> deployment_pack/README.md
          tar -czvf ops_result.tar.gz deployment_pack/

      - name: ðŸ“¤ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ops-scripts-package
          path: ops_result.tar.gz
