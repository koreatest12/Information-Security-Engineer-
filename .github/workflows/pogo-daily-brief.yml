name: PokÃ©mon GO Ops Server & Release

on:
  schedule:
    - cron: '0 0 * * *' # ë§¤ì¼ 00:00 UTC
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰

permissions:
  contents: write

jobs:
  ops-server-deployment:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # [ê°•ì œ ë™ê¸°í™”] Git ì¶©ëŒ ë°©ì§€
      - name: ğŸ”„ Hard Reset to Remote
        run: |
          git fetch origin main
          git reset --hard origin/main
          echo "âœ… Repository synced successfully."

      # [ìë™ ë³µêµ¬] íŒŒì´ì¬ ì„œë²„ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ìƒì„± (ì—ëŸ¬ ì›ì²œ ì°¨ë‹¨)
      - name: ğŸ› ï¸ Auto-Generate Ops Server Script
        run: |
          mkdir -p scripts
          cat << 'EOF' > scripts/ops_server.py
          import os
          import json
          import feedparser
          import pytz
          from datetime import datetime
          
          # --- Configuration ---
          KST = pytz.timezone('Asia/Seoul')
          NOW = datetime.now(KST)
          DATE_TAG = NOW.strftime("%Y.%m.%d")
          CURRENT_TIME_STR = NOW.strftime("%Y-%m-%d %H:%M:%S (KST)")
          
          RSS_URL = "https://pokemongolive.com/feeds/news.xml"
          DB_FILE = "data/daily_intel.json"
          README_FILE = "README.md"
          
          DATA_SOURCES = {
              "ğŸ“¢ Official": [
                  {"name": "Twitter (Global)", "url": "https://twitter.com/PokemonGoApp"},
                  {"name": "Twitter (Korea)", "url": "https://twitter.com/PokemonGOAppKR"},
                  {"name": "Blog News", "url": "https://pokemongolive.com/post/"},
              ],
              "âš¡ Intel & Data": [
                  {"name": "LeekDuck", "url": "https://leekduck.com/"},
                  {"name": "The Silph Road", "url": "https://thesilphroad.com/"},
                  {"name": "GO Hub", "url": "https://pokemongohub.net/"},
              ],
              "ğŸ“š Pokedex DB": [
                  {"name": "Official Pokedex (KR)", "url": "https://www.pokemonkorea.co.kr/pokedex"},
                  {"name": "GO Hub Stats", "url": "https://db.pokemongohub.net/"},
                  {"name": "Shiny List", "url": "https://leekduck.com/shiny/"},
              ]
          }
          
          def collect_data():
              print("ğŸ“¡ [Server] Fetching external data...")
              news_data = []
              try:
                  feed = feedparser.parse(RSS_URL)
                  for entry in feed.entries[:5]:
                      published = datetime(*entry.published_parsed[:6]).strftime('%Y-%m-%d')
                      news_data.append({"date": published, "title": entry.title, "link": entry.link})
              except Exception as e:
                  print(f"âš ï¸ Error: {e}")
          
              return {
                  "timestamp": CURRENT_TIME_STR,
                  "version": DATE_TAG,
                  "news": news_data,
                  "sources": DATA_SOURCES
              }
          
          def save_database(data):
              os.makedirs(os.path.dirname(DB_FILE), exist_ok=True)
              with open(DB_FILE, "w", encoding="utf-8") as f:
                  json.dump(data, f, indent=4, ensure_ascii=False)
              print(f"ğŸ’¾ [Server] Database saved to {DB_FILE}")
          
          def render_dashboard(data):
              print("ğŸ¨ [Renderer] Generating Dashboard...")
              repo = os.environ.get('GITHUB_REPOSITORY', 'Grand-Ops/Pogo')
              
              md = f"# ğŸ“± PokÃ©mon GO Ops Center (v{data['version']})\n"
              md += f"**Server Status:** ğŸŸ¢ Online | **Last Sync:** {data['timestamp']}\n\n"
              md += f"[![Release](https://img.shields.io/github/v/release/{repo}?label=Latest%20Release&color=success)](../../releases/latest) "
              md += f"![Python](https://img.shields.io/badge/Python-3.12-blue)\n\n"
          
              md += "## ğŸ”¥ Live Intelligence (News)\n"
              if data['news']:
                  for item in data['news']:
                      md += f"- `[{item['date']}]` [{item['title']}]({item['link']})\n"
              else:
                  md += "- No news data available.\n"
              md += "\n"
          
              md += "## ğŸ”— Critical Links\n"
              md += "| Category | Source | Access |\n"
              md += "| --- | --- | --- |\n"
              for category, sites in data['sources'].items():
                  for site in sites:
                      md += f"| {category} | **{site['name']}** | [Connect]({site['url']}) |\n"
              
              md += "\n---\n"
              md += f"*Grand-Ops-Master Automated System (Engine: Python 3.12)*"
          
              with open(README_FILE, "w", encoding="utf-8") as f:
                  f.write(md)
              
              if "GITHUB_STEP_SUMMARY" in os.environ:
                  with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as f:
                      f.write(f"## ğŸš€ Ops Server Report (v{data['version']})\n")
                      f.write(f"- **Data Points:** {len(data['news'])} items\n")
                      f.write(f"- **Database:** `data/daily_intel.json` updated.\n")
          
          if __name__ == "__main__":
              intel_data = collect_data()
              save_database(intel_data)
              render_dashboard(intel_data)
          EOF
          
          echo "âœ… scripts/ops_server.py has been generated/verified."

      # [ì—…ê·¸ë ˆì´ë“œ] íŒŒì´ì¬ 3.12 ì—”ì§„ ì‚¬ìš©
      - name: ğŸ Upgrade Python Engine to 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install feedparser pytz

      # [ì„œë²„ ê°€ë™] ì´ì œ íŒŒì¼ì´ í™•ì‹¤íˆ ìˆìœ¼ë¯€ë¡œ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•ŠìŒ
      - name: ğŸš€ Run Ops Server
        run: |
          python scripts/ops_server.py

      # [ì»¤ë°‹] ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ + ë°ì´í„° + ëŒ€ì‹œë³´ë“œ ëª¨ë‘ ì €ì¥
      - name: ğŸ’¾ Commit & Push All Artifacts
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Auto-Healing Server & Release v${{ steps.date.outputs.date }} [skip ci]"
          # scripts í´ë”ê¹Œì§€ í¬í•¨í•˜ì—¬ ì»¤ë°‹
          file_pattern: "README.md data/*.json scripts/*.py"
          commit_user_name: "Grand-Ops-Master-Bot"
          commit_user_email: "actions@github.com"
          push_options: '--force'
          tagging_message: "v${{ steps.date.outputs.date }}"

      # [ë¦´ë¦¬ì¦ˆ] GitHub Release ìƒì„± ë° JSON íŒŒì¼ ì²¨ë¶€
      - name: ğŸ·ï¸ Prepare Release Tag
        id: date
        run: echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.date.outputs.date }}
          name: ğŸ“¢ Ops Report v${{ steps.date.outputs.date }}
          body: |
            ## ğŸ“ Daily Operations Log
            ìë™í™” ì„œë²„ê°€ ìˆ˜ì§‘í•œ ì˜¤ëŠ˜ì˜ í¬ì¼“ëª¬ê³  ì¸í…”ë¦¬ì „ìŠ¤ ë°ì´í„°ì…ë‹ˆë‹¤.
            
            - **Engine:** Python 3.12
            - **Server:** Self-Healing Mode Active
            
            ### ğŸ“‚ Artifacts
            - `daily_intel.json`: ìˆ˜ì§‘ëœ ì›ë³¸ ë°ì´í„°ë² ì´ìŠ¤
          files: |
            data/daily_intel.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
