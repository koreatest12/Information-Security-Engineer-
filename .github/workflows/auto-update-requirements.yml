name: ìë™ ì—…ë°ì´íŠ¸ ë° ìš”êµ¬ì‚¬í•­ ê´€ë¦¬ (Grand Ops Master)

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œ ë³´ì—¬ì§ˆ ì´ë¦„
run-name: ğŸš€ ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°:ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë° ë™ê¸°í™” - ${{ github.ref_name }}

permissions:
  contents: write

on:
  # 1. 10ë¶„ ë‹¨ìœ„ ìë™ ì‹¤í–‰
  schedule:
    - cron: '*/10 * * * *'
  # 2. íŒŒì´ì¬ íŒŒì¼ ìˆ˜ì • ì‹œ ì‹¤í–‰
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.py'
  # 3. ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  workflow_dispatch:

jobs:
  grand-ops-execution:
    name: ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Seoul'

    steps:
      # ----------------------------------------------------------------
      # 1. ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ê°•ì œ ë™ê¸°í™”
      # ----------------------------------------------------------------
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ ë° ê°•ì œ ë¦¬ì…‹
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ê¹ƒ(Git) í™˜ê²½ ì´ˆê¸°í™”
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "grand-ops-master@github.com"
          
          echo "ğŸ”„ [Init] ì›ê²© ì €ì¥ì†Œ ìƒíƒœë¡œ ê°•ì œ ë™ê¸°í™”..."
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}

      # ----------------------------------------------------------------
      # 2. íŒŒì´ì¬ í™˜ê²½ ì„¤ì •
      # ----------------------------------------------------------------
      - name: íŒŒì´ì¬(Python) í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: í•„ìˆ˜ ë„êµ¬ ë° ë¶„ì„ê¸° ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade pipreqs setuptools wheel build
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œ í•„ìš”í•  ìˆ˜ ìˆëŠ” ê³µìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ì „ ì„¤ì¹˜
          pip install pandas numpy beautifulsoup4 fastapi requests || true

      # ----------------------------------------------------------------
      # 3. [ì‹ ê·œ ê¸°ëŠ¥] scripts í´ë” ì „ìš© ì²˜ë¦¬ ë° ì‹¤í–‰
      # ----------------------------------------------------------------
      - name: Scripts í´ë” ë¶„ì„ ë° ìë™ ì‹¤í–‰ (Auto-Execute)
        id: script_runner
        run: |
          echo "ğŸƒâ€â™‚ï¸ [Exec] 'scripts' ë””ë ‰í† ë¦¬ ì‘ì—… ì‹œì‘..."
          
          SCRIPT_DIR="./scripts"
          SCRIPT_LOG=""
          EXEC_COUNT=0
          
          # 1. scripts í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if [ -d "$SCRIPT_DIR" ]; then
            echo "ğŸ“‚ scripts ë””ë ‰í† ë¦¬ ê°ì§€ë¨."
            
            # 2. scripts í´ë” ì „ìš© requirements.txt ìƒì„±
            echo "ğŸ“¦ scripts ë‚´ë¶€ ì˜ì¡´ì„± ì¶”ì¶œ ì¤‘..."
            pipreqs "$SCRIPT_DIR" --force --encoding=utf-8 --savepath "$SCRIPT_DIR/requirements.txt"
            
            # 3. ì¶”ì¶œëœ ì˜ì¡´ì„± ì„¤ì¹˜ (ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì„ ìœ„í•´)
            if [ -f "$SCRIPT_DIR/requirements.txt" ]; then
                echo "â¬‡ï¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì„ ìœ„í•œ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
                pip install -r "$SCRIPT_DIR/requirements.txt"
            fi
            
            # 4. í´ë” ë‚´ ëª¨ë“  .py íŒŒì¼ ì‹¤í–‰
            echo "â–¶ï¸ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ì¼ê´„ ì‹¤í–‰ ì‹œì‘..."
            for script in "$SCRIPT_DIR"/*.py; do
                if [ -f "$script" ]; then
                    echo "   Running: $script"
                    # ì‹¤í–‰ ë° ê²°ê³¼ ìº¡ì²˜ (ì—ëŸ¬ ë‚˜ë„ ë©ˆì¶”ì§€ ì•ŠìŒ)
                    if python "$script"; then
                        STATUS="âœ… Success"
                    else
                        STATUS="âŒ Failed"
                    fi
                    SCRIPT_LOG+="- $script : $STATUS<br>"
                    EXEC_COUNT=$((EXEC_COUNT+1))
                fi
            done
          else
            echo "âš ï¸ scripts ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹¤í–‰ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            SCRIPT_LOG="(scripts í´ë” ì—†ìŒ)"
          fi
          
          # í™˜ê²½ë³€ìˆ˜ ì €ì¥ (ëŒ€ì‹œë³´ë“œìš©)
          echo "EXEC_COUNT=$EXEC_COUNT" >> $GITHUB_ENV
          # ë©€í‹°ë¼ì¸ í…ìŠ¤íŠ¸ ì €ì¥ì„ ìœ„í•œ ì²˜ë¦¬
          echo "SCRIPT_LOG<<EOF" >> $GITHUB_ENV
          echo "$SCRIPT_LOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 4. ì „ì²´ í”„ë¡œì íŠ¸ ìŠ¤ìº” (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
      # ----------------------------------------------------------------
      - name: ì „ì²´ í”„ë¡œì íŠ¸ Requirements ë™ê¸°í™”
        run: |
          echo "ğŸ” [Scan] ì „ì²´ í”„ë¡œì íŠ¸ ìŠ¤ìº”..."
          # ë£¨íŠ¸ ê²½ë¡œì˜ requirements.txt ê°±ì‹ 
          pipreqs . --force --encoding=utf-8 --ignore .github
          
          # ì „ì²´ íŒŒì¼ ìˆ˜ ì¹´ìš´íŠ¸
          PY_FILES=$(find . -type f -name "*.py" -not -path "./.git/*")
          FILE_COUNT=$(echo "$PY_FILES" | grep -c ".py" || true)
          echo "PY_COUNT=$FILE_COUNT" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 5. ëŒ€ì‹œë³´ë“œ(README) ì—…ë°ì´íŠ¸
      # ----------------------------------------------------------------
      - name: ëŒ€ì‹œë³´ë“œ(README) ì—…ë°ì´íŠ¸
        run: |
          NOW=$(date +'%Y-%m-%d %H:%M:%S')
          REPO="${{ github.repository }}"
          
          BADGE_STATUS="![ìƒíƒœ](https://github.com/$REPO/actions/workflows/grand-ops-master.yml/badge.svg)"
          BADGE_SCRIPTS="![ìŠ¤í¬ë¦½íŠ¸](https://img.shields.io/badge/Scripts_Run-${{ env.EXEC_COUNT }}-orange?logo=python)"
          
          echo "ğŸ“Š [Dashboard] ë¦¬í¬íŠ¸ ì‘ì„± ì¤‘..."

          cat <<EOF > README.md
          # ğŸ›¡ï¸ ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°: í†µí•© ê´€ì œ ì„¼í„°
          
          $BADGE_STATUS $BADGE_SCRIPTS
          
          ---
          
          ## ğŸ“¡ ìë™í™” ìš´ì˜ í˜„í™© (Automation Status)
          
          **ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°**ê°€ \`scripts\` í´ë”ë¥¼ ê°ì‹œí•˜ê³  ì‹¤í–‰ ê²°ê³¼ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
          
          | í•­ëª© (Metric) | ìƒíƒœ (Status) |
          | :--- | :--- |
          | **ë§ˆì§€ë§‰ ì‹¤í–‰** | ğŸ•’ $NOW (KST) |
          | **ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ìˆ˜** | ğŸƒâ€â™‚ï¸ **${{ env.EXEC_COUNT }}** ê°œ ì‹¤í–‰ ì‹œë„ |
          | **ì „ì²´ íŒŒì¼ ê´€ë¦¬** | ğŸ“‚ **${{ env.PY_COUNT }}** ê°œ Python íŒŒì¼ ìŠ¤ìº”ë¨ |
          | **íƒ€ê²Ÿ ë¸Œëœì¹˜** | ${{ github.ref_name }} |
          
          ---
          
          ## ğŸƒâ€â™‚ï¸ Scripts Execution Log (ì‹¤í–‰ ë¡œê·¸)
          \`scripts\` ë””ë ‰í† ë¦¬ ë‚´ë¶€ íŒŒì¼ ì‹¤í–‰ ê²°ê³¼:
          
          ${{ env.SCRIPT_LOG }}
          
          ---
          
          ## ğŸ“¦ Auto-Generated Dependencies
          
          ### 1. Root Project
          \`\`\`text
          $(cat requirements.txt)
          \`\`\`
          
          ### 2. Scripts Directory
          *(scripts/requirements.txt)*
          \`\`\`text
          $(if [ -f "./scripts/requirements.txt" ]; then cat ./scripts/requirements.txt; else echo "N/A"; fi)
          \`\`\`
          
          > _System v7.0 by Grand Ops Master_
          EOF

      # ----------------------------------------------------------------
      # 6. ê²°ê³¼ ë°˜ì˜ ë° ë¦´ë¦¬ì¦ˆ
      # ----------------------------------------------------------------
      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° ë¦´ë¦¬ì¦ˆ ë°°í¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add -A
          
          if git diff --staged --quiet; then
             echo "â„¹ï¸ (ë³€ê²½ ì—†ìŒ) ë¦´ë¦¬ì¦ˆ ë°°í¬ë§Œ ì§„í–‰í•©ë‹ˆë‹¤."
          else
             git commit -m "Grand-Ops: Ran ${{ env.EXEC_COUNT }} scripts & Updated Deps ($NOW)"
             git pull origin ${{ github.ref_name }} --rebase
             git push origin HEAD:${{ github.ref_name }}
          fi
          
          TAG_NAME="v$(date +'%Y.%m.%d-%H%M%S')"
          ZIP_NAME="Grand-Ops-Full-$TAG_NAME.zip"
          
          zip -r "$ZIP_NAME" . -x ".git/*" ".github/*"
          
          echo "ğŸš€ [Release] $TAG_NAME ë°°í¬..."
          gh release create "$TAG_NAME" \
            --title "ğŸš€ Grand-Ops Execution $TAG_NAME" \
            --notes "## ğŸƒâ€â™‚ï¸ Script Execution Report
            - **Executed Scripts**: ${{ env.EXEC_COUNT }}
            - **Status**: Scripts Ran & Requirements Synced" \
            "$ZIP_NAME" \
            requirements.txt

          echo "ğŸ‰ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë° ë°°í¬ ì™„ë£Œ!"
