name: ì´ˆì •ë°€ ìë™ ì—…ë°ì´íŠ¸ ë° ë°ì´í„° ì¹´ìš´íŒ… (Grand Ops Master v10.4)
run-name: ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ë° ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ - ${{ github.ref_name }}

permissions:
  contents: write
  packages: write

on:
  schedule:
    - cron: '0 */3 * * *'
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  grand-ops-execution:
    name: í•˜ì´ë¸Œë¦¬ë“œ ì˜¤í¼ë ˆì´ì…˜ ì‹¤í–‰
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Seoul'

    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ëŸ°íƒ€ì„ í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: í•„ìˆ˜ ë„êµ¬ ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
        run: |
          pip install pandas requests beautifulsoup4 tabulate
          # ë°ì´í„° ë””ë ‰í† ë¦¬ ë¯¸ì¡´ì¬ ì‹œ ìƒì„±
          mkdir -p data

      # [í•µì‹¬ ì¶”ê°€] ë°ì´í„° ìˆ˜ì§‘ ë° ê°œìˆ˜ ì¶”ì¶œ ë¡œì§
      - name: ë°ì´í„° ìˆ˜ì§‘ ì—”ì§„ ê°€ë™
        id: collector
        run: |
          echo "ğŸ” [Collector] ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„ ì‹œì‘..."
          
          # 1. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ì—¬ê¸°ì„œ data/daily_intel.json ë“±ì´ ìƒì„±ë¨)
          # ì˜ˆì‹œë¡œ scripts ë‚´ì˜ ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python scripts/collect_data.py || echo "ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ"
          
          # 2. ìƒì„±ëœ JSON íŒŒì¼ì—ì„œ ì•„ì´í…œ ê°œìˆ˜ íŒŒì•… (jq í™œìš©)
          # íŒŒì¼ì´ ì¡´ì¬í•˜ê³  ë°ì´í„°ê°€ ìˆë‹¤ë©´ ê°œìˆ˜ë¥¼ ì„¸ì–´ ENVì— ì €ì¥
          if [ -f "data/daily_intel.json" ]; then
            ITEM_COUNT=$(jq '. | length' data/daily_intel.json 2>/dev/null || echo "0")
          else
            ITEM_COUNT="0"
          fi
          
          echo "ITEM_COUNT=$ITEM_COUNT" >> $GITHUB_ENV
          echo "âœ… ìˆ˜ì§‘ëœ ì•„ì´í…œ ê°œìˆ˜: $ITEM_COUNT"

      - name: README ë° ë¦¬í¬íŠ¸ ì—…ë°ì´íŠ¸
        run: |
          NOW=$(date +'%Y.%m.%d')
          FULL_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          
          # ğŸš€ ë¦¬í¬íŠ¸ ë° ëŒ€ì‹œë³´ë“œ ìƒì„±
          cat <<EOF > README.md
          # ğŸ›¡ï¸ ì •ë³´ë³´ì•ˆ ê¸°ì‚¬: í†µí•© ìš´ì˜ ì‹œìŠ¤í…œ (v10.4)
          
          ### ğŸš€ Ops Server Report ($NOW)
          - **Data Points**: ğŸ“Š **${{ env.ITEM_COUNT }}** news items collected.
          - **Database**: [Download JSON](./data/daily_intel.json)
          
          ---
          ## ğŸ“Š ì‹œìŠ¤í…œ ê°€ë™ í˜„í™©
          | í•­ëª© | ìƒì„¸ ë‚´ìš© |
          | :--- | :--- |
          | **ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸** | $FULL_TIME (KST) |
          | **ìˆ˜ì§‘ëœ ë°ì´í„°** | ğŸ“‚ **${{ env.ITEM_COUNT }}** items |
          | **ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ** | \`data/daily_intel.json\` updated. |
          
          ## ğŸ› ï¸ ìµœê·¼ ì‹¤í–‰ ë¡œê·¸
          | êµ¬ë¶„ | ìƒíƒœ |
          | :--- | :--- |
          | **Data Collection** | âœ… Completed |
          | **Auto-Sync** | âœ… Resolved |
          
          ---
          > _System v10.4 by Grand Ops Master_
          EOF

      - name: ë°ì´í„° í‘¸ì‹œ ë° ë¦´ë¦¬ì¦ˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "Grand-Ops-Master-v10"
          git config --global user.email "ops-v10@github.com"
          
          git add -A
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            git commit -m "ğŸš€ Ops Update: ${{ env.ITEM_COUNT }} items collected ($NOW)"
            git push origin HEAD:${{ github.ref_name }} --force
            
            # ë¦´ë¦¬ì¦ˆ ìƒì„± ì‹œì—ë„ ê°œìˆ˜ ë°˜ì˜
            TAG="v$NOW-$(date +'%H%M%S')"
            gh release create "$TAG" --title "ğŸš€ Build $TAG (Items: ${{ env.ITEM_COUNT }})" --notes "ê¸ˆì¼ ìˆ˜ì§‘ëœ ë°ì´í„° ê°œìˆ˜: ${{ env.ITEM_COUNT }}ê°œ"
          fi
