name: Auto Generate Requirements and Push (Final Fix)

# ê¶Œí•œ ì„¤ì • (í•„ìˆ˜)
permissions:
  contents: write

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.py'
  workflow_dispatch:

jobs:
  force-update-job:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì²´í¬ì•„ì›ƒ (ëª¨ë“  íˆìŠ¤í† ë¦¬)
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. [í•µì‹¬] ê¼¬ì¸ íˆìŠ¤í† ë¦¬ ê°•ì œ ì´ˆê¸°í™” (Hard Reset)
      # ì™¸ë¶€ ì•¡ì…˜ ì—†ì´ ì§ì ‘ Git ëª…ë ¹ì–´ë¡œ ë¡œì»¬ ìƒíƒœë¥¼ ì›ê²© ì„œë²„ì™€ 100% ì¼ì¹˜ì‹œí‚µë‹ˆë‹¤.
      - name: Reset Local History to Remote
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "grand-ops-master@github.com"
          
          echo "ğŸ”„ Fetching latest info from remote..."
          git fetch origin
          
          echo "âš ï¸ Hard Resetting to match origin/${{ github.ref_name }}..."
          git reset --hard origin/${{ github.ref_name }}

      # 3. Python ì„¸íŒ…
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4. requirements.txt ìƒì„±
      - name: Generate requirements.txt
        run: |
          pip install pipreqs
          # .github í´ë” ì œì™¸í•˜ê³  ê°•ì œ ìƒì„±
          pipreqs . --force --encoding=utf-8 --ignore .github
          
          echo "âœ… requirements.txt Created:"
          cat requirements.txt

      # 5. [í•µì‹¬] ìˆ˜ë™ ì»¤ë°‹ ë° í‘¸ì‹œ (Manual Commit & Push)
      # git-auto-commit-actionì„ ì“°ì§€ ì•Šê³  ì§ì ‘ ëª…ë ¹ì–´ë¡œ ì²˜ë¦¬í•˜ì—¬ ì˜¤ë¥˜ ê°€ëŠ¥ì„± ì°¨ë‹¨
      - name: Commit and Push Manually
        run: |
          # ë³€ê²½ëœ ëª¨ë“  íŒŒì¼ ìŠ¤í…Œì´ì§•
          git add -A
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --staged --quiet; then
            echo "âœ‹ No changes detected. Exiting..."
            exit 0
          fi
          
          # ì»¤ë°‹ ì§„í–‰
          git commit -m "Update: requirements.txt and project files by Grand-Ops-Master"
          
          # í‘¸ì‹œ ì§„í–‰ (í˜¹ì‹œ ëª¨ë¥¼ ì¶©ëŒ ëŒ€ë¹„í•´ pull --rebase í•œë²ˆ ë” ìˆ˜í–‰ í›„ í‘¸ì‹œ)
          echo "ğŸš€ Pushing to remote..."
          git pull origin ${{ github.ref_name }} --rebase
          git push origin HEAD:${{ github.ref_name }}
