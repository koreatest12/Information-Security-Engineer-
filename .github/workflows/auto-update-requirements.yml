name: Grand Ops - Dashboard & Auto Release

permissions:
  contents: write

on:
  schedule:
    - cron: '*/10 * * * *'  # 10ë¶„ë§ˆë‹¤ ì‹¤í–‰
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.py'
  workflow_dispatch:

jobs:
  grand-ops-dashboard:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Seoul'

    steps:
      # 1. ì´ˆê¸°í™” ë° ê°•ì œ ë™ê¸°í™”
      - name: Checkout & Force Reset
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize Git
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "grand-ops-master@github.com"
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}

      # 2. ì‹œìŠ¤í…œ í™˜ê²½ êµ¬ì„±
      - name: Setup Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Tools
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade setuptools wheel build pipreqs
          pip install pandas numpy beautifulsoup4 fastapi || true

      # 3. Requirements ìƒì„±
      - name: Generate Requirements
        run: |
          pipreqs . --force --encoding=utf-8 --ignore .github

      # 4. [NEW] ëŒ€ì‹œë³´ë“œ(README.md) ìƒì„± ë° ì—…ë°ì´íŠ¸
      # ë¦¬í¬ì§€í† ë¦¬ ë©”ì¸ì— ë±ƒì§€ì™€ ìƒíƒœ í…Œì´ë¸”ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê¸°ë¡í•©ë‹ˆë‹¤.
      - name: Update Dashboard (README.md)
        run: |
          # í˜„ì¬ ì‹œê°„ ë° ì •ë³´ ë³€ìˆ˜ ì„¤ì •
          NOW=$(date +'%Y-%m-%d %H:%M:%S')
          REPO="${{ github.repository }}"
          WORKFLOW_NAME="Grand Ops - Dashboard & Auto Release"
          
          # ë±ƒì§€ URL ì„¤ì • (Shields.io ì‚¬ìš©)
          BADGE_BUILD="![Build Status](https://github.com/$REPO/actions/workflows/grand-ops-master.yml/badge.svg)"
          BADGE_LICENSE="![License](https://img.shields.io/github/license/$REPO)"
          BADGE_RELEASE="![Latest Release](https://img.shields.io/github/v/release/$REPO?color=blueviolet)"
          BADGE_PYTHON="![Python](https://img.shields.io/badge/Python-3.10-blue?logo=python&logoColor=white)"
          
          echo "ğŸ“Š [Dashboard] README.md ëŒ€ì‹œë³´ë“œ ê°±ì‹  ì¤‘..."

          # README.md ë‚´ìš© ì‘ì„± (ë®ì–´ì“°ê¸°)
          cat <<EOF > README.md
          # ğŸ›¡ï¸ Grand Ops Master: System Dashboard
          
          $BADGE_BUILD $BADGE_RELEASE $BADGE_PYTHON $BADGE_LICENSE
          
          ---
          
          ## ğŸ“¡ Real-time Operation Status (ì‹¤ì‹œê°„ ìš´ì˜ í˜„í™©)
          
          ì´ ì‹œìŠ¤í…œì€ **Grand-Ops-Master** ìë™í™” ì—”ì§„ì— ì˜í•´ 10ë¶„ ë‹¨ìœ„ë¡œ ê´€ë¦¬ë˜ê³  ìˆìŠµë‹ˆë‹¤.
          
          | Metric (ì§€í‘œ) | Status (ìƒíƒœ) |
          | :--- | :--- |
          | **Last Update** | ğŸ•’ $NOW (KST) |
          | **System Mode** | âœ… Always-On (No Skip) |
          | **Dependency Sync** | âœ… synchronized |
          | **Target Branch** | ${{ github.ref_name }} |
          
          ---
          
          ## ğŸ“¦ Auto-Generated Dependencies
          Current \`requirements.txt\` generated by \`pipreqs\`:
          
          \`\`\`text
          $(cat requirements.txt)
          \`\`\`
          
          > _Auto-generated by Grand Ops Automation System._
          EOF

      # 5. [ë¦´ë¦¬ì¦ˆ & íŒ¨í‚¤ì§•] ë²„ì „ ìƒì„±
      - name: Create Release & Package
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="v$(date +'%Y.%m.%d-%H%M%S')"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          
          # íŒŒì¼ ì••ì¶•
          zip -r "Grand-Ops-$TAG_NAME.zip" . -x ".git/*" ".github/*"
          
          # ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ (README.md í¬í•¨)
          git add -A
          
          if git diff --staged --quiet; then
             echo "â„¹ï¸ (Content Unchanged) But proceeding with release..."
          else
             git commit -m "Update: Dashboard & Files ($TAG_NAME)"
             git pull origin ${{ github.ref_name }} --rebase
             git push origin HEAD:${{ github.ref_name }}
          fi

          # ë¦´ë¦¬ì¦ˆ ë°°í¬
          gh release create "$TAG_NAME" \
            --title "ğŸš€ Release $TAG_NAME" \
            --notes "Auto-deployed release with updated Dashboard." \
            "Grand-Ops-$TAG_NAME.zip" \
            requirements.txt

      # 6. [ì•Œë¦¼] ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ ë¡œê·¸
      - name: Log Dashboard Update
        run: |
          echo "âœ… ëŒ€ì‹œë³´ë“œ(README.md)ê°€ ì„±ê³µì ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ğŸ”— í™•ì¸ ë§í¬: https://github.com/${{ github.repository }}"
