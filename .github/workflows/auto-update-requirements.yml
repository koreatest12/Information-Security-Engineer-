name: Grand Ops - Deep Scan & Dashboard System

# ê¶Œí•œ ì„¤ì •: íŒŒì¼ ìˆ˜ì • ë° ë¦´ë¦¬ì¦ˆ ë°°í¬ ê¶Œí•œ
permissions:
  contents: write

on:
  # 1. 10ë¶„ ë‹¨ìœ„ ìë™ ì‹¤í–‰
  schedule:
    - cron: '*/10 * * * *'
  # 2. ì½”ë“œ ë³€ê²½ ì‹œ ì‹¤í–‰
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.py'
  # 3. ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:

jobs:
  grand-ops-master:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Seoul'

    steps:
      # ----------------------------------------------------------------
      # 1. [ì‹œìŠ¤í…œ ì´ˆê¸°í™”] ê°•ì œ ë™ê¸°í™” (ì¶©ëŒ ë°©ì§€)
      # ----------------------------------------------------------------
      - name: Checkout & Force Reset
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize Git
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "grand-ops-master@github.com"
          
          echo "ğŸ”„ [Init] ì›ê²© ì €ì¥ì†Œì™€ ë™ê¸°í™” ì¤‘..."
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}

      # ----------------------------------------------------------------
      # 2. [í™˜ê²½ ì„¤ì •] Python ë° ë„êµ¬ ì¤€ë¹„
      # ----------------------------------------------------------------
      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Analysis Tools
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade pipreqs setuptools wheel build
          # ë¶„ì„ ì¤‘ë‹¨ ë°©ì§€ë¥¼ ìœ„í•œ í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„ íƒ‘ì¬
          pip install pandas numpy beautifulsoup4 fastapi || true

      # ----------------------------------------------------------------
      # 3. [í•µì‹¬ ê¸°ëŠ¥] ëª¨ë“  .py íŒŒì¼ ì •ë°€ ìŠ¤ìº” ë° Requirements ìƒì„±
      # ----------------------------------------------------------------
      - name: Deep Scan .py Files & Generate Requirements
        id: scanner
        run: |
          echo "ğŸ” [Scan] ë¦¬í¬ì§€í† ë¦¬ ë‚´ ëª¨ë“  .py íŒŒì¼ ê²€ìƒ‰ ì‹œì‘..."
          
          # 1. ëª¨ë“  í•˜ìœ„ í´ë”ì˜ .py íŒŒì¼ ì°¾ê¸° ë° ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
          PY_FILES=$(find . -type f -name "*.py" -not -path "./.git/*")
          FILE_COUNT=$(echo "$PY_FILES" | grep -c ".py" || true)
          
          echo "------------------------------------------------"
          echo "ğŸ“„ Detected Python Files ($FILE_COUNT files):"
          echo "$PY_FILES"
          echo "------------------------------------------------"
          
          # 2. ì°¾ì€ íŒŒì¼ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ requirements.txt ì¦‰ì‹œ ìƒì„±
          # --force: ë®ì–´ì“°ê¸°, --savepath: í˜„ì¬ ìœ„ì¹˜ì— ì €ì¥
          pipreqs . --force --encoding=utf-8 --ignore .github
          
          echo "âœ… requirements.txt ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          
          # í™˜ê²½ ë³€ìˆ˜ë¡œ íŒŒì¼ ê°œìˆ˜ ì €ì¥ (ëŒ€ì‹œë³´ë“œ í‘œê¸°ìš©)
          echo "PY_COUNT=$FILE_COUNT" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 4. [ì‹œê°í™”] ëŒ€ì‹œë³´ë“œ(README.md) ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
      # ----------------------------------------------------------------
      - name: Update Live Dashboard (README.md)
        run: |
          NOW=$(date +'%Y-%m-%d %H:%M:%S')
          REPO="${{ github.repository }}"
          
          # ë±ƒì§€ ì„¤ì •
          BADGE_BUILD="![Status](https://github.com/$REPO/actions/workflows/grand-ops-master.yml/badge.svg)"
          BADGE_RELEASE="![Release](https://img.shields.io/github/v/release/$REPO?color=blueviolet)"
          BADGE_FILES="![Files](https://img.shields.io/badge/Scanned_Files-${{ env.PY_COUNT }}-success?logo=python)"
          
          echo "ğŸ“Š [Dashboard] README.md í˜„í™©íŒ ê°±ì‹ ..."

          cat <<EOF > README.md
          # ğŸ›¡ï¸ Grand Ops Master: Security Engineer Dashboard
          
          $BADGE_BUILD $BADGE_RELEASE $BADGE_FILES
          
          ---
          
          ## ğŸ“¡ Real-time System Status
          
          **Grand-Ops-Master** ì—”ì§„ì´ ë¦¬í¬ì§€í† ë¦¬ì˜ ëª¨ë“  Python ì½”ë“œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì‹œí•˜ê³  ìˆìŠµë‹ˆë‹¤.
          
          | Metric (ì§€í‘œ) | Value (ê°’) |
          | :--- | :--- |
          | **Last Scan** | ğŸ•’ $NOW (KST) |
          | **Scanned Files** | ğŸ“‚ **${{ env.PY_COUNT }}** Python files detected |
          | **Sync Mode** | ğŸš€ Deep Scan & Auto-Push |
          | **Branch** | ${{ github.ref_name }} |
          
          ---
          
          ## ğŸ“¦ Active Dependencies (Requirements)
          ì‹œìŠ¤í…œì´ ì†ŒìŠ¤ì½”ë“œë¥¼ ë¶„ì„í•˜ì—¬ ìë™ìœ¼ë¡œ ì¶”ì¶œí•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ì…ë‹ˆë‹¤.
          
          \`\`\`text
          $(cat requirements.txt)
          \`\`\`
          
          > _Powered by Grand Ops Automation System v5.0_
          EOF

      # ----------------------------------------------------------------
      # 5. [ë°°í¬] ì»¤ë°‹, í‘¸ì‹œ, ë¦´ë¦¬ì¦ˆ & íŒ¨í‚¤ì§• (All-in-One)
      # ----------------------------------------------------------------
      - name: Commit, Push & Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. íŒŒì¼ ìŠ¤í…Œì´ì§• ë° ì»¤ë°‹
          git add -A
          
          if git diff --staged --quiet; then
             echo "â„¹ï¸ (No Changes) íŒŒì¼ ë³€ê²½ ì—†ìŒ. í•˜ì§€ë§Œ ë¦´ë¦¬ì¦ˆëŠ” ì§„í–‰í•©ë‹ˆë‹¤."
          else
             git commit -m "Grand-Ops: Scanned ${{ env.PY_COUNT }} files & Updated Req ($NOW)"
             git pull origin ${{ github.ref_name }} --rebase
             git push origin HEAD:${{ github.ref_name }}
          fi
          
          # 2. ë²„ì „ íƒœê·¸ ë° íŒ¨í‚¤ì§€ ìƒì„±
          TAG_NAME="v$(date +'%Y.%m.%d-%H%M%S')"
          ZIP_NAME="Grand-Ops-Source-$TAG_NAME.zip"
          
          zip -r "$ZIP_NAME" . -x ".git/*" ".github/*"
          
          # 3. ë¦´ë¦¬ì¦ˆ ë°°í¬
          echo "ğŸš€ [Release] $TAG_NAME ë°°í¬ ì‹œì‘..."
          gh release create "$TAG_NAME" \
            --title "ğŸš€ Grand-Ops Release $TAG_NAME" \
            --notes "## ğŸ” Deep Scan Report
            - **Scanned Python Files**: ${{ env.PY_COUNT }}
            - **Status**: Requirements Updated & Synced" \
            "$ZIP_NAME" \
            requirements.txt

          echo "ğŸ‰ ëª¨ë“  ì‘ì—… ì™„ë£Œ!"
