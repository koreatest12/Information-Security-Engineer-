name: ìë™ ì—…ë°ì´íŠ¸ ë° ìš”êµ¬ì‚¬í•­ ê´€ë¦¬ (Grand Ops Master)

run-name: ğŸš€ ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°:ì¶©ëŒ í•´ê²° ë° ì‹¤í–‰ - ${{ github.ref_name }}

permissions:
  contents: write

on:
  schedule:
    - cron: '*/10 * * * *'
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.py'
  workflow_dispatch:

jobs:
  grand-ops-execution:
    name: ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Seoul'

    steps:
      # ----------------------------------------------------------------
      # 1. ì‹œìŠ¤í…œ ì´ˆê¸°í™” (í´ë¦° ë¶€íŒ…)
      # ----------------------------------------------------------------
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ ë° ë¦¬ì…‹
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ê¹ƒ(Git) í™˜ê²½ ì´ˆê¸°í™”
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "grand-ops-master@github.com"
          
          # ë°”ì´ë„ˆë¦¬ íŒŒì¼(.db, .sig) ì¶©ëŒ ì‹œ í˜„ì¬(Local) ë²„ì „ì„ ìš°ì„ ì‹œí•˜ë„ë¡ ì„¤ì •
          echo "*.db binary" >> .gitattributes
          echo "*.sig binary" >> .gitattributes
          echo "*.sqlite binary" >> .gitattributes
          
          echo "ğŸ”„ [Init] ì›ê²© ì €ì¥ì†Œ ìƒíƒœë¡œ ë¦¬ì…‹..."
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}

      # ----------------------------------------------------------------
      # 2. íŒŒì´ì¬ 3.12 í™˜ê²½ ë° í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜
      # ----------------------------------------------------------------
      - name: íŒŒì´ì¬(Python) 3.12 í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ (Tabulate ì¶”ê°€ë¨)
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade pipreqs setuptools wheel build
          
          # [ì¤‘ìš”] ë¡œê·¸ì—ì„œ ë°œê²¬ëœ ëˆ„ë½ ë¼ì´ë¸ŒëŸ¬ë¦¬(tabulate) ë° ê³µìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
          pip install pandas numpy beautifulsoup4 fastapi requests tabulate || true

      # ----------------------------------------------------------------
      # 3. Scripts í´ë” ìŠ¤ë§ˆíŠ¸ ë¶„ì„ ë° ì‹¤í–‰
      # ----------------------------------------------------------------
      - name: Scripts í´ë” ë¶„ì„ ë° ìë™ ì‹¤í–‰
        id: script_runner
        run: |
          echo "ğŸƒâ€â™‚ï¸ [Exec] 'scripts' ë””ë ‰í† ë¦¬ ì‘ì—… ì‹œì‘..."
          
          SCRIPT_DIR="./scripts"
          SCRIPT_LOG=""
          EXEC_COUNT=0
          
          if [ -d "$SCRIPT_DIR" ]; then
            
            # 1. ì˜ì¡´ì„± ì¶”ì¶œ
            pipreqs "$SCRIPT_DIR" --force --encoding=utf-8 --savepath "$SCRIPT_DIR/requirements.txt"
            
            # 2. ìŠ¤ë§ˆíŠ¸ ì„¤ì¹˜ (í˜¸í™˜ì„± ë¬¸ì œ ìë™ í•´ê²°)
            if [ -f "$SCRIPT_DIR/requirements.txt" ]; then
                echo "â¬‡ï¸ ìŠ¤í¬ë¦½íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œë„..."
                if pip install -r "$SCRIPT_DIR/requirements.txt"; then
                    echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì„±ê³µ"
                else
                    echo "âš ï¸ [Fix] í˜¸í™˜ì„± ì—ëŸ¬ ê°ì§€! ë²„ì „ ì œí•œ í•´ì œ í›„ ì¬ì‹œë„..."
                    sed 's/==.*$//' "$SCRIPT_DIR/requirements.txt" > "$SCRIPT_DIR/requirements.loose.txt"
                    pip install -r "$SCRIPT_DIR/requirements.loose.txt" || true
                fi
            fi
            
            # 3. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            echo "â–¶ï¸ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ì¼ê´„ ì‹¤í–‰..."
            for script in "$SCRIPT_DIR"/*.py; do
                if [ -f "$script" ]; then
                    echo "   Running: $script"
                    # ì‹¤í–‰ ê²°ê³¼ ìº¡ì²˜
                    if python "$script"; then
                        STATUS="âœ… Success"
                    else
                        STATUS="âŒ Failed"
                    fi
                    SCRIPT_LOG+="- $script : $STATUS<br>"
                    EXEC_COUNT=$((EXEC_COUNT+1))
                fi
            done
          else
            SCRIPT_LOG="(scripts í´ë” ì—†ìŒ)"
          fi
          
          echo "EXEC_COUNT=$EXEC_COUNT" >> $GITHUB_ENV
          echo "SCRIPT_LOG<<EOF" >> $GITHUB_ENV
          echo "$SCRIPT_LOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 4. ì „ì²´ í”„ë¡œì íŠ¸ ìŠ¤ìº”
      # ----------------------------------------------------------------
      - name: ì „ì²´ í”„ë¡œì íŠ¸ Requirements ë™ê¸°í™”
        run: |
          echo "ğŸ” [Scan] ì „ì²´ í”„ë¡œì íŠ¸ ìŠ¤ìº”..."
          pipreqs . --force --encoding=utf-8 --ignore .github
          
          PY_FILES=$(find . -type f -name "*.py" -not -path "./.git/*")
          FILE_COUNT=$(echo "$PY_FILES" | grep -c ".py" || true)
          echo "PY_COUNT=$FILE_COUNT" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 5. ëŒ€ì‹œë³´ë“œ(README) ì—…ë°ì´íŠ¸
      # ----------------------------------------------------------------
      - name: ëŒ€ì‹œë³´ë“œ(README) ì—…ë°ì´íŠ¸
        run: |
          NOW=$(date +'%Y-%m-%d %H:%M:%S')
          REPO="${{ github.repository }}"
          
          BADGE_STATUS="![ìƒíƒœ](https://github.com/$REPO/actions/workflows/grand-ops-master.yml/badge.svg)"
          BADGE_SCRIPTS="![ìŠ¤í¬ë¦½íŠ¸](https://img.shields.io/badge/Scripts_Run-${{ env.EXEC_COUNT }}-orange?logo=python)"
          
          cat <<EOF > README.md
          # ğŸ›¡ï¸ ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°: í†µí•© ê´€ì œ ì„¼í„°
          
          $BADGE_STATUS $BADGE_SCRIPTS
          
          ---
          
          ## ğŸ“¡ ìë™í™” ìš´ì˜ í˜„í™© (System Status)
          
          **ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°**ê°€ DB ì¶©ëŒì„ ìë™ í•´ê²°í•˜ê³  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
          
          | í•­ëª© (Metric) | ìƒíƒœ (Status) |
          | :--- | :--- |
          | **ì‹œìŠ¤í…œ ë²„ì „** | ğŸ **Python 3.12** (Tabulate Support) |
          | **ë§ˆì§€ë§‰ ì‹¤í–‰** | ğŸ•’ $NOW (KST) |
          | **ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰** | ğŸƒâ€â™‚ï¸ **${{ env.EXEC_COUNT }}** ê°œ ìˆ˜í–‰ |
          | **ë°ì´í„°ë² ì´ìŠ¤** | ğŸ’¾ Auto-Sync & Conflict Resolved |
          
          ---
          
          ## ğŸƒâ€â™‚ï¸ Scripts Execution Log
          
          ${{ env.SCRIPT_LOG }}
          
          ---
          
          ## ğŸ“¦ Auto-Generated Dependencies
          
          ### Root
          \`\`\`text
          $(cat requirements.txt)
          \`\`\`
          
          ### Scripts
          \`\`\`text
          $(if [ -f "./scripts/requirements.txt" ]; then cat ./scripts/requirements.txt; else echo "N/A"; fi)
          \`\`\`
          
          > _System v9.0 by Grand Ops Master_
          EOF

      # ----------------------------------------------------------------
      # 6. [í•µì‹¬] ì¶©ëŒ í•´ê²° ë° ê°•ì œ ë³‘í•© ì»¤ë°‹ (Conflict Auto-Resolver)
      # ----------------------------------------------------------------
      - name: ì¶©ëŒ í•´ê²° ë° ê²°ê³¼ ë°˜ì˜
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. ëª¨ë“  ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§• (DB íŒŒì¼ í¬í•¨)
          git add -A
          
          # 2. ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --staged --quiet; then
             echo "â„¹ï¸ (ë³€ê²½ ì—†ìŒ) ë¦´ë¦¬ì¦ˆ í”„ë¡œì„¸ìŠ¤ë¡œ ì´ë™"
          else
             echo "ğŸ“ ì»¤ë°‹ ìƒì„± ì¤‘..."
             git commit -m "Grand-Ops: Resolve Conflicts & Update Data ($NOW)"
             
             # 3. [í•µì‹¬] ë³‘í•© ì „ëµ ìˆ˜ì • (Merge Strategy: Ours)
             # ë¦¬ë² ì´ìŠ¤(Rebase) ëŒ€ì‹  ë³‘í•©(Merge)ì„ ì‚¬ìš©í•˜ë©°, 
             # ì¶©ëŒ ì‹œ 'í˜„ì¬ ì›Œí¬í”Œë¡œìš°ì˜ íŒŒì¼(Ours)'ì„ ë¬´ì¡°ê±´ ì±„íƒí•˜ì—¬ ë°”ì´ë„ˆë¦¬ ì˜¤ë¥˜ í•´ê²°
             echo "âš”ï¸ ì›ê²© ì €ì¥ì†Œì™€ ë³‘í•© ì‹œë„ (ì „ëµ: Ours)..."
             git fetch origin
             git merge -X ours origin/${{ github.ref_name }} --no-edit
             
             # 4. í‘¸ì‹œ
             echo "ğŸš€ í‘¸ì‹œ ì§„í–‰..."
             git push origin HEAD:${{ github.ref_name }}
          fi
          
          # 7. ë¦´ë¦¬ì¦ˆ ë°°í¬
          TAG_NAME="v$(date +'%Y.%m.%d-%H%M%S')"
          ZIP_NAME="Grand-Ops-System-$TAG_NAME.zip"
          
          zip -r "$ZIP_NAME" . -x ".git/*" ".github/*"
          
          gh release create "$TAG_NAME" \
            --title "ğŸš€ Grand-Ops System $TAG_NAME" \
            --notes "## âš”ï¸ Conflict Resolution Report
            - **Binary Files**: Auto-merged using 'Ours' strategy
            - **Executed Scripts**: ${{ env.EXEC_COUNT }}
            - **Status**: Operational" \
            "$ZIP_NAME" \
            requirements.txt

          echo "ğŸ‰ ëª¨ë“  ì¶©ëŒ í•´ê²° ë° ë°°í¬ ì™„ë£Œ!"
