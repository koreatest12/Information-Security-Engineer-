name: ìë™ ì—…ë°ì´íŠ¸ ë° ìš”êµ¬ì‚¬í•­ ê´€ë¦¬ (Grand Ops Master)

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œ ë³´ì—¬ì§ˆ ì´ë¦„
run-name: ğŸš€ ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°:ìŠ¤ë§ˆíŠ¸ ì˜ì¡´ì„± í•´ê²° ë° ì‹¤í–‰ - ${{ github.ref_name }}

permissions:
  contents: write

on:
  # 1. 10ë¶„ ë‹¨ìœ„ ìë™ ì‹¤í–‰
  schedule:
    - cron: '*/10 * * * *'
  # 2. íŒŒì´ì¬ íŒŒì¼ ìˆ˜ì • ì‹œ ì‹¤í–‰
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.py'
  # 3. ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  workflow_dispatch:

jobs:
  grand-ops-execution:
    name: ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Seoul'

    steps:
      # ----------------------------------------------------------------
      # 1. ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ê°•ì œ ë™ê¸°í™”
      # ----------------------------------------------------------------
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ ë° ê°•ì œ ë¦¬ì…‹
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ê¹ƒ(Git) í™˜ê²½ ì´ˆê¸°í™”
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "grand-ops-master@github.com"
          
          echo "ğŸ”„ [Init] ì›ê²© ì €ì¥ì†Œ ìƒíƒœë¡œ ê°•ì œ ë™ê¸°í™”..."
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}

      # ----------------------------------------------------------------
      # 2. [ì—…ê·¸ë ˆì´ë“œ] íŒŒì´ì¬ 3.12 í™˜ê²½ ì„¤ì • (Numpy í˜¸í™˜ì„± í•´ê²°)
      # ----------------------------------------------------------------
      - name: íŒŒì´ì¬(Python) 3.12 í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'  # 3.10 -> 3.12ë¡œ ìƒí–¥ (NumPy 2.x ì§€ì›)

      - name: í•„ìˆ˜ ë„êµ¬ ë° ë¶„ì„ê¸° ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade pipreqs setuptools wheel build
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì•ˆì •ì„±ì„ ìœ„í•œ ê³µìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
          pip install pandas numpy beautifulsoup4 fastapi requests || true

      # ----------------------------------------------------------------
      # 3. Scripts í´ë” ìŠ¤ë§ˆíŠ¸ ë¶„ì„ ë° ì‹¤í–‰ (Smart Install ì ìš©)
      # ----------------------------------------------------------------
      - name: Scripts í´ë” ë¶„ì„ ë° ìë™ ì‹¤í–‰ (Auto-Execute)
        id: script_runner
        run: |
          echo "ğŸƒâ€â™‚ï¸ [Exec] 'scripts' ë””ë ‰í† ë¦¬ ì‘ì—… ì‹œì‘..."
          
          SCRIPT_DIR="./scripts"
          SCRIPT_LOG=""
          EXEC_COUNT=0
          
          if [ -d "$SCRIPT_DIR" ]; then
            echo "ğŸ“‚ scripts ë””ë ‰í† ë¦¬ ê°ì§€ë¨."
            
            # 1. ì˜ì¡´ì„± ì¶”ì¶œ
            echo "ğŸ“¦ scripts ë‚´ë¶€ ì˜ì¡´ì„± ì¶”ì¶œ ì¤‘..."
            pipreqs "$SCRIPT_DIR" --force --encoding=utf-8 --savepath "$SCRIPT_DIR/requirements.txt"
            
            # 2. [ìŠ¤ë§ˆíŠ¸ ì„¤ì¹˜] ì˜ì¡´ì„± ì„¤ì¹˜ (ì‹¤íŒ¨ ì‹œ ìœ ì—°í•œ ëŒ€ì²˜)
            if [ -f "$SCRIPT_DIR/requirements.txt" ]; then
                echo "â¬‡ï¸ ìŠ¤í¬ë¦½íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œë„..."
                
                # ë¨¼ì € ì—„ê²©í•œ ë²„ì „(==x.x.x)ìœ¼ë¡œ ì„¤ì¹˜ ì‹œë„
                if pip install -r "$SCRIPT_DIR/requirements.txt"; then
                    echo "âœ… ì—„ê²©í•œ ë²„ì „ ì„¤ì¹˜ ì„±ê³µ!"
                else
                    echo "âš ï¸ [Warning] ë²„ì „ í˜¸í™˜ì„± ì—ëŸ¬ ë°œìƒ! (Numpy ë“±)"
                    echo "ğŸ”§ 'ìœ ì—°í•œ ì„¤ì¹˜ ëª¨ë“œ'ë¡œ ì „í™˜í•©ë‹ˆë‹¤..."
                    
                    # ==ë²„ì „ëª… ì œê±° í›„ ì„¤ì¹˜ (sed ëª…ë ¹ì–´ë¡œ ë²„ì „ ì •ë³´ ì‚­ì œ)
                    sed 's/==.*$//' "$SCRIPT_DIR/requirements.txt" > "$SCRIPT_DIR/requirements.loose.txt"
                    
                    if pip install -r "$SCRIPT_DIR/requirements.loose.txt"; then
                        echo "âœ… ìœ ì—°í•œ ì„¤ì¹˜ ì„±ê³µ (ìµœì‹  í˜¸í™˜ ë²„ì „ ì ìš©ë¨)"
                    else
                        echo "âŒ ìœ ì—°í•œ ì„¤ì¹˜ë„ ì‹¤íŒ¨í•¨. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì— ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                    fi
                fi
            fi
            
            # 3. í´ë” ë‚´ ëª¨ë“  .py íŒŒì¼ ì‹¤í–‰
            echo "â–¶ï¸ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ì¼ê´„ ì‹¤í–‰ ì‹œì‘..."
            for script in "$SCRIPT_DIR"/*.py; do
                if [ -f "$script" ]; then
                    echo "   Running: $script"
                    if python "$script"; then
                        STATUS="âœ… Success"
                    else
                        STATUS="âŒ Failed"
                    fi
                    SCRIPT_LOG+="- $script : $STATUS<br>"
                    EXEC_COUNT=$((EXEC_COUNT+1))
                fi
            done
          else
            echo "âš ï¸ scripts ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹¤í–‰ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            SCRIPT_LOG="(scripts í´ë” ì—†ìŒ)"
          fi
          
          echo "EXEC_COUNT=$EXEC_COUNT" >> $GITHUB_ENV
          echo "SCRIPT_LOG<<EOF" >> $GITHUB_ENV
          echo "$SCRIPT_LOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 4. ì „ì²´ í”„ë¡œì íŠ¸ ìŠ¤ìº” (ê¸°ì¡´ ê¸°ëŠ¥)
      # ----------------------------------------------------------------
      - name: ì „ì²´ í”„ë¡œì íŠ¸ Requirements ë™ê¸°í™”
        run: |
          echo "ğŸ” [Scan] ì „ì²´ í”„ë¡œì íŠ¸ ìŠ¤ìº”..."
          pipreqs . --force --encoding=utf-8 --ignore .github
          
          PY_FILES=$(find . -type f -name "*.py" -not -path "./.git/*")
          FILE_COUNT=$(echo "$PY_FILES" | grep -c ".py" || true)
          echo "PY_COUNT=$FILE_COUNT" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 5. ëŒ€ì‹œë³´ë“œ(README) ì—…ë°ì´íŠ¸
      # ----------------------------------------------------------------
      - name: ëŒ€ì‹œë³´ë“œ(README) ì—…ë°ì´íŠ¸
        run: |
          NOW=$(date +'%Y-%m-%d %H:%M:%S')
          REPO="${{ github.repository }}"
          
          BADGE_STATUS="![ìƒíƒœ](https://github.com/$REPO/actions/workflows/grand-ops-master.yml/badge.svg)"
          BADGE_PYTHON="![Python](https://img.shields.io/badge/Python-3.12-blue?logo=python&logoColor=white)"
          BADGE_SCRIPTS="![ìŠ¤í¬ë¦½íŠ¸](https://img.shields.io/badge/Scripts_Run-${{ env.EXEC_COUNT }}-orange?logo=python)"
          
          cat <<EOF > README.md
          # ğŸ›¡ï¸ ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°: í†µí•© ê´€ì œ ì„¼í„°
          
          $BADGE_STATUS $BADGE_PYTHON $BADGE_SCRIPTS
          
          ---
          
          ## ğŸ“¡ ìë™í™” ìš´ì˜ í˜„í™© (Automation Status)
          
          **ê·¸ëœë“œ ì˜¤í¼ë ˆì´ì…˜ ë§ˆìŠ¤í„°**ê°€ ì‹œìŠ¤í…œ í˜¸í™˜ì„±ì„ ìë™ìœ¼ë¡œ í•´ê²°í•˜ê³  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
          
          | í•­ëª© (Metric) | ìƒíƒœ (Status) |
          | :--- | :--- |
          | **ì‹œìŠ¤í…œ ë²„ì „** | ğŸ **Python 3.12** (Upgraded) |
          | **ë§ˆì§€ë§‰ ì‹¤í–‰** | ğŸ•’ $NOW (KST) |
          | **ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰** | ğŸƒâ€â™‚ï¸ **${{ env.EXEC_COUNT }}** ê°œ ìˆ˜í–‰ |
          | **ì „ì²´ íŒŒì¼** | ğŸ“‚ **${{ env.PY_COUNT }}** ê°œ ìŠ¤ìº”ë¨ |
          
          ---
          
          ## ğŸƒâ€â™‚ï¸ Scripts Execution Log (ì‹¤í–‰ ë¡œê·¸)
          \`scripts\` ë””ë ‰í† ë¦¬ ë‚´ë¶€ ì‹¤í–‰ ê²°ê³¼:
          
          ${{ env.SCRIPT_LOG }}
          
          ---
          
          ## ğŸ“¦ Auto-Generated Dependencies
          
          ### Root Project
          \`\`\`text
          $(cat requirements.txt)
          \`\`\`
          
          ### Scripts Directory
          \`\`\`text
          $(if [ -f "./scripts/requirements.txt" ]; then cat ./scripts/requirements.txt; else echo "N/A"; fi)
          \`\`\`
          
          > _System v8.0 by Grand Ops Master_
          EOF

      # ----------------------------------------------------------------
      # 6. ê²°ê³¼ ë°˜ì˜ ë° ë¦´ë¦¬ì¦ˆ
      # ----------------------------------------------------------------
      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° ë¦´ë¦¬ì¦ˆ ë°°í¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add -A
          
          if git diff --staged --quiet; then
             echo "â„¹ï¸ (ë³€ê²½ ì—†ìŒ) ë¦´ë¦¬ì¦ˆ ë°°í¬ ì§„í–‰"
          else
             git commit -m "Grand-Ops: Smart Install & Executed ${{ env.EXEC_COUNT }} scripts ($NOW)"
             git pull origin ${{ github.ref_name }} --rebase
             git push origin HEAD:${{ github.ref_name }}
          fi
          
          TAG_NAME="v$(date +'%Y.%m.%d-%H%M%S')"
          ZIP_NAME="Grand-Ops-Full-$TAG_NAME.zip"
          
          zip -r "$ZIP_NAME" . -x ".git/*" ".github/*"
          
          echo "ğŸš€ [Release] $TAG_NAME ë°°í¬..."
          gh release create "$TAG_NAME" \
            --title "ğŸš€ Grand-Ops Execution $TAG_NAME" \
            --notes "## ğŸƒâ€â™‚ï¸ Script Execution & Fix Report
            - **Status**: Python 3.12 Upgrade & Smart Dependency Fix
            - **Executed Scripts**: ${{ env.EXEC_COUNT }}
            - **Dependency**: Auto-resolved conflicts" \
            "$ZIP_NAME" \
            requirements.txt

          echo "ğŸ‰ ëª¨ë“  í˜¸í™˜ì„± ë¬¸ì œ í•´ê²° ë° ë°°í¬ ì™„ë£Œ!"
