name: ì´ˆì •ë°€ ìë™ ì—…ë°ì´íŠ¸ ë° ë‹¤ì¤‘ ì–¸ì–´ ë°°í¬ (Grand Ops Master v10)
run-name: ğŸš€ ìš´ì˜ ë§ˆìŠ¤í„°:í•˜ì´ë¸Œë¦¬ë“œ ì‹¤í–‰ ë° ë°°í¬ - ${{ github.ref_name }}

permissions:
  contents: write
  packages: write

on:
  schedule:
    - cron: '*/15 * * * *'
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.py'
      - '**.java'
      - '**.sh'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  grand-ops-execution:
    name: í•˜ì´ë¸Œë¦¬ë“œ ì˜¤í¼ë ˆì´ì…˜ ì‹¤í–‰
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Seoul'

    steps:
      # 1. ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ì†ë„ ìµœì í™”: fetch-depth 1)
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ (Fast Fetch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # ìµœì‹  ìƒíƒœë§Œ ê°€ì ¸ì™€ì„œ ì†ë„ë¥¼ ëŒ€í­ í–¥ìƒì‹œí‚µë‹ˆë‹¤.

      - name: ê¹ƒ(Git) í™˜ê²½ ë° ë°”ì´ë„ˆë¦¬ ì²˜ë¦¬
        run: |
          git config --global user.name "Grand-Ops-Master-v10"
          git config --global user.email "ops-v10@github.com"
          # ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ ì†ì„± ì •ì˜
          echo "*.db binary" > .gitattributes
          echo "*.sqlite binary" >> .gitattributes
          echo "*.jar binary" >> .gitattributes
          # ì›ê²©ì˜ ìµœì‹  ìƒíƒœì™€ ë™ê¸°í™”
          git fetch origin ${{ github.ref_name }}
          git reset --soft origin/${{ github.ref_name }}

      # 2. ë‹¤ì¤‘ ì–¸ì–´ í™˜ê²½ êµ¬ì¶• (ë³‘ë ¬ ì„¤ì¹˜ ëŠë‚Œìœ¼ë¡œ êµ¬ì„±)
      - name: ëŸ°íƒ€ì„ í™˜ê²½ ì„¤ì • (Python 3.12 & Java 21)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: ìë°” JDK ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ì¢…ì†ì„± ë„êµ¬ ê³ ì† ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          # í•„ìš”í•œ í•µì‹¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë§Œ ì„ ë³„ ì„¤ì¹˜í•˜ì—¬ ì‹œê°„ ë‹¨ì¶•
          pip install pandas numpy beautifulsoup4 fastapi requests tabulate pipreqs
          sudo apt-get update && sudo apt-get install -y jq zip curl

      # 3. í†µí•© ì„œë¹„ìŠ¤ ë¶„ì„ ë° ì‹¤í–‰ (scripts í´ë” ì§‘ì¤‘í™”)
      - name: í•˜ì´ë¸Œë¦¬ë“œ ì—”ì§„ ê°€ë™
        id: engine
        run: |
          echo "ğŸƒâ€â™‚ï¸ [Engine] ë‹¤ì¤‘ ì–¸ì–´ ì„œë¹„ìŠ¤ ì‹¤í–‰ ì‹œì‘..."
          SCRIPT_DIR="./scripts"
          LOG_CONTENT=""
          SUCCESS_COUNT=0
          
          if [ -d "$SCRIPT_DIR" ]; then
            cd "$SCRIPT_DIR"
            # Python ì„¹ì…˜
            if ls *.py >/dev/null 2>&1; then
              pip install -r requirements.txt 2>/dev/null || pip install pandas requests tabulate
              for f in *.py; do
                echo "Running Python: $f"
                python "$f" && { LOG_CONTENT+="| Python | $f | âœ… Success |<br>"; SUCCESS_COUNT=$((SUCCESS_COUNT+1)); } || LOG_CONTENT+="| Python | $f | âŒ Failed |<br>"
              done
            fi
            # Java ì„¹ì…˜
            if ls *.java >/dev/null 2>&1; then
              for f in *.java; do
                echo "Compiling/Running Java: $f"
                javac "$f" && java "${f%.*}" && { LOG_CONTENT+="| Java | $f | âœ… Success |<br>"; SUCCESS_COUNT=$((SUCCESS_COUNT+1)); } || LOG_CONTENT+="| Java | $f | âŒ Error |<br>"
              done
            fi
            cd ..
          fi
          echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
          echo "LOG_CONTENT=$LOG_CONTENT" >> $GITHUB_ENV

      # 4. ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
      - name: README ì—…ë°ì´íŠ¸
        run: |
          NOW=$(date +'%Y-%m-%d %H:%M:%S')
          cat <<EOF > README.md
          # ğŸ›¡ï¸ ì •ë³´ë³´ì•ˆ ê¸°ì‚¬: í†µí•© ìš´ì˜ ê´€ì œ (v10.2)
          
          ![System Status](https://github.com/${{ github.repository }}/actions/workflows/auto-update-requirements.yml/badge.svg)
          ![Tasks](https://img.shields.io/badge/Executed_Tasks-${{ env.SUCCESS_COUNT }}-blueviolet)
          
          ---
          ## ğŸ“Š ì‹œìŠ¤í…œ í˜„í™©
          - **OS**: Ubuntu (Latest)
          - **Runtime**: Python 3.12 / Java 21
          - **Last Sync**: $NOW (KST)
          
          ## ğŸ› ï¸ ì‹¤í–‰ ë¡œê·¸
          | Language | File Name | Status |
          | :--- | :--- | :--- |
          ${{ env.LOG_CONTENT }}
          
          ---
          > _System Optimized for Speed & Accuracy_
          EOF

      # 5. ìŠ¤ë§ˆíŠ¸ ì»¤ë°‹ ë° ë¦´ë¦¬ì¦ˆ ë°°í¬
      - name: ê²°ê³¼ ë°˜ì˜ ë° ìë™ ë¦´ë¦¬ì¦ˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add -A
          NOW=$(date +'%Y-%m-%d %H:%M:%S')
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            git commit -m "Grand-Ops: Delta Update ($NOW)"
            # ì¶©ëŒ ë°œìƒ ì‹œ ì›ê²© ë²„ì „ ë¬´ì‹œí•˜ê³  í˜„ì¬ ê²°ê³¼ë¬¼ ê°•ì œ ì ìš© (Ours ì „ëµ)
            git push origin HEAD:${{ github.ref_name }} --force
            
            # ë°°í¬ìš© íŒ¨í‚¤ì§€ ìƒì„± (ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œì™¸ë¡œ ì†ë„ í–¥ìƒ)
            TAG="v$(date +'%Y%m%d-%H%M%S')"
            zip -r "Service-Build.zip" . -x "*.git*" "node_modules/*"
            gh release create "$TAG" "Service-Build.zip" --title "ğŸš€ Build $TAG" --notes "ìë™í™”ëœ í†µí•© ì„œë¹„ìŠ¤ ë°°í¬ íŒ¨í‚¤ì§€ì…ë‹ˆë‹¤."
          fi
