name: ì´ˆì •ë°€ ìë™ ì—…ë°ì´íŠ¸ ë° ë‹¤ì¤‘ ì–¸ì–´ ë°°í¬ (Grand Ops Master v10)
run-name: ğŸš€ ìš´ì˜ ë§ˆìŠ¤í„°:í•˜ì´ë¸Œë¦¬ë“œ ì‹¤í–‰ ë° ë°°í¬ - ${{ github.ref_name }}

permissions:
  contents: write
  packages: write
  releases: write

on:
  schedule:
    - cron: '*/15 * * * *' # íš¨ìœ¨ì„±ì„ ìœ„í•´ 15ë¶„ ê°„ê²© ì¡°ì •
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.py'
      - '**.java'
      - '**.sh'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  grand-ops-execution:
    name: í•˜ì´ë¸Œë¦¬ë“œ ì˜¤í¼ë ˆì´ì…˜ ì‹¤í–‰
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Seoul'

    steps:
      # 1. ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° í´ë¦° ë¶€íŒ…
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ê¹ƒ(Git) í™˜ê²½ ìµœì í™”
        run: |
          git config --global user.name "Grand-Ops-Master-v10"
          git config --global user.email "ops-v10@github.com"
          # ëŒ€ìš©ëŸ‰ ë° ë°”ì´ë„ˆë¦¬ íŒŒì¼ ì¶©ëŒ ë°©ì§€ ì „ëµ ì„¤ì •
          echo "*.db binary" > .gitattributes
          echo "*.sqlite binary" >> .gitattributes
          echo "*.jar binary" >> .gitattributes
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}

      # 2. ë‹¤ì¤‘ ì–¸ì–´ í™˜ê²½ êµ¬ì¶• (Python & Java)
      - name: íŒŒì´ì¬(Python) 3.12 ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ìë°”(Java) JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: í•„ìˆ˜ ëŸ°íƒ€ì„ ë° ì„œë¹„ìŠ¤ ë„êµ¬ ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy beautifulsoup4 fastapi requests tabulate pipreqs
          sudo apt-get update && sudo apt-get install -y jq zip curl

      # 3. [í•µì‹¬] í•˜ì´ë¸Œë¦¬ë“œ ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ (Python + Java + Shell)
      - name: í†µí•© ì„œë¹„ìŠ¤ ë¶„ì„ ë° ì‹¤í–‰
        id: engine
        run: |
          echo "ğŸƒâ€â™‚ï¸ [Engine] ë‹¤ì¤‘ ì–¸ì–´ ì„œë¹„ìŠ¤ ì‹¤í–‰ ì‹œì‘..."
          SCRIPT_DIR="./scripts"
          LOG_CONTENT=""
          SUCCESS_COUNT=0
          
          if [ -d "$SCRIPT_DIR" ]; then
            cd "$SCRIPT_DIR"
            
            # A. Python ì‹¤í–‰ ë° ì˜ì¡´ì„± ê´€ë¦¬
            if ls *.py >/dev/null 2>&1; then
              pipreqs . --force --encoding=utf-8 || true
              pip install -r requirements.txt || pip install pandas requests tabulate
              for f in *.py; do
                echo "Executing Python: $f"
                python "$f" && { LOG_CONTENT+="| Python | $f | âœ… Success |<br>"; SUCCESS_COUNT=$((SUCCESS_COUNT+1)); } || LOG_CONTENT+="| Python | $f | âŒ Failed |<br>"
              done
            fi

            # B. Java ì‹¤í–‰ (ë‹¨ì¼ .java íŒŒì¼ ì»´íŒŒì¼ ë° ì‹¤í–‰)
            if ls *.java >/dev/null 2>&1; then
              for f in *.java; do
                echo "Compiling Java: $f"
                javac "$f" && java "${f%.*}" && { LOG_CONTENT+="| Java | $f | âœ… Success |<br>"; SUCCESS_COUNT=$((SUCCESS_COUNT+1)); } || LOG_CONTENT+="| Java | $f | âŒ Compile Error |<br>"
              done
            fi
            cd ..
          fi
          
          echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
          echo "LOG_CONTENT=$LOG_CONTENT" >> $GITHUB_ENV

      # 4. ë°ì´í„° ëŒ€ì‹œë³´ë“œ ë° ì„œë¹„ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
      - name: README ëŒ€ì‹œë³´ë“œ ê³ ë„í™”
        run: |
          NOW=$(date +'%Y-%m-%d %H:%M:%S')
          cat <<EOF > README.md
          # ğŸ›¡ï¸ ì •ë³´ë³´ì•ˆ ê¸°ì‚¬: í†µí•© ìš´ì˜ ê´€ì œ (v10.0)
          
          ![System Status](https://github.com/${{ github.repository }}/actions/workflows/grand-ops-master.yml/badge.svg)
          ![Total Success](https://img.shields.io/badge/Executed_Tasks-${{ env.SUCCESS_COUNT }}-blueviolet)
          
          ---
          ## ğŸ“Š ì‹œìŠ¤í…œ ê°€ë™ í˜„í™©
          | êµ¬ë¶„ | ìƒì„¸ ë‚´ìš© |
          | :--- | :--- |
          | **ìš´ì˜ì²´ì œ** | Ubuntu Latest (Hybrid Runtime) |
          | **ì—”ì§„ ë²„ì „** | Python 3.12 / JDK 21 |
          | **ì—…ë°ì´íŠ¸ ì‹œê°** | $NOW (KST) |
          | **ì¶©ëŒ í•´ê²°** | ìë™ ë³‘í•© (Merge Strategy: Ours) |
          
          ## ğŸ› ï¸ ìµœê·¼ ì‹¤í–‰ ë¡œê·¸ (Execution Log)
          | Language | File Name | Result |
          | :--- | :--- | :--- |
          ${{ env.LOG_CONTENT }}
          
          ---
          > _ë³¸ ë¦¬í¬ì§€í† ë¦¬ëŠ” ë³´ì•ˆ ë¶„ì„ ë° ë°ì´í„° ìˆ˜ì§‘ì„ ìœ„í•´ ìë™ìœ¼ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤._
          EOF

      # 5. ì¶©ëŒ ë°©ì§€ ìë™ ë³‘í•© ë° ë°ì´í„° ë°°í¬
      - name: ë°ì´í„° ë™ê¸°í™” ë° ë¦´ë¦¬ì¦ˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            git commit -m "Auto-Update: Systems & Services ($NOW)"
            git fetch origin
            git merge -X ours origin/${{ github.ref_name }} --no-edit
            git push origin HEAD:${{ github.ref_name }}
            
            # ìµœì‹  ìƒíƒœ íŒ¨í‚¤ì§• ë° ë¦´ë¦¬ì¦ˆ
            TAG="release-$(date +'%Y%m%d-%H%M%S')"
            zip -r "Full-Service-Package.zip" . -x "*.git*"
            gh release create "$TAG" "Full-Service-Package.zip" --title "ğŸš€ Service Build $TAG" --notes "ìë™ ìƒì„±ëœ í†µí•© ì„œë¹„ìŠ¤ íŒ¨í‚¤ì§€ì…ë‹ˆë‹¤."
          fi
