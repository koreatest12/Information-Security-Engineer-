name: Grand Ops - Always Release & Package (No Skip)

# ê¶Œí•œ ì„¤ì •: ì½”ë“œ í‘¸ì‹œ ë° ë¦´ë¦¬ì¦ˆ ìƒì„± ê¶Œí•œ í•„ìˆ˜
permissions:
  contents: write

on:
  # 1. 10ë¶„ ë‹¨ìœ„ ë¬´ì¡°ê±´ ì‹¤í–‰ (ìŠ¤ì¼€ì¤„ëŸ¬)
  schedule:
    - cron: '*/10 * * * *'
  # 2. ì½”ë“œ í‘¸ì‹œ ì‹œ ì‹¤í–‰
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.py'
  # 3. ìˆ˜ë™ ì‹¤í–‰ (ì¦‰ì‹œ ë°°í¬)
  workflow_dispatch:

jobs:
  grand-ops-executor:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Seoul' # í•œêµ­ ì‹œê°„ ê¸°ì¤€

    steps:
      # ----------------------------------------------------------------
      # 1. [ì´ˆê¸°í™”] ì €ì¥ì†Œ ê°•ì œ ë™ê¸°í™” (ì¶©ëŒ ë°©ì§€)
      # ----------------------------------------------------------------
      - name: Checkout & Force Reset
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize Git & Reset History
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "grand-ops-master@github.com"
          
          echo "ğŸ”„ [Init] ì›ê²© ì„œë²„ ìƒíƒœì™€ ê°•ì œ ë™ê¸°í™”..."
          git fetch origin
          # ë¡œì»¬ ìƒíƒœë¥¼ ì›ê²© ì„œë²„ì™€ 100% ì¼ì¹˜ì‹œí‚´ (Clean State)
          git reset --hard origin/${{ github.ref_name }}

      # ----------------------------------------------------------------
      # 2. [ì—…ê·¸ë ˆì´ë“œ] ì‹œìŠ¤í…œ ë° íŒ¨í‚¤ì§€ ë„êµ¬ ìµœì‹ í™”
      # ----------------------------------------------------------------
      - name: System Upgrade & Python Setup
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Upgrade Build Tools
        run: |
          echo "ğŸ›  [System] ë¹Œë“œ ë„êµ¬ ëŒ€ëŸ‰ ì—…ë°ì´íŠ¸ ìˆ˜í–‰..."
          python -m pip install --upgrade pip
          pip install --upgrade setuptools wheel build pipreqs
          
          # ê²½ê³  ë°©ì§€ìš© ê¸°ë³¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
          pip install pandas numpy beautifulsoup4 fastapi || true

      # ----------------------------------------------------------------
      # 3. [ìƒì„±] Requirements ë° ì˜ì¡´ì„± ë¶„ì„
      # ----------------------------------------------------------------
      - name: Generate Requirements (Full Scan)
        run: |
          echo "ğŸ“¦ [Scan] ì „ì²´ í”„ë¡œì íŠ¸ ìŠ¤ìº” ì¤‘..."
          # ê²½ê³ ê°€ ë– ë„ ë¬´ì‹œí•˜ê³  ê°•ì œ ìƒì„± (--force)
          pipreqs . --force --encoding=utf-8 --ignore .github
          
          echo "âœ… requirements.txt ìƒíƒœ:"
          cat requirements.txt

      # ----------------------------------------------------------------
      # 4. [ì»¤ë°‹] ë³€ê²½ì‚¬í•­ ë°˜ì˜ (ë³€ê²½ ì—†ìœ¼ë©´ í†µê³¼, ì—ëŸ¬ ì—†ìŒ)
      # ----------------------------------------------------------------
      - name: Commit & Push Changes (If any)
        run: |
          git add -A
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --staged --quiet; then
            echo "âœ‹ [Info] ì½”ë“œ ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "â„¹ï¸ í•˜ì§€ë§Œ ë¦´ë¦¬ì¦ˆ ë°°í¬ëŠ” ìŠ¤í‚µí•˜ì§€ ì•Šê³  ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."
          else
            echo "ğŸ“ [Commit] ë³€ê²½ ì‚¬í•­ ê°ì§€! ì»¤ë°‹ ë° í‘¸ì‹œ ì§„í–‰..."
            git commit -m "Grand-Ops Update: $(date +'%Y-%m-%d %H:%M:%S')"
            
            git pull origin ${{ github.ref_name }} --rebase
            git push origin HEAD:${{ github.ref_name }}
          fi

      # ----------------------------------------------------------------
      # 5. [ë°°í¬] ë¬´ì¡°ê±´ ë¦´ë¦¬ì¦ˆ ë° íŒ¨í‚¤ì§€ ì¶œì‹œ (SKIP ì—†ìŒ)
      # ----------------------------------------------------------------
      - name: Force Release & Package Launch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ì´ˆ ë‹¨ìœ„ê¹Œì§€ í¬í•¨í•˜ì—¬ ì ˆëŒ€ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ë²„ì „ íƒœê·¸ ìƒì„±
          TAG_NAME="v$(date +'%Y.%m.%d-%H%M%S')"
          RELEASE_TITLE="ğŸš€ Grand-Ops Package $TAG_NAME"
          ZIP_NAME="Grand-Ops-Package-$TAG_NAME.zip"
          
          echo "ğŸš€ [Launch] ë¦´ë¦¬ì¦ˆ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ (Skip ì—†ì´ ì‹¤í–‰)"
          echo "ğŸ·  Version Tag: $TAG_NAME"
          
          # 1. ì „ì²´ ì†ŒìŠ¤ì½”ë“œ íŒ¨í‚¤ì§• (ì••ì¶•)
          echo "ğŸ“¦ [Package] ì†ŒìŠ¤ì½”ë“œ ì „ì²´ ì••ì¶• ì¤‘..."
          zip -r "$ZIP_NAME" . -x ".git/*" ".github/*"
          
          # 2. GitHub Release ìƒì„± ë° íŒŒì¼ ì—…ë¡œë“œ
          # ë³€ê²½ ì‚¬í•­ì´ ì—†ì–´ë„ í˜„ì¬ ìƒíƒœ ê·¸ëŒ€ë¡œ ìŠ¤ëƒ…ìƒ·ì„ ì°ì–´ ë°°í¬í•©ë‹ˆë‹¤.
          gh release create "$TAG_NAME" \
            --title "$RELEASE_TITLE" \
            --notes "## ğŸ“¦ Grand-Ops Auto Release
            - **Build Time**: $(date)
            - **Status**: Force Deployed by Grand-Ops-Master
            - **Mode**: No-Skip Execution" \
            "$ZIP_NAME" \
            requirements.txt

          echo "ğŸ‰ [Complete] $TAG_NAME ë°°í¬ ì™„ë£Œ!"
