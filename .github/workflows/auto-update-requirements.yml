name: Auto Generate Requirements and Push (Final Master)

# ê¶Œí•œ ì„¤ì • (í•„ìˆ˜: í† í° ì—†ì´ í‘¸ì‹œ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •)
permissions:
  contents: write

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.py'                    # íŒŒì´ì¬ íŒŒì¼ ë³€ê²½ ì‹œì—ë§Œ ì‘ë™
  workflow_dispatch:               # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  force-update-job:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ (ëª¨ë“  íˆìŠ¤í† ë¦¬ í¬í•¨)
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. [ê°•ì œ ë™ê¸°í™”] ê¼¬ì¸ Git ì¡±ë³´ í•´ê²° (Hard Reset)
      # ë¡œì»¬ ìƒíƒœë¥¼ ì›ê²© ì„œë²„ì™€ 100% ì¼ì¹˜ì‹œì¼œ 'non-fast-forward' ì˜¤ë¥˜ë¥¼ ì›ì²œ ì°¨ë‹¨í•©ë‹ˆë‹¤.
      - name: Reset Local History to Remote
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "grand-ops-master@github.com"
          
          echo "ğŸ”„ ì›ê²© ì €ì¥ì†Œ ìµœì‹  ì •ë³´ ê°€ì ¸ì˜¤ê¸°..."
          git fetch origin
          
          echo "âš ï¸ ë¡œì»¬ ìƒíƒœë¥¼ ì›ê²© ë¸Œëœì¹˜(${{ github.ref_name }})ë¡œ ê°•ì œ ì´ˆê¸°í™”..."
          git reset --hard origin/${{ github.ref_name }}

      # 3. Python í™˜ê²½ ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4. requirements.txt ìƒì„± (pipreqs)
      # ë¡œê·¸ì— ë‚˜ì˜¨ WARNINGì„ ì²˜ë¦¬í•˜ê³ , ì°¾ì•„ë‚¸ ë²„ì „ì„ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
      - name: Generate requirements.txt
        run: |
          pip install --upgrade pip
          pip install pipreqs
          
          echo "ğŸ“¦ ì˜ì¡´ì„± íŒŒì¼ ìƒì„± ì‹œì‘..."
          # .github í´ë” ì œì™¸, ì¸ì½”ë”© utf-8 ì„¤ì •
          pipreqs . --force --encoding=utf-8 --ignore .github
          
          echo "âœ… requirements.txt ìƒì„± ì™„ë£Œ. ë‚´ìš© í™•ì¸:"
          cat requirements.txt

      # 5. [ìˆ˜ë™ í‘¸ì‹œ] ë³€ê²½ ì‚¬í•­ ë°˜ì˜
      # ì™¸ë¶€ ì•¡ì…˜ ì—†ì´ ì§ì ‘ Git ëª…ë ¹ì–´ë¡œ ì•ˆì „í•˜ê²Œ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
      - name: Commit and Push Manually
        run: |
          # 1. ë³€ê²½ëœ ëª¨ë“  íŒŒì¼ ìŠ¤í…Œì´ì§•
          git add -A
          
          # 2. ë³€ê²½ì‚¬í•­ ìœ ë¬´ í™•ì¸ (ë³€ê²½ ì—†ìœ¼ë©´ ì¢…ë£Œ)
          if git diff --staged --quiet; then
            echo "âœ‹ ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ì›Œí¬í”Œë¡œìš°ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
            exit 0
          fi
          
          # 3. ì»¤ë°‹ ìƒì„±
          git commit -m "Update: requirements.txt generated by Grand-Ops-Master"
          
          # 4. í‘¸ì‹œ ì „ í•œ ë²ˆ ë” ë™ê¸°í™” (ì¶©ëŒ ë°©ì§€) ë° í‘¸ì‹œ
          echo "ğŸš€ ì›ê²© ì €ì¥ì†Œë¡œ ì—…ë¡œë“œ ì¤‘..."
          git pull origin ${{ github.ref_name }} --rebase
          git push origin HEAD:${{ github.ref_name }}
