name: Grand Ops Master - Auto Sync, Release & Package

# ê¶Œí•œ ì„¤ì •: ì½”ë“œ í‘¸ì‹œ ë° ë¦´ë¦¬ì¦ˆ ìƒì„± ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: write

on:
  # 1. 10ë¶„ ë‹¨ìœ„ ìë™ ì‹¤í–‰ (UTC ê¸°ì¤€)
  schedule:
    - cron: '*/10 * * * *'
  # 2. ì½”ë“œ í‘¸ì‹œ ì‹œ ì‹¤í–‰
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.py'
  # 3. ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  workflow_dispatch:

jobs:
  ops-system-upgrade:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Seoul' # í•œêµ­ ì‹œê°„ ì„¤ì •

    steps:
      # ----------------------------------------------------------------
      # 1. ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ë™ê¸°í™” (Conflict ë°©ì§€)
      # ----------------------------------------------------------------
      - name: Checkout & Force Sync (Reset)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize Grand-Ops Environment
        run: |
          git config --global user.name "Grand-Ops-Master"
          git config --global user.email "grand-ops-master@github.com"
          
          echo "ğŸ”„ [System] ì›ê²© ì„œë²„ ìƒíƒœì™€ ê°•ì œ ë™ê¸°í™” ì¤‘..."
          git fetch origin
          # ë¡œì»¬ ë³€ê²½ì‚¬í•­ ë¬´ì‹œí•˜ê³  ì„œë²„ ìƒíƒœë¡œ ë¦¬ì…‹ (ì¶©ëŒ ì›ì²œ ì°¨ë‹¨)
          git reset --hard origin/${{ github.ref_name }}

      # ----------------------------------------------------------------
      # 2. í™˜ê²½ ì—…ê·¸ë ˆì´ë“œ ë° ê²½ê³  ë©”ì‹œì§€ ì²˜ë¦¬
      # ----------------------------------------------------------------
      - name: Upgrade System & Python Setup
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies & Tools
        run: |
          echo "ğŸ›  [Upgrade] pip ë° íŒ¨í‚¤ì§€ ê´€ë¦¬ ë„êµ¬ ìµœì‹ í™”..."
          python -m pip install --upgrade pip
          pip install pipreqs setuptools wheel
          
          # ê²½ê³  ë©”ì‹œì§€ ìµœì†Œí™”ë¥¼ ìœ„í•´ ì‚¬ì „ í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì‹œë„
          pip install pandas numpy beautifulsoup4 fastapi || true

      # ----------------------------------------------------------------
      # 3. Requirements ìƒì„± ë° ëŒ€ëŸ‰ íŒŒì¼ ìŠ¤ìº”
      # ----------------------------------------------------------------
      - name: Generate Requirements (Mass Scan)
        id: req_gen
        run: |
          echo "ğŸ“¦ [Package] ì „ì²´ ë””ë ‰í† ë¦¬ ìŠ¤ìº” ë° ì˜ì¡´ì„± ì¶”ì¶œ..."
          
          # ê²½ê³  ë©”ì‹œì§€ëŠ” ìœ ì§€í•˜ë˜, ì‹¤í–‰ì´ ë©ˆì¶”ì§€ ì•Šë„ë¡ ì²˜ë¦¬
          pipreqs . --force --encoding=utf-8 --ignore .github
          
          echo "âœ… requirements.txt ìƒì„± ì™„ë£Œ"
          cat requirements.txt

      # ----------------------------------------------------------------
      # 4. ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
      # ----------------------------------------------------------------
      - name: Commit & Push Changes
        id: auto_commit
        run: |
          # ëª¨ë“  íŒŒì¼(ëŒ€ëŸ‰ ìˆ˜ì • í¬í•¨) ìŠ¤í…Œì´ì§•
          git add -A
          
          # ë³€ê²½ ì‚¬í•­ í™•ì¸
          if git diff --staged --quiet; then
            echo "âœ‹ ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¦´ë¦¬ì¦ˆ í”„ë¡œì„¸ìŠ¤ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # í˜„ì¬ ì‹œê°„ ë³€ìˆ˜ ìƒì„±
          CURRENT_DATE=$(date +'%Y-%m-%d %H:%M:%S')
          
          git commit -m "Grand-Ops Update: $CURRENT_DATE (Auto-Generated)"
          
          echo "ğŸš€ [Push] ì›ê²© ì €ì¥ì†Œë¡œ ì—…ë¡œë“œ..."
          git pull origin ${{ github.ref_name }} --rebase
          git push origin HEAD:${{ github.ref_name }}
          
          echo "changed=true" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------------
      # 5. ë¦´ë¦¬ì¦ˆ ìƒì„± ë° íŒ¨í‚¤ì§€(Zip) ë°°í¬ (ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
      # ----------------------------------------------------------------
      - name: Create Release & Package
        if: steps.auto_commit.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ë²„ì „ íƒœê·¸ ìƒì„± (ì˜ˆ: v2025.12.15-2030)
          TAG_NAME="v$(date +'%Y.%m.%d-%H%M')"
          RELEASE_TITLE="ğŸš€ Grand-Ops Release $TAG_NAME"
          
          echo "ğŸ“¦ [Release] ìƒˆë¡œìš´ ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„±: $TAG_NAME"
          
          # ì†ŒìŠ¤ ì½”ë“œ ì••ì¶• (íŒ¨í‚¤ì§•)
          zip -r "source-code-$TAG_NAME.zip" . -x ".git/*" ".github/*"
          
          # GitHub Release ìƒì„± ë° íŒŒì¼ ì—…ë¡œë“œ
          gh release create "$TAG_NAME" \
            --title "$RELEASE_TITLE" \
            --notes "Auto-generated release by Grand-Ops-Master system. includes updated requirements.txt and project files." \
            "source-code-$TAG_NAME.zip" \
            requirements.txt

          echo "ğŸ‰ [Success] ë¦´ë¦¬ì¦ˆ ë° íŒ¨í‚¤ì§€ ë°°í¬ ì™„ë£Œ!"
