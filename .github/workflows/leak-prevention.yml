name: ğŸ›¡ï¸ Grand Ops:Resilient Ultimate Wargame

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  security-events: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================================================================================
  # JOB 1: ê²°í•¨ í—ˆìš© ì¸í”„ë¼ êµ¬ì¶• (Fault-Tolerant Infrastructure Build)
  # ==================================================================================
  build-resilient-infra:
    name: ğŸš€ Build Resilient Infrastructure
    runs-on: ubuntu-latest
    steps:
      # 1. ì²´í¬ì•„ì›ƒ (ì¬ì‹œë„ ë¡œì§ í¬í•¨ì€ ì–´ë µì§€ë§Œ, í† í° ì„¤ì •ìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´)
      - name: ğŸ“¥ Checkout Code (Stable)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2. ëŒ€ëŸ‰ ì¸í”„ë¼ ìƒì„± (ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ -> ì‹¤íŒ¨ ì‹œ ê°•ì œ ì§„í–‰ ë¡œì§ ì ìš©)
      - name: ğŸ—ï¸ Construct Massive Services (Retry & Proceed)
        shell: bash
        run: |
          # --- ì¬ìˆ˜í–‰ ë° ê°•ì œ ì„±ê³µ í•¨ìˆ˜ ì •ì˜ ---
          function run_with_retry() {
            local n=1
            local max=3
            local delay=3
            while true; do
              "$@" && break || {
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "âš ï¸ Command failed. Attempt $n/$max. Retrying in $delay seconds..."
                  sleep $delay;
                else
                  echo "âŒ Command failed after $max attempts."
                  echo "âš ï¸ [SKIP] Proceeding despite failure (Fault Tolerance Active)."
                  return 0 # ì‹¤íŒ¨í•´ë„ 0(ì„±ê³µ)ì„ ë°˜í™˜í•˜ì—¬ ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨ ë°©ì§€
                fi
              }
            done
          }

          echo "ğŸš€ Initializing Grand Ops Mega-Construction..."

          # --- [ëª…ë ¹ 1] ë””ë ‰í† ë¦¬ ëŒ€ëŸ‰ ìƒì„± ---
          run_with_retry mkdir -p apps/frontend_web apps/backend_api apps/payment_gateway apps/auth_service apps/inventory_system apps/admin_console
          run_with_retry mkdir -p infrastructure/k8s_manifests infrastructure/terraform_scripts infrastructure/firewall_rules
          run_with_retry mkdir -p security_hq/red_team_tools security_hq/blue_team_tools security_hq/audit_logs reports/ops_logs

          # --- [ëª…ë ¹ 2] ì„œë¹„ìŠ¤ íŒŒì¼ ëŒ€ëŸ‰ ìƒì„± (ì™„ë²½ êµ¬ì„±) ---
          echo "Generating Application Code..."
          
          # Frontend
          echo "<!DOCTYPE html><html><body><h1>Grand Ops Dashboard v7</h1></body></html>" > apps/frontend_web/index.html
          echo '{"name":"frontend","version":"3.0.0"}' > apps/frontend_web/package.json
          
          # Backend
          echo "module.exports = { db: 'postgres://prod-db' }" > apps/backend_api/config.js
          echo "const express = require('express'); app.listen(8080);" > apps/backend_api/server.js
          
          # Auth Service (ì·¨ì•½ì  í¬í•¨)
          echo "def login(u, p): return True # TODO: Fix weak auth" > apps/auth_service/auth.py
          
          # Payment Gateway (SQL Injection íƒ€ê²Ÿ)
          echo "query = 'SELECT * FROM tx WHERE id=' + input_id" > apps/payment_gateway/payment.py
          echo "CREATE TABLE transactions (id INT, amount DECIMAL);" > apps/payment_gateway/schema.sql

          # Inventory Service
          echo "package main; func main() { println('Inventory Online') }" > apps/inventory_system/main.go
          
          # Admin Console
          echo "<?php echo 'Admin Dashboard'; ?>" > apps/admin_console/index.php

          # --- [ëª…ë ¹ 3] ì¸í”„ë¼ ì„¤ì • ìƒì„± ---
          echo "Generating Infrastructure Configs..."
          
          # K8s
          echo "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: core-backend" > infrastructure/k8s_manifests/backend.yaml
          echo "apiVersion: v1\nkind: Service\nmetadata:\n  name: core-svc" > infrastructure/k8s_manifests/service.yaml
          
          # Terraform
          echo "provider \"aws\" { region = \"us-east-1\" }" > infrastructure/terraform_scripts/main.tf
          
          # Firewall
          echo "SecRuleEngine On" > infrastructure/firewall_rules/waf.conf
          echo "192.168.10.5 # Blocked Malicious IP" >> infrastructure/firewall_rules/blocked_ips.txt

          # --- [ëª…ë ¹ 4] ë³´ì•ˆ íˆ´ ìƒì„± ---
          echo "Generating Security Tools..."
          echo "print('ğŸš€ DDOS Simulation Tool')" > security_hq/red_team_tools/ddos.py
          echo "print('ğŸ›¡ï¸ Log Analysis Tool')" > security_hq/blue_team_tools/log_analyzer.py

          echo "âœ… Massive Infrastructure Built Successfully (Fault Tolerant Mode)."

  # ==================================================================================
  # JOB 2: ë³´ì•ˆ ìŠ¤ìº” ë° ëª¨ì˜ í›ˆë ¨ (DLP & Wargame) - ì‹¤íŒ¨ ë¬´ì‹œ ëª¨ë“œ
  # ==================================================================================
  security-ops-execution:
    name: âš”ï¸ Security Operations (Fault Tolerant)
    needs: build-resilient-infra
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ›¡ï¸ Run DLP & Gitleaks (With Retry & Ignore Failure)
        shell: bash
        run: |
          # ì¬ìˆ˜í–‰ í•¨ìˆ˜ ì¬ì •ì˜ (Jobì´ ë‹¬ë¼ì„œ ë‹¤ì‹œ ì •ì˜ í•„ìš”)
          function run_tolerant() {
            local n=1
            local max=3
            while true; do
              echo "ğŸ”„ Executing: $1 (Attempt $n/$max)"
              # ì‹œë®¬ë ˆì´ì…˜: ëª…ë ¹ì–´ ì‹¤í–‰ (ì—¬ê¸°ì„œëŠ” echoë¡œ ëŒ€ì²´í•˜ì§€ë§Œ ì‹¤ì œ ëª…ë ¹ì–´ê°€ ë“¤ì–´ê°)
              if eval "$1"; then
                echo "âœ… Success!"
                break
              else
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "âš ï¸ Failed. Retrying in 2s..."
                  sleep 2
                else
                  echo "âŒ Failed permanently. MARKING AS SUCCESS to proceed."
                  return 0 # ê°•ì œ ì„±ê³µ ì²˜ë¦¬
                fi
              fi
            done
          }

          # 1. Gitleaks ì„¤ì¹˜ ë° ì‹¤í–‰ ì‹œë®¬ë ˆì´ì…˜
          # ì‹¤ì œ Gitleaksê°€ ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” í†µê³¼ë¨
          run_tolerant "mkdir -p reports/dlp && echo 'Scan Result' > reports/dlp/scan.log"
          
          # 2. ì·¨ì•½ì  ìŠ¤ìº” (ì˜ë„ì  ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜ í¬í•¨)
          # 'false' ëª…ë ¹ì€ ë¬´ì¡°ê±´ ì‹¤íŒ¨í•˜ì§€ë§Œ, run_tolerant í•¨ìˆ˜ ë•ë¶„ì— ì›Œí¬í”Œë¡œìš°ëŠ” ì•ˆ ì£½ìŒ
          echo "--- Testing Fault Tolerance (Intentional Failure) ---"
          run_tolerant "false" 
          echo "--- End Fault Tolerance Test (Should see âœ… Success above despite failure) ---"

      - name: âš”ï¸ Execute Wargame Scenarios
        run: |
          # ê³µê²© ë° ë°©ì–´ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰
          mkdir -p reports/wargame
          
          echo "ğŸ”´ [Red Team] Launching SQL Injection..." >> reports/wargame/ops.log
          echo "ğŸ”´ [Red Team] Locking Files (Ransomware)..." >> reports/wargame/ops.log
          
          echo "ğŸ”µ [Blue Team] Firewall Activated." >> reports/wargame/ops.log
          echo "ğŸ”µ [Blue Team] Patched SQL Vulnerability." >> reports/wargame/ops.log
          
          echo "âœ… Wargame Completed."

  # ==================================================================================
  # JOB 3: ê²°ê³¼ ë°°í¬ (Resilient Deployment)
  # ==================================================================================
  deploy-results:
    name: ğŸ’¾ Commit & Deploy Results
    needs: security-ops-execution
    runs-on: ubuntu-latest
    if: always() # ì´ì „ ì‘ì—…ì´ ì‹¤íŒ¨í•´ë„(ì‹¤ì œë¡œëŠ” ê°•ì œ ì„±ê³µ ì²˜ë¦¬ë˜ì§€ë§Œ) ë¬´ì¡°ê±´ ì‹¤í–‰
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‚ Restore Artifacts (Simulation)
        run: |
          # ì´ì „ ë‹¨ê³„ì—ì„œ íŒŒì¼ì´ ì‹¤ì œë¡œëŠ” ì²´í¬ì•„ì›ƒëœ ìƒíƒœì´ë¯€ë¡œ
          # ì—¬ê¸°ì„œëŠ” ìµœì¢… ë¦¬í¬íŠ¸ë§Œ ë‹¤ì‹œ ìƒì„±í•´ì„œ í‘¸ì‹œí•©ë‹ˆë‹¤.
          mkdir -p reports/final
          echo "# Grand Ops Final Report" > reports/final/REPORT.md
          echo "Status: COMPLETED (With Fault Tolerance)" >> reports/final/REPORT.md
          echo "Timestamp: $(date)" >> reports/final/REPORT.md

      - name: ğŸ’¾ Force Commit & Push
        run: |
          git config --global user.name "Grand Ops Resilience Bot"
          git config --global user.email "bot@grandops.io"
          
          git add .
          git commit -m "ğŸ›¡ï¸ Grand Ops: Resilient Execution Result #${{ github.run_number }} [skip ci]" || echo "No changes."
          
          # ì¬ì‹œë„ ë¡œì§ì´ í¬í•¨ëœ Push
          n=0
          until [ "$n" -ge 5 ]
          do
             git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
             git push origin HEAD:${{ github.ref }} && break
             n=$((n+1))
             echo "âš ï¸ Push failed. Retrying... ($n/5)"
             sleep 5
          done
          
          # 5ë²ˆ ë‹¤ ì‹¤íŒ¨í•´ë„ ì—ëŸ¬ ë‚´ì§€ ì•Šê³  ì¢…ë£Œ
          if [ "$n" -ge 5 ]; then
             echo "âŒ Final Push failed, but workflow marked as SUCCESS."
             exit 0
          fi
