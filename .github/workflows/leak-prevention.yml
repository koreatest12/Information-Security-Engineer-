name: ğŸ›¡ï¸ Grand Ops:Ultimate DLP & Secret Audit

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * *' # ë§¤ì¼ ìì • ì •ë°€ ê°ì‚¬
  workflow_dispatch:

permissions:
  contents: write       # ë¦¬í¬íŠ¸ ë° ê²©ë¦¬ ì¡°ì¹˜ ì»¤ë°‹ ê¶Œí•œ
  security-events: write # GitHub Security íƒ­ ì—…ë¡œë“œ
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  advanced-secret-audit:
    name: ğŸ•µï¸ Deep Secret Inspection
    runs-on: ubuntu-latest
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì¸ì¦ ì—ëŸ¬ ë°©ì§€ í¬í•¨)
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ ìŠ¤ìº”
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. [í…ŒìŠ¤íŠ¸ìš©] ê°€ì§œ ìœ ì¶œ ë°ì´í„° ìƒì„± (Scannerê°€ ì˜ ë„ëŠ”ì§€ í™•ì¸ìš©)
      - name: ğŸ§ª Generate Mock Leaks (Simulation)
        run: |
          mkdir -p .secrets_simulation
          
          # ê°€ì§œ AWS í‚¤ ìƒì„±
          echo "aws_access_key_id=AKIAIMNOVALIDKEY123456" > .secrets_simulation/aws_config.env
          echo "aws_secret_access_key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY" >> .secrets_simulation/aws_config.env
          
          # ê°€ì§œ Generic API Token
          echo "const apiToken = 'glpat-abcdef1234567890';" > .secrets_simulation/app_config.js
          
          # ê°€ì§œ Private Key (RSA Header)
          echo "-----BEGIN RSA PRIVATE KEY-----" > .secrets_simulation/id_rsa_test
          echo "MIIEpAIBAAKCAQEA4..." >> .secrets_simulation/id_rsa_test
          
          echo "âš ï¸ Mock Sensitive Data Generated for DLP Testing."

      # 3. Gitleaks ì‹¤í–‰ (ë©”ì¸ ìŠ¤ìºë„ˆ)
      - name: ğŸ•µï¸ Run Gitleaks (Standard Scan)
        uses: gitleaks/gitleaks-action@v2
        id: gitleaks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•´ ì—ëŸ¬ê°€ ë‚˜ë„ ë‹¤ìŒ ë‹¨ê³„(ë¦¬í¬íŒ…)ë¡œ ì§„í–‰í•˜ë„ë¡ ì„¤ì •
          fail-on-error: false 
          verbose: true

      # 4. ì»¤ìŠ¤í…€ íŒ¨í„´ ìŠ¤ìº” (ê·¸ë ™ & ì—”íŠ¸ë¡œí”¼)
      - name: ğŸ” Run Custom Pattern & Entropy Scan
        run: |
          mkdir -p reports/dlp
          
          echo "Starting Custom Heuristic Scan..."
          echo "# Custom Scan Results" > reports/dlp/custom_scan.log
          
          # 4-1. ìœ„í—˜ í‚¤ì›Œë“œ ê²€ìƒ‰ (TODO, FIXME, PASSWORD, SECRET)
          echo "## 1. Keyword Matches" >> reports/dlp/custom_scan.log
          grep -rnEi "(password|secret|apikey|token|auth)" . --exclude-dir=.git --exclude-dir=reports >> reports/dlp/custom_scan.log || echo "No keywords found."
          
          # 4-2. ê³ ì—”íŠ¸ë¡œí”¼ ë¬¸ìì—´ íƒì§€ (Python ìŠ¤í¬ë¦½íŠ¸)
          cat << 'EOF' > detect_entropy.py
          import os, math, sys

          def shannon_entropy(data):
              if not data: return 0
              entropy = 0
              for x in range(256):
                  p_x = float(data.count(chr(x)))/len(data)
                  if p_x > 0: entropy += - p_x*math.log(p_x, 2)
              return entropy

          print("## 2. High Entropy Strings (Potential Keys)", file=sys.stderr)
          for root, dirs, files in os.walk("."):
              if ".git" in root or "reports" in root: continue
              for f in files:
                  try:
                      path = os.path.join(root, f)
                      with open(path, 'r', errors='ignore') as file:
                          content = file.read()
                          # ê°„ë‹¨í•œ íœ´ë¦¬ìŠ¤í‹±: ê³µë°± ì—†ëŠ” ê¸´ ë¬¸ìì—´ ì¤‘ ì—”íŠ¸ë¡œí”¼ 4.5 ì´ìƒ
                          for word in content.split():
                              if len(word) > 20 and shannon_entropy(word) > 4.5:
                                  print(f"- [High Entropy] {path}: {word[:10]}...", file=sys.stderr)
                  except: pass
          EOF
          
          python detect_entropy.py 2>> reports/dlp/custom_scan.log
          echo "Custom Scan Completed."

      # 5. í†µí•© ë³´ì•ˆ ë¦¬í¬íŠ¸ ìƒì„± ë° ìë™ ì¡°ì¹˜(Quarantine)
      - name: ğŸ“ Generate DLP Report & Auto-Quarantine
        run: |
          REPORT_FILE="reports/dlp/DLP_REPORT_${{ github.run_number }}.md"
          
          echo "# ğŸ›¡ï¸ Grand Ops DLP Audit Report" > $REPORT_FILE
          echo "### ğŸ“… Scan Date: $(date)" >> $REPORT_FILE
          echo "### ğŸ” Scan Engine: Gitleaks + GrandOps Heuristic" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          
          # 5-1. Gitleaks ê²°ê³¼ ìš”ì•½ (ìˆì„ ê²½ìš°)
          if [ -f gitleaks-report.json ]; then
             echo "## ğŸš¨ Gitleaks Detection" >> $REPORT_FILE
             echo "Sensitive data patterns detected by Gitleaks." >> $REPORT_FILE
          else
             echo "## âœ… Gitleaks: Clean" >> $REPORT_FILE
          fi
          
          # 5-2. ì»¤ìŠ¤í…€ ìŠ¤ìº” ê²°ê³¼ ë³‘í•©
          echo "## âš ï¸ Custom Scan Findings" >> $REPORT_FILE
          echo "\`\`\`text" >> $REPORT_FILE
          cat reports/dlp/custom_scan.log >> $REPORT_FILE
          echo "\`\`\`" >> $REPORT_FILE
          
          # 5-3. ìë™ ê²©ë¦¬ ì¡°ì¹˜ (Auto-Quarantine)
          echo "## ğŸ›¡ï¸ Automated Actions" >> $REPORT_FILE
          if [ -d ".secrets_simulation" ]; then
             echo "- [ACTION] Mock secrets detected." >> $REPORT_FILE
             mv .secrets_simulation .secrets_simulation_quarantined
             echo "- [ACTION] Moved to '.secrets_simulation_quarantined' to prevent exposure." >> $REPORT_FILE
          fi

      # 6. ê²°ê³¼ ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: ğŸ’¾ Commit & Push DLP Report
        run: |
          # Git ìœ ì € ì„¤ì •
          git config --global user.name "Grand Ops Security Bot"
          git config --global user.email "security@grandops.io"
          
          # ë¦¬í¬íŠ¸ ë° ê²©ë¦¬ëœ íŒŒì¼ ìŠ¤í…Œì´ì§•
          git add .
          
          # ì»¤ë°‹
          git commit -m "ğŸ›¡ï¸ DLP Scan Report #${{ github.run_number }} & Quarantine Actions [skip ci]" || echo "No changes to commit"
          
          # [í•µì‹¬] í† í°ì„ ì‚¬ìš©í•œ ì¸ì¦ ë° í‘¸ì‹œ
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin HEAD:${{ github.ref }}

      # 7. (ì˜µì…˜) ìœ ì¶œ ë°œê²¬ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬ (PR ì°¨ë‹¨ìš©)
      # ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì£¼ì„ í•´ì œí•˜ì—¬ ì‚¬ìš©
      # - name: ğŸ›‘ Fail Build if Leaks Found
      #   if: steps.gitleaks.outcome == 'failure'
      #   run: |
      #     echo "âŒ CRITICAL: Secrets detected in the codebase! Build failed to prevent leak."
      #     exit 1
