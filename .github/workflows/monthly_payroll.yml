name: Total Financial System (Scripts Folder Version)

on:
  schedule:
    - cron: '0 9 11,21 * *'
  workflow_dispatch:

jobs:
  run-financial-core:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install pandas matplotlib reportlab openpyxl numpy cryptography tabulate schedule

    # [ìˆ˜ì •ë¨] scripts í´ë” ìƒì„± ë° ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ìƒì„± ìœ„ì¹˜ ë³€ê²½
    - name: Generate Script in 'scripts' folder
      run: |
        # 1. scripts ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p scripts

        # 2. íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ scripts í´ë” ì•ˆì— ìƒì„±
        cat << 'EOF' > scripts/financial_core.py
        import sqlite3
        import pandas as pd
        import os
        import time
        import shutil
        import schedule
        import numpy as np
        import hashlib
        from datetime import datetime
        from cryptography.fernet import Fernet
        from tabulate import tabulate

        # ==========================================
        # 1. Directory Structure (Root based)
        # ==========================================
        # ìŠ¤í¬ë¦½íŠ¸ëŠ” scripts/ ì•ˆì— ìˆì§€ë§Œ, ë°ì´í„°ëŠ” í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ì €ì¥
        BASE_DIR = os.getcwd() 
        DIRS = {
            'CARD': os.path.join(BASE_DIR, 'INBOUND/CARD'),
            'LOAN': os.path.join(BASE_DIR, 'INBOUND/LOAN'),
            'CORE': os.path.join(BASE_DIR, 'INBOUND/CORE'),
            'ARCHIVE': os.path.join(BASE_DIR, 'DATA/ARCHIVE'),
            'BACKUP': os.path.join(BASE_DIR, 'DATA/BACKUP'),
            'REPORT': os.path.join(BASE_DIR, 'DATA/REPORT')
        }
        for d in DIRS.values():
            if not os.path.exists(d): os.makedirs(d)

        # ==========================================
        # 2. Security Module (AES-256)
        # ==========================================
        class SecurityManager:
            def __init__(self):
                self.key = Fernet.generate_key()
                self.cipher = Fernet(self.key)
            
            def encrypt(self, text): 
                return self.cipher.encrypt(str(text).encode()).decode()
            
            def decrypt(self, text): 
                return self.cipher.decrypt(str(text).encode()).decode()

        # ==========================================
        # 3. Financial DW Manager
        # ==========================================
        class FinancialDW:
            def __init__(self, db_name="financial_dw.db"):
                # DB íŒŒì¼ë„ ë£¨íŠ¸ì˜ DATA í´ë”ì— ì €ì¥
                self.db_path = os.path.join(BASE_DIR, 'DATA', db_name)
                self.conn = sqlite3.connect(self.db_path)
                self.cursor = self.conn.cursor()
                self.sec = SecurityManager()
                self._init_schema()

            def _init_schema(self):
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS fact_card_tx (
                    tx_id INTEGER PRIMARY KEY AUTOINCREMENT,
                    card_no_enc TEXT, tx_type TEXT, merchant TEXT, amount INTEGER, approval_time TIMESTAMP)''')
                
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS fact_loan_tx (
                    loan_id INTEGER PRIMARY KEY AUTOINCREMENT,
                    cust_id_enc TEXT, loan_type TEXT, interest_rate REAL, amount INTEGER, tx_time TIMESTAMP)''')
                
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS fact_core_tx (
                    core_id INTEGER PRIMARY KEY AUTOINCREMENT,
                    account_enc TEXT, tx_type TEXT, amount INTEGER, balance_after INTEGER, tx_time TIMESTAMP)''')
                
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS sys_job_log (
                    job_id TEXT, start_time TIMESTAMP, end_time TIMESTAMP, status TEXT, target_file TEXT)''')
                self.conn.commit()

            def execute_backup(self):
                backup_file = os.path.join(DIRS['BACKUP'], f"FULL_BACKUP_{datetime.now().strftime('%Y%m%d_%H%M%S')}.db")
                try:
                    bck = sqlite3.connect(backup_file)
                    self.conn.backup(bck)
                    bck.close()
                    return True, backup_file
                except Exception as e:
                    return False, str(e)

        # ==========================================
        # 4. Interface Simulator
        # ==========================================
        class InterfaceSimulator:
            def gen_card_file(self): self._gen_file('CARD', 'CARD_', ['APPROVAL', 'CARD_LOAN'], 8)
            def gen_loan_file(self): self._gen_file('LOAN', 'LOAN_', ['NEW_LOAN', 'REPAYMENT'], 4)
            def gen_core_file(self): self._gen_file('CORE', 'CORE_', ['DEPOSIT', 'WITHDRAW'], 15)

            def _gen_file(self, system, prefix, types, count):
                timestamp = datetime.now().strftime("%H%M%S")
                filename = f"{prefix}{timestamp}.dat"
                path = os.path.join(DIRS[system], filename)
                data = {
                    'type': [np.random.choice(types) for _ in range(count)],
                    'user': [f"User_{np.random.randint(1000,9999)}" for _ in range(count)],
                    'amount': np.random.randint(1, 100) * 10000
                }
                pd.DataFrame(data).to_csv(path, index=False)
                print(f"ğŸ“¡ [Interface] {system} File Generated: {filename}")

        # ==========================================
        # 5. Batch & CTMFW
        # ==========================================
        class BatchJobController:
            def __init__(self, dw): self.dw = dw
            
            def process_common(self, filepath, table, col_map):
                df = pd.read_csv(filepath)
                data = []
                for _, row in df.iterrows():
                    enc_user = self.dw.sec.encrypt(row['user'])
                    # ê°„ë‹¨í•œ ë§¤í•‘ ë¡œì§ ì‹œë®¬ë ˆì´ì…˜
                    if table == 'fact_card_tx':
                        data.append((enc_user, row['type'], 'Merchant_X', row['amount'], datetime.now()))
                    elif table == 'fact_loan_tx':
                        rate = 5.0
                        data.append((enc_user, row['type'], rate, row['amount'], datetime.now()))
                    elif table == 'fact_core_tx':
                        bal = 1000000 + row['amount']
                        data.append((enc_user, row['type'], row['amount'], bal, datetime.now()))
                
                placeholders = ','.join(['?'] * len(data[0]))
                cols = ','.join(col_map)
                self.dw.cursor.executemany(f"INSERT INTO {table} ({cols}) VALUES ({placeholders})", data)
                self.dw.conn.commit()
                return len(data)

        class CTMFW_Engine:
            def __init__(self, dw, batch):
                self.dw = dw
                self.batch = batch
            
            def watch_files(self):
                targets = [
                    ('CARD', DIRS['CARD'], 'fact_card_tx', ['card_no_enc', 'tx_type', 'merchant', 'amount', 'approval_time'], 'JOB_CARD'),
                    ('LOAN', DIRS['LOAN'], 'fact_loan_tx', ['cust_id_enc', 'loan_type', 'interest_rate', 'amount', 'tx_time'], 'JOB_LOAN'),
                    ('CORE', DIRS['CORE'], 'fact_core_tx', ['account_enc', 'tx_type', 'amount', 'balance_after', 'tx_time'], 'JOB_CORE')
                ]
                
                for sys, folder, table, cols, job_id in targets:
                    for f in [x for x in os.listdir(folder) if x.endswith('.dat')]:
                        src = os.path.join(folder, f)
                        dst = os.path.join(DIRS['ARCHIVE'], f"{sys}_{f}")
                        print(f"ğŸ‘ï¸ [CTMFW] Detected {f} -> Trigger Batch")
                        
                        try:
                            cnt = self.batch.process_common(src, table, cols)
                            status = "SUCCESS"
                            shutil.move(src, dst)
                            # ì„±ê³µ ì‹œ ë°±ì—… íŠ¸ë¦¬ê±°
                            self.dw.execute_backup()
                        except Exception as e:
                            status = "FAIL"
                            print(f"Error: {e}")
                        
                        self.dw.cursor.execute("INSERT INTO sys_job_log VALUES (?,?,?,?,?)", 
                            (job_id, datetime.now(), datetime.now(), status, f))
                        self.dw.conn.commit()

        # ==========================================
        # 6. Main Execution
        # ==========================================
        def print_dashboard(dw):
            print("\n" + "="*60)
            print(f"   FINANCIAL BATCH DASHBOARD ({datetime.now().strftime('%H:%M:%S')})")
            print("="*60)
            df = pd.read_sql("SELECT job_id, status, target_file, end_time FROM sys_job_log ORDER BY end_time DESC LIMIT 5", dw.conn)
            if not df.empty: print(tabulate(df, headers='keys', tablefmt='psql', showindex=False))
            else: print("   (No History)")
            print("\n")

        if __name__ == "__main__":
            print(">> [Init] Financial System Starting (Scripts in /scripts)...")
            dw = FinancialDW()
            batch = BatchJobController(dw)
            ctmfw = CTMFW_Engine(dw, batch)
            sim = InterfaceSimulator()
            
            schedule.every(3).seconds.do(sim.gen_core_file)
            schedule.every(6).seconds.do(sim.gen_card_file)
            schedule.every(10).seconds.do(sim.gen_loan_file)
            schedule.every(1).seconds.do(ctmfw.watch_files)
            schedule.every(5).seconds.do(lambda: print_dashboard(dw))
            
            # ì‹¤í–‰ ì‹œê°„ (60ì´ˆ)
            start = time.time()
            while time.time() - start < 60:
                schedule.run_pending()
                time.sleep(1)
            
            print(">> [Shutdown] Saving Final Reports...")
            for t in ['fact_card_tx', 'fact_loan_tx', 'fact_core_tx', 'sys_job_log']:
                pd.read_sql(f"SELECT * FROM {t}", dw.conn).to_excel(f"{DIRS['REPORT']}/{t}.xlsx")
        EOF

    # [ìˆ˜ì •ë¨] scripts ê²½ë¡œì˜ íŒŒì¼ ì‹¤í–‰
    - name: Run Financial System
      run: python scripts/financial_core.py

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Financial-Data-${{ github.run_id }}
        path: |
          DATA/REPORT/
          DATA/BACKUP/
          DATA/ARCHIVE/
        retention-days: 30
