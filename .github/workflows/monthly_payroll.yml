name: Monthly Payroll Automation (Self-Healing)

on:
  schedule:
    - cron: '0 9 25 * *'  # 매월 25일 실행
  workflow_dispatch:      # 수동 실행 버튼

jobs:
  run-payroll-system:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write

    steps:
    # 1. 저장소 체크아웃
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2. Python 환경 설정
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 3. 디버깅: 현재 파일 목록 확인 (에러 원인 파악용)
    - name: Debug - List Files
      run: |
        echo "Current Directory: $(pwd)"
        ls -R

    # 4. 필수 라이브러리 설치
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas matplotlib reportlab openpyxl numpy

    # 5. [핵심] 파이썬 스크립트 자동 생성 (파일 누락 방지)
    # 아래 코드가 실행 시점에 'payroll_master.py'를 직접 만들어냅니다.
    - name: Create Python Script (Auto-Generate)
      run: |
        cat << 'EOF' > payroll_master.py
        import sqlite3
        import pandas as pd
        import os
        import urllib.request
        import numpy as np
        from datetime import datetime
        import matplotlib.pyplot as plt
        import matplotlib.font_manager as fm
        from reportlab.pdfgen import canvas
        from reportlab.lib.pagesizes import A4
        from reportlab.pdfbase import pdfmetrics
        from reportlab.pdfbase.ttfonts import TTFont
        from reportlab.lib.pdfencrypt import StandardEncryption

        # === 1. DB Manager ===
        class PayrollDBManager:
            def __init__(self, db_name="payroll.db"):
                self.db_name = db_name
            def initialize_db(self):
                conn = sqlite3.connect(self.db_name)
                cursor = conn.cursor()
                cursor.execute('''CREATE TABLE IF NOT EXISTS employees (
                    emp_id TEXT PRIMARY KEY, name TEXT, dept TEXT, email TEXT,
                    birth_date TEXT, base_pay INTEGER, bank_name TEXT, account_number TEXT)''')
                sample_data = [
                    ('2025001', 'Kim Chulsoo', 'Dev Team', 'kim@test.com', '900101', 5000000, 'KB Bank', '111-111'),
                    ('2025002', 'Lee Younghee', 'HR Team', 'lee@test.com', '920505', 4500000, 'Shinhan', '222-222'),
                    ('2025003', 'Park Minsu', 'Sales', 'park@test.com', '881212', 5500000, 'Woori', '333-333')
                ]
                cursor.executemany('INSERT OR IGNORE INTO employees VALUES (?,?,?,?,?,?,?,?)', sample_data)
                conn.commit()
                conn.close()
                print(f">> [DB] Initialized {self.db_name}")

        # === 2. Master Workflow ===
        class MasterPayrollWorkflow:
            def __init__(self, db_name="payroll.db"):
                self.db_name = db_name
                self.current_month = datetime.now().strftime('%Y-%m')
                self.output_dir = f"Result_{self.current_month}"
                if not os.path.exists(self.output_dir): os.makedirs(self.output_dir)
                self._setup_fonts()

            def _setup_fonts(self):
                self.font_name = 'NanumGothic'
                font_file = 'NanumGothic.ttf'
                if not os.path.exists(font_file):
                    url = "https://github.com/google/fonts/raw/main/ofl/nanumgothic/NanumGothic-Regular.ttf"
                    urllib.request.urlretrieve(url, font_file)
                try: pdfmetrics.registerFont(TTFont(self.font_name, font_file))
                except: self.font_name = 'Helvetica'
                try:
                    fe = fm.FontEntry(fname=font_file, name=self.font_name)
                    fm.fontManager.ttflist.insert(0, fe)
                    plt.rc('font', family=self.font_name)
                except: pass

            def run_process(self):
                # 1. Load Data
                conn = sqlite3.connect(self.db_name)
                df = pd.read_sql("SELECT * FROM employees", conn)
                conn.close()
                
                # 2. Merge Variable Data
                np.random.seed(42)
                df['overtime_pay'] = np.random.randint(0, 6, size=len(df)) * 100000
                
                # 3. Calculate
                tax_free = 200000
                df['taxable'] = df['base_pay'] + df['overtime_pay'] - tax_free
                df['total_deduct'] = (df['taxable'] * (0.045 + 0.03545 + 0.009 + 0.033)).astype(int) # Approximate
                df['net_pay'] = (df['base_pay'] + df['overtime_pay']) - df['total_deduct']
                
                # 4. Generate Output (PDF & Excel)
                for _, row in df.iterrows():
                    fname = f"{self.output_dir}/Payslip_{row['emp_id']}.pdf"
                    enc = StandardEncryption(str(row['birth_date']), canPrint=1, canCopy=0)
                    c = canvas.Canvas(fname, pagesize=A4, encrypt=enc)
                    c.setFont(self.font_name, 12)
                    c.drawString(50, 800, f"Payslip: {row['name']}")
                    c.drawString(50, 780, f"Net Pay: {row['net_pay']:,} KRW")
                    c.save()
                
                df.to_excel(f"{self.output_dir}/Report.xlsx", index=False)
                print(f">> Success! Files saved in {self.output_dir}")

        if __name__ == "__main__":
            db = PayrollDBManager()
            db.initialize_db()
            wf = MasterPayrollWorkflow()
            wf.run_process()
        EOF

    # 6. 생성된 스크립트 실행
    - name: Run Payroll Script
      run: |
        ls -l payroll_master.py  # 파일 생성 확인
        python payroll_master.py

    # 7. 결과물 업로드 (v4 업데이트 반영)
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Payroll-Result-${{ github.run_id }}
        path: Result_*/
        retention-days: 30
