name: Enterprise Vertica Batch System (Resident & BS/MIS)

on:
  schedule:
    - cron: '0 9 11,21 * *' # 매월 11일, 21일 (급여일)
  workflow_dispatch:        # 수동 실행

jobs:
  run-enterprise-system:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # vertica-python은 실제 연결 시 필요하지만, 여기선 시뮬레이션으로 대체
        pip install pandas matplotlib reportlab openpyxl numpy cryptography tabulate schedule

    - name: Generate Resident System Script
      run: |
        cat << 'EOF' > enterprise_system.py
        import sqlite3
        import pandas as pd
        import os
        import time
        import schedule # 스케줄러 라이브러리
        import numpy as np
        import hashlib
        from datetime import datetime, timedelta
        from cryptography.fernet import Fernet
        from tabulate import tabulate

        # 시각화 & PDF
        from reportlab.pdfgen import canvas
        from reportlab.lib.pagesizes import A4
        from reportlab.lib.pdfencrypt import StandardEncryption

        # ==========================================
        # 1. Security & Common Utils
        # ==========================================
        class SecurityManager:
            def __init__(self):
                self.key = Fernet.generate_key()
                self.cipher = Fernet(self.key)
            def encrypt(self, text): return self.cipher.encrypt(str(text).encode()).decode()
            def decrypt(self, text): return self.cipher.decrypt(str(text).encode()).decode()
            def hash_tx(self, data): return hashlib.sha256(str(data).encode()).hexdigest()

        # ==========================================
        # 2. Vertica DW Manager (Simulation)
        # ==========================================
        class VerticaDWManager:
            """
            실제 Vertica DB 연결 대신, 로컬에서 Vertica의 
            Fact/Dimension 구조를 모방한 SQLite DW를 구축합니다.
            """
            def __init__(self, db_name="vertica_dw.db"):
                self.conn = sqlite3.connect(db_name)
                self.cursor = self.conn.cursor()
                self.sec = SecurityManager()

            def initialize_schema(self):
                # [Dimension Table] 사원/조직 정보
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS dim_employees (
                    emp_sk INTEGER PRIMARY KEY AUTOINCREMENT, -- Surrogate Key
                    emp_id TEXT UNIQUE,
                    name TEXT,
                    dept_name TEXT,
                    enc_account TEXT
                )''')

                # [Dimension Table] 계정과목 (BS용)
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS dim_account_codes (
                    code TEXT PRIMARY KEY,
                    category TEXT, -- ASSET, LIABILITY, EQUITY
                    name TEXT
                )''')

                # [Fact Table] 거래 트랜잭션 (대용량 가정)
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS fact_transactions (
                    tx_id INTEGER PRIMARY KEY AUTOINCREMENT,
                    tx_time TIMESTAMP,
                    emp_sk INTEGER,
                    tx_type TEXT,
                    amount INTEGER,
                    tx_hash TEXT
                )''')

                # [Fact Table] 배치 작업 로그
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS fact_batch_logs (
                    log_id INTEGER PRIMARY KEY AUTOINCREMENT,
                    batch_type TEXT, -- TRANSACTION, BS, MIS
                    run_time TIMESTAMP,
                    status TEXT,
                    details TEXT
                )''')

                # 기초 데이터 로드 (계정과목)
                self.cursor.execute("INSERT OR IGNORE INTO dim_account_codes VALUES ('1001', 'ASSET', '법인예금')")
                self.cursor.execute("INSERT OR IGNORE INTO dim_account_codes VALUES ('2001', 'LIABILITY', '미지급급여')")
                self.cursor.execute("INSERT OR IGNORE INTO dim_account_codes VALUES ('5001', 'EXPENSE', '급여비용')")
                
                # 기초 데이터 로드 (사원)
                emps = [('E01', 'Kim', 'Dev', 'ACC_ENC_1'), ('E02', 'Lee', 'HR', 'ACC_ENC_2')]
                self.cursor.executemany("INSERT OR IGNORE INTO dim_employees (emp_id, name, dept_name, enc_account) VALUES (?,?,?,?)", emps)
                
                self.conn.commit()
                print(">> [Vertica] DW Schema (Fact/Dim) Initialized.")

            def insert_transaction(self, emp_id, amount, tx_type="SALARY_PAYMENT"):
                # SK 조회
                self.cursor.execute("SELECT emp_sk FROM dim_employees WHERE emp_id=?", (emp_id,))
                res = self.cursor.fetchone()
                if not res: return
                emp_sk = res[0]

                # 트랜잭션 기록
                tx_hash = self.sec.hash_tx(f"{emp_sk}{amount}{time.time()}")
                self.cursor.execute("""
                    INSERT INTO fact_transactions (tx_time, emp_sk, tx_type, amount, tx_hash)
                    VALUES (CURRENT_TIMESTAMP, ?, ?, ?, ?)
                """, (emp_sk, tx_type, amount, tx_hash))
                self.conn.commit()

            def log_batch(self, b_type, status, details):
                self.cursor.execute("INSERT INTO fact_batch_logs (batch_type, run_time, status, details) VALUES (?, CURRENT_TIMESTAMP, ?, ?)",
                                    (b_type, status, details))
                self.conn.commit()

        # ==========================================
        # 3. Batch Job Engine (BS / MIS)
        # ==========================================
        class BatchJobEngine:
            def __init__(self, dw_mgr):
                self.dw = dw_mgr
                self.output_dir = "Batch_Reports"
                if not os.path.exists(self.output_dir): os.makedirs(self.output_dir)

            def run_transaction_batch(self):
                """20분마다 실행되는 트랜잭션 수행 배치"""
                print(f"\n[Batch] 트랜잭션 배치 시작 ({datetime.now().strftime('%H:%M:%S')})")
                try:
                    # 시뮬레이션: 5건의 랜덤 급여 이체
                    for i in range(5):
                        amt = np.random.randint(300, 500) * 10000
                        self.dw.insert_transaction("E01", amt)
                    
                    self.dw.log_batch("TRANSACTION", "SUCCESS", "5 tx generated")
                    print("   - 트랜잭션 데이터 생성 및 Vertica 적재 완료")
                except Exception as e:
                    self.dw.log_batch("TRANSACTION", "ERROR", str(e))

            def run_bs_batch(self):
                """BS(재무상태표) 마감 배치"""
                print(f"[Batch] BS(대차대조표) 생성 배치 가동")
                # Fact 테이블 집계
                df = pd.read_sql("SELECT tx_type, sum(amount) as total FROM fact_transactions GROUP BY tx_type", self.dw.conn)
                
                # BS 로직 시뮬레이션
                total_salary = df[df['tx_type']=='SALARY_PAYMENT']['total'].sum() if not df.empty else 0
                bs_data = [
                    ['자산 (Asset)', '법인예금', f"{1000000000 - total_salary:,}"],
                    ['부채 (Liability)', '미지급금', '0'],
                    ['자본 (Equity)', '자본금', '1,000,000,000']
                ]
                
                # 리포트 저장
                file_path = f"{self.output_dir}/BS_Report_{datetime.now().strftime('%H%M%S')}.xlsx"
                pd.DataFrame(bs_data, columns=['구분', '계정', '금액']).to_excel(file_path)
                self.dw.log_batch("BS_BATCH", "SUCCESS", f"Report saved: {file_path}")
                print(f"   - BS 리포트 생성 완료: {file_path}")

            def run_mis_batch(self):
                """MIS(경영정보) 분석 배치"""
                print(f"[Batch] MIS(경영분석) 리포팅 배치 가동")
                query = """
                    SELECT d.dept_name, count(f.tx_id) as tx_count, sum(f.amount) as total_amt
                    FROM fact_transactions f
                    JOIN dim_employees d ON f.emp_sk = d.emp_sk
                    GROUP BY d.dept_name
                """
                df = pd.read_sql(query, self.dw.conn)
                
                print(tabulate(df, headers='keys', tablefmt='psql'))
                self.dw.log_batch("MIS_BATCH", "SUCCESS", "MIS Query Executed")

        # ==========================================
        # 4. Resident Daemon (상주 프로세스)
        # ==========================================
        class ResidentDaemon:
            def __init__(self):
                self.dw = VerticaDWManager()
                self.dw.initialize_schema()
                self.engine = BatchJobEngine(self.dw)
                
                # 스케줄러 등록
                # (GitHub Actions 테스트를 위해 간격 단축: 20분 -> 시뮬레이션상 3초)
                # 실제 운영 시: schedule.every(20).minutes.do(...)
                schedule.every(2).seconds.do(self.engine.run_transaction_batch)
                schedule.every(5).seconds.do(self.engine.run_bs_batch)
                schedule.every(5).seconds.do(self.engine.run_mis_batch)

            def start_service(self):
                print(">> [Daemon] Vertica 상주 배치 서비스가 시작되었습니다. (PID: {})".format(os.getpid()))
                print(">> [Config] 트랜잭션 주기: 20분(Sim:2s) | BS/MIS 주기: 매시 정각(Sim:5s)")
                
                start_time = time.time()
                # GitHub Actions 타임아웃 방지를 위해 약 30초만 시뮬레이션 수행
                # 실제 서버에서는 while True: 사용
                max_runtime = 30 
                
                while time.time() - start_time < max_runtime:
                    schedule.run_pending()
                    time.sleep(1)
                
                print(">> [Daemon] 서비스 안전 종료 (Simulation Finished).")

        # ==========================================
        # Main Execution
        # ==========================================
        if __name__ == "__main__":
            daemon = ResidentDaemon()
            daemon.start_service()
        EOF

    - name: Run Resident Batch System
      run: python enterprise_system.py

    - name: Upload Batch Reports
      uses: actions/upload-artifact@v4
      with:
        name: Batch-Reports-${{ github.run_id }}
        path: Batch_Reports/
        retention-days: 30
