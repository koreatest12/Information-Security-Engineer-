name: Dashboard-Style Secure DB Ops & Locking

on:
  schedule:
    - cron: '0 18 * * 5' # Îß§Ï£º Í∏àÏöîÏùº Ïã§Ìñâ
  workflow_dispatch:

jobs:
  run-dashboard-secure-ops:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      checks: write

    steps:
    - name: Checkout Main Repository
      uses: actions/checkout@v4
      with:
        path: main_repo

    - name: Checkout External Security Assets
      uses: actions/checkout@v4
      continue-on-error: true
      with:
        repository: koreatest12/Information-Security-Engineer-
        path: external_assets
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install pandas numpy cryptography schedule tabulate psutil openpyxl networkx pyzipper

    - name: Deploy Dashboard Ops Engine
      run: |
        mkdir -p main_repo/scripts
        cat << 'EOF' > main_repo/scripts/dashboard_ops.py
        import os
        import time
        import sqlite3
        import shutil
        import stat
        import schedule
        import pandas as pd
        import numpy as np
        import networkx as nx
        import pyzipper
        from datetime import datetime
        from cryptography.fernet import Fernet
        from tabulate import tabulate

        # ==========================================
        # 1. Global Configuration
        # ==========================================
        BASE_DIR = os.getcwd()
        EXT_REPO_DIR = os.path.join(BASE_DIR, '../external_assets')
        
        DIRS = {
            'SECURE_VAULT': os.path.join(BASE_DIR, 'SECURE_VAULT'),
            'DB_DATA': os.path.join(BASE_DIR, 'DATA/DB'),
            'EXTERNAL_SYNC': os.path.join(BASE_DIR, 'DATA/EXTERNAL_SYNC'),
            'LOGS': os.path.join(BASE_DIR, 'LOGS')
        }
        
        for d in DIRS.values():
            os.makedirs(d, exist_ok=True)

        # ==========================================
        # 2. Security Vault (Password Rotation)
        # ==========================================
        class SecurityVault:
            def __init__(self):
                self.base_pin = 4310
                self.current_week = datetime.now().isocalendar()[1]
                self.current_password = self._generate_weekly_password()

            def _generate_weekly_password(self):
                rotated_pin = self.base_pin + self.current_week
                pwd = f"korea{rotated_pin}@#$"
                print(f"üîê [Vault] Password Rotated for Week {self.current_week}")
                return pwd

            def encrypt_and_archive(self, target_dir, zip_name):
                zip_path = os.path.join(DIRS['SECURE_VAULT'], f"{zip_name}.zip")
                try:
                    with pyzipper.AESZipFile(zip_path, 'w', compression=pyzipper.ZIP_LZMA, encryption=pyzipper.WZ_AES) as zf:
                        zf.setpassword(self.current_password.encode())
                        for root, _, files in os.walk(target_dir):
                            for file in files:
                                p = os.path.join(root, file)
                                zf.write(p, os.path.relpath(p, os.path.dirname(target_dir)))
                    return True, zip_path
                except Exception as e:
                    print(f"‚ùå Encryption Error: {e}")
                    return False, str(e)

        # ==========================================
        # 3. Secure DB Manager (Locking)
        # ==========================================
        class SecureDBManager:
            def __init__(self, db_name="korea_financial_core.db"):
                self.db_path = os.path.join(DIRS['DB_DATA'], db_name)
                self.conn = None
                
            def create_db_and_tables(self):
                self.conn = sqlite3.connect(self.db_path)
                self.conn.execute('''CREATE TABLE IF NOT EXISTS fin_transactions (
                    tx_id TEXT PRIMARY KEY, user_id TEXT, amount REAL, 
                    tx_type TEXT, timestamp DATETIME)''')
                self.conn.close()
                return "DB Schema & Tables Initialized"

            def perform_transaction_with_table_lock(self):
                try:
                    self.conn = sqlite3.connect(self.db_path)
                    cursor = self.conn.cursor()
                    
                    # [Table Lock] Exclusive Transaction
                    cursor.execute("BEGIN EXCLUSIVE TRANSACTION")
                    
                    data = [(f"TX_{i}", f"U_{i}", 1000, "DEP", datetime.now()) for i in range(100)]
                    cursor.executemany("INSERT INTO fin_transactions VALUES (?,?,?,?,?)", data)
                    
                    self.conn.commit() # Lock Release
                    return "100 Rows Inserted (Locked Mode)"
                except Exception as e:
                    if self.conn: self.conn.rollback()
                    return f"Tx Failed: {e}"
                finally:
                    if self.conn: self.conn.close()

            def apply_physical_db_lock(self):
                if os.path.exists(self.db_path):
                    os.chmod(self.db_path, stat.S_IRUSR) # Read-Only
                    return "Physical DB File Locked (0o400)"
                return "DB File Not Found"

        # ==========================================
        # 4. External Assets & Control-M
        # ==========================================
        class ExternalRepoManager:
            def __init__(self):
                self.sync_path = DIRS['EXTERNAL_SYNC']
            
            def sync(self):
                if os.path.exists(EXT_REPO_DIR):
                    if os.path.exists(self.sync_path): shutil.rmtree(self.sync_path)
                    shutil.copytree(EXT_REPO_DIR, self.sync_path, dirs_exist_ok=True)
                    return f"Synced from {os.path.basename(EXT_REPO_DIR)}"
                else:
                    with open(os.path.join(self.sync_path, "mock.txt"), 'w') as f: f.write("MOCK")
                    return "Mock Assets Generated"

        class ControlM_Engine:
            def __init__(self):
                self.dag = nx.DiGraph()
                self.results = [] # Í≤∞Í≥ºÎ•º Ï†ÄÏû•Ìï† Î¶¨Ïä§Ìä∏
            
            def add_job(self, name, func, deps=[]):
                self.dag.add_node(name, task=func)
                for d in deps: self.dag.add_edge(d, name)
            
            def run(self):
                print(f"\nüéÆ [Control-M] Processing...")
                try:
                    for job in nx.topological_sort(self.dag):
                        start_ts = time.time()
                        res = self.dag.nodes[job]['task']()
                        duration = time.time() - start_ts
                        
                        # Í≤∞Í≥º Ï†ÄÏû•
                        self.results.append({
                            "Job Name": job,
                            "Status": "‚úÖ Success",
                            "Result": res,
                            "Duration": f"{duration:.2f}s"
                        })
                        print(f"   ‚ñ∂Ô∏è {job}: {res}")
                except Exception as e:
                    self.results.append({"Job Name": "FATAL_ERROR", "Status": "‚ùå Failed", "Result": str(e), "Duration": "0s"})
                return self.results

        # ==========================================
        # 5. Main Execution & Dashboard Generation
        # ==========================================
        if __name__ == "__main__":
            vault = SecurityVault()
            db_mgr = SecureDBManager()
            ext_mgr = ExternalRepoManager()
            ctm = ControlM_Engine()
            
            # --- Workflow Definition ---
            ctm.add_job("1. EXT_ASSET_SYNC", ext_mgr.sync)
            ctm.add_job("2. DB_SCHEMA_INIT", db_mgr.create_db_and_tables, deps=["1. EXT_ASSET_SYNC"])
            ctm.add_job("3. TX_TABLE_LOCK", db_mgr.perform_transaction_with_table_lock, deps=["2. DB_SCHEMA_INIT"])
            ctm.add_job("4. DB_FILE_LOCK", db_mgr.apply_physical_db_lock, deps=["3. TX_TABLE_LOCK"])
            
            def job_final_backup():
                targets = [DIRS['DB_DATA'], DIRS['EXTERNAL_SYNC']]
                files = []
                for t in targets:
                    name = f"SECURE_BK_{os.path.basename(t)}_{datetime.now().strftime('%Y%m%d')}"
                    success, path = vault.encrypt_and_archive(t, name)
                    if success: files.append(os.path.basename(path))
                return f"Archived: {', '.join(files)}"

            ctm.add_job("5. FINAL_VAULT_LOCK", job_final_backup, deps=["4. DB_FILE_LOCK"])
            
            # --- Execution ---
            results = ctm.run()
            
            # --- [ÌïµÏã¨] GitHub Actions Summary Ï∂úÎ†• ---
            summary_file = os.environ.get('GITHUB_STEP_SUMMARY')
            if summary_file:
                with open(summary_file, 'a', encoding='utf-8') as f:
                    # 1. Ìó§Îçî
                    f.write("# üõ°Ô∏è Ultra-Secure DB Ops Dashboard\n")
                    f.write(f"**Execution Time:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
                    
                    # 2. Î≥¥Ïïà Í∏àÍ≥† ÏÉÅÌÉú (ÎπÑÎ∞ÄÎ≤àÌò∏ ÌûåÌä∏)
                    f.write("## üîê Security Vault Status\n")
                    f.write(f"- **Current Week:** {vault.current_week}\n")
                    f.write(f"- **Password Rotation Logic:** `4310` + `Week({vault.current_week})`\n")
                    f.write(f"- **Current Password Hint:** `korea{4310 + vault.current_week}****` (Masked)\n\n")
                    
                    # 3. ÏÉÅÏÑ∏ ÏûëÏóÖ Î¶¨Ìè¨Ìä∏ (ÌÖåÏù¥Î∏î)
                    f.write("## üìã Workflow Execution Report\n")
                    f.write("| Job Name | Status | Result | Duration |\n")
                    f.write("| :--- | :---: | :--- | :---: |\n")
                    
                    for r in results:
                        f.write(f"| {r['Job Name']} | {r['Status']} | {r['Result']} | {r['Duration']} |\n")
                    
                    # 4. Ïû†Í∏à ÏÉÅÌÉú ÌôïÏù∏
                    f.write("\n## üö´ Locking Status Verification\n")
                    f.write("- **Logical Lock (Transaction):** ‚úÖ Committed & Released\n")
                    f.write("- **Physical Lock (File):** üîí Read-Only (0o400) Applied\n")
                    f.write("- **Archive Lock (AES-256):** üîê Applied\n")
        EOF

    - name: Execute & Generate Dashboard
      run: |
        cd main_repo
        python scripts/dashboard_ops.py

    - name: Upload Secured Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Dashboard-Secured-Data-${{ github.run_number }}
        path: main_repo/SECURE_VAULT/
        retention-days: 14
