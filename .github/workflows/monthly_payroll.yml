name: Ultra-Secure Financial Ops & External Integration

on:
  schedule:
    - cron: '0 18 * * 5' # ë§¤ì£¼ ê¸ˆìš”ì¼ 18:00 (UTC 09:00) ë³´ì•ˆ ë°±ì—… ì‹¤í–‰
  workflow_dispatch:

jobs:
  run-secure-integrated-ops:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      checks: write

    steps:
    - name: Checkout Main Repository
      uses: actions/checkout@v4
      with:
        path: main_repo

    # [ìš”ì²­ ë°˜ì˜] ì™¸ë¶€ ë¦¬í¬ì§€í† ë¦¬(koreatest12) ì²´í¬ì•„ì›ƒ ë° í†µí•©
    - name: Checkout External Security Assets
      uses: actions/checkout@v4
      with:
        repository: koreatest12/Information-Security-Engineer-
        path: external_assets
        continue-on-error: true # í•´ë‹¹ ë¦¬í¬ì§€í† ë¦¬ê°€ ì—†ì–´ë„ ë°ëª¨ ì‹¤í–‰ì„ ìœ„í•´ ê³„ì† ì§„í–‰

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Secure Dependencies
      run: |
        # pyzipper: AES ì•”í˜¸í™” ì••ì¶• ì§€ì› ë¼ì´ë¸ŒëŸ¬ë¦¬
        pip install pandas numpy cryptography schedule tabulate psutil openpyxl networkx pyzipper

    - name: Deploy Secure Ops Engine
      run: |
        mkdir -p main_repo/scripts
        cat << 'EOF' > main_repo/scripts/secure_ops_engine.py
        import os
        import time
        import sqlite3
        import shutil
        import schedule
        import pandas as pd
        import numpy as np
        import networkx as nx
        import pyzipper  # ì•”í˜¸í™” ZIP ì§€ì›
        from datetime import datetime
        from cryptography.fernet import Fernet
        from tabulate import tabulate

        # ==========================================
        # 1. Global Configuration
        # ==========================================
        BASE_DIR = os.getcwd()
        EXT_REPO_DIR = os.path.join(BASE_DIR, '../external_assets') # ì™¸ë¶€ ë¦¬í¬ì§€í† ë¦¬ ê²½ë¡œ
        
        DIRS = {
            'SECURE_VAULT': os.path.join(BASE_DIR, 'SECURE_VAULT'), # ìµœì¢… ì•”í˜¸í™” ì €ì¥ì†Œ
            'INTERNAL_DATA': os.path.join(BASE_DIR, 'DATA/INTERNAL'),
            'EXTERNAL_SYNC': os.path.join(BASE_DIR, 'DATA/EXTERNAL_SYNC'),
            'LOGS': os.path.join(BASE_DIR, 'LOGS')
        }
        
        for d in DIRS.values():
            os.makedirs(d, exist_ok=True)

        # ==========================================
        # 2. Dynamic Security Vault (Password Rotation)
        # ==========================================
        class SecurityVault:
            def __init__(self):
                self.base_pin = 4310
                self.current_password = self._generate_weekly_password()

            def _generate_weekly_password(self):
                """
                [ë³´ì•ˆ ìš”ì²­ ë°˜ì˜] ë§¤ì£¼ ìˆ«ì ë³€ê²½ ì•Œê³ ë¦¬ì¦˜
                - ê¸°ë³¸ê°’ 4310 + í˜„ì¬ ì£¼ì°¨(ISO Week Number)
                - ì˜ˆ: 10ì£¼ì°¨ -> 4320
                """
                current_week = datetime.now().isocalendar()[1]
                rotated_pin = self.base_pin + current_week
                pwd = f"korea{rotated_pin}@#$"
                
                # ë³´ì•ˆìƒ ë¡œê·¸ì—ëŠ” ë§ˆìŠ¤í‚¹ ì²˜ë¦¬
                print(f"ğŸ”’ [Security] Password Rotated for Week {current_week}: korea****@#$")
                return pwd

            def lock_and_archive(self, source_dir, archive_name):
                """AES-256 ì•”í˜¸í™”ë¥¼ ì ìš©í•œ ZIP ì••ì¶•"""
                target_zip = os.path.join(DIRS['SECURE_VAULT'], f"{archive_name}.zip")
                
                print(f"ğŸ›¡ï¸ [Vault] Locking {archive_name} with weekly password...")
                try:
                    with pyzipper.AESZipFile(target_zip, 'w', compression=pyzipper.ZIP_LZMA, encryption=pyzipper.WZ_AES) as zf:
                        zf.setpassword(self.current_password.encode())
                        for root, _, files in os.walk(source_dir):
                            for file in files:
                                file_path = os.path.join(root, file)
                                arcname = os.path.relpath(file_path, BASE_DIR)
                                zf.write(file_path, arcname)
                    print(f"   âœ… Locked Successfully: {target_zip}")
                    return True
                except Exception as e:
                    print(f"   âŒ Locking Failed: {e}")
                    return False

        # ==========================================
        # 3. External Repository Manager
        # ==========================================
        class ExternalRepoManager:
            def __init__(self):
                self.sync_path = DIRS['EXTERNAL_SYNC']

            def sync_external_assets(self):
                """ì™¸ë¶€ ë¦¬í¬ì§€í† ë¦¬ì˜ ëª¨ë“  í´ë” ë° ìŠ¤í¬ë¦½íŠ¸ ë°˜ì˜"""
                print(f"\nğŸŒ [External] Syncing assets from {EXT_REPO_DIR}...")
                
                synced_files = []
                if not os.path.exists(EXT_REPO_DIR):
                    print("   âš ï¸ External repo not found (Simulation Mode). Creating Mock Data.")
                    # ëª¨ì˜ ë°ì´í„° ìƒì„±
                    mock_script = os.path.join(self.sync_path, "mock_security_check.sh")
                    with open(mock_script, 'w') as f: f.write("#!/bin/bash\necho 'Checking Firewall...'")
                    synced_files.append("mock_security_check.sh")
                else:
                    # ì‹¤ì œ ë³µì‚¬ ë¡œì§
                    for item in os.listdir(EXT_REPO_DIR):
                        s = os.path.join(EXT_REPO_DIR, item)
                        d = os.path.join(self.sync_path, item)
                        if os.path.isdir(s):
                            shutil.copytree(s, d, dirs_exist_ok=True)
                        else:
                            shutil.copy2(s, d)
                        synced_files.append(item)
                
                return f"Synced {len(synced_files)} assets from External Repo"

        # ==========================================
        # 4. Financial & Control-M Core
        # ==========================================
        class ControlM_Engine:
            def __init__(self):
                self.dag = nx.DiGraph()
            
            def add_job(self, name, func, deps=[]):
                self.dag.add_node(name, task=func)
                for d in deps: self.dag.add_edge(d, name)
            
            def run(self):
                print("\nğŸ® [Control-M] Executing Secured Workflow...")
                for job in nx.topological_sort(self.dag):
                    print(f"   â–¶ï¸ Starting {job}...")
                    res = self.dag.nodes[job]['task']()
                    print(f"      âœ… {res}")

        # --- ê¸ˆìœµ ë¡œì§ (ê°„ì†Œí™”) ---
        def job_financial_tx():
            # DB ìƒì„± ë° íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ì‹œë®¬ë ˆì´ì…˜
            db_path = os.path.join(DIRS['INTERNAL_DATA'], "core_ledger.db")
            conn = sqlite3.connect(db_path)
            pd.DataFrame({'user': ['U1','U2'], 'amt': [100, 200]}).to_sql('tx', conn, if_exists='replace')
            conn.close()
            return "Financial Transactions Processed"

        # ==========================================
        # 5. Main Integration
        # ==========================================
        if __name__ == "__main__":
            print(">> [Init] Secure Integrated Ops System Started")
            
            # ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
            vault = SecurityVault()
            ext_mgr = ExternalRepoManager()
            ctm = ControlM_Engine()
            
            # --- Control-M Job Definition ---
            
            # 1. ì™¸ë¶€ ìì‚° ë™ê¸°í™” (ê°€ì¥ ë¨¼ì € ìˆ˜í–‰)
            ctm.add_job("EXT_SYNC", ext_mgr.sync_external_assets)
            
            # 2. ê¸ˆìœµ ê±°ë˜ ë° DB ì‘ì—… (ë™ê¸°í™” í›„ ìˆ˜í–‰)
            ctm.add_job("FIN_OPS", job_financial_tx, deps=["EXT_SYNC"])
            
            # 3. ë°ì´í„° ë° ì™¸ë¶€ ìì‚° í†µí•© ì•”í˜¸í™” ë°±ì—… (ë§ˆì§€ë§‰ ìˆ˜í–‰)
            def job_secure_backup():
                # ë‚´ë¶€ ë°ì´í„°ì™€ ë™ê¸°í™”ëœ ì™¸ë¶€ ë°ì´í„°ë¥¼ ëª¨ë‘ í¬í•¨í•˜ì—¬ ì ê¸ˆ
                targets = [DIRS['INTERNAL_DATA'], DIRS['EXTERNAL_SYNC']]
                results = []
                for t in targets:
                    name = f"BACKUP_{os.path.basename(t)}_{datetime.now().strftime('%Y%m%d')}"
                    vault.lock_and_archive(t, name)
                    results.append(name)
                return f"Locked & Archived: {', '.join(results)}"

            ctm.add_job("SECURE_LOCK", job_secure_backup, deps=["FIN_OPS"])
            
            # ì‹¤í–‰
            ctm.run()
            
            print(f"\n>> [Complete] System locked with password rotation policy.")
            print(f">> [Info] This week's password hint: korea(4310 + WeekNum)@#$")
        EOF

    - name: Run Secure Ops
      run: |
        cd main_repo
        python scripts/secure_ops_engine.py

    - name: Upload Encrypted Vault
      uses: actions/upload-artifact@v4
      with:
        name: Secured-Vault-Week-${{ github.run_number }}
        path: main_repo/SECURE_VAULT/
        retention-days: 14
