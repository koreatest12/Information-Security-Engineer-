name: Secure Payroll Automation (Pro)

on:
  schedule:
    - cron: '0 9 25 * *' # 매월 25일 자동 실행
  workflow_dispatch:     # 수동 실행

jobs:
  run-secure-payroll:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write

    steps:
    # 1. 저장소 체크아웃
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2. Python 3.11 업그레이드
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # 3. 필수 라이브러리 설치 (암호화 라이브러리 추가)
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas matplotlib reportlab openpyxl numpy cryptography tabulate

    # 4. [핵심] 보안 강화된 파이썬 스크립트 자동 생성
    - name: Generate Secure Python Script
      run: |
        cat << 'EOF' > payroll_pro.py
        import sqlite3
        import pandas as pd
        import os
        import urllib.request
        import numpy as np
        from datetime import datetime
        from cryptography.fernet import Fernet # AES 암호화용
        from tabulate import tabulate # 로그 출력용

        # 시각화 및 PDF
        import matplotlib.pyplot as plt
        import matplotlib.font_manager as fm
        from reportlab.pdfgen import canvas
        from reportlab.lib.pagesizes import A4
        from reportlab.pdfbase import pdfmetrics
        from reportlab.pdfbase.ttfonts import TTFont
        from reportlab.lib.pdfencrypt import StandardEncryption

        # ==========================================
        # 1. Security Manager (AES-256 암호화)
        # ==========================================
        class SecurityManager:
            def __init__(self):
                # 실무에서는 이 키를 GitHub Secrets에 저장해야 합니다.
                # 데모를 위해 실행 시마다 생성합니다.
                self.key = Fernet.generate_key()
                self.cipher = Fernet(self.key)

            def encrypt_data(self, plain_text):
                return self.cipher.encrypt(str(plain_text).encode()).decode()

            def decrypt_data(self, cipher_text):
                return self.cipher.decrypt(cipher_text.encode()).decode()

        # ==========================================
        # 2. Secure DB & Banking Manager
        # ==========================================
        class BankingDBManager:
            def __init__(self, security_mgr, db_name="secure_payroll.db"):
                self.db_name = db_name
                self.sec = security_mgr
                self.conn = sqlite3.connect(self.db_name)
                self.cursor = self.conn.cursor()

            def initialize_system(self):
                """테이블 생성 (사원정보, 회사계좌, 거래원장)"""
                # 1) 사원 테이블 (민감정보 암호화 저장)
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS employees (
                    emp_id TEXT PRIMARY KEY,
                    name TEXT,
                    dept TEXT,
                    email TEXT,
                    enc_birth_date TEXT,   -- 암호화된 생년월일
                    base_pay INTEGER,
                    bank_name TEXT,
                    enc_account TEXT       -- 암호화된 계좌번호
                )''')

                # 2) 회사 법인 계좌 (자금 원천)
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS company_wallet (
                    id INTEGER PRIMARY KEY,
                    balance INTEGER
                )''')
                # 초기 자금 10억 원 세팅
                self.cursor.execute('INSERT OR IGNORE INTO company_wallet (id, balance) VALUES (1, 1000000000)')

                # 3) 거래 원장 (Ledger) - 입출금 내역 기록
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS transaction_ledger (
                    tx_id INTEGER PRIMARY KEY AUTOINCREMENT,
                    tx_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    sender TEXT,
                    receiver TEXT,
                    amount INTEGER,
                    tx_type TEXT, -- 'SALARY', 'BONUS'
                    status TEXT   -- 'SUCCESS', 'FAILED'
                )''')
                
                # 샘플 사원 데이터 주입 (암호화 적용)
                raw_data = [
                    ('2025001', 'Kim CEO', 'Executive', 'ceo@corp.com', '800101', 9000000, 'Citi', '111-999'),
                    ('2025002', 'Lee Dev', 'Dev Team', 'lee@corp.com', '920505', 5000000, 'KB', '222-888'),
                    ('2025003', 'Park HR', 'HR Team', 'park@corp.com', '950303', 4500000, 'Shinhan', '333-777')
                ]
                
                for row in raw_data:
                    # 데이터 암호화 수행
                    enc_birth = self.sec.encrypt_data(row[4])
                    enc_account = self.sec.encrypt_data(row[7])
                    
                    self.cursor.execute('INSERT OR IGNORE INTO employees VALUES (?,?,?,?,?,?,?,?)', 
                        (row[0], row[1], row[2], row[3], enc_birth, row[5], row[6], enc_account))
                
                self.conn.commit()
                print(f">> [System] 보안 DB 초기화 및 자금 세팅 완료.")

            def get_company_balance(self):
                self.cursor.execute("SELECT balance FROM company_wallet WHERE id=1")
                return self.cursor.fetchone()[0]

            def execute_transfer(self, emp_name, amount):
                """입출금 트랜잭션 시뮬레이션"""
                current_balance = self.get_company_balance()
                
                if current_balance >= amount:
                    # 1. 회사 계좌 차감
                    self.cursor.execute("UPDATE company_wallet SET balance = balance - ? WHERE id=1", (amount,))
                    # 2. 거래 기록 (Ledger)
                    self.cursor.execute('''INSERT INTO transaction_ledger (sender, receiver, amount, tx_type, status)
                                           VALUES (?, ?, ?, ?, ?)''', ('Company_Main', emp_name, amount, 'SALARY', 'SUCCESS'))
                    self.conn.commit()
                    return True
                else:
                    # 잔액 부족 기록
                    self.cursor.execute('''INSERT INTO transaction_ledger (sender, receiver, amount, tx_type, status)
                                           VALUES (?, ?, ?, ?, ?)''', ('Company_Main', emp_name, amount, 'SALARY', 'FAILED'))
                    self.conn.commit()
                    return False

            def get_employees_df(self):
                return pd.read_sql("SELECT * FROM employees", self.conn)

            def get_ledger_df(self):
                return pd.read_sql("SELECT * FROM transaction_ledger", self.conn)

        # ==========================================
        # 3. Master Workflow Engine
        # ==========================================
        class SecurePayrollWorkflow:
            def __init__(self):
                self.sec_mgr = SecurityManager()
                self.db = BankingDBManager(self.sec_mgr)
                self.db.initialize_system()
                
                self.current_month = datetime.now().strftime('%Y-%m')
                self.output_dir = f"Secure_Result_{self.current_month}"
                if not os.path.exists(self.output_dir): os.makedirs(self.output_dir)
                self._setup_fonts()

            def _setup_fonts(self):
                # 한글 폰트 자동 설정
                self.font_name = 'NanumGothic'
                font_file = 'NanumGothic.ttf'
                if not os.path.exists(font_file):
                    url = "https://github.com/google/fonts/raw/main/ofl/nanumgothic/NanumGothic-Regular.ttf"
                    urllib.request.urlretrieve(url, font_file)
                try: pdfmetrics.registerFont(TTFont(self.font_name, font_file))
                except: self.font_name = 'Helvetica'
                try:
                    fe = fm.FontEntry(fname=font_file, name=self.font_name)
                    fm.fontManager.ttflist.insert(0, fe)
                    plt.rc('font', family=self.font_name)
                except: pass

            def run_payroll_process(self):
                print(">> [Process] 1. 데이터 복호화 및 급여 계산 시작")
                df = self.db.get_employees_df()
                
                # 시뮬레이션: 야근 수당
                np.random.seed(42)
                df['overtime_pay'] = np.random.randint(0, 5, size=len(df)) * 150000
                
                # 계산 로직
                df['taxable'] = df['base_pay'] + df['overtime_pay'] - 200000
                df['deductions'] = (df['taxable'] * 0.18).astype(int) # 약식 공제율
                df['net_pay'] = (df['base_pay'] + df['overtime_pay']) - df['deductions']
                
                print(">> [Banking] 2. 급여 이체 시뮬레이션 시작 (Company -> Employee)")
                results = []
                for idx, row in df.iterrows():
                    # 이체 실행
                    is_success = self.db.execute_transfer(row['name'], int(row['net_pay']))
                    status = "이체성공" if is_success else "잔액부족"
                    results.append(status)
                    
                    # 보안: 복호화된 생년월일 가져오기 (비밀번호용)
                    decrypted_birth = self.sec_mgr.decrypt_data(row['enc_birth_date'])
                    
                    # PDF 생성
                    if is_success:
                        self.generate_secure_pdf(row, decrypted_birth)
                
                df['status'] = results
                
                # 결과 리포트
                print(">> [Report] 3. 최종 결과 생성")
                df_display = df[['emp_id', 'name', 'net_pay', 'status']].copy()
                print(tabulate(df_display, headers='keys', tablefmt='psql'))
                
                # 원장(Ledger) 저장
                ledger = self.db.get_ledger_df()
                ledger.to_excel(f"{self.output_dir}/Transaction_Ledger.xlsx", index=False)
                df.to_excel(f"{self.output_dir}/Payroll_Final.xlsx", index=False)
                
                final_balance = self.db.get_company_balance()
                print(f">> [System] 법인 계좌 잔액: {final_balance:,} KRW")

            def generate_secure_pdf(self, row, password):
                fname = f"{self.output_dir}/SecureSlip_{row['emp_id']}.pdf"
                # PDF 암호화 설정
                enc = StandardEncryption(password, canPrint=1, canCopy=0)
                c = canvas.Canvas(fname, pagesize=A4, encrypt=enc)
                
                c.setFont(self.font_name, 14)
                c.drawString(50, 800, f"SECURE PAYROLL SLIP: {row['name']}")
                c.setFont(self.font_name, 10)
                c.drawString(50, 770, f"Account: ****-**** (Encrypted)")
                c.drawString(50, 750, f"Net Pay: {row['net_pay']:,} KRW")
                c.drawString(50, 50, "Generated by Secure Payroll Automation System")
                c.save()

        if __name__ == "__main__":
            system = SecurePayrollWorkflow()
            system.run_payroll_process()
        EOF

    # 5. 스크립트 실행
    - name: Run Secure Payroll
      run: python payroll_pro.py

    # 6. 결과물 업로드
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Secure-Payroll-Result-${{ github.run_id }}
        path: Secure_Result_*/
        retention-days: 30
