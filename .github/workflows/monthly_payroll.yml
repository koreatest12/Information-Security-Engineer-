name: Enterprise Payroll Simulation (Multi-Company & Ledger)

on:
  schedule:
    - cron: '0 9 11,21 * *' # 매월 11일, 21일에 자동 실행 (시뮬레이션용)
  workflow_dispatch:        # 수동 실행

jobs:
  run-enterprise-payroll:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas matplotlib reportlab openpyxl numpy cryptography tabulate

    - name: Generate Enterprise Simulation Script
      run: |
        cat << 'EOF' > payroll_enterprise.py
        import sqlite3
        import pandas as pd
        import os
        import urllib.request
        import numpy as np
        import hashlib
        from datetime import datetime, date
        from cryptography.fernet import Fernet
        from tabulate import tabulate

        # 시각화 & PDF
        import matplotlib.pyplot as plt
        import matplotlib.font_manager as fm
        from reportlab.pdfgen import canvas
        from reportlab.lib.pagesizes import A4
        from reportlab.pdfbase import pdfmetrics
        from reportlab.pdfbase.ttfonts import TTFont
        from reportlab.lib.pdfencrypt import StandardEncryption

        # 상수 정의
        MIN_WAGE_2025 = 10030  # 2025년 예상 최저시급
        MIN_MONTHLY_PAY = MIN_WAGE_2025 * 209 # 약 2,096,270원

        # ==========================================
        # 1. 보안 모듈 (AES-256 Encryption)
        # ==========================================
        class SecurityManager:
            def __init__(self):
                # 실무에선 키 관리 시스템(KMS) 사용 권장
                self.key = Fernet.generate_key()
                self.cipher = Fernet(self.key)

            def encrypt(self, text):
                return self.cipher.encrypt(str(text).encode()).decode()

            def decrypt(self, text):
                return self.cipher.decrypt(str(text).encode()).decode()
            
            def generate_hash(self, data_str):
                """무결성 검증용 해시 생성"""
                return hashlib.sha256(data_str.encode()).hexdigest()

        # ==========================================
        # 2. ERP DB 매니저 (거래 원장 포함)
        # ==========================================
        class ERPDatabase:
            def __init__(self, sec_mgr, db_name="erp_system.db"):
                self.sec = sec_mgr
                self.conn = sqlite3.connect(db_name)
                self.cursor = self.conn.cursor()

            def initialize_schema(self):
                # 1) 기업 정보 (급여일 구분)
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS companies (
                    comp_id INTEGER PRIMARY KEY,
                    comp_name TEXT,
                    pay_day INTEGER,  -- 11 or 21
                    balance INTEGER
                )''')

                # 2) 사원 정보 (민감정보 암호화)
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS employees (
                    emp_id TEXT PRIMARY KEY,
                    comp_id INTEGER,
                    name TEXT,
                    enc_birth TEXT,    -- 암호화
                    base_pay INTEGER,
                    enc_account TEXT,  -- 암호화
                    FOREIGN KEY(comp_id) REFERENCES companies(comp_id)
                )''')

                # 3) 거래 원장 (Transaction Ledger) - 핵심 기능
                self.cursor.execute('''CREATE TABLE IF NOT EXISTS general_ledger (
                    tx_id INTEGER PRIMARY KEY AUTOINCREMENT,
                    tx_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    comp_name TEXT,
                    tx_type TEXT,      -- DEPOSIT(입금) / WITHDRAW(출금/급여지급)
                    counterparty TEXT, -- 거래 대상 (사원명 등)
                    amount INTEGER,
                    balance_after INTEGER,
                    tx_hash TEXT       -- 위변조 방지 해시
                )''')

                # 초기 데이터 세팅 (회사)
                companies = [
                    (1, 'Tech Corp (대기업)', 11, 10000000000), # 100억, 11일 급여
                    (2, 'Retail Inc (서비스)', 21, 2000000000)  # 20억, 21일 급여
                ]
                self.cursor.executemany('INSERT OR IGNORE INTO companies VALUES (?,?,?,?)', companies)
                
                # 초기 데이터 세팅 (사원 - 암호화 적용)
                # Tech Corp (고액연봉), Retail Inc (최저임금)
                raw_employees = [
                    # ID, CompID, Name, Birth, Pay, Account
                    ('T001', 1, 'Kim Dev', '900101', 6500000, '111-222-333'),
                    ('T002', 1, 'Lee Ops', '920505', 5800000, '444-555-666'),
                    ('R001', 2, 'Park Staff', '000101', MIN_MONTHLY_PAY, '777-888-999'), # 최저임금
                    ('R002', 2, 'Choi Part', '010303', MIN_MONTHLY_PAY, '123-456-789')   # 최저임금
                ]
                
                for row in raw_employees:
                    enc_birth = self.sec.encrypt(row[3])
                    enc_acct = self.sec.encrypt(row[5])
                    self.cursor.execute('INSERT OR IGNORE INTO employees VALUES (?,?,?,?,?,?)', 
                        (row[0], row[1], row[2], enc_birth, row[4], enc_acct))
                
                self.conn.commit()
                print(">> [System] ERP DB 스키마 초기화 및 암호화 데이터 로드 완료.")

            def record_transaction(self, comp_id, comp_name, tx_type, counterparty, amount):
                """원장 기록 및 잔액 업데이트 (트랜잭션)"""
                # 현재 잔액 조회
                self.cursor.execute("SELECT balance FROM companies WHERE comp_id=?", (comp_id,))
                current_bal = self.cursor.fetchone()[0]
                
                if tx_type == 'WITHDRAW' and current_bal < amount:
                    return False, "잔액 부족"
                
                # 잔액 변경
                new_bal = current_bal - amount if tx_type == 'WITHDRAW' else current_bal + amount
                self.cursor.execute("UPDATE companies SET balance=? WHERE comp_id=?", (new_bal, comp_id))
                
                # 원장 기록 (해시 포함)
                raw_str = f"{comp_name}{tx_type}{counterparty}{amount}{datetime.now()}"
                tx_hash = self.sec.generate_hash(raw_str)
                
                self.cursor.execute('''
                    INSERT INTO general_ledger (comp_name, tx_type, counterparty, amount, balance_after, tx_hash)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', (comp_name, tx_type, counterparty, amount, new_bal, tx_hash))
                
                self.conn.commit()
                return True, new_bal

            def get_payday_employees(self, day):
                """특정 급여일에 해당하는 회사와 사원 조회"""
                query = '''
                    SELECT e.emp_id, e.name, e.enc_birth, e.base_pay, c.comp_id, c.comp_name 
                    FROM employees e
                    JOIN companies c ON e.comp_id = c.comp_id
                    WHERE c.pay_day = ?
                '''
                return pd.read_sql(query, self.conn, params=(day,))

        # ==========================================
        # 3. 시뮬레이션 엔진
        # ==========================================
        class PayrollSimulator:
            def __init__(self):
                self.sec = SecurityManager()
                self.db = ERPDatabase(self.sec)
                self.db.initialize_schema()
                
                self.current_month = datetime.now().strftime('%Y-%m')
                self.output_dir = f"Simulation_{self.current_month}"
                if not os.path.exists(self.output_dir): os.makedirs(self.output_dir)
                self._setup_fonts()

            def _setup_fonts(self):
                self.font_name = 'NanumGothic'
                font_file = 'NanumGothic.ttf'
                if not os.path.exists(font_file):
                    urllib.request.urlretrieve("https://github.com/google/fonts/raw/main/ofl/nanumgothic/NanumGothic-Regular.ttf", font_file)
                try: pdfmetrics.registerFont(TTFont(self.font_name, font_file))
                except: self.font_name = 'Helvetica'

            def run_simulation(self):
                # 시뮬레이션할 날짜: 11일(대기업)과 21일(중소기업) 모두 실행
                target_days = [11, 21]
                
                print(f"[{datetime.now()}] 급여 입출금 시뮬레이션 시작...")
                
                all_results = []

                for day in target_days:
                    print(f"\n>> [Scenario] {day}일 급여 지급 시뮬레이션 가동")
                    df = self.db.get_payday_employees(day)
                    
                    if df.empty:
                        print(f"   - {day}일에 지급할 대상이 없습니다.")
                        continue
                        
                    for _, row in df.iterrows():
                        # 급여 계산 (최저임금 체크)
                        base_pay = row['base_pay']
                        is_min_wage = base_pay <= MIN_MONTHLY_PAY + 1000 # 오차범위
                        
                        # 공제 계산
                        deduct = int(base_pay * 0.15) # 약식 공제
                        net_pay = base_pay - deduct
                        
                        # 법인 계좌 출금 시뮬레이션
                        success, msg = self.db.record_transaction(
                            row['comp_id'], row['comp_name'], 'WITHDRAW', 
                            f"{row['name']} (Salary)", net_pay
                        )
                        
                        status = "지급성공" if success else f"실패({msg})"
                        note = "최저임금적용" if is_min_wage else "일반급여"
                        
                        all_results.append([
                            day, row['comp_name'], row['name'], note, 
                            f"{net_pay:,}", status
                        ])
                        
                        if success:
                            # 복호화 후 PDF 생성
                            real_birth = self.sec.decrypt(row['enc_birth'])
                            self.generate_secure_pdf(row, net_pay, real_birth, day)

                # 최종 리포트 출력
                print("\n>> [Final Report] 급여 지급 결과 원장")
                headers = ["PayDay", "Company", "Employee", "Type", "Net Pay", "Status"]
                print(tabulate(all_results, headers=headers, tablefmt="psql"))
                
                # 원장 엑셀 저장
                ledger_df = pd.read_sql("SELECT * FROM general_ledger", self.db.conn)
                ledger_df.to_excel(f"{self.output_dir}/Full_Transaction_Ledger.xlsx", index=False)
                print(f">> 거래 원장 파일 저장 완료: {self.output_dir}/Full_Transaction_Ledger.xlsx")

            def generate_secure_pdf(self, row, net_pay, password, day):
                fname = f"{self.output_dir}/{day}th_{row['name']}_Slip.pdf"
                enc = StandardEncryption(password, canPrint=1, canCopy=0)
                c = canvas.Canvas(fname, pagesize=A4, encrypt=enc)
                
                c.setFont(self.font_name, 16)
                c.drawString(50, 800, f"[{row['comp_name']}] 급여 명세서")
                c.setFont(self.font_name, 10)
                c.drawString(50, 770, f"지급일: {self.current_month}-{day}")
                c.drawString(50, 750, f"성명: {row['name']}")
                c.drawString(50, 730, f"실수령액: {net_pay:,} 원")
                c.drawString(50, 50, "※ 본 문서는 암호화 처리되었습니다.")
                c.save()

        if __name__ == "__main__":
            sim = PayrollSimulator()
            sim.run_simulation()
        EOF

    - name: Run Simulation
      run: python payroll_enterprise.py

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Enterprise-Payroll-Ledger-${{ github.run_id }}
        path: Simulation_*/
        retention-days: 30
