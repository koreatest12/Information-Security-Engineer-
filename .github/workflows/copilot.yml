name: ğŸŒŒ Grand Ops Universe v24 (Release, Pkg & Omni-News)

on:
  schedule:
    - cron: '*/30 * * * *' # 30ë¶„ ì£¼ê¸° (ë‰´ìŠ¤ ë° ë¦´ë¦¬ì¦ˆ ì²´í¬)
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub Release?'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_universe.db'
  DASHBOARD_FILE: 'data/universe_dashboard.md'
  RELEASE_DIR: 'dist'
  ARTIFACT_PASSWORD: ${{ secrets.ARTIFACT_KEY || 'Universe_Secret_2025' }}

permissions:
  contents: write

jobs:
  universe-engine:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Initialize Universe Stack
        run: |
          echo "ğŸŒŒ Booting Grand Ops Universe..."
          mkdir -p data backup scripts dist
          python -m pip install --upgrade pip
          # [í•µì‹¬] feedparser(ë‰´ìŠ¤), psutil(ì‹œìŠ¤í…œ), requests(API)
          echo -e "requests\npandas\nnumpy\nscikit-learn\ntabulate\npsutil\nfeedparser" > requirements.txt
          pip install -r requirements.txt

      # [Core] ë¦´ë¦¬ì¦ˆ, íŒ¨í‚¤ì§•, ë‰´ìŠ¤, ê´€ì œê°€ í†µí•©ëœ ì´ˆê±°ëŒ€ ìŠ¤í¬ë¦½íŠ¸
      - name: ğŸ§  Generate Universe Script
        run: |
          cat <<'EOF' > scripts/universe_core.py
          import sqlite3
          import os
          import datetime
          import requests
          import psutil
          import feedparser
          import shutil
          import tarfile
          import pandas as pd
          from sklearn.ensemble import IsolationForest

          # í™˜ê²½ ì„¤ì •
          DB_PATH = os.getenv('DB_PATH', 'data/grand_ops_universe.db')
          DASH_PATH = os.getenv('DASHBOARD_FILE', 'data/universe_dashboard.md')
          RELEASE_DIR = os.getenv('RELEASE_DIR', 'dist')
          
          class ReleaseManager:
              """ğŸš€ ì†Œí”„íŠ¸ì›¨ì–´ ë¦´ë¦¬ì¦ˆ ë° íŒ¨í‚¤ì§€ ë¹Œë“œ ì‹œìŠ¤í…œ"""
              def __init__(self, conn):
                  self.conn = conn
                  self.version = datetime.datetime.now().strftime("v%Y.%m.%d.%H%M")
                  
              def build_package(self):
                  """ë°ì´í„° ë° ë¡œê·¸ë¥¼ íŒ¨í‚¤ì§•í•˜ì—¬ ë°°í¬ íŒŒì¼ ìƒì„± (.tar.gz)"""
                  try:
                      if not os.path.exists(RELEASE_DIR): os.makedirs(RELEASE_DIR)
                      
                      pkg_name = f"grand-ops-core-{self.version}.tar.gz"
                      pkg_path = os.path.join(RELEASE_DIR, pkg_name)
                      
                      # data í´ë”ë¥¼ ì••ì¶• (íŒ¨í‚¤ì§•)
                      with tarfile.open(pkg_path, "w:gz") as tar:
                          tar.add("data", arcname=os.path.basename("data"))
                      
                      return self.version, pkg_name, os.path.getsize(pkg_path) / 1024 # KB size
                  except Exception as e:
                      print(f"âš ï¸ Packaging Error: {e}")
                      return self.version, "Error", 0

              def generate_notes(self):
                  """ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìë™ ìƒì„±"""
                  notes_path = os.path.join(RELEASE_DIR, "RELEASE_NOTES.md")
                  with open(notes_path, "w") as f:
                      f.write(f"# ğŸš€ Release Notes - {self.version}\n\n")
                      f.write("## ğŸ“¦ What's New\n")
                      f.write("- Automated Package Build complete.\n")
                      f.write("- Latest AI Intelligence data included.\n")
                      f.write("- Security Audit logs synced.\n")
                  return notes_path

          class NewsBroadcaster:
              """ğŸ“° ë‹¤ë¶„ì•¼(ì •ì¹˜, ì—°ì˜ˆ, ë‚ ì”¨, IT) ë‰´ìŠ¤ ìˆ˜ì§‘ê¸°"""
              def __init__(self):
                  self.feeds = {
                      "ğŸ¤– AI & Tech": "https://techcrunch.com/category/artificial-intelligence/feed/",
                      "ğŸ›ï¸ Politics": "http://feeds.bbci.co.uk/news/politics/rss.xml",
                      "ğŸ¬ Entertainment": "https://www.eonline.com/news/rss.xml",
                      "ğŸŒªï¸ Weather News": "https://www.sciencedaily.com/rss/earth_climate/weather.xml"
                  }

              def fetch_all(self):
                  news_board = {}
                  for category, url in self.feeds.items():
                      try:
                          feed = feedparser.parse(url)
                          items = []
                          for entry in feed.entries[:3]: # ì¹´í…Œê³ ë¦¬ë³„ ìƒìœ„ 3ê°œ
                              items.append(f"[{entry.title}]({entry.link})")
                          news_board[category] = items
                      except:
                          news_board[category] = ["Unavailable"]
                  return news_board

          class SystemMonitor:
              @staticmethod
              def get_stats():
                  return psutil.cpu_percent(), psutil.virtual_memory().percent, psutil.disk_usage('/').percent

          class DashboardGenerator:
              def __init__(self):
                  pass

              def draw_gauge(self, val):
                  fill = int((val / 100) * 10)
                  return "â–ˆ" * fill + "â–‘" * (10 - fill)

              def generate(self, sys_stats, news_data, pkg_info):
                  cpu, ram, disk = sys_stats
                  ver, pkg_name, pkg_size = pkg_info
                  
                  with open(DASH_PATH, 'w', encoding='utf-8') as f:
                      f.write(f"# ğŸŒŒ Grand Ops Universe Dashboard\n")
                      f.write(f"> **System Time:** {datetime.datetime.now().strftime('%Y-%m-%d %H:%M')} | **Latest Version:** `{ver}`\n\n")

                      # 1. ë¦´ë¦¬ì¦ˆ & íŒ¨í‚¤ì§€ ì„¹ì…˜
                      f.write("### ğŸš€ Release & Package Status\n")
                      f.write(f"| Version | Package Name | Size | Status |\n|---|---|---|---|\n")
                      f.write(f"| **{ver}** | `{pkg_name}` | {pkg_size:.2f} KB | ğŸŸ¢ **Built & Ready** |\n\n")

                      # 2. ì‹œìŠ¤í…œ ìƒíƒœ
                      f.write("### ğŸ–¥ï¸ Infrastructure Health\n")
                      f.write(f"- **CPU:** `{self.draw_gauge(cpu)}` {cpu}%\n")
                      f.write(f"- **RAM:** `{self.draw_gauge(ram)}` {ram}%\n")
                      f.write(f"- **Disk:** `{self.draw_gauge(disk)}` {disk}%\n\n")

                      # 3. í†µí•© ë‰´ìŠ¤ë£¸
                      f.write("### ğŸ“° Global Newsroom (Live Feed)\n")
                      for cat, headlines in news_data.items():
                          f.write(f"#### {cat}\n")
                          for hl in headlines:
                              f.write(f"- {hl}\n")
                          f.write("\n")

                      f.write("---\n*Powered by Grand Ops Universe v24.0*")

          def main():
              if not os.path.exists("data"): os.makedirs("data")
              conn = sqlite3.connect(DB_PATH)
              
              # 1. ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§
              sys_mon = SystemMonitor()
              stats = sys_mon.get_stats()
              
              # 2. ë‰´ìŠ¤ ìˆ˜ì§‘ (ëŒ€ëŸ‰)
              print("ğŸ“¡ Fetching Global Feeds...")
              broadcaster = NewsBroadcaster()
              news = broadcaster.fetch_all()
              
              # 3. ë¦´ë¦¬ì¦ˆ ë° íŒ¨í‚¤ì§• ìˆ˜í–‰
              print("ğŸ“¦ Building Software Package...")
              release_mgr = ReleaseManager(conn)
              pkg_info = release_mgr.build_package() # (ver, name, size)
              release_mgr.generate_notes()
              
              # 4. ëŒ€ì‹œë³´ë“œ ìƒì„±
              dash = DashboardGenerator()
              dash.generate(stats, news, pkg_info)
              
              conn.close()
              print("âœ… Universe Tasks Completed.")

          if __name__ == "__main__":
              main()
          EOF

      - name: ğŸš€ Run Universe Engine
        run: python scripts/universe_core.py

      # GitHub Actions ìš”ì•½ í™”ë©´ì— ëŒ€ì‹œë³´ë“œ ì¶œë ¥
      - name: ğŸ“¢ Publish Universe Dashboard
        run: cat "$DASHBOARD_FILE" >> $GITHUB_STEP_SUMMARY

      # [NEW] ë¦´ë¦¬ì¦ˆ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ (Artifact)
      - name: ğŸ“¦ Upload Release Package
        uses: actions/upload-artifact@v4
        with:
          name: grand-ops-release-package
          path: dist/*
          retention-days: 3

      # [NEW] GitHub Release ìë™ ìƒì„± (ì¡°ê±´ë¶€)
      - name: ğŸš€ Create GitHub Release
        if: github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.tar.gz
          body_path: dist/RELEASE_NOTES.md
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”’ Encrypt & Backup
        run: |
          zip -e -P "$ARTIFACT_PASSWORD" universe_backup.zip data/*.md data/*.db dist/*
      
      - name: Upload Secured Backup
        uses: actions/upload-artifact@v4
        with:
          name: Universe-Secure-Backup
          path: universe_backup.zip

      - name: ğŸ”„ Sync Universe
        run: |
          git config --global user.name "Universe-Bot"
          git config --global user.email "bot@grand-ops.ai"
          git config --global --add safe.directory $GITHUB_WORKSPACE
          
          [ -f "$DASHBOARD_FILE" ] && git add -f "$DASHBOARD_FILE"
          [ -f "$DB_PATH" ] && git add -f "$DB_PATH"
          git add -A
          
          if [ -z "$(git status --porcelain)" ]; then exit 0; fi
          git commit -m "universe: release build & omni-news update [skip ci]"
          git push origin main || echo "Sync skipped"
