name: ğŸ” Grand Ops Master Pipeline v12 (Schema Fix & Defense)

on:
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ ì£¼ê¸° (ë¹ ë¥¸ ë³µêµ¬)
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_secure.db'
  BACKUP_DIR: 'backup'
  CONFIG_DIR: 'config'
  ARTIFACT_PASSWORD: ${{ secrets.ARTIFACT_KEY || 'GrandOpsSecure2025!' }} # ë‹¤ìš´ë¡œë“œ ë°©ì§€ìš© ì•”í˜¸

permissions:
  contents: write

jobs:
  # 1. ì¸í”„ë¼ ì¤€ë¹„ ë° ì—”ì§„ ì²´í¬
  infra-setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ› ï¸ Initialize System Hierarchy
        run: |
          echo "ğŸ“‚ Verifying Directory Structure..."
          mkdir -p data
          mkdir -p backup
          mkdir -p config
          mkdir -p scripts
          echo "âœ… Directories Ready."

      - name: ğŸ”„ Environment Upgrade
        run: |
          sudo apt-get update && sudo apt-get install -y sqlite3 zip
          python -m pip install --upgrade pip
          # í•„ìš”í•œ ì˜ì¡´ì„± íŒŒì¼ ê°•ì œ ìƒì„±
          if [ ! -f requirements.txt ]; then
            echo "requests" > requirements.txt
            echo "bandit" >> requirements.txt
          fi
          pip install -r requirements.txt

  # 2. DB ë°©ì–´, ìŠ¤í‚¤ë§ˆ ë³µêµ¬ ë° ë°ì´í„° ê´€ë¦¬ (í•µì‹¬ ìˆ˜ì • íŒŒíŠ¸)
  db-defense-ops:
    needs: infra-setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ©º Auto-Heal DB Schema (Fix 'No Such Table')
        run: |
          echo "ğŸ›¡ï¸ Activating DB Defense Systems..."
          
          # [ì¤‘ìš”] ë””ë ‰í† ë¦¬ ë‹¤ì‹œ í™•ì¸ (Job ë¶„ë¦¬ë¡œ ì¸í•œ ì†ì‹¤ ë°©ì§€)
          mkdir -p $(dirname "$DB_PATH")
          
          # 1. DB ì—°ê²° í…ŒìŠ¤íŠ¸ ë° ìŠ¤í‚¤ë§ˆ ê°•ì œ ì ìš© (Migration)
          # íŒŒì¼ì´ ìˆë“  ì—†ë“  ë¬´ì¡°ê±´ í…Œì´ë¸” ìƒì„± ì‹œë„ (IF NOT EXISTS)
          sqlite3 "$DB_PATH" "CREATE TABLE IF NOT EXISTS access_log (id INTEGER PRIMARY KEY, timestamp DATETIME DEFAULT CURRENT_TIMESTAMP, action TEXT, risk_level TEXT);"
          sqlite3 "$DB_PATH" "CREATE TABLE IF NOT EXISTS security_events (id INTEGER PRIMARY KEY, event_type TEXT, description TEXT);"
          
          echo "âœ… Schema Migration Completed."

      - name: ğŸ“ Execute DB Operations
        run: |
          # 2. ë°ì´í„° ì‚½ì… (ì´ì œ í…Œì´ë¸”ì´ í™•ì‹¤íˆ ìˆìœ¼ë¯€ë¡œ ì—ëŸ¬ ì•ˆ ë‚¨)
          echo "ğŸ’¾ Injecting Audit Log..."
          sqlite3 "$DB_PATH" "INSERT INTO access_log (action, risk_level) VALUES ('Pipeline Execution Check', 'LOW');"
          
          # 3. ë¬´ê²°ì„± ê²€ì¦
          sqlite3 "$DB_PATH" "PRAGMA integrity_check;"
          
          # 4. ë°ì´í„° í™•ì¸ (ë¡œê·¸ ì¶œë ¥)
          echo "ğŸ“Š Current Log Count:"
          sqlite3 "$DB_PATH" "SELECT count(*) FROM access_log;"

      - name: ğŸ“¦ Secure Encrypted Backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mkdir -p "$BACKUP_DIR"
          
          # ë°±ì—…ë³¸ ìƒì„±
          cp "$DB_PATH" "$BACKUP_DIR/db_$TIMESTAMP.bak"
          
          # [ë³´ì•ˆ] ì™¸ë¶€ ìœ ì¶œ ë°©ì§€: ì•”í˜¸í™” ì••ì¶• (ë¹„ë°€ë²ˆí˜¸ ëª¨ë¥´ë©´ ì••ì¶• í•´ì œ ë¶ˆê°€)
          echo "ğŸ”’ Encrypting Backup Artifact..."
          zip -e -P "$ARTIFACT_PASSWORD" secure_db_package.zip "$DB_PATH" "$BACKUP_DIR"/*
          
          # ì˜¤ë˜ëœ ë¡œì»¬ ë°±ì—… ì •ë¦¬
          cd "$BACKUP_DIR" && ls -t *.bak | tail -n +6 | xargs -r rm --

      - name: Upload Secured Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: encrypted-db-storage
          path: secure_db_package.zip
          retention-days: 1 # ë³´ì•ˆì„ ìœ„í•´ ì§§ê²Œ ìœ ì§€

  # 3. ë³€ê²½ ì‚¬í•­ ê°•ì œ ë™ê¸°í™” (Force Sync)
  sync-and-commit:
    needs: db-defense-ops
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸš€ Run Force Sync Engine
        run: |
          # Git ì„¤ì •
          git config --global user.name "DB-Master-Bot"
          git config --global user.email "bot@grand-ops.internal"
          git config --global --add safe.directory $GITHUB_WORKSPACE

          echo "ğŸ“¦ Staging Artifacts..."
          # [Fix] .gitignore ë¬´ì‹œí•˜ê³  ê°•ì œë¡œ íŒŒì¼ ë‹´ê¸°
          git add -f data/*.db
          git add -f data/*.sql
          git add -f config/*.json
          git add -A

          if [ -z "$(git status --porcelain)" ]; then
             echo "âœ… No changes needed."
             exit 0
          fi

          echo "ğŸ’¾ Committing..."
          git commit -m "ops: schema auto-heal & sync [skip ci]"

          # [Retry Loop] ì¶©ëŒ ìë™ í•´ê²° ë° í‘¸ì‹œ
          MAX_RETRIES=5
          COUNT=0
          SUCCESS=false

          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ Sync Attempt $((COUNT+1))..."
            
            # Pull Rebase (ì›ê²© ë³€ê²½ì‚¬í•­ ìš°ì„  ë°˜ì˜)
            git pull --rebase origin main || {
              echo "âš ï¸ Conflict detected. Retrying rebase..."
              git rebase --abort || true
            }

            if git push origin main; then
              echo "ğŸš€ Push Successful!"
              SUCCESS=true
              break
            fi
            
            sleep 5
            COUNT=$((COUNT+1))
          done

          if [ "$SUCCESS" = false ]; then
            echo "âŒ Push Failed."
            exit 1
          fi
