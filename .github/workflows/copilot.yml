name: ğŸ” Grand Ops Universal Manager v13 (Script Factory & Auto-Fix)

on:
  schedule:
    - cron: '*/5 * * * *' # 5ë¶„ ì£¼ê¸°
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_secure.db'
  SCHEMA_PATH: 'data/schema_snapshot.sql'
  BACKUP_DIR: 'backup'
  ARTIFACT_PASSWORD: ${{ secrets.ARTIFACT_KEY || 'UltraSecure2025!' }}

permissions:
  contents: write

jobs:
  # í†µí•© ìš´ì˜ ê´€ë¦¬ (ë‹¨ì¼ Jobìœ¼ë¡œ ì˜ì¡´ì„± ë¬¸ì œ í•´ê²°)
  universal-ops-manager:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. í™˜ê²½ ì´ˆê¸°í™” ë° ë””ë ‰í† ë¦¬ ë°©ì–´
      - name: ğŸ› ï¸ Initialize Infrastructure
        run: |
          echo "ğŸ—ï¸ Setting up Ops Environment..."
          mkdir -p data backup config scripts
          
          # íŒŒì´ì¬ ì˜ì¡´ì„± ì„¤ì¹˜
          python -m pip install --upgrade pip
          if [ ! -f requirements.txt ]; then
             echo "requests" > requirements.txt
          fi
          pip install -r requirements.txt

      # 2. [í•µì‹¬] Python ìš´ì˜ ìŠ¤í¬ë¦½íŠ¸ ë™ì  ìƒì„± (Script Factory)
      # ì´ ë‹¨ê³„ê°€ íŒŒì¼ ìƒì„±ì„ ë³´ì¥í•˜ì—¬ 'No such file' ì—ëŸ¬ë¥¼ í•´ê²°í•¨
      - name: ğŸ­ Generate Ops Manager Script
        run: |
          cat <<EOF > scripts/grand_ops_manager.py
          import sqlite3
          import os
          import datetime

          DB_PATH = "${{ env.DB_PATH }}"
          SCHEMA_PATH = "${{ env.SCHEMA_PATH }}"

          def init_and_manage_db():
              print(f"ğŸ”§ Connecting to DB: {DB_PATH}")
              conn = sqlite3.connect(DB_PATH)
              cursor = conn.cursor()
              
              # í…Œì´ë¸” ê°•ì œ ìƒì„± (Schema Migration)
              cursor.execute('''
                  CREATE TABLE IF NOT EXISTS service_health (
                      id INTEGER PRIMARY KEY AUTOINCREMENT,
                      service_name TEXT,
                      status TEXT,
                      checked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                  )
              ''')
              cursor.execute('''
                  CREATE TABLE IF NOT EXISTS access_log (
                      id INTEGER PRIMARY KEY AUTOINCREMENT,
                      action TEXT,
                      risk_level TEXT,
                      timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                  )
              ''')
              
              # ìƒíƒœ ì ê²€ ë°ì´í„° ì£¼ì… (Health Check)
              cursor.execute("INSERT INTO service_health (service_name, status) VALUES ('Auth_Server', 'ACTIVE')")
              cursor.execute("INSERT INTO service_health (service_name, status) VALUES ('DB_Engine', 'OPTIMIZED')")
              cursor.execute("INSERT INTO access_log (action, risk_level) VALUES ('Routine Ops Check', 'SAFE')")
              
              conn.commit()
              print("âœ… DB Data Injected.")
              
              # [ì¤‘ìš”] ìŠ¤í‚¤ë§ˆ ìŠ¤ëƒ…ìƒ· ìƒì„± (git add ì—ëŸ¬ ë°©ì§€ìš©)
              with open(SCHEMA_PATH, 'w', encoding='utf-8') as f:
                  for line in conn.iterdump():
                      f.write('%s\n' % line)
              print(f"ğŸ“„ Schema Snapshot Saved: {SCHEMA_PATH}")
              
              conn.close()

          if __name__ == "__main__":
              # í´ë”ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ë‚˜ë¯€ë¡œ ìƒì„± í™•ì¸
              if not os.path.exists("data"):
                  os.makedirs("data")
              init_and_manage_db()
          EOF
          
          echo "âœ¨ Script Generated: scripts/grand_ops_manager.py"

      # 3. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (DB ë° íŒŒì¼ ì‹¤ì œ ìƒì„±)
      - name: ğŸš€ Run Ops Manager
        run: |
          python scripts/grand_ops_manager.py
          
          # ìƒì„± í™•ì¸
          ls -l data/

      # 4. ë³´ì•ˆ ë°±ì—… ë° ì•”í˜¸í™” (ë‹¤ìš´ë¡œë“œ ë°©ì§€)
      - name: ğŸ”’ Secure Backup & Encrypt
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          cp "$DB_PATH" "$BACKUP_DIR/db_$TIMESTAMP.bak"
          
          echo "ğŸ” Encrypting Artifacts..."
          # ì•”í˜¸ê°€ ê±¸ë¦° Zip íŒŒì¼ ìƒì„±
          zip -e -P "$ARTIFACT_PASSWORD" secure_ops_package.zip data/* config/* backup/*
          
          # ë°±ì—… ì •ë¦¬
          cd "$BACKUP_DIR" && ls -t *.bak | tail -n +6 | xargs -r rm --

      - name: Upload Secured Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: secure-ops-data
          path: secure_ops_package.zip
          retention-days: 1

      # 5. [ìˆ˜ì •ë¨] ì•ˆì „í•œ ë™ê¸°í™” (Safe Sync Engine)
      - name: ğŸ”„ Safe Git Sync
        run: |
          git config --global user.name "DB-Master-Bot"
          git config --global user.email "bot@grand-ops.internal"
          git config --global --add safe.directory $GITHUB_WORKSPACE

          echo "ğŸ“¦ Staging Files..."
          
          # [Fix] ë¬´ì¡°ê±´ add í•˜ì§€ ì•Šê³ , íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ add (ì—ëŸ¬ ë°©ì§€)
          if [ -f "data/schema_snapshot.sql" ]; then
            git add -f data/schema_snapshot.sql
          else
            echo "âš ï¸ Warning: Schema file not found, skipping..."
          fi
          
          if [ -f "data/grand_ops_secure.db" ]; then
            git add -f data/grand_ops_secure.db
          fi

          # ë‚˜ë¨¸ì§€ íŒŒì¼ ì²˜ë¦¬
          git add -A

          # ë³€ê²½ì‚¬í•­ ì²´í¬
          if [ -z "$(git status --porcelain)" ]; then
             echo "âœ… No changes to commit."
             exit 0
          fi

          echo "ğŸ’¾ Committing..."
          git commit -m "ops: full-service reinforcement & sync [skip ci]"

          # Retry Loop for Push
          MAX_RETRIES=5
          COUNT=0
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ Sync Attempt $((COUNT+1))..."
            git pull --rebase origin main || git rebase --abort
            
            if git push origin main; then
              echo "ğŸš€ Push Successful!"
              exit 0
            fi
            sleep 5
            COUNT=$((COUNT+1))
          done
          
          echo "âŒ Push Failed after retries."
          exit 1
