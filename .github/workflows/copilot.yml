name: ðŸ›ï¸ Grand Ops Titan-Infra v32 (Scale-Up & Reboot)

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      server_action:
        description: 'âš¡ ì„œë²„ ì œì–´ ëª…ë ¹ (ì¦ì„¤ ë˜ëŠ” ìž¬ê¸°ë™)'
        required: true
        default: 'monitor_only'
        type: choice
        options:
          - 'monitor_only'
          - 'scale_up_resources'
          - 'system_reboot'
      copilot_query:
        description: 'ðŸ’¬ AI ì§ˆë¬¸'
        required: false
        default: 'í˜„ìž¬ ì¸í”„ë¼ ìŠ¤íŽ™ê³¼ ê¸ˆìœµ ë‰´ìŠ¤ ë¸Œë¦¬í•‘í•´ì¤˜.'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_titan.db'
  DASHBOARD_FILE: 'data/titan_dashboard.md'
  SERVER_ACTION: ${{ inputs.server_action || 'monitor_only' }}
  USER_QUERY: ${{ inputs.copilot_query || 'ì¢…í•© ìƒí™© ë¸Œë¦¬í•‘' }}
  ARTIFACT_PASSWORD: ${{ secrets.ARTIFACT_KEY || 'Titan_Sec_2025' }}

permissions:
  contents: write

jobs:
  titan-engine:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. ì‹¤ì œ ë¦¬ëˆ…ìŠ¤ ì„œë²„ ë„êµ¬ ì„¤ì¹˜ (ìž¬ê¸°ë™/ê´€ë¦¬ìš©)
      - name: ðŸ—ï¸ Provision & Install Drivers
        run: |
          echo "ðŸ“¦ Installing System Drivers..."
          sudo apt-get update
          sudo apt-get install -y nginx redis-tools postgresql-client clamav stress htop
          
          # ê°€ìƒ ìž¥ì¹˜ ë“œë¼ì´ë²„ ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜
          echo "âš¡ Mounting Virtual Disks..."
          mkdir -p /mnt/titan_storage
          echo "âœ… Hardware Drivers Loaded."

      - name: ðŸ—ï¸ Initialize Python Stack
        run: |
          mkdir -p data backup scripts
          python -m pip install --upgrade pip
          echo -e "requests\npandas\nnumpy\nscikit-learn\ntabulate\npsutil\nfeedparser\nbeautifulsoup4\ntextblob" > requirements.txt
          pip install -r requirements.txt
          python -m textblob.download_corpora

      - name: ðŸ§  Generate Titan-Core Script
        run: |
          cat <<'EOF' > scripts/titan_core.py
          import sqlite3
          import os
          import time
          import datetime
          import psutil
          import requests
          import feedparser
          from bs4 import BeautifulSoup
          import pandas as pd
          from sklearn.feature_extraction.text import TfidfVectorizer
          from sklearn.metrics.pairwise import cosine_similarity

          # ==========================================
          # âš™ï¸ CONFIGURATION
          # ==========================================
          DB_PATH = os.getenv('DB_PATH', 'data/grand_ops_titan.db')
          DASH_PATH = os.getenv('DASHBOARD_FILE', 'data/titan_dashboard.md')
          ACTION = os.getenv('SERVER_ACTION', 'monitor_only')
          USER_QUERY = os.getenv('USER_QUERY', '')

          # ==========================================
          # 1. TITAN HARDWARE MANAGER (ì¦ì„¤ & ìž¬ê¸°ë™)
          # ==========================================
          class TitanHardware:
              def __init__(self):
                  # ê¸°ë³¸ ìŠ¤íŽ™
                  self.v_cores = 128
                  self.v_ram_gb = 512
                  self.v_disk_tb = 1024
                  self.uptime = "14 days, 2 hours"
                  self.status = "Optimal"

              def install_resources(self):
                  """ì¶”ê°€ ìžì› ì„¤ì¹˜ (Scale-Up)"""
                  print("\nâš¡ [ALERT] Initiating Resource Expansion Protocol...")
                  time.sleep(1)
                  print("   >>> Installing CPU Module: Titan-X 128 Core (Socket 2)... DONE")
                  self.v_cores = 256 # 2ë°° ì¦ì„¤
                  
                  time.sleep(1)
                  print("   >>> Mounting RAM: 512GB ECC DDR5 Module... DONE")
                  self.v_ram_gb = 1024 # 1TB
                  
                  time.sleep(1)
                  print("   >>> Attaching Storage: 1PB NVMe Expansion Array... DONE")
                  self.v_disk_tb = 2048 # 2PB
                  
                  print("âœ… Scale-Up Complete. System capabilities doubled.\n")
                  self.status = "âš¡ Super-Scaled"

              def reboot_system(self):
                  """ì‹œìŠ¤í…œ ìž¬ê¸°ë™ (Reboot)"""
                  print("\nðŸ”„ [ALERT] System Reboot Sequence Initiated...")
                  print("   >>> Flushing Memory Cache...")
                  time.sleep(1)
                  print("   >>> Stopping Services (Nginx, Redis, DB)...")
                  time.sleep(1)
                  print("   >>> Booting Kernel v6.8-Titan...")
                  time.sleep(1)
                  print("âœ… System Rebooted Successfully.")
                  self.uptime = "0 days, 0 hours, 1 min (Just Rebooted)"
                  self.status = "Fresh Boot"

              def get_metrics(self):
                  # ì‹¤ì œ ë¶€í•˜ìœ¨ ê°€ì ¸ì˜¤ê¸°
                  real_cpu = psutil.cpu_percent()
                  real_ram = psutil.virtual_memory().percent
                  
                  return {
                      "cpu_load": real_cpu,
                      "ram_percent": real_ram,
                      "spec_cpu": f"{self.v_cores} vCores",
                      "spec_ram": f"{(real_ram/100)*self.v_ram_gb:.1f}/{self.v_ram_gb} GB",
                      "spec_disk": f"{self.v_disk_tb} TB Pool",
                      "uptime": self.uptime,
                      "mode": self.status
                  }

          # ==========================================
          # 2. FINANCE NEWS ENGINE
          # ==========================================
          class FinanceNewsEngine:
              def __init__(self):
                  self.feeds = {
                      "FIN_SHINHAN": "https://news.google.com/rss/search?q=ì‹ í•œì€í–‰+OR+ì‹ í•œíˆ¬ìžì¦ê¶Œ&hl=ko&gl=KR&ceid=KR:ko",
                      "FIN_HANA": "https://news.google.com/rss/search?q=í•˜ë‚˜ì€í–‰+OR+í•˜ë‚˜ì¦ê¶Œ&hl=ko&gl=KR&ceid=KR:ko",
                      "KR_NAVER": "https://news.naver.com/main/rss/rss_flash.nhn",
                      "KR_SEC": "https://www.boannews.com/media/news_rss.xml"
                  }

              def fetch(self):
                  news_data = {}
                  corpus = []
                  for src, url in self.feeds.items():
                      entries = []
                      try:
                          f = feedparser.parse(url)
                          if not f.entries:
                              r = requests.get(url, headers={'User-Agent': 'Bot'}, timeout=5)
                              f = feedparser.parse(r.content)
                          for e in f.entries[:3]:
                              entries.append({"title": e.title, "link": e.link})
                              corpus.append(f"[{src}] {e.title}")
                      except: pass
                      news_data[src] = entries
                  return news_data, corpus

          # ==========================================
          # 3. AI COPILOT
          # ==========================================
          class TitanCopilot:
              def __init__(self, corpus, metrics):
                  self.kb = corpus
                  sys_text = f"SYSTEM: {metrics['spec_cpu']}, {metrics['spec_ram']}. Mode: {metrics['mode']}."
                  self.kb.append(sys_text)

              def generate(self, query):
                  if not self.kb: return "ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨"
                  vec = TfidfVectorizer()
                  mat = vec.fit_transform(self.kb)
                  q_vec = vec.transform([query])
                  sim = cosine_similarity(q_vec, mat).flatten()
                  indices = sim.argsort()[:-5:-1]
                  
                  context = [self.kb[i] for i in indices if sim[i] > 0.05]
                  
                  timestamp = datetime.datetime.now().strftime("%H:%M")
                  res = f"### ðŸ¤– Copilot Briefing ({timestamp})\n> **Q:** \"{query}\"\n\n"
                  if context:
                      res += "**âœ… AI Analysis:**\n" + "\n".join([f"- {c}" for c in context])
                  else:
                      res += "âŒ ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
                  return res

          # ==========================================
          # 4. DASHBOARD ENGINE
          # ==========================================
          class DashboardEngine:
              def draw_bar(self, val):
                  fill = int((val/100)*15)
                  return "â–ˆ"*fill + "â–‘"*(15-fill)

              def create(self, metrics, news, copilot):
                  with open(DASH_PATH, 'w', encoding='utf-8') as f:
                      f.write(f"# ðŸ›ï¸ Grand Ops Titan-Infra Dashboard\n")
                      f.write(f"> **Time:** {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')} | **Mode:** {metrics['mode']} | **Uptime:** {metrics['uptime']}\n\n")

                      f.write(f"{copilot}\n\n---\n")

                      # 1. Hardware Status (Titan Class)
                      f.write(f"### âš¡ Titan Infrastructure (Resource Pool)\n")
                      f.write(f"| Component | Specification (Installed) | Real-time Usage | Capacity Bar |\n|---|---|---|---|\n")
                      f.write(f"| **CPU Cluster** | `{metrics['spec_cpu']}` | {metrics['cpu_load']}% | `{self.draw_bar(metrics['cpu_load'])}` |\n")
                      f.write(f"| **Memory Bank** | `{metrics['spec_ram']}` | {metrics['ram_percent']}% | `{self.draw_bar(metrics['ram_percent'])}` |\n")
                      f.write(f"| **Storage Array**| `{metrics['spec_disk']}` | 1% (Optimized) | `{self.draw_bar(1)}` |\n\n")

                      # 2. Finance News
                      f.write("### ðŸ¦ Major Finance (Shinhan & Hana)\n")
                      shinhan = news.get('FIN_SHINHAN', [])
                      hana = news.get('FIN_HANA', [])
                      
                      if shinhan:
                          f.write(f"**ðŸ”µ Shinhan Financial Group**\n")
                          for n in shinhan[:2]: f.write(f"- [{n['title']}]({n['link']})\n")
                      if hana:
                          f.write(f"\n**ðŸŸ¢ Hana Financial Group**\n")
                          for n in hana[:2]: f.write(f"- [{n['title']}]({n['link']})\n")
                      f.write("\n")

                      # 3. Security
                      f.write("### ðŸ›¡ï¸ Security Intelligence\n")
                      sec = news.get('KR_SEC', [])
                      for n in sec[:3]: f.write(f"- [{n['title']}]({n['link']})\n")

                      f.write("\n---\n*Powered by Titan-Infra Engine v32.0*")

          # ==========================================
          # ðŸš€ MAIN
          # ==========================================
          def main():
              if not os.path.exists("data"): os.makedirs("data")
              conn = sqlite3.connect(DB_PATH)
              
              # 1. í•˜ë“œì›¨ì–´ ë§¤ë‹ˆì € (ì¦ì„¤/ìž¬ê¸°ë™ ë¡œì§)
              hw = TitanHardware()
              
              # ì‚¬ìš©ìž ëª…ë ¹ ì²˜ë¦¬
              if ACTION == 'scale_up_resources':
                  hw.install_resources()
              elif ACTION == 'system_reboot':
                  hw.reboot_system()
              else:
                  print("â„¹ï¸ Standard Monitoring Mode Active.")

              metrics = hw.get_metrics()
              
              # 2. ë‰´ìŠ¤ ë° ì½”íŒŒì¼ëŸ¿
              news_eng = FinanceNewsEngine()
              news_data, corpus = news_eng.fetch()
              
              ai = TitanCopilot(corpus, metrics)
              ans = ai.generate(USER_QUERY)
              
              # 3. ëŒ€ì‹œë³´ë“œ
              dash = DashboardEngine()
              dash.create(metrics, news_data, ans)
              
              conn.close()
              print("âœ… Titan-Infra Operations Completed.")

          if __name__ == "__main__":
              main()
          EOF

      - name: ðŸš€ Run Titan-Engine
        run: python scripts/titan_core.py

      - name: ðŸ“¢ Publish Dashboard
        run: cat "$DASHBOARD_FILE" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”’ Encrypt & Sync
        run: |
          zip -e -P "$ARTIFACT_PASSWORD" titan_backup.zip data/*.md data/*.db
          
          git config --global user.name "Titan-Admin"
          git config --global user.email "admin@grand-ops.ai"
          git config --global --add safe.directory $GITHUB_WORKSPACE
          
          [ -f "$DASHBOARD_FILE" ] && git add -f "$DASHBOARD_FILE"
          [ -f "$DB_PATH" ] && git add -f "$DB_PATH"
          git add -A
          
          if [ -z "$(git status --porcelain)" ]; then exit 0; fi
          git commit -m "infra: scale-up & reboot action applied [skip ci]"
          git push origin main || echo "Sync skipped"
