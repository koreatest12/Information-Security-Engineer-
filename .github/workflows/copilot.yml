name: ğŸ‡°ğŸ‡· Grand Ops Korean-Fusion v28 (Naver/Daum & Security)

on:
  schedule:
    - cron: '*/30 * * * *' # 30ë¶„ ì£¼ê¸°
  workflow_dispatch:
    inputs:
      copilot_query:
        description: 'ğŸ’¬ Copilot ì§ˆë¬¸ (ì˜ˆ: "êµ­ë‚´ ë³´ì•ˆ ì´ìŠˆ ì•Œë ¤ì¤˜", "ë„¤ì´ë²„ ì†ë³´ ìš”ì•½")'
        required: false
        default: 'í˜„ì¬ êµ­ë‚´ì™¸ ì£¼ìš” ë‰´ìŠ¤ì™€ ì‹œìŠ¤í…œ ìƒíƒœë¥¼ ë¸Œë¦¬í•‘í•´ì¤˜.'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_korean.db'
  DASHBOARD_FILE: 'data/korean_dashboard.md'
  USER_QUERY: ${{ inputs.copilot_query || 'ì „ì²´ ì‹œìŠ¤í…œ ì§„ë‹¨ ë° ë‰´ìŠ¤ ë¸Œë¦¬í•‘' }}
  ARTIFACT_PASSWORD: ${{ secrets.ARTIFACT_KEY || 'Korea_Sec_2025' }}

permissions:
  contents: write

jobs:
  korean-intelligence-engine:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Initialize Korean Fusion Stack
        run: |
          echo "ğŸ‡°ğŸ‡· Booting Korean Intelligence Layer..."
          mkdir -p data backup scripts
          python -m pip install --upgrade pip
          # [í•µì‹¬] beautifulsoup4(í¬ë¡¤ë§), feedparser(RSS), textblob(ë¶„ì„)
          echo -e "requests\npandas\nnumpy\nscikit-learn\ntabulate\npsutil\nfeedparser\nbeautifulsoup4\ntextblob" > requirements.txt
          pip install -r requirements.txt
          python -m textblob.download_corpora

      - name: ğŸ§  Generate Fusion Copilot Script
        run: |
          cat <<'EOF' > scripts/korean_core.py
          import sqlite3
          import os
          import datetime
          import psutil
          import requests
          import feedparser
          from bs4 import BeautifulSoup
          import pandas as pd
          from textblob import TextBlob
          from sklearn.feature_extraction.text import TfidfVectorizer
          from sklearn.metrics.pairwise import cosine_similarity

          # ì„¤ì •
          DB_PATH = os.getenv('DB_PATH', 'data/grand_ops_korean.db')
          DASH_PATH = os.getenv('DASHBOARD_FILE', 'data/korean_dashboard.md')
          USER_QUERY = os.getenv('USER_QUERY', '')

          class KNewsFetcher:
              """ğŸ‡°ğŸ‡· êµ­ë‚´ í¬í„¸ ë° ë³´ì•ˆ ë‰´ìŠ¤ ìˆ˜ì§‘ê¸°"""
              def __init__(self):
                  self.feeds = {
                      "NAVER_FLASH": "https://news.naver.com/main/rss/rss_flash.nhn",
                      "K_SECURITY": "https://www.boannews.com/media/news_rss.xml",
                      "GOOGLE_IT_KR": "https://news.google.com/rss/search?q=IT+ì¸ê³µì§€ëŠ¥+ë³´ì•ˆ&hl=ko&gl=KR&ceid=KR:ko"
                  }
                  self.headers = {'User-Agent': 'Mozilla/5.0 (GrandOpsBot/1.0)'}

              def fetch_all(self):
                  news_data = {}
                  raw_texts = []
                  
                  for source, url in self.feeds.items():
                      entries = []
                      try:
                          # RSS íŒŒì‹± ì‹œë„
                          f = feedparser.parse(url)
                          # ë§Œì•½ RSS íŒŒì‹±ì´ ì˜ ì•ˆë˜ë©´ requestsë¡œ ì§ì ‘ ìš”ì²­ (ë„¤ì´ë²„ ë“± ë°©ì–´ ë¡œì§ ìš°íšŒ)
                          if not f.entries:
                              resp = requests.get(url, headers=self.headers, timeout=5)
                              f = feedparser.parse(resp.content)
                              
                          for e in f.entries[:4]: # ì†ŒìŠ¤ë‹¹ 4ê°œ
                              clean_title = e.title.replace("&quot;", "'").replace("<b>", "").replace("</b>", "")
                              entries.append({"title": clean_title, "link": e.link})
                              raw_texts.append(f"[{source}] {clean_title}")
                      except Exception as e:
                          print(f"âš ï¸ {source} Fetch Error: {e}")
                      
                      news_data[source] = entries
                  
                  return news_data, raw_texts

          class HyperscaleSystem:
              """ê°€ìƒ í•˜ì´í¼ìŠ¤ì¼€ì¼ ë¦¬ì†ŒìŠ¤"""
              def get_metrics(self):
                  return {
                      "cpu": psutil.cpu_percent(),
                      "ram_pct": psutil.virtual_memory().percent,
                      "v_cores": 128,
                      "v_mem": "512GB"
                  }

          class FusionCopilot:
              """ğŸ§  í•œ/ì˜ í†µí•© RAG ì½”íŒŒì¼ëŸ¿"""
              def __init__(self, news_texts, sys_metrics):
                  self.knowledge_base = news_texts
                  
                  # ì‹œìŠ¤í…œ ìƒíƒœë„ ì§€ì‹ìœ¼ë¡œ ì£¼ì…
                  self.knowledge_base.append(f"SYSTEM_STATUS: CPU Load is {sys_metrics['cpu']}%. Memory usage is {sys_metrics['ram_pct']}%.")
                  if sys_metrics['cpu'] < 50:
                      self.knowledge_base.append("SYSTEM_ADVICE: The server is stable. Good time for batch processing.")
                  else:
                      self.knowledge_base.append("SYSTEM_ADVICE: High load detected. Monitor resource usage.")

              def generate_answer(self, query):
                  # ë²¡í„° ê²€ìƒ‰ (TF-IDF)
                  if not self.knowledge_base: return "ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨. ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                  
                  vectorizer = TfidfVectorizer()
                  tfidf_matrix = vectorizer.fit_transform(self.knowledge_base)
                  query_vec = vectorizer.transform([query])
                  
                  cosine_sim = cosine_similarity(query_vec, tfidf_matrix).flatten()
                  related_indices = cosine_sim.argsort()[:-4:-1] # ìƒìœ„ 3ê°œ
                  
                  context = []
                  for i in related_indices:
                      if cosine_sim[i] > 0.05: # ìœ ì‚¬ë„ ì„ê³„ê°’
                          context.append(self.knowledge_base[i])
                  
                  # ë‹µë³€ ìƒì„±
                  timestamp = datetime.datetime.now().strftime("%H:%M")
                  response = f"### ğŸ¤– Copilot Briefing ({timestamp})\n"
                  response += f"> **ì§ˆë¬¸:** \"{query}\"\n\n"
                  
                  if context:
                      response += "**âœ… ë¶„ì„ ê²°ê³¼ ë° ê´€ë ¨ ë‰´ìŠ¤:**\n"
                      for item in context:
                          # íƒœê·¸ ì •ë¦¬
                          clean_item = item.replace("NAVER_FLASH", "ë„¤ì´ë²„").replace("K_SECURITY", "ë³´ì•ˆë‰´ìŠ¤").replace("GOOGLE_IT_KR", "ITì¢…í•©")
                          response += f"- {clean_item}\n"
                      
                      response += "\n*ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ íŒë‹¨í•  ë•Œ, ì‚¬ìš©ìê°€ ìš”ì²­í•˜ì‹  ì •ë³´ëŠ” ìœ„ì™€ ê°™ìŠµë‹ˆë‹¤.*"
                  else:
                      response += "âŒ ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ìˆ˜ì§‘ëœ ë„¤ì´ë²„/ë³´ì•ˆ ë‰´ìŠ¤ ë°ì´í„°ì—ì„œ ê´€ë ¨ ë‚´ìš©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
                      
                  return response

          class DashboardUI:
              def generate(self, metrics, news, copilot_ans):
                  with open(DASH_PATH, 'w', encoding='utf-8') as f:
                      f.write(f"# ğŸ‡°ğŸ‡· Grand Ops Korean-Fusion Dashboard\n")
                      f.write(f"> **System Time:** {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')} (KST)\n\n")

                      # 1. Copilot ì„¹ì…˜
                      f.write(f"{copilot_ans}\n\n")
                      f.write("---\n")

                      # 2. í•˜ì´í¼ìŠ¤ì¼€ì¼ ì‹œìŠ¤í…œ ìƒíƒœ
                      f.write(f"### âš¡ Hyperscale System Status\n")
                      f.write(f"- **vCPU:** {metrics['v_cores']} Cores (Load: {metrics['cpu']}%)\n")
                      f.write(f"- **Memory:** {metrics['v_mem']} (Used: {metrics['ram_pct']}%)\n")
                      f.write(f"- **Storage:** 1PB NVMe Pool (Healthy)\n\n")

                      # 3. K-News ì„¹ì…˜ (ë„¤ì´ë²„/ë‹¤ìŒ/ë³´ì•ˆ)
                      f.write(f"### ğŸ“° êµ­ë‚´ ì£¼ìš” ë‰´ìŠ¤ ë¸Œë¦¬í•‘ (Real-time)\n")
                      
                      if "NAVER_FLASH" in news:
                          f.write(f"#### ğŸŸ¢ ë„¤ì´ë²„ ì†ë³´ (Naver Flash)\n")
                          for item in news["NAVER_FLASH"]:
                              f.write(f"- [{item['title']}]({item['link']})\n")
                          f.write("\n")
                          
                      if "K_SECURITY" in news:
                          f.write(f"#### ğŸ›¡ï¸ êµ­ë‚´ ë³´ì•ˆ ë‰´ìŠ¤ (BoanNews)\n")
                          for item in news["K_SECURITY"]:
                              f.write(f"- [{item['title']}]({item['link']})\n")
                          f.write("\n")

                      if "GOOGLE_IT_KR" in news:
                          f.write(f"#### ğŸ’» IT ë° ì¸ê³µì§€ëŠ¥ íŠ¸ë Œë“œ (Daum/Google)\n")
                          for item in news["GOOGLE_IT_KR"]:
                              f.write(f"- [{item['title']}]({item['link']})\n")
                          f.write("\n")
                      
                      f.write("---\n*Powered by Grand Ops Korean-Fusion Engine v28.0*")

          def main():
              if not os.path.exists("data"): os.makedirs("data")
              conn = sqlite3.connect(DB_PATH)
              
              # 1. ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­
              hs = HyperscaleSystem()
              metrics = hs.get_metrics()
              
              # 2. í•œêµ­ ë‰´ìŠ¤ ìˆ˜ì§‘
              fetcher = KNewsFetcher()
              news_data, flat_texts = fetcher.fetch_all()
              
              # 3. ì½”íŒŒì¼ëŸ¿ RAG (í•œêµ­ì–´ ì§€ì›)
              copilot = FusionCopilot(flat_texts, metrics)
              answer = copilot.generate_answer(USER_QUERY)
              
              # 4. ëŒ€ì‹œë³´ë“œ ìƒì„±
              ui = DashboardUI()
              ui.generate(metrics, news_data, answer)
              
              conn.close()
              print("âœ… Korean Fusion Tasks Completed.")

          if __name__ == "__main__":
              main()
          EOF

      - name: ğŸš€ Run Korean Fusion Engine
        run: python scripts/korean_core.py

      - name: ğŸ“¢ Publish Dashboard to Summary
        run: cat "$DASHBOARD_FILE" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”’ Encrypt & Sync
        run: |
          zip -e -P "$ARTIFACT_PASSWORD" korea_backup.zip data/*.md data/*.db
          
          git config --global user.name "K-Copilot"
          git config --global user.email "korea@grand-ops.ai"
          git config --global --add safe.directory $GITHUB_WORKSPACE
          
          [ -f "$DASHBOARD_FILE" ] && git add -f "$DASHBOARD_FILE"
          [ -f "$DB_PATH" ] && git add -f "$DB_PATH"
          git add -A
          
          if [ -z "$(git status --porcelain)" ]; then exit 0; fi
          git commit -m "korea: naver/daum news sync & copilot rag [skip ci]"
          git push origin main || echo "Sync skipped"
