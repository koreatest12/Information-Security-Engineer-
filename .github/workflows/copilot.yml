name: ğŸ›ï¸ Grand Ops Titan-Infra v34 (Control Center)

on:
  schedule:
    - cron: '*/30 * * * *'  # 30ë¶„ë§ˆë‹¤ ìë™ ëª¨ë‹ˆí„°ë§
  workflow_dispatch:
    inputs:
      server_action:
        description: 'âš¡ ì„œë²„ ì œì–´ ëª…ë ¹ ì„ íƒ'
        required: true
        default: 'monitor_only'
        type: choice
        options:
          - 'monitor_only'
          - 'scale_up_resources'
          - 'system_reboot'
          - 'reset_factory'
      copilot_query:
        description: 'ğŸ’¬ AI ì§ˆë¬¸'
        required: false
        default: 'í˜„ì¬ ì¸í”„ë¼ ìƒíƒœ ìš”ì•½í•´ì¤˜.'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  # ìƒíƒœ ì €ì¥ì„ ìœ„í•œ JSON íŒŒì¼ ê²½ë¡œ
  STATE_FILE: 'data/titan_status.json' 
  DASHBOARD_FILE: 'data/titan_dashboard.md'
  SERVER_ACTION: ${{ inputs.server_action || 'monitor_only' }}
  USER_QUERY: ${{ inputs.copilot_query || 'ì¢…í•© ìƒí™© ë¸Œë¦¬í•‘' }}
  REPO_NAME: ${{ github.repository }} # ë§í¬ ìƒì„±ì„ ìœ„í•´ ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ í•„ìš”
  ARTIFACT_PASSWORD: ${{ secrets.ARTIFACT_KEY || 'Titan_Sec_2025' }}

permissions:
  contents: write

jobs:
  titan-engine:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Provision System & Fix Permissions
        run: |
          echo "ğŸ“¦ Installing System Tools..."
          sudo apt-get update
          sudo apt-get install -y nginx redis-tools postgresql-client stress htop
          
          echo "âš¡ Mounting Virtual Disks..."
          sudo mkdir -p /mnt/titan_storage
          sudo chown -R $USER:$USER /mnt/titan_storage
          touch /mnt/titan_storage/virtual_disk.img
          
          echo "âœ… System Ready."

      - name: ğŸ Initialize Python Stack
        run: |
          mkdir -p data
          python -m pip install --upgrade pip
          echo -e "requests\npandas\nnumpy\nscikit-learn\npsutil\nfeedparser\nbeautifulsoup4" > requirements.txt
          pip install -r requirements.txt

      - name: ğŸ§  Generate Titan-Core Script (v34 Control Center)
        run: |
          cat <<'EOF' > scripts/titan_core.py
          import json
          import os
          import time
          import datetime
          import psutil
          import requests
          import feedparser
          from sklearn.feature_extraction.text import TfidfVectorizer
          from sklearn.metrics.pairwise import cosine_similarity

          # ==========================================
          # âš™ï¸ CONFIGURATION
          # ==========================================
          STATE_PATH = os.getenv('STATE_FILE', 'data/titan_status.json')
          DASH_PATH = os.getenv('DASHBOARD_FILE', 'data/titan_dashboard.md')
          ACTION = os.getenv('SERVER_ACTION', 'monitor_only')
          REPO = os.getenv('REPO_NAME', '')
          USER_QUERY = os.getenv('USER_QUERY', '')

          # ==========================================
          # 1. TITAN HARDWARE MANAGER (With Persistence)
          # ==========================================
          class TitanHardware:
              def __init__(self):
                  self.state = self.load_state()
                  
              def load_state(self):
                  # ê¸°ì¡´ ìƒíƒœ íŒŒì¼ì´ ìˆìœ¼ë©´ ë¡œë“œ, ì—†ìœ¼ë©´ ì´ˆê¸°ê°’ ìƒì„±
                  if os.path.exists(STATE_PATH):
                      try:
                          with open(STATE_PATH, 'r') as f:
                              return json.load(f)
                      except: pass
                  return {
                      "v_cores": 128,
                      "v_ram_gb": 512,
                      "v_disk_tb": 1024,
                      "last_boot": time.time(),
                      "status": "ğŸŸ¢ Optimal",
                      "generation": 1
                  }

              def save_state(self):
                  with open(STATE_PATH, 'w') as f:
                      json.dump(self.state, f, indent=4)

              def process_action(self, action_cmd):
                  msg = "Monitoring..."
                  if action_cmd == 'scale_up_resources':
                      print("\nâš¡ [ACTION] Scaling Up Resources...")
                      self.state['v_cores'] *= 2
                      self.state['v_ram_gb'] *= 2
                      self.state['status'] = "âš¡ Scaled-Up"
                      self.state['generation'] += 1
                      msg = "Resource Doubled successfully."
                      
                  elif action_cmd == 'system_reboot':
                      print("\nğŸ”„ [ACTION] Rebooting System...")
                      self.state['last_boot'] = time.time()
                      self.state['status'] = "ğŸ”µ Fresh Boot"
                      msg = "System Rebooted."

                  elif action_cmd == 'reset_factory':
                      if os.path.exists(STATE_PATH):
                          os.remove(STATE_PATH)
                      # ì¬ê·€ì ìœ¼ë¡œ ì´ˆê¸°í™”ëœ ìƒíƒœ ë¡œë“œ
                      self.__init__()
                      msg = "Factory Reset Complete."
                  
                  self.save_state()
                  return msg

              def get_metrics(self):
                  # ê°€ë™ ì‹œê°„ ê³„ì‚°
                  uptime_sec = time.time() - self.state['last_boot']
                  uptime_str = str(datetime.timedelta(seconds=int(uptime_sec)))
                  
                  real_cpu = psutil.cpu_percent()
                  real_ram = psutil.virtual_memory().percent
                  
                  return {
                      "cpu_load": real_cpu,
                      "ram_percent": real_ram,
                      "spec_cpu": f"{self.state['v_cores']} vCores",
                      "spec_ram": f"{(real_ram/100)*self.state['v_ram_gb']:.1f}/{self.state['v_ram_gb']} GB",
                      "spec_disk": f"{self.state['v_disk_tb']} TB",
                      "uptime": uptime_str,
                      "mode": self.state['status'],
                      "gen": self.state['generation']
                  }

          # ==========================================
          # 2. FINANCE NEWS ENGINE
          # ==========================================
          class FinanceNewsEngine:
              def fetch(self):
                  feeds = {
                      "FIN_SHINHAN": "https://news.google.com/rss/search?q=ì‹ í•œê¸ˆìœµ&hl=ko&gl=KR&ceid=KR:ko",
                      "KR_ECON": "https://news.google.com/rss/search?q=í•œêµ­ê²½ì œ&hl=ko&gl=KR&ceid=KR:ko"
                  }
                  news_data = {}
                  corpus = []
                  for src, url in feeds.items():
                      entries = []
                      try:
                          f = feedparser.parse(url)
                          if not f.entries:
                              r = requests.get(url, headers={'User-Agent': 'Bot'}, timeout=5)
                              f = feedparser.parse(r.content)
                          for e in f.entries[:2]:
                              entries.append({"title": e.title, "link": e.link})
                              corpus.append(f"[{src}] {e.title}")
                      except: 
                          news_data[src] = [{"title": "News Feed Error", "link": "#"}]
                      news_data[src] = entries
                  return news_data, corpus

          # ==========================================
          # 3. AI COPILOT
          # ==========================================
          class TitanCopilot:
              def __init__(self, corpus, metrics):
                  self.kb = corpus
                  self.kb.append(f"SYS: CPU {metrics['spec_cpu']}, RAM {metrics['spec_ram']}, Mode {metrics['mode']}")

              def generate(self, query):
                  if len(self.kb) < 2: return "ë°ì´í„° ë¶€ì¡±"
                  try:
                      vec = TfidfVectorizer()
                      mat = vec.fit_transform(self.kb)
                      q_vec = vec.transform([query])
                      sim = cosine_similarity(q_vec, mat).flatten()
                      idx = sim.argsort()[:-3:-1]
                      ctx = [self.kb[i] for i in idx if sim[i] > 0.05]
                      
                      res = f"> **Q:** {query}\n\n"
                      res += "**ğŸ¤– AI Analysis:**\n" + "\n".join([f"- {c}" for c in ctx]) if ctx else "ê´€ë ¨ ì •ë³´ ì—†ìŒ"
                      return res
                  except: return "AI Engine Error"

          # ==========================================
          # 4. DASHBOARD ENGINE (With Buttons)
          # ==========================================
          class DashboardEngine:
              def draw_bar(self, val):
                  fill = int((val/100)*15)
                  return "â–ˆ"*fill + "â–‘"*(15-fill)

              def create(self, metrics, news, copilot):
                  # Action URL ìƒì„± (Github ì›Œí¬í”Œë¡œìš° íƒ­ìœ¼ë¡œ ì´ë™)
                  action_url = f"https://github.com/{REPO}/actions/workflows/main.yml" 
                  # (ì°¸ê³ : íŒŒì¼ëª…ì´ main.ymlì´ ì•„ë‹ ê²½ìš° ì‹¤ì œ íŒŒì¼ëª…ìœ¼ë¡œ ìˆ˜ì • í•„ìš”)
                  
                  with open(DASH_PATH, 'w', encoding='utf-8') as f:
                      f.write(f"# ğŸ›ï¸ Grand Ops Titan-Infra Control Center\n")
                      f.write(f"> **Status:** {metrics['mode']} (Gen {metrics['gen']}) | **Uptime:** {metrics['uptime']}\n\n")
                      
                      # --- ğŸ® Control Center (Buttons) ---
                      f.write("### ğŸ® Operations Control Center\n")
                      f.write("ì‹œìŠ¤í…œ ì œì–´ê°€ í•„ìš”í•˜ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ **Run workflow**ë¥¼ ì‹¤í–‰í•˜ì‹­ì‹œì˜¤.\n\n")
                      
                      # ë°°ì§€ ìŠ¤íƒ€ì¼ ë²„íŠ¼ (ë§í¬ëŠ” Actions íƒ­ìœ¼ë¡œ ì—°ê²°)
                      f.write(f"[![Reboot](https://img.shields.io/badge/COMMAND-SYSTEM__REBOOT-red?style=for-the-badge&logo=linux&logoColor=white)]({action_url}) ")
                      f.write(f"[![ScaleUp](https://img.shields.io/badge/COMMAND-SCALE__UP-blue?style=for-the-badge&logo=server&logoColor=white)]({action_url}) ")
                      f.write(f"[![Refresh](https://img.shields.io/badge/VIEW-REFRESH__LOGS-green?style=for-the-badge&logo=githubactions&logoColor=white)]({action_url})\n\n")
                      
                      f.write(f"{copilot}\n\n---\n")

                      f.write(f"### âš¡ Hardware Metrics\n")
                      f.write(f"| Resource | Spec | Usage | Graph |\n|---|---|---|---|\n")
                      f.write(f"| **CPU** | `{metrics['spec_cpu']}` | {metrics['cpu_load']}% | `{self.draw_bar(metrics['cpu_load'])}` |\n")
                      f.write(f"| **RAM** | `{metrics['spec_ram']}` | {metrics['ram_percent']}% | `{self.draw_bar(metrics['ram_percent'])}` |\n\n")

                      f.write("### ğŸ¦ Financial Briefing\n")
                      for k, v in news.items():
                          if v: f.write(f"- [{v[0]['title']}]({v[0]['link']})\n")
                      
                      f.write("\n---\n*Titan-Infra v34.0 Automated Dashboard*")

          # ==========================================
          # ğŸš€ MAIN
          # ==========================================
          def main():
              if not os.path.exists("data"): os.makedirs("data")
              
              hw = TitanHardware()
              # ì•¡ì…˜ ì²˜ë¦¬ ë° ìƒíƒœ ì €ì¥
              hw.process_action(ACTION) 
              metrics = hw.get_metrics()

              news_eng = FinanceNewsEngine()
              news_data, corpus = news_eng.fetch()
              
              ai = TitanCopilot(corpus, metrics)
              ans = ai.generate(USER_QUERY)

              dash = DashboardEngine()
              dash.create(metrics, news_data, ans)
              
              print("âœ… Operation Complete.")

          if __name__ == "__main__":
              main()
          EOF

      - name: ğŸš€ Run Titan-Engine
        run: python scripts/titan_core.py

      - name: ğŸ“¢ Publish Dashboard
        run: |
          [ -f "$DASHBOARD_FILE" ] && cat "$DASHBOARD_FILE" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”’ Encrypt & Sync Data
        run: |
          zip -e -P "$ARTIFACT_PASSWORD" titan_backup.zip data/*.md data/*.json
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory $GITHUB_WORKSPACE

          # JSON ìƒíƒœ íŒŒì¼ê³¼ ëŒ€ì‹œë³´ë“œ ì»¤ë°‹
          git add data/titan_status.json data/titan_dashboard.md
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ops: update system state & dashboard [v34]"
            git pull --rebase origin main
            git push origin main
          else
            echo "â„¹ï¸ No changes."
          fi
