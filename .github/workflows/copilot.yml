name: ğŸ¦ Grand Ops Finance-Master v30 (Shinhan & Hana Special)

on:
  schedule:
    - cron: '*/30 * * * *' # 30ë¶„ ì£¼ê¸° ì‹¤í–‰
  workflow_dispatch:
    inputs:
      copilot_query:
        description: 'ğŸ’¬ AIì—ê²Œ ì§ˆë¬¸ (ì˜ˆ: "ì‹ í•œì€í–‰ê³¼ í•˜ë‚˜ì€í–‰ ìµœê·¼ ì†Œì‹ ì•Œë ¤ì¤˜")'
        required: false
        default: 'ê¸ˆìœµì‚¬(ì‹ í•œ/í•˜ë‚˜) ì£¼ìš” ë‰´ìŠ¤ì™€ ì‹œìŠ¤í…œ ìƒíƒœ ë¸Œë¦¬í•‘í•´ì¤˜.'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  TZ: 'Asia/Seoul'
  DB_PATH: 'data/grand_ops_finance.db'
  DASHBOARD_FILE: 'data/finance_dashboard.md'
  USER_QUERY: ${{ inputs.copilot_query || 'ê¸ˆìœµ ë° ì‹œìŠ¤í…œ ì¢…í•© ë¸Œë¦¬í•‘' }}
  ARTIFACT_PASSWORD: ${{ secrets.ARTIFACT_KEY || 'Finance_Master_2025' }}

permissions:
  contents: write

jobs:
  finance-master-engine:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Initialize Finance Stack
        run: |
          echo "ğŸ¦ Booting Finance-Master Engine..."
          mkdir -p data backup scripts dist
          python -m pip install --upgrade pip
          
          # [í†µí•© ì˜ì¡´ì„± ì„¤ì¹˜]
          echo -e "requests\npandas\nnumpy\nscikit-learn\ntabulate\npsutil\nfeedparser\nbeautifulsoup4\ntextblob" > requirements.txt
          pip install -r requirements.txt
          python -m textblob.download_corpora

      - name: ğŸ§  Generate Finance-Master Script
        run: |
          cat <<'EOF' > scripts/master_finance_core.py
          import sqlite3
          import os
          import datetime
          import psutil
          import requests
          import feedparser
          from bs4 import BeautifulSoup
          import pandas as pd
          from textblob import TextBlob
          from sklearn.feature_extraction.text import TfidfVectorizer
          from sklearn.metrics.pairwise import cosine_similarity

          # ==========================================
          # âš™ï¸ CONFIGURATION
          # ==========================================
          DB_PATH = os.getenv('DB_PATH', 'data/grand_ops_finance.db')
          DASH_PATH = os.getenv('DASHBOARD_FILE', 'data/finance_dashboard.md')
          USER_QUERY = os.getenv('USER_QUERY', '')

          # ==========================================
          # 1. HYPERSCALE MONITOR (ì‹œìŠ¤í…œ ìì›)
          # ==========================================
          class HyperscaleMonitor:
              def __init__(self):
                  self.v_cores = 128
                  self.v_ram_gb = 512
              
              def get_metrics(self):
                  real_cpu = psutil.cpu_percent()
                  real_ram = psutil.virtual_memory().percent
                  return {
                      "cpu_load": real_cpu,
                      "ram_percent": real_ram,
                      "spec_cpu": f"{self.v_cores} vCores",
                      "spec_ram": f"{(real_ram/100)*self.v_ram_gb:.1f}/{self.v_ram_gb} GB"
                  }

          # ==========================================
          # 2. TARGETED NEWS ENGINE (ê¸ˆìœµ íŠ¹í™”)
          # ==========================================
          class TargetedNewsEngine:
              """ê¸ˆìœµì‚¬(ì‹ í•œ/í•˜ë‚˜) ë° ì¼ë°˜ ë‰´ìŠ¤ í†µí•© ìˆ˜ì§‘"""
              def __init__(self):
                  # Google News RSSë¥¼ ì´ìš©í•´ íŠ¹ì • í‚¤ì›Œë“œ ì •ë°€ ì¶”ì 
                  self.feeds = {
                      # 1. ê¸ˆìœµì‚¬ íŠ¹í™” (ìš”ì²­ì‚¬í•­ ë°˜ì˜)
                      "FIN_SHINHAN_BANK": "https://news.google.com/rss/search?q=ì‹ í•œì€í–‰&hl=ko&gl=KR&ceid=KR:ko",
                      "FIN_HANA_BANK": "https://news.google.com/rss/search?q=í•˜ë‚˜ì€í–‰&hl=ko&gl=KR&ceid=KR:ko",
                      "FIN_SHINHAN_INV": "https://news.google.com/rss/search?q=ì‹ í•œíˆ¬ìì¦ê¶Œ+OR+ì‹ í•œê¸ˆìœµíˆ¬ì&hl=ko&gl=KR&ceid=KR:ko",
                      "FIN_HANA_INV": "https://news.google.com/rss/search?q=í•˜ë‚˜ì¦ê¶Œ+OR+í•˜ë‚˜ê¸ˆìœµíˆ¬ì&hl=ko&gl=KR&ceid=KR:ko",
                      
                      # 2. ê¸°ì¡´ ë‰´ìŠ¤ ì†ŒìŠ¤ (ë„¤ì´ë²„ ì†ë³´, ë³´ì•ˆ)
                      "KR_NAVER": "https://news.naver.com/main/rss/rss_flash.nhn",
                      "KR_SECURITY": "https://www.boannews.com/media/news_rss.xml",
                      "US_TECH": "https://techcrunch.com/category/artificial-intelligence/feed/"
                  }
                  self.headers = {'User-Agent': 'Mozilla/5.0 (GrandOpsBot/1.0)'}

              def fetch_all(self):
                  news_data = {}
                  corpus = [] # AI í•™ìŠµìš© í…ìŠ¤íŠ¸
                  
                  for source, url in self.feeds.items():
                      entries = []
                      try:
                          f = feedparser.parse(url)
                          if not f.entries: 
                              r = requests.get(url, headers=self.headers, timeout=5)
                              f = feedparser.parse(r.content)
                              
                          for e in f.entries[:3]: # ì†ŒìŠ¤ë‹¹ ìƒìœ„ 3ê°œ
                              clean_title = e.title.replace("&quot;", "'").replace("<b>", "").replace("</b>", "")
                              entries.append({"title": clean_title, "link": e.link})
                              
                              # AI í•™ìŠµìš© íƒœê¹…
                              tag = "Finance" if "FIN" in source else "General"
                              corpus.append(f"[{tag}/{source}] {clean_title}")
                      except: pass
                      news_data[source] = entries
                  
                  return news_data, corpus

          # ==========================================
          # 3. AI COGNITIVE COPILOT
          # ==========================================
          class MasterCopilot:
              def __init__(self, news_corpus, sys_metrics):
                  self.knowledge_base = news_corpus
                  # ì‹œìŠ¤í…œ ìƒíƒœ ì£¼ì…
                  self.knowledge_base.append(f"SYSTEM: CPU {sys_metrics['cpu_load']}%, RAM {sys_metrics['ram_percent']}%. Status: Healthy.")

              def generate_response(self, query):
                  if not self.knowledge_base: return "ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
                  
                  vectorizer = TfidfVectorizer()
                  tfidf_matrix = vectorizer.fit_transform(self.knowledge_base)
                  query_vec = vectorizer.transform([query])
                  
                  sim_scores = cosine_similarity(query_vec, tfidf_matrix).flatten()
                  top_indices = sim_scores.argsort()[:-5:-1] # ìƒìœ„ 4ê°œ
                  
                  context_lines = []
                  for idx in top_indices:
                      if sim_scores[idx] > 0.05:
                          context_lines.append(f"- {self.knowledge_base[idx]}")
                  
                  timestamp = datetime.datetime.now().strftime("%H:%M")
                  res = f"### ğŸ¤– Copilot Briefing ({timestamp})\n"
                  res += f"> **Q:** \"{query}\"\n\n"
                  
                  if context_lines:
                      res += "**âœ… AI ë¶„ì„ ê²°ê³¼ (ê´€ë ¨ì„± ë†’ìŒ):**\n" + "\n".join(context_lines)
                  else:
                      res += "âŒ ì§ˆë¬¸ê³¼ ì§ì ‘ì ìœ¼ë¡œ ê´€ë ¨ëœ ìµœì‹  ë‰´ìŠ¤ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì¼ë°˜ ë‰´ìŠ¤ ë¸Œë¦¬í•‘ ì°¸ê³ )"
                  return res

          # ==========================================
          # 4. DASHBOARD ENGINE
          # ==========================================
          class DashboardEngine:
              def draw_bar(self, val):
                  fill = int((val/100)*15)
                  return "â–ˆ"*fill + "â–‘"*(15-fill)

              def create_dashboard(self, metrics, news, copilot_ans):
                  with open(DASH_PATH, 'w', encoding='utf-8') as f:
                      f.write(f"# ğŸ¦ Grand Ops Finance-Master Dashboard\n")
                      f.write(f"> **Time:** {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')} (KST)\n\n")

                      # Copilot
                      f.write(f"{copilot_ans}\n\n")
                      f.write("---\n")

                      # 1. ê¸ˆìœµ ì„¹ì…˜ (í•µì‹¬ ì¶”ê°€)
                      f.write(f"### ğŸ¦ Major Financial News (Shinhan & Hana)\n")
                      f.write("| Bank / Investment | Latest Headlines (Click to Read) |\n|---|---|\n")
                      
                      # ì‹ í•œ
                      shinhan_news = news.get('FIN_SHINHAN_BANK', []) + news.get('FIN_SHINHAN_INV', [])
                      if shinhan_news:
                          f.write(f"| **ğŸ”µ ì‹ í•œê¸ˆìœµ (ì€í–‰/íˆ¬ì)** | ")
                          for item in shinhan_news[:2]: f.write(f"â€¢ [{item['title']}]({item['link']})<br>")
                          f.write(" |\n")
                      
                      # í•˜ë‚˜
                      hana_news = news.get('FIN_HANA_BANK', []) + news.get('FIN_HANA_INV', [])
                      if hana_news:
                          f.write(f"| **ğŸŸ¢ í•˜ë‚˜ê¸ˆìœµ (ì€í–‰/íˆ¬ì)** | ")
                          for item in hana_news[:2]: f.write(f"â€¢ [{item['title']}]({item['link']})<br>")
                          f.write(" |\n")

                      f.write("\n")

                      # 2. ì¼ë°˜ ë‰´ìŠ¤
                      f.write(f"### ğŸ“° General & Security News\n")
                      if "KR_NAVER" in news:
                          f.write(f"**ğŸŸ¢ ë„¤ì´ë²„ ì†ë³´:**\n")
                          for item in news["KR_NAVER"]: f.write(f"- [{item['title']}]({item['link']})\n")
                      
                      if "KR_SECURITY" in news:
                          f.write(f"\n**ğŸ›¡ï¸ ë³´ì•ˆë‰´ìŠ¤ (Security):**\n")
                          for item in news["KR_SECURITY"]: f.write(f"- [{item['title']}]({item['link']})\n")

                      # 3. ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤
                      f.write(f"\n### âš¡ Hyperscale Resources\n")
                      f.write(f"- **vCPU:** `{metrics['spec_cpu']}` (Load: {metrics['cpu_load']}%)\n")
                      f.write(f"- **RAM:** `{metrics['spec_ram']}` (Used: {metrics['ram_percent']}%)\n")
                      
                      f.write("\n---\n*Powered by Grand Ops Finance-Master v30.0*")

          # ==========================================
          # ğŸš€ MAIN
          # ==========================================
          def main():
              if not os.path.exists("data"): os.makedirs("data")
              conn = sqlite3.connect(DB_PATH)
              
              monitor = HyperscaleMonitor()
              metrics = monitor.get_metrics()
              
              news_engine = TargetedNewsEngine()
              news_data, corpus = news_engine.fetch_all()
              
              copilot = MasterCopilot(corpus, metrics)
              answer = copilot.generate_response(USER_QUERY)
              
              dash = DashboardEngine()
              dash.create_dashboard(metrics, news_data, answer)
              
              conn.close()
              print("âœ… Finance-Master Cycle Completed.")

          if __name__ == "__main__":
              main()
          EOF

      - name: ğŸš€ Run Finance Engine
        run: python scripts/master_finance_core.py

      - name: ğŸ“¢ Publish Dashboard
        run: cat "$DASHBOARD_FILE" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”’ Encrypt & Sync
        run: |
          zip -e -P "$ARTIFACT_PASSWORD" finance_backup.zip data/*.md data/*.db
          
          git config --global user.name "Finance-Bot"
          git config --global user.email "bot@grand-ops.ai"
          git config --global --add safe.directory $GITHUB_WORKSPACE
          
          [ -f "$DASHBOARD_FILE" ] && git add -f "$DASHBOARD_FILE"
          [ -f "$DB_PATH" ] && git add -f "$DB_PATH"
          git add -A
          
          if [ -z "$(git status --porcelain)" ]; then exit 0; fi
          git commit -m "finance: shinhan/hana news sync [skip ci]"
          git push origin main || echo "Sync skipped"
