name: Enterprise Master Fix & Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  enterprise_master_build:
    name: ðŸ›¡ï¸ ì—”í„°í”„ë¼ì´ì¦ˆ ë§ˆìŠ¤í„° ë¹Œë“œ
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ðŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ë‚´ë ¤ë°›ê¸°
        uses: actions/checkout@v4

      # 2. í”„ë¡œì íŠ¸ ìƒíƒœ ê°ì§€
      - name: ðŸ” í”„ë¡œì íŠ¸ ìƒíƒœ ê°ì§€
        id: check
        run: |
          FOUND_PATH=$(find . -type f -name "pubspec.yaml" -not -path '*/.*' | head -n 1)
          
          if [ -z "$FOUND_PATH" ]; then
            echo "âš ï¸ í”„ë¡œì íŠ¸ ì—†ìŒ: ìžë™ ìƒì„± ëª¨ë“œ ì§„ìž…"
            echo "NEED_GENERATION=true" >> $GITHUB_ENV
            echo "MODE_TEXT=ìžë™ ìƒì„± (Auto-Gen)" >> $GITHUB_ENV
          else
            echo "âœ… í”„ë¡œì íŠ¸ ê°ì§€ë¨: $FOUND_PATH"
            echo "NEED_GENERATION=false" >> $GITHUB_ENV
            echo "FLUTTER_PROJECT_PATH=$(dirname "$FOUND_PATH")" >> $GITHUB_ENV
            echo "MODE_TEXT=ê¸°ì¡´ í”„ë¡œì íŠ¸ (Existing)" >> $GITHUB_ENV
          fi

      # 3. Java 17 ìˆ˜ë™ ì„¤ì¹˜ (AWS Corretto)
      - name: â˜• Java 17 ì„¤ì¹˜ (AWS Corretto)
        run: |
          echo "â¬‡ï¸ AWS Corretto 17 ë‹¤ìš´ë¡œë“œ ì¤‘..."
          JAVA_URL="https://corretto.aws/downloads/latest/amazon-corretto-17-x64-linux-jdk.tar.gz"
          curl -L -o java_jdk.tar.gz $JAVA_URL
          mkdir -p $HOME/java_jdk
          tar -xzf java_jdk.tar.gz -C $HOME/java_jdk --strip-components=1
          echo "JAVA_HOME=$HOME/java_jdk" >> $GITHUB_ENV
          echo "$HOME/java_jdk/bin" >> $GITHUB_PATH
          echo "âœ… Java ì„¤ì¹˜ ì™„ë£Œ."

      # 4. Flutter SDK ì„¤ì •
      - name: ðŸ¦ Flutter SDK ì„¤ì • (Stable)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true

      # 5. [í•µì‹¬] í”„ë¡œì íŠ¸ ìƒì„± ë° ì½”ë“œ ìˆ˜ì • (Deprecated ì œê±°)
      - name: ðŸ› ï¸ í”„ë¡œì íŠ¸ ìƒì„± ë° ë³´ì•ˆ ì½”ë“œ íŒ¨ì¹˜
        if: env.NEED_GENERATION == 'true'
        run: |
          mkdir -p scripts
          
          cat > scripts/init_project.sh <<-'EOF'
          #!/bin/bash
          set -e
          
          PROJECT_NAME="auto_enterprise_app"
          echo "ðŸš€ Generating project: $PROJECT_NAME"
          
          # 1. í”„ë¡œì íŠ¸ ìƒì„±
          flutter create $PROJECT_NAME
          cd $PROJECT_NAME
          
          # 2. íŒ¨í‚¤ì§€ ì¶”ê°€
          echo "ðŸ“¦ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜..."
          flutter pub add flutter_secure_storage
          flutter pub add dio
          flutter pub add provider
          flutter pub add get_it

          # 3. [Gradle Patch] Android MinSDK ë²„ì „ì„ 24ë¡œ ê°•ì œ ìƒí–¥ (ë¹Œë“œ ì—ëŸ¬ ë°©ì§€)
          echo "ðŸ”§ Android Gradle ì„¤ì • íŒ¨ì¹˜ ì¤‘..."
          GRADLE_FILE="android/app/build.gradle"
          
          if grep -q "minSdk =" "$GRADLE_FILE"; then
             sed -i 's/minSdk = .*/minSdk = 24/g' "$GRADLE_FILE"
          elif grep -q "minSdkVersion" "$GRADLE_FILE"; then
             sed -i 's/minSdkVersion .*/minSdkVersion 24/g' "$GRADLE_FILE"
          else
             sed -i 's/flutter.minSdkVersion/24/g' "$GRADLE_FILE"
          fi
          
          # compileSdk ìˆ˜ì • (34ë¡œ ê³ ì •)
          if grep -q "compileSdk =" "$GRADLE_FILE"; then
             sed -i 's/compileSdk = .*/compileSdk = 34/g' "$GRADLE_FILE"
          elif grep -q "compileSdkVersion" "$GRADLE_FILE"; then
             sed -i 's/compileSdkVersion .*/compileSdkVersion 34/g' "$GRADLE_FILE"
          else
             sed -i 's/flutter.compileSdkVersion/34/g' "$GRADLE_FILE"
          fi

          # 4. í´ë” êµ¬ì¡° ìƒì„±
          mkdir -p lib/core/security lib/core/network lib/features/auth/data lib/features/auth/presentation
          
          # 5. [FIX] ë³´ì•ˆ ì„œë¹„ìŠ¤ ì½”ë“œ ìˆ˜ì • (Deprecatedëœ encryptedSharedPreferences ì œê±°)
          # ì—ëŸ¬ ì›ì¸ì´ì—ˆë˜ íŒŒë¼ë¯¸í„°ë¥¼ ì‚­ì œí•˜ê³  í‘œì¤€ ì˜µì…˜ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
          cat > lib/core/security/security_service.dart <<INNER_EOF
          import 'package:flutter_secure_storage/flutter_secure_storage.dart';

          class SecurityService {
            final _storage = const FlutterSecureStorage();

            // [ìˆ˜ì •ë¨] encryptedSharedPreferences ì˜µì…˜ ì œê±° (Deprecated í•´ê²°)
            // resetOnError: true -> ë°ì´í„° ì†ìƒ ì‹œ ì´ˆê¸°í™”í•˜ì—¬ ì•± ì¶©ëŒ ë°©ì§€
            AndroidOptions _getAndroidOptions() => const AndroidOptions(
              resetOnError: true,
            );
            
            Future<void> save(String k, String v) async => 
              await _storage.write(key: k, value: v, aOptions: _getAndroidOptions());
              
            Future<String?> read(String k) async =>
              await _storage.read(key: k, aOptions: _getAndroidOptions());
          }
          INNER_EOF
          
          # 6. ë©”ì¸ UI ìž‘ì„±
          cat > lib/main.dart <<INNER_EOF
          import 'package:flutter/material.dart';
          void main() { runApp(const MyApp()); }
          class MyApp extends StatelessWidget {
            const MyApp({super.key});
            @override
            Widget build(BuildContext context) {
              return const MaterialApp(
                home: Scaffold(body: Center(child: Text("Security Patch Applied"))),
              );
            }
          }
          INNER_EOF

          # 7. í…ŒìŠ¤íŠ¸ ì½”ë“œ ë™ê¸°í™”
          cat > test/widget_test.dart <<INNER_EOF
          import 'package:flutter_test/flutter_test.dart';
          import 'package:auto_enterprise_app/main.dart';
          void main() {
            testWidgets('Smoke test', (WidgetTester tester) async {
              await tester.pumpWidget(const MyApp());
              expect(find.text('Security Patch Applied'), findsOneWidget);
            });
          }
          INNER_EOF
          
          EOF

          chmod +x scripts/init_project.sh
          ./scripts/init_project.sh
          
          echo "FLUTTER_PROJECT_PATH=$GITHUB_WORKSPACE/auto_enterprise_app" >> $GITHUB_ENV

      # 6. ì˜ì¡´ì„± ì—…ê·¸ë ˆì´ë“œ (ìµœì‹ í™”)
      - name: ðŸ†™ íŒ¨í‚¤ì§€ ì—…ê·¸ë ˆì´ë“œ
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter pub upgrade
          flutter pub get

      # 7. ì½”ë“œ ë¶„ì„ (Analyze Fix)
      - name: ðŸ” ì½”ë“œ ë¶„ì„ (ì •ë³´ì„± ê²½ê³  ë¬´ì‹œ)
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          # [ìˆ˜ì •] --no-fatal-infos ì˜µì…˜ì„ ì¶”ê°€í•˜ì—¬ Deprecated ê²½ê³ ê°€ ìžˆì–´ë„ ë¹Œë“œë¥¼ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ
          flutter analyze --no-fatal-infos

      # 8. í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
      - name: âœ… í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter test

      # 9. ë¹Œë“œ (APK)
      - name: ðŸ—ï¸ APK ë¹Œë“œ (Release)
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter build apk --release --build-number=${{ github.run_number }} --no-tree-shake-icons

      # 10. ê²°ê³¼ ë¦¬í¬íŠ¸ (Github Summary)
      - name: ðŸ“Š ë¹Œë“œ ê²°ê³¼ ë¦¬í¬íŠ¸
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ ì—”í„°í”„ë¼ì´ì¦ˆ ë§ˆìŠ¤í„° ë¹Œë“œ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ë‚´ìš© |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **ëª¨ë“œ** | ${{ env.MODE_TEXT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ë³´ì•ˆ íŒ¨ì¹˜** | Deprecated ì˜µì…˜ ì œê±° ì™„ë£Œ |" >> $GITHUB_STEP_SUMMARY
          echo "| **Gradle** | MinSDK 24 ì ìš©ë¨ |" >> $GITHUB_STEP_SUMMARY
          echo "| **ìƒíƒœ** | ${{ job.status == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‚ ê²°ê³¼ë¬¼" >> $GITHUB_STEP_SUMMARY
          echo "- \`app-release.apk\` (Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œ)" >> $GITHUB_STEP_SUMMARY

      # 11. ì„œë²„ ì „ì†¡
      - name: ðŸ“¡ ì •ë³´ ì„œë²„ ì „ì†¡
        if: always()
        run: |
          if [ -n "${{ secrets.INFO_SERVER_URL }}" ]; then
            curl -X POST -H "Content-Type: application/json" \
            -d '{"status":"${{ job.status }}", "version":"${{ github.run_number }}", "patch":"deprecated_removed"}' \
            ${{ secrets.INFO_SERVER_URL }}
          fi

      # 12. ì—…ë¡œë“œ
      - name: ðŸ“¤ APK ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: enterprise-master-v${{ github.run_number }}
          path: ${{ env.FLUTTER_PROJECT_PATH }}/build/app/outputs/flutter-apk/app-release.apk
          compression-level: 9
