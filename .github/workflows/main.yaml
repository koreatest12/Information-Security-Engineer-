name: Flutter Enterprise Generator & Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  generate_and_build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Source
        uses: actions/checkout@v4

      # 2. Java í™˜ê²½ ì„¤ì • (Android ë¹Œë“œ í•„ìˆ˜)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3. Flutter í™˜ê²½ ì„¤ì • (ê³µì‹ êµ¬ê¸€ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš© & ìºì‹±)
      # ìŠ¤í¬ë¦½íŠ¸ì˜ ìˆ˜ë™ ë‹¤ìš´ë¡œë“œ ëŒ€ì‹ , ë” ë¹ ë¥´ê³  ì•ˆì •ì ì¸ ê³µì‹ ì•¡ì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true

      # 4. [í•µì‹¬] í”„ë¡œì íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (User Script Integration)
      # ì €ì¥ì†Œì— pubspec.yamlì´ ì—†ìœ¼ë©´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ í”„ë¡œì íŠ¸ë¥¼ ì¦‰ì„ì—ì„œ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤.
      - name: Execute Project Generator Script
        id: generator
        run: |
          # 1. ê¸°ì¡´ í”„ë¡œì íŠ¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          EXISTING_PUBSPEC=$(find . -type f -name "pubspec.yaml" -not -path '*/.*' | head -n 1)

          if [ -n "$EXISTING_PUBSPEC" ]; then
            echo "âœ… ê¸°ì¡´ í”„ë¡œì íŠ¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤: $EXISTING_PUBSPEC"
            PROJECT_DIR=$(dirname "$EXISTING_PUBSPEC")
            echo "FLUTTER_PROJECT_PATH=$PROJECT_DIR" >> $GITHUB_ENV
            echo "MODE=EXISTING" >> $GITHUB_ENV
          else
            echo "âš ï¸ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. 'ìŠ¤í¬ë¦½íŠ¸'ë¥¼ ì‹¤í–‰í•˜ì—¬ ìƒì„± ëª¨ë“œë¡œ ì§„ì…í•©ë‹ˆë‹¤."
            
            # --- [User Script Start] ---
            PROJECT_NAME="my_enterprise_app"
            echo "ğŸ› ï¸ [Step 1] '$PROJECT_NAME' í”„ë¡œì íŠ¸ ìƒì„± ì¤‘..."
            flutter create $PROJECT_NAME
            
            echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™..."
            cd $PROJECT_NAME
            
            echo "ğŸ“¦ [Step 2] ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì¶”ê°€..."
            flutter pub add flutter_secure_storage # ì•”í˜¸í™”
            flutter pub add dio # ë„¤íŠ¸ì›Œí¬
            flutter pub add provider # ìƒíƒœ ê´€ë¦¬
            flutter pub add get_it # ì˜ì¡´ì„± ì£¼ì…

            echo "ğŸ“‚ [Step 3] í´ë” êµ¬ì¡° ì¬í¸ (Clean Architecture)..."
            mkdir -p lib/core/network
            mkdir -p lib/core/security
            mkdir -p lib/features/auth/data
            mkdir -p lib/features/auth/presentation
            mkdir -p lib/shared

            echo "ğŸ“ [Step 4] í•µì‹¬ íŒŒì¼ ë° ì•”í˜¸í™” ëª¨ë“ˆ ìë™ ìƒì„±..."
            
            # (A) ë³´ì•ˆ ì €ì¥ì†Œ ìœ í‹¸ë¦¬í‹°
            cat <<EOF > lib/core/security/secure_storage.dart
            import 'package:flutter_secure_storage/flutter_secure_storage.dart';

            class SecurityService {
              final _storage = const FlutterSecureStorage();

              Future<void> saveToken(String key, String value) async {
                await _storage.write(key: key, value: value);
              }

              Future<String?> getToken(String key) async {
                return await _storage.read(key: key);
              }
            }
            EOF

            # (B) ë©”ì¸ ì•± ì§„ì…ì 
            cat <<EOF > lib/main.dart
            import 'package:flutter/material.dart';

            void main() {
              WidgetsFlutterBinding.ensureInitialized();
              runApp(const MyApp());
            }

            class MyApp extends StatelessWidget {
              const MyApp({super.key});

              @override
              Widget build(BuildContext context) {
                return MaterialApp(
                  title: 'Enterprise App',
                  theme: ThemeData(primarySwatch: Colors.blue, useMaterial3: true),
                  home: const Scaffold(
                    body: Center(child: Text("Security & Server Setup Complete")),
                  ),
                );
              }
            }
            EOF
            
            echo "âœ¨ í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œ!"
            # --- [User Script End] ---

            # ìƒì„±ëœ ê²½ë¡œë¥¼ í™˜ê²½ë³€ìˆ˜ì— ë“±ë¡í•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ë“¤ì´ ì¸ì‹í•˜ê²Œ í•¨
            # $GITHUB_WORKSPACEëŠ” ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì˜ ë£¨íŠ¸ ê²½ë¡œì…ë‹ˆë‹¤.
            echo "FLUTTER_PROJECT_PATH=$GITHUB_WORKSPACE/$PROJECT_NAME" >> $GITHUB_ENV
            echo "MODE=GENERATED" >> $GITHUB_ENV
          fi

      # 5. ì˜ì¡´ì„± ì„¤ì¹˜ (ìë™ ê°ì§€ëœ ê²½ë¡œ ì‚¬ìš©)
      - name: Install Dependencies
        run: |
          echo "Current Path: ${{ env.FLUTTER_PROJECT_PATH }}"
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter pub get

      # 6. ì½”ë“œ ë¶„ì„
      - name: Analyze Code
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter analyze

      # 7. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run Tests
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter test

      # 8. [ì—…ë°ì´íŠ¸ ê¸°ëŠ¥] ìë™ ë²„ì „ ì¦ê°€ ë¹Œë“œ
      - name: Build Android APK
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter build apk --release --build-number=${{ github.run_number }}

      # 9. [ì •ë³´ ìˆ˜ì§‘ ì„œë²„] ë¹Œë“œ ê²°ê³¼ ì „ì†¡ (Webhook)
      - name: Report Status to Info Server
        if: always()
        run: |
          STATUS="${{ job.status }}"
          BUILD_NUM="${{ github.run_number }}"
          MODE="${{ env.MODE }}"
          
          echo "ğŸ“¡ Reporting to server..."
          
          # JSON ë°ì´í„° êµ¬ì„±
          JSON_PAYLOAD=$(cat <<EOF
          {
            "build_id": "${{ github.run_id }}",
            "status": "$STATUS",
            "version": "$BUILD_NUM",
            "mode": "$MODE",
            "repo": "${{ github.repository }}"
          }
          EOF
          )
          
          # ì„œë²„ URLì´ Secretsì— ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ ì „ì†¡
          if [ -n "${{ secrets.INFO_SERVER_URL }}" ]; then
            curl -X POST -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            ${{ secrets.INFO_SERVER_URL }}
            echo "âœ… Data sent."
          else
            echo "â„¹ï¸ INFO_SERVER_URL ì‹œí¬ë¦¿ì´ ì—†ì–´ ì „ì†¡ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      # 10. ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ìƒì„±ëœ APK)
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: enterprise-app-v${{ github.run_number }}
          path: ${{ env.FLUTTER_PROJECT_PATH }}/build/app/outputs/flutter-apk/app-release.apk
          compression-level: 9
