name: Flutter Enterprise CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    # [에러 수정 핵심] Flutter 프로젝트가 루트가 아닌 하위 폴더에 있다면 아래 경로를 수정하세요.
    # 예: 프로젝트가 'myapp' 폴더 안에 있다면 './myapp'으로 변경
    # 현재 에러는 이 설정이 없어서 발생했습니다.
    defaults:
      run:
        working-directory: ./

    steps:
      # 1. 소스 코드 가져오기 (v4 업데이트)
      - name: Checkout Source
        uses: actions/checkout@v4

      # 2. Java 환경 설정 (안드로이드 빌드용)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3. Flutter 환경 설정 및 [속도 향상] 캐시 활성화
      # cache: true 옵션이 라이브러리 다운로드 속도를 비약적으로 높여줍니다.
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true 

      # 4. 의존성 설치 (에러가 발생했던 구간 해결됨)
      - name: Install Dependencies
        run: flutter pub get

      # 5. 정적 분석 (코드 품질)
      - name: Analyze Code
        run: flutter analyze

      # 6. 테스트 실행
      - name: Run Tests
        run: flutter test

      # 7. [업데이트 기능] 빌드 번호 자동 증가 및 APK 생성
      # github.run_number를 사용하여 빌드할 때마다 버전 코드가 자동으로 1, 2, 3... 증가합니다.
      # 앱 업데이트 시 충돌을 방지합니다.
      - name: Build Android APK (Auto Versioning)
        run: flutter build apk --release --build-number=${{ github.run_number }}

      # 8. [정보 수집 서버] 빌드 결과 전송 (Webhook)
      # 빌드가 성공하면 귀하의 정보 수집 서버로 알림을 보냅니다.
      # Settings > Secrets에 'INFO_SERVER_URL'을 등록해야 합니다. (없으면 echo로 대체됨)
      - name: Send Build Status to Info Server
        if: always() # 성공/실패 상관없이 실행
        run: |
          echo "Sending build data to Info Server..."
          # 실제 서버가 있다면 아래 주석을 해제하고 Secrets를 설정하세요.
          # curl -X POST -H "Content-Type: application/json" \
          # -d '{"build_id": "${{ github.run_id }}", "status": "${{ job.status }}", "version": "${{ github.run_number }}"}' \
          # ${{ secrets.INFO_SERVER_URL }}

      # 9. 빌드 결과물 업로드 (v4 업데이트)
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-v${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          compression-level: 9 # [속도 vs 용량] 전송 속도를 위해 압축 최적화
