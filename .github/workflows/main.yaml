name: Flutter Enterprise CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_deploy:
    runs-on: ubuntu-latest

    # [!!!중요 수정 포인트!!!]
    # 본인의 Flutter 프로젝트가 있는 '폴더 이름'을 아래 ./ 뒤에 적어주세요.
    # 예: 저장소 안에 'my_app' 폴더가 있다면 -> './my_app'
    # 예: 최상위에 있다면 -> './' 그대로 두세요.
    defaults:
      run:
        working-directory: ./YOUR_PROJECT_FOLDER_NAME

    steps:
      # 1. 소스 코드 체크아웃 (v4 최신)
      - name: Checkout Source
        uses: actions/checkout@v4

      # 2. Java 세팅 (Android 빌드용)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3. Flutter 세팅 및 [속도 향상] 캐시 적용
      # cache: true 옵션이 켜져 있어 2번째 빌드부터 속도가 매우 빨라집니다.
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true

      # 4. 의존성 설치 (위에서 설정한 폴더에서 실행됨)
      - name: Install Dependencies
        run: flutter pub get

      # 5. [업데이트 기능] 자동 버전 넘버링 빌드
      # github.run_number를 사용하여 빌드할 때마다 앱 버전 코드가 1씩 자동 증가합니다.
      - name: Build Android APK (Auto Versioning)
        run: flutter build apk --release --build-number=${{ github.run_number }}

      # 6. [정보 수집 서버] 빌드 상태 전송 (Webhook)
      # 빌드 성공/실패 여부를 외부 서버로 전송합니다.
      # Github Settings > Secrets에 'INFO_SERVER_URL'을 등록하지 않으면 로그만 출력하고 넘어갑니다.
      - name: Report Status to Info Server
        if: always() # 실패해도 실행됨
        run: |
          echo "Sending build report..."
          STATUS="${{ job.status }}"
          BUILD_NUM="${{ github.run_number }}"
          
          # 실제 전송 로직 (URL이 설정된 경우에만 작동)
          if [ -n "${{ secrets.INFO_SERVER_URL }}" ]; then
            curl -X POST -H "Content-Type: application/json" \
            -d "{\"status\": \"$STATUS\", \"build_number\": \"$BUILD_NUM\", \"repo\": \"${{ github.repository }}\"}" \
            ${{ secrets.INFO_SERVER_URL }}
          else
            echo "No INFO_SERVER_URL secret found. Skipping webhook."
          fi

      # 7. 결과물 업로드 (v4 최신)
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-v${{ github.run_number }}
          path: |
            **/build/app/outputs/flutter-apk/app-release.apk
          compression-level: 9 # 전송 속도 최적화
