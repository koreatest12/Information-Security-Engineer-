name: Enterprise Upgrade & Fix Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  enterprise_fix_build:
    name: ðŸ›¡ï¸ ì—”í„°í”„ë¼ì´ì¦ˆ ì—…ê·¸ë ˆì´ë“œ ë° ë¹Œë“œ
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ðŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ë‚´ë ¤ë°›ê¸°
        uses: actions/checkout@v4

      # 2. í”„ë¡œì íŠ¸ ìƒíƒœ ê°ì§€
      - name: ðŸ” í”„ë¡œì íŠ¸ ìƒíƒœ ê°ì§€
        id: check
        run: |
          FOUND_PATH=$(find . -type f -name "pubspec.yaml" -not -path '*/.*' | head -n 1)
          
          if [ -z "$FOUND_PATH" ]; then
            echo "âš ï¸ í”„ë¡œì íŠ¸ ì—†ìŒ: ìžë™ ìƒì„± ëª¨ë“œ"
            echo "NEED_GENERATION=true" >> $GITHUB_ENV
            echo "MODE_TEXT=ìžë™ ìƒì„± + ì—…ê·¸ë ˆì´ë“œ" >> $GITHUB_ENV
          else
            echo "âœ… í”„ë¡œì íŠ¸ ê°ì§€ë¨: $FOUND_PATH"
            echo "NEED_GENERATION=false" >> $GITHUB_ENV
            echo "FLUTTER_PROJECT_PATH=$(dirname "$FOUND_PATH")" >> $GITHUB_ENV
            echo "MODE_TEXT=ê¸°ì¡´ ìœ ì§€ + ì—…ê·¸ë ˆì´ë“œ" >> $GITHUB_ENV
          fi

      # 3. Java 17 ìˆ˜ë™ ì„¤ì¹˜ (AWS Corretto)
      - name: â˜• Java 17 ì„¤ì¹˜ (AWS Corretto)
        run: |
          echo "â¬‡ï¸ Downloading Java 17..."
          JAVA_URL="https://corretto.aws/downloads/latest/amazon-corretto-17-x64-linux-jdk.tar.gz"
          curl -L -o java_jdk.tar.gz $JAVA_URL
          mkdir -p $HOME/java_jdk
          tar -xzf java_jdk.tar.gz -C $HOME/java_jdk --strip-components=1
          echo "JAVA_HOME=$HOME/java_jdk" >> $GITHUB_ENV
          echo "$HOME/java_jdk/bin" >> $GITHUB_PATH
          echo "âœ… Java Setup Complete."

      # 4. Flutter SDK ì„¤ì •
      - name: ðŸ¦ Flutter SDK ì„¤ì • (Stable & Cache)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true

      # 5. [í•µì‹¬] í”„ë¡œì íŠ¸ ìƒì„± ë° Android Gradle ê¸´ê¸‰ ìˆ˜ì •
      - name: ðŸ› ï¸ í”„ë¡œì íŠ¸ ìƒì„± ë° ì—ëŸ¬ íŒ¨ì¹˜ (Gradle Fix)
        if: env.NEED_GENERATION == 'true'
        run: |
          mkdir -p scripts
          
          cat > scripts/init_project.sh <<-'EOF'
          #!/bin/bash
          set -e
          
          PROJECT_NAME="auto_enterprise_app"
          echo "ðŸš€ Generating project: $PROJECT_NAME"
          
          # 1. í”„ë¡œì íŠ¸ ìƒì„±
          flutter create $PROJECT_NAME
          cd $PROJECT_NAME
          
          # 2. íŒ¨í‚¤ì§€ ì¶”ê°€
          echo "ðŸ“¦ Installing Dependencies..."
          flutter pub add flutter_secure_storage
          flutter pub add dio
          flutter pub add provider
          flutter pub add get_it

          # 3. [ì—ëŸ¬ ìˆ˜ì •] Android build.gradle ë²„ì „ ê°•ì œ ìƒí–¥
          # flutter_secure_storageëŠ” minSdkVersion 24 ì´ìƒì„ ìš”êµ¬í•¨ (ê¸°ë³¸ 21)
          # sed ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ë‚´ìš©ì„ ì§ì ‘ ìˆ˜ì •í•©ë‹ˆë‹¤.
          echo "ðŸ”§ Patching Android build.gradle for SDK 35/MinSdk 24..."
          
          GRADLE_FILE="android/app/build.gradle"
          
          # minSdkVersion ìˆ˜ì • (21 -> 24)
          if grep -q "minSdk =" "$GRADLE_FILE"; then
             sed -i 's/minSdk = .*/minSdk = 24/g' "$GRADLE_FILE"
          elif grep -q "minSdkVersion" "$GRADLE_FILE"; then
             sed -i 's/minSdkVersion .*/minSdkVersion 24/g' "$GRADLE_FILE"
          else
             # ìµœì‹  Flutter í…œí”Œë¦¿ ëŒ€ì‘
             sed -i 's/flutter.minSdkVersion/24/g' "$GRADLE_FILE"
          fi
          
          # compileSdk ìˆ˜ì • (ê¸°ë³¸ -> 34 ì´ìƒ)
          if grep -q "compileSdk =" "$GRADLE_FILE"; then
             sed -i 's/compileSdk = .*/compileSdk = 34/g' "$GRADLE_FILE"
          elif grep -q "compileSdkVersion" "$GRADLE_FILE"; then
             sed -i 's/compileSdkVersion .*/compileSdkVersion 34/g' "$GRADLE_FILE"
          else
             sed -i 's/flutter.compileSdkVersion/34/g' "$GRADLE_FILE"
          fi

          echo "âœ… Gradle Patch Applied."

          # 4. í´ë” êµ¬ì¡° ë° íŒŒì¼ ìƒì„±
          mkdir -p lib/core/security lib/core/network lib/features/auth/data lib/features/auth/presentation
          
          # Security Service
          cat > lib/core/security/security_service.dart <<INNER_EOF
          import 'package:flutter_secure_storage/flutter_secure_storage.dart';
          class SecurityService {
            final _storage = const FlutterSecureStorage();
            AndroidOptions _getAndroidOptions() => const AndroidOptions(encryptedSharedPreferences: true);
            
            Future<void> save(String k, String v) async => 
              await _storage.write(key: k, value: v, aOptions: _getAndroidOptions());
          }
          INNER_EOF
          
          # Main UI
          cat > lib/main.dart <<INNER_EOF
          import 'package:flutter/material.dart';
          void main() { runApp(const MyApp()); }
          class MyApp extends StatelessWidget {
            const MyApp({super.key});
            @override
            Widget build(BuildContext context) {
              return const MaterialApp(
                home: Scaffold(body: Center(child: Text("Enterprise App v2.0"))),
              );
            }
          }
          INNER_EOF

          # Test Fix
          cat > test/widget_test.dart <<INNER_EOF
          import 'package:flutter_test/flutter_test.dart';
          import 'package:auto_enterprise_app/main.dart';
          void main() {
            testWidgets('Smoke test', (WidgetTester tester) async {
              await tester.pumpWidget(const MyApp());
              expect(find.text('Enterprise App v2.0'), findsOneWidget);
            });
          }
          INNER_EOF
          
          EOF

          chmod +x scripts/init_project.sh
          ./scripts/init_project.sh
          
          echo "FLUTTER_PROJECT_PATH=$GITHUB_WORKSPACE/auto_enterprise_app" >> $GITHUB_ENV

      # 6. [ì¶”ê°€ ìš”ì²­] ì—…ê·¸ë ˆì´ë“œ ê¸°ëŠ¥ (Pub Upgrade)
      - name: ðŸ†™ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì—…ê·¸ë ˆì´ë“œ
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          echo "ðŸ“¦ íŒ¨í‚¤ì§€ ë²„ì „ì„ ìµœì‹ ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•©ë‹ˆë‹¤..."
          flutter pub upgrade
          flutter pub outdated

      # 7. ì˜ì¡´ì„± ê°€ì ¸ì˜¤ê¸°
      - name: ðŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜ (Pub Get)
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter pub get

      # 8. ì½”ë“œ ë¶„ì„
      - name: ðŸ” ì½”ë“œ ë¶„ì„ (Analyze)
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter analyze

      # 9. í…ŒìŠ¤íŠ¸
      - name: âœ… í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter test

      # 10. ë¹Œë“œ (APK)
      - name: ðŸ—ï¸ ì•ˆë“œë¡œì´ë“œ APK ë¹Œë“œ
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          # --no-tree-shake-icons ì˜µì…˜ìœ¼ë¡œ í°íŠ¸ ê²½ê³  ë°©ì§€
          flutter build apk --release --build-number=${{ github.run_number }} --no-tree-shake-icons

      # 11. ë¹Œë“œ ê²°ê³¼ ë¦¬í¬íŠ¸ (í™”ë©´ ì¶œë ¥)
      - name: ðŸ“Š ë¹Œë“œ ê²°ê³¼ ë¦¬í¬íŠ¸
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ ì—”í„°í”„ë¼ì´ì¦ˆ ë¹Œë“œ ê²°ê³¼ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ë‚´ìš© |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **ëª¨ë“œ** | ${{ env.MODE_TEXT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **íŒ¨ì¹˜** | Android MinSDK 24+ ì ìš©ë¨ |" >> $GITHUB_STEP_SUMMARY
          echo "| **ì—…ê·¸ë ˆì´ë“œ** | Flutter Pub Upgrade ì™„ë£Œ |" >> $GITHUB_STEP_SUMMARY
          echo "| **ìƒíƒœ** | ${{ job.status == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ê²°ê³¼ë¬¼" >> $GITHUB_STEP_SUMMARY
          echo "- \`app-release.apk\` (Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œ)" >> $GITHUB_STEP_SUMMARY

      # 12. ì„œë²„ ì „ì†¡
      - name: ðŸ“¡ ì •ë³´ ì„œë²„ ì „ì†¡
        if: always()
        run: |
          if [ -n "${{ secrets.INFO_SERVER_URL }}" ]; then
            curl -X POST -H "Content-Type: application/json" \
            -d '{"status":"${{ job.status }}", "version":"${{ github.run_number }}", "upgrade":"true"}' \
            ${{ secrets.INFO_SERVER_URL }}
          fi

      # 13. ì—…ë¡œë“œ
      - name: ðŸ“¤ APK ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: enterprise-upgrade-v${{ github.run_number }}
          path: ${{ env.FLUTTER_PROJECT_PATH }}/build/app/outputs/flutter-apk/app-release.apk
          compression-level: 9
