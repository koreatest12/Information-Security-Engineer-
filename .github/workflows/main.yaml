name: Perfect Enterprise Generator & Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  auto_generate_build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Source
        uses: actions/checkout@v4

      # 2. í”„ë¡œì íŠ¸ ì¡´ì¬ ì—¬ë¶€ ê°ì§€
      - name: Detect Project Status
        id: check
        run: |
          # pubspec.yaml ì°¾ê¸°
          FOUND_PATH=$(find . -type f -name "pubspec.yaml" -not -path '*/.*' | head -n 1)
          
          if [ -z "$FOUND_PATH" ]; then
            echo "âš ï¸ No project found. Scripts generation mode activated."
            echo "NEED_GENERATION=true" >> $GITHUB_ENV
          else
            echo "âœ… Project found at $FOUND_PATH"
            echo "NEED_GENERATION=false" >> $GITHUB_ENV
            echo "FLUTTER_PROJECT_PATH=$(dirname "$FOUND_PATH")" >> $GITHUB_ENV
          fi

      # 3. Java í™˜ê²½ ì„¤ì •
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 4. Flutter í™˜ê²½ ì„¤ì •
      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true

      # 5. [ëŒ€ëŸ‰ ìˆ˜ì •] ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° í…ŒìŠ¤íŠ¸ ì½”ë“œ(Test) ë™ê¸°í™”
      - name: Create and Run Generation Script
        if: env.NEED_GENERATION == 'true'
        run: |
          echo "ğŸ“‚ Creating 'scripts' directory..."
          mkdir -p scripts
          
          # scripts/init_project.sh ì‘ì„±
          cat > scripts/init_project.sh <<-'EOF'
          #!/bin/bash
          set -e
          
          PROJECT_NAME="auto_enterprise_app"
          echo "ğŸš€ Generating project: $PROJECT_NAME"
          
          # í”„ë¡œì íŠ¸ ìƒì„±
          flutter create $PROJECT_NAME
          cd $PROJECT_NAME
          
          # íŒ¨í‚¤ì§€ ì¶”ê°€
          flutter pub add flutter_secure_storage
          flutter pub add dio
          flutter pub add provider
          flutter pub add get_it

          # êµ¬ì¡° ìƒì„±
          mkdir -p lib/core/security lib/core/network lib/features/auth/data lib/features/auth/presentation
          
          # [1] ë³´ì•ˆ íŒŒì¼ ìƒì„±
          cat > lib/core/security/security_service.dart <<INNER_EOF
          import 'package:flutter_secure_storage/flutter_secure_storage.dart';
          class SecurityService {
            final _storage = const FlutterSecureStorage();
            Future<void> save(String k, String v) async => await _storage.write(key: k, value: v);
          }
          INNER_EOF
          
          # [2] ë©”ì¸ íŒŒì¼ ìƒì„± (í™”ë©´ ë‚´ìš©: "Auto Generated")
          cat > lib/main.dart <<INNER_EOF
          import 'package:flutter/material.dart';
          void main() { runApp(const MyApp()); }
          
          class MyApp extends StatelessWidget {
            const MyApp({super.key});
            @override
            Widget build(BuildContext context) {
              return const MaterialApp(
                home: Scaffold(body: Center(child: Text("Auto Generated"))),
              );
            }
          }
          INNER_EOF

          # [3] í…ŒìŠ¤íŠ¸ íŒŒì¼ ìˆ˜ì • (ì¤‘ìš”: ì—ëŸ¬ í•´ê²° í¬ì¸íŠ¸)
          # ê¸°ë³¸ í…ŒìŠ¤íŠ¸ëŠ” ì¹´ìš´í„° ì•±ì„ ì°¾ìœ¼ë¯€ë¡œ ì‚­ì œí•˜ê³ , í˜„ì¬ UI("Auto Generated")ë¥¼ ì°¾ëŠ” í…ŒìŠ¤íŠ¸ë¡œ êµì²´
          cat > test/widget_test.dart <<INNER_EOF
          import 'package:flutter_test/flutter_test.dart';
          import 'package:auto_enterprise_app/main.dart';

          void main() {
            testWidgets('App launch smoke test', (WidgetTester tester) async {
              // ì•± ì‹¤í–‰
              await tester.pumpWidget(const MyApp());

              // "Auto Generated"ë¼ëŠ” í…ìŠ¤íŠ¸ê°€ í™”ë©´ì— ìˆëŠ”ì§€ ê²€ì‚¬
              expect(find.text('Auto Generated'), findsOneWidget);
            });
          }
          INNER_EOF
          
          echo "âœ… Script execution finished & Test file updated."
          EOF

          # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° ì‹¤í–‰
          chmod +x scripts/init_project.sh
          ./scripts/init_project.sh
          
          # ê²½ë¡œ í™˜ê²½ë³€ìˆ˜ ë“±ë¡
          echo "FLUTTER_PROJECT_PATH=$GITHUB_WORKSPACE/auto_enterprise_app" >> $GITHUB_ENV

      # 6. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Dependencies
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter pub get

      # 7. ì½”ë“œ ë¶„ì„
      - name: Analyze Code
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter analyze

      # 8. í…ŒìŠ¤íŠ¸ (ì´ì œ ì„±ê³µí•¨)
      - name: Run Tests
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter test

      # 9. ë¹Œë“œ (ìë™ ë²„ì „ ì—…)
      - name: Build Android APK
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter build apk --release --build-number=${{ github.run_number }}

      # 10. ì •ë³´ ìˆ˜ì§‘ ì„œë²„ ì „ì†¡
      - name: Report Status
        if: always()
        run: |
          JSON_DATA='{"status": "'"${{ job.status }}"'", "version": "'"${{ github.run_number }}"'"}'
          
          if [ -n "${{ secrets.INFO_SERVER_URL }}" ]; then
            curl -X POST -H "Content-Type: application/json" -d "$JSON_DATA" ${{ secrets.INFO_SERVER_URL }}
          else
            echo "Skipping webhook (No Secret)."
          fi

      # 11. ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: generated-app-v${{ github.run_number }}
          path: ${{ env.FLUTTER_PROJECT_PATH }}/build/app/outputs/flutter-apk/app-release.apk
          compression-level: 9
