name: Flutter Ultimate CI/CD (Debug Mode)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  diagnostic_build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Source
        uses: actions/checkout@v4

      # 2. [9999% ê°•ë ¥í•œ ê¸°ëŠ¥] íŒŒì¼ ì‹œìŠ¤í…œ ì§„ë‹¨ ë° ê²½ë¡œ ìë™ í™•ì •
      # íŒŒì¼ì´ ì—†ìœ¼ë©´ ì „ì²´ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ì¶œë ¥í•˜ì—¬ ì›ì¸ì„ ë°í˜€ëƒ…ë‹ˆë‹¤.
      - name: Diagnostic & Auto-Detect Path
        id: detect
        run: |
          echo "ğŸ” Searching for pubspec.yaml..."
          
          # pubspec.yaml íŒŒì¼ ì°¾ê¸° (ìˆ¨ê¹€ í´ë” ì œì™¸)
          FOUND_PATH=$(find . -type f -name "pubspec.yaml" -not -path '*/.*' | head -n 1)

          if [ -z "$FOUND_PATH" ]; then
            echo "âŒ ERROR: pubspec.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "ğŸ“‚ [í˜„ì¬ ì €ì¥ì†Œ íŒŒì¼ ëª©ë¡ ì „ì²´ ì¶œë ¥]"
            ls -R
            echo "--------------------------------------"
            echo "âš ï¸ í•´ê²°ì±…: pubspec.yaml íŒŒì¼ì´ Gitì— ì»¤ë°‹ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi

          # ê²½ë¡œ ì¶”ì¶œ
          PROJECT_DIR=$(dirname "$FOUND_PATH")
          echo "âœ… Project found at: $PROJECT_DIR"
          
          # í™˜ê²½ ë³€ìˆ˜ ì €ì¥ (ì´í›„ ë‹¨ê³„ì—ì„œ ì‚¬ìš©)
          echo "FLUTTER_PROJECT_PATH=$PROJECT_DIR" >> $GITHUB_ENV

      # 3. [ê¶Œí•œ ì„¤ì •] ì‹¤í–‰ íŒŒì¼ ê¶Œí•œ ê°•ì œ ë¶€ì—¬ (ë³´ì•ˆ/ê¶Œí•œ ë¬¸ì œ í•´ê²°)
      - name: Fix Permissions
        run: |
          echo "ğŸ”§ Fixing permissions in ${{ env.FLUTTER_PROJECT_PATH }}..."
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          if [ -d "android" ]; then
            chmod +x android/gradlew
            echo "âœ… android/gradlew permissions set."
          fi

      # 4. Java ì„¤ì¹˜ (ì„œë²„ ì¤€ë¹„ ì‚¬í•­)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 5. Flutter ì„¤ì¹˜ ë° [ì†ë„ ì¦ê°€] ìºì‹œ ì ìš©
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true

      # 6. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Dependencies
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter pub get

      # 7. ì½”ë“œ ë¶„ì„
      - name: Analyze Code
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter analyze

      # 8. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run Tests
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter test

      # 9. [ì—…ë°ì´íŠ¸ ê¸°ëŠ¥] ìë™ ë²„ì „ ë„˜ë²„ë§ ë¹Œë“œ
      # github.run_numberë¥¼ ì´ìš©í•´ ë¹Œë“œ ë²ˆí˜¸ë¥¼ 1, 2, 3... ìë™ìœ¼ë¡œ ì¦ê°€
      - name: Build Android APK (Auto Versioning)
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter build apk --release --build-number=${{ github.run_number }}

      # 10. [ì •ë³´ ìˆ˜ì§‘ ì„œë²„] ê²°ê³¼ ì „ì†¡ (ì•”í˜¸í™”/ë³´ì•ˆ ê³ ë ¤)
      - name: Report Status to Info Server
        if: always()
        run: |
          STATUS="${{ job.status }}"
          BUILD_NUM="${{ github.run_number }}"
          PROJECT_PATH="${{ env.FLUTTER_PROJECT_PATH }}"
          
          # JSON ë°ì´í„° êµ¬ì„±
          JSON_DATA=$(cat <<EOF
          {
            "status": "$STATUS",
            "build_number": "$BUILD_NUM",
            "repo": "${{ github.repository }}",
            "path": "$PROJECT_PATH"
          }
          EOF
          )

          if [ -n "${{ secrets.INFO_SERVER_URL }}" ]; then
            echo "ğŸ“¡ Sending secure data to server..."
            curl -X POST -H "Content-Type: application/json" \
            -d "$JSON_DATA" \
            ${{ secrets.INFO_SERVER_URL }}
          else
            echo "â„¹ï¸ INFO_SERVER_URL Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì „ì†¡ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      # 11. ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-v${{ github.run_number }}
          path: ${{ env.FLUTTER_PROJECT_PATH }}/build/app/outputs/flutter-apk/app-release.apk
          compression-level: 9
