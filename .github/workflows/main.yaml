name: Fixed Enterprise Generator & Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_process:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Source
        uses: actions/checkout@v4

      # 2. í”„ë¡œì íŠ¸ ì¡´ì¬ ì—¬ë¶€ íŒë‹¨ (ì‰˜ ë¡œì§ ë‹¨ìˆœí™”)
      - name: Check Project Status
        id: check
        run: |
          # pubspec.yaml íŒŒì¼ ì°¾ê¸°
          FOUND_PATH=$(find . -type f -name "pubspec.yaml" -not -path '*/.*' | head -n 1)
          
          if [ -z "$FOUND_PATH" ]; then
            echo "âš ï¸ No project found."
            echo "SHOULD_GENERATE=true" >> $GITHUB_ENV
            echo "FLUTTER_PROJECT_PATH=$GITHUB_WORKSPACE/auto_generated_app" >> $GITHUB_ENV
          else
            echo "âœ… Project found at $FOUND_PATH"
            echo "SHOULD_GENERATE=false" >> $GITHUB_ENV
            echo "FLUTTER_PROJECT_PATH=$(dirname "$FOUND_PATH")" >> $GITHUB_ENV
          fi

      # 3. Java ì„¤ì •
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 4. Flutter ì„¤ì •
      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true

      # 5. [ìˆ˜ì • ì™„ë£Œ] í”„ë¡œì íŠ¸ ìë™ ìƒì„± (ë…ë¦½ëœ ë‹¨ê³„ë¡œ ë¶„ë¦¬í•˜ì—¬ EOF ì—ëŸ¬ í•´ê²°)
      - name: Generate Project Structure
        if: env.SHOULD_GENERATE == 'true'
        run: |
          echo "ğŸš€ Starting Project Generation..."
          PROJECT_NAME="auto_generated_app"
          
          # í”„ë¡œì íŠ¸ ìƒì„±
          flutter create $PROJECT_NAME
          
          cd $PROJECT_NAME
          
          # íŒ¨í‚¤ì§€ ì¶”ê°€
          flutter pub add flutter_secure_storage
          flutter pub add dio
          flutter pub add provider
          flutter pub add get_it

          # í´ë” êµ¬ì¡° ìƒì„±
          mkdir -p lib/core/network
          mkdir -p lib/core/security
          mkdir -p lib/features/auth/data
          mkdir -p lib/features/auth/presentation
          mkdir -p lib/shared

          echo "ğŸ“ Writing Security Module..."
          
          # [EOF ì—ëŸ¬ ìˆ˜ì • í¬ì¸íŠ¸] 
          # ë“¤ì—¬ì“°ê¸°ë¥¼ ë¬´ì‹œí•˜ë„ë¡ <<-EOFë¥¼ ì‚¬ìš©í•˜ê³ , EOF ìœ„ì¹˜ë¥¼ ì •í™•íˆ ë§ì¶¤
          cat > lib/core/security/security_service.dart <<-'EOF'
          import 'package:flutter_secure_storage/flutter_secure_storage.dart';

          class SecurityService {
            final _storage = const FlutterSecureStorage();

            Future<void> saveToken(String key, String value) async {
              await _storage.write(key: key, value: value);
            }

            Future<String?> getToken(String key) async {
              return await _storage.read(key: key);
            }
          }
          EOF

          echo "ğŸ“ Writing Main Entry Point..."
          cat > lib/main.dart <<-'EOF'
          import 'package:flutter/material.dart';

          void main() {
            WidgetsFlutterBinding.ensureInitialized();
            runApp(const MyApp());
          }

          class MyApp extends StatelessWidget {
            const MyApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'Enterprise App',
                theme: ThemeData(primarySwatch: Colors.blue, useMaterial3: true),
                home: const Scaffold(
                  body: Center(child: Text("Security Setup Complete")),
                ),
              );
            }
          }
          EOF
          
          echo "âœ… Generation Complete."

      # 6. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Dependencies
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter pub get

      # 7. ì½”ë“œ ë¶„ì„
      - name: Analyze Code
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter analyze

      # 8. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run Tests
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter test

      # 9. ë¹Œë“œ (ìë™ ë²„ì „ ì¦ê°€)
      - name: Build Android APK
        run: |
          cd ${{ env.FLUTTER_PROJECT_PATH }}
          flutter build apk --release --build-number=${{ github.run_number }}

      # 10. ì •ë³´ ìˆ˜ì§‘ ì„œë²„ ì „ì†¡ (Webhook)
      - name: Report Status
        if: always()
        run: |
          STATUS="${{ job.status }}"
          VERSION="${{ github.run_number }}"
          
          JSON_DATA=$(cat <<EOF
          {
            "status": "$STATUS",
            "version": "$VERSION",
            "repo": "${{ github.repository }}"
          }
          EOF
          )
          
          if [ -n "${{ secrets.INFO_SERVER_URL }}" ]; then
            echo "Sending webhook..."
            curl -X POST -H "Content-Type: application/json" \
            -d "$JSON_DATA" \
            ${{ secrets.INFO_SERVER_URL }}
          else
            echo "Skipping webhook (No Secret)."
          fi

      # 11. ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-v${{ github.run_number }}
          path: ${{ env.FLUTTER_PROJECT_PATH }}/build/app/outputs/flutter-apk/app-release.apk
          compression-level: 9
