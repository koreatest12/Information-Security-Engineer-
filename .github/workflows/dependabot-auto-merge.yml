name: ğŸ¤– Dependabot Auto-Merge & Batch Processor

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [opened, synchronize, reopened]
  workflow_dispatch: # ê´€ë¦¬ì ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

permissions:
  contents: write       # ì½”ë“œ ë³‘í•© ê¶Œí•œ
  pull-requests: write  # PR ìŠ¹ì¸ ë° ì½”ë©˜íŠ¸ ê¶Œí•œ
  checks: read          # CI ìƒíƒœ í™•ì¸ ê¶Œí•œ

jobs:
  approve-and-merge:
    runs-on: ubuntu-latest
    # ì¡°ê±´: ë´‡ì´ ë§Œë“  PRì´ê±°ë‚˜, ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í–ˆì„ ë•Œë§Œ ì‘ë™
    if: ${{ github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ========================================================
      # [Case 1] ë´‡ì´ PRì„ ìƒì„±í–ˆì„ ë•Œ (ì‹¤ì‹œê°„ ë‹¨ì¼ ì²˜ë¦¬)
      # ========================================================
      
      # 1-1. ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (Dependabot Action ì‚¬ìš©)
      - name: Fetch Metadata (Auto Event)
        if: ${{ github.event_name != 'workflow_dispatch' }}
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      # 1-2. ìŠ¹ì¸ ë° ë³‘í•© (Major ë²„ì „ ì œì™¸)
      - name: Approve & Merge (Auto Event)
        if: ${{ github.event_name != 'workflow_dispatch' && steps.metadata.outputs.update-type != 'version-update:semver-major' }}
        run: |
          echo "ğŸ¤– Processing PR: $PR_URL"
          echo "ğŸ“¦ Update Type: ${{ steps.metadata.outputs.update-type }}"
          
          # ìŠ¹ì¸ (Approve)
          gh pr review "$PR_URL" --approve --body "ğŸ¤– Dependabot Automation: Approved safe update."
          
          # ìë™ ë³‘í•© í™œì„±í™” (Squash Merge)
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========================================================
      # [Case 2] ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ (ì¼ê´„ ì²˜ë¦¬)
      # ========================================================
      
      - name: Manual Batch Process (Safe Mode)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "ğŸ” Searching for open Dependabot PRs..."
          
          # Dependabot PR ì¡°íšŒ (ë¼ë²¨ ì •ë³´ í¬í•¨)
          prs=$(gh pr list --state open --app dependabot --json number,url,title,labels --limit 50)
          
          if [ -z "$prs" ] || [ "$prs" == "[]" ]; then
            echo "âœ… No open Dependabot PRs found."
            exit 0
          fi
          
          echo "ğŸ“‹ Found PRs. Starting safety check and merge process..."
          
          # PR í•˜ë‚˜ì”© ìˆœíšŒí•˜ë©° ì²˜ë¦¬
          echo "$prs" | jq -c '.[]' | while read -r pr; do
            pr_url=$(echo "$pr" | jq -r '.url')
            pr_title=$(echo "$pr" | jq -r '.title')
            # ë¼ë²¨ ì •ë³´ë¥¼ í†µí•´ ë²„ì „ í™•ì¸ (dependabotì€ 'semver:major', 'semver:minor' ë“±ì˜ ë¼ë²¨ì„ ë¶™ì„)
            labels=$(echo "$pr" | jq -r '.labels[].name')
            
            echo "---------------------------------------------------"
            echo "Processing: $pr_title"
            
            # [ì•ˆì „ì¥ì¹˜] Major ë²„ì „ ì—…ë°ì´íŠ¸ì¸ì§€ í™•ì¸ (ë¼ë²¨ ë¶„ì„)
            if echo "$labels" | grep -q "semver:major"; then
              echo "âš ï¸ SKIP: Major version update detected. Manual review required."
              continue
            fi

            # 1. ìŠ¹ì¸ (Approve)
            echo "âœ… Safe update detected. Approving..."
            gh pr review "$pr_url" --approve --body "ğŸ¤– Manual Dispatch: Batch Approved (Safe Update)." || echo "NOTE: Already approved."
            
            # 2. ìë™ ë³‘í•© (Merge)
            echo "ğŸš€ Enabling auto-merge..."
            gh pr merge --auto --squash "$pr_url" || echo "âš ï¸ Merge waiting for checks."
            
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
