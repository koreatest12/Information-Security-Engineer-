name: ğŸ¤– Dependabot Auto-Merge & Batch Processor

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [opened, synchronize, reopened]
  workflow_dispatch: # ê´€ë¦¬ì ìˆ˜ë™ ì‹¤í–‰ (ì¼ê´„ ì²˜ë¦¬)

permissions:
  contents: write       # ë³‘í•© ê¶Œí•œ
  pull-requests: write  # ìŠ¹ì¸ ë° ì½”ë©˜íŠ¸ ê¶Œí•œ
  checks: read          # CI ìƒíƒœ í™•ì¸

jobs:
  dependabot-manager:
    runs-on: ubuntu-latest
    # ë´‡ì´ ìƒì„±í•œ PRì´ê±°ë‚˜, ê´€ë¦¬ìê°€ ìˆ˜ë™ ì‹¤í–‰í•œ ê²½ìš°ë§Œ ì‘ë™
    if: ${{ github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ========================================================
      # [Case 1] ì‹¤ì‹œê°„ ë‹¨ì¼ ì²˜ë¦¬ (Auto Event)
      # ========================================================
      - name: Fetch Metadata (Auto Event)
        if: ${{ github.event_name != 'workflow_dispatch' }}
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Approve & Merge (Single PR)
        if: ${{ github.event_name != 'workflow_dispatch' }}
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"
          
          echo "ğŸ¤– Processing Single PR: $PR_URL"
          echo "ğŸ“¦ Update Type: $UPDATE_TYPE"

          # [ì•ˆì „ì¥ì¹˜] Major ë²„ì „ ì—…ë°ì´íŠ¸ëŠ” ìë™ ë³‘í•© ì œì™¸
          if [[ "$UPDATE_TYPE" == "version-update:semver-major" ]]; then
            echo "âš ï¸ Major version update detected. Skipping auto-merge."
            exit 0
          fi

          # 1. ìŠ¹ì¸ (Approve)
          gh pr review "$PR_URL" --approve --body "ğŸ¤– Dependabot Automation: Approved safe update."

          # 2. ë³‘í•© ì‹œë„ (Auto Merge) -> ì‹¤íŒ¨ ì‹œ ê²½ê³ ë§Œ ì¶œë ¥í•˜ê³  ë„˜ì–´ê° (|| true)
          echo "ğŸš€ Attempting to enable auto-merge..."
          gh pr merge --auto --squash "$PR_URL" || echo "âš ï¸ Auto-merge failed. Please check 'Allow auto-merge' in Repo Settings."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========================================================
      # [Case 2] ì¼ê´„ ì²˜ë¦¬ (Manual Batch)
      # ========================================================
      - name: Manual Batch Process (Safe Mode)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "ğŸ” Searching for open Dependabot PRs..."
          
          # Dependabot PR ì¡°íšŒ (ìµœëŒ€ 50ê°œ)
          prs=$(gh pr list --state open --app dependabot --json number,url,title,labels --limit 50)

          if [ -z "$prs" ] || [ "$prs" == "[]" ]; then
            echo "âœ… No open Dependabot PRs found."
            exit 0
          fi

          echo "ğŸ“‹ Found PRs. Starting processing loop..."

          # jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSON íŒŒì‹± í›„ ë£¨í”„ ì²˜ë¦¬
          echo "$prs" | jq -c '.[]' | while read -r pr; do
            pr_url=$(echo "$pr" | jq -r '.url')
            pr_title=$(echo "$pr" | jq -r '.title')
            # ë¼ë²¨ ë°°ì—´ì„ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ê²€ìƒ‰ ìš©ì´í•˜ê²Œ í•¨
            labels=$(echo "$pr" | jq -r '.labels[].name' | tr '\n' ' ')

            echo "---------------------------------------------------"
            echo "Processing: $pr_title"
            echo "Labels: $labels"

            # [ì•ˆì „ì¥ì¹˜] Major ë²„ì „ ë¼ë²¨ í™•ì¸
            if [[ "$labels" == *"semver:major"* ]]; then
              echo "âš ï¸ SKIP: Major version update detected ($pr_title)"
              continue
            fi

            # 1. ìŠ¹ì¸ (Approve) - ì´ë¯¸ ìŠ¹ì¸ëœ ê²½ìš° ì—ëŸ¬ ë¬´ì‹œ
            gh pr review "$pr_url" --approve --body "ğŸ¤– Manual Batch: Approved safe update." || echo "â„¹ï¸ Review already submitted or failed."

            # 2. ë³‘í•© (Merge) - ì‹¤íŒ¨í•˜ë”ë¼ë„ ìŠ¤í¬ë¦½íŠ¸ê°€ ì¤‘ë‹¨ë˜ì§€ ì•Šë„ë¡ ì²˜ë¦¬
            echo "ğŸš€ Enabling auto-merge..."
            if gh pr merge --auto --squash "$pr_url"; then
              echo "âœ… Auto-merge enabled for $pr_title"
            else
              echo "âŒ Failed to enable auto-merge for $pr_title. (Check Repo Settings or Branch Rules)"
            fi
            
            # API ì†ë„ ì œí•œ ë°©ì§€ë¥¼ ìœ„í•œ ì§§ì€ ëŒ€ê¸°
            sleep 2
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
