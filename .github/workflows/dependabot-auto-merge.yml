# íŒŒì¼ ê²½ë¡œ: .github/workflows/dependabot-auto-merge.yml
name: ğŸ¤– Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [opened, synchronize, reopened]
  workflow_dispatch: # ìˆ˜ë™ ì¼ê´„ ì²˜ë¦¬ ë²„íŠ¼

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  approve-and-merge:
    runs-on: ubuntu-latest
    # ë´‡ì´ ë§Œë“  PRì´ê±°ë‚˜, ê´€ë¦¬ìê°€ ìˆ˜ë™ ì‹¤í–‰í–ˆì„ ë•Œë§Œ ì‘ë™
    if: ${{ github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # [Case 1] ë´‡ì´ ìë™ìœ¼ë¡œ PRì„ ì˜¬ë ¸ì„ ë•Œ (ë‹¨ì¼ ì²˜ë¦¬)
      - name: Fetch Metadata (Auto Event)
        if: ${{ github.event_name != 'workflow_dispatch' }}
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Approve & Merge (Auto Event)
        if: ${{ github.event_name != 'workflow_dispatch' && steps.metadata.outputs.update-type != 'version-update:semver-major' }}
        run: |
          echo "ğŸ¤– Auto-processing PR: $PR_URL"
          gh pr review "$PR_URL" --approve --body "ğŸ¤– Dependabot Automation: Approved by Workflow."
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # [Case 2] ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ (ì¼ê´„ ì²˜ë¦¬)
      - name: Manual Batch Process
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "ğŸ” Searching for open Dependabot PRs..."
          prs=$(gh pr list --state open --app dependabot --json number,url,title --limit 50)
          
          if [ -z "$prs" ] || [ "$prs" == "[]" ]; then
            echo "âœ… No open Dependabot PRs found."
            exit 0
          fi
          
          echo "$prs" | jq -c '.[]' | while read -r pr; do
            pr_url=$(echo "$pr" | jq -r '.url')
            pr_title=$(echo "$pr" | jq -r '.title')
            echo "Processing: $pr_title"
            
            # ìŠ¹ì¸ ë° ìë™ ë³‘í•© ì„¤ì •
            gh pr review "$pr_url" --approve --body "ğŸ¤– Manual Dispatch: Batch Approved." || true
            gh pr merge --auto --squash "$pr_url" || echo "âš ï¸ Check CI status for $pr_title"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
