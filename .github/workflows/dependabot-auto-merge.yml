name: ğŸ¤– Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened] # PRì´ ì—´ë¦¬ê±°ë‚˜ ìˆ˜ì •ë  ë•Œ íŠ¸ë¦¬ê±°
  pull_request_target:
    types: [opened, synchronize, reopened] # í¬í¬ëœ ì €ì¥ì†Œë‚˜ ê¶Œí•œ ì´ìŠˆ ëŒ€ë¹„ìš©
  workflow_dispatch:                       # [NEW] ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ ì¶”ê°€

permissions:
  contents: write       # ì½”ë“œ ë³‘í•©ì„ ìœ„í•´ ì“°ê¸° ê¶Œí•œ í•„ìˆ˜
  pull-requests: write  # PR ìŠ¹ì¸ ë° ì½”ë©˜íŠ¸ë¥¼ ìœ„í•´ í•„ìˆ˜
  checks: read          # CI í…ŒìŠ¤íŠ¸ ê²°ê³¼ í™•ì¸ìš©

jobs:
  approve-and-merge:
    runs-on: ubuntu-latest
    # ë´‡ì´ ìƒì„±í•œ PRì´ê±°ë‚˜, ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í–ˆì„ ë•Œë§Œ ì§„í–‰
    if: ${{ github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # [Case 1] ìë™ íŠ¸ë¦¬ê±° (PR ì´ë²¤íŠ¸) ì²˜ë¦¬
      # ë´‡ì´ PRì„ ì˜¬ë ¸ì„ ë•Œ í•´ë‹¹ PR 1ê°œì— ëŒ€í•´ì„œë§Œ ë™ì‘
      - name: Fetch Dependabot metadata (For PR Event)
        if: ${{ github.event_name != 'workflow_dispatch' }}
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Approve PR (For PR Event)
        if: ${{ github.event_name != 'workflow_dispatch' && steps.metadata.outputs.update-type != 'version-update:semver-major' }}
        run: |
          echo "âœ… Approving PR for ${{ steps.metadata.outputs.package-name }}"
          gh pr review "$PR_URL" --approve --body "ğŸ¤– Dependabot automation: Approved via GitHub Actions."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable Auto-Merge (For PR Event)
        if: ${{ github.event_name != 'workflow_dispatch' && steps.metadata.outputs.update-type != 'version-update:semver-major' }}
        run: |
          echo "ğŸš€ Enabling auto-merge for ${{ steps.metadata.outputs.package-name }}"
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # [Case 2] ìˆ˜ë™ ì‹¤í–‰ (workflow_dispatch) ì²˜ë¦¬
      # í˜„ì¬ ì—´ë ¤ìˆëŠ” ëª¨ë“  Dependabot PRì„ ì¡°íšŒí•˜ì—¬ ì¼ê´„ ì²˜ë¦¬
      - name: Handle Manual Dispatch (Process All Open Dependabot PRs)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "ğŸ” Searching for open Dependabot PRs..."
          
          # Dependabotì´ ì‘ì„±í•œ ì—´ë ¤ìˆëŠ” PR ëª©ë¡ ì¡°íšŒ
          prs=$(gh pr list --state open --app dependabot --json number,url,title --limit 50)
          
          if [ -z "$prs" ] || [ "$prs" == "[]" ]; then
            echo "âœ… No open Dependabot PRs found."
            exit 0
          fi
          
          echo "Found PRs to process. Starting batch update..."
          
          # ê° PRì— ëŒ€í•´ ë£¨í”„ë¥¼ ëŒë©° ì²˜ë¦¬
          echo "$prs" | jq -c '.[]' | while read -r pr; do
            pr_url=$(echo "$pr" | jq -r '.url')
            pr_title=$(echo "$pr" | jq -r '.title')
            
            echo "Processing: $pr_title ($pr_url)"
            
            # ë©”ì´ì € ì—…ë°ì´íŠ¸ì¸ì§€ ì œëª©ìœ¼ë¡œ ê°„ë‹¨ ì²´í¬ (ì•ˆì „ì¥ì¹˜)
            # ì œëª©ì— "major"ê°€ í¬í•¨ë˜ì–´ ìˆê±°ë‚˜ "to v2/v3" ì²˜ëŸ¼ í° ìˆ«ì ë³€ê²½ì´ ë³´ì´ë©´ ìŠ¤í‚µ ê¶Œì¥
            # ì—¬ê¸°ì„œëŠ” í¸ì˜ìƒ ì¼ê´„ ìŠ¹ì¸ ë° Auto-Merge í™œì„±í™” ìˆ˜í–‰
            
            # 1. ìŠ¹ì¸ (Approve)
            gh pr review "$pr_url" --approve --body "ğŸ¤– Batch Update: Approved manually via Workflow Dispatch." || echo "Already approved or failed to approve."
            
            # 2. ìë™ ë³‘í•© (Auto-Merge)
            gh pr merge --auto --squash "$pr_url" || echo "Failed to enable auto-merge (Check CI status)."
            
            echo "-----------------------------------"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
