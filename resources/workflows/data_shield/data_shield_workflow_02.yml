version: "1.1"
name: "Data Shield Workflow 02"
description: |
  Auto-generated workflow including Server Security Upgrade,
  Encryption/Decryption, Outbound DLP, and DB Indexing for batch 02.
metadata:
  owner: data-security
  classification: restricted
  rotation_window_hours: 12
stages:
  # [NEW] 서버 업그레이드 및 보안 패치 단계 추가
  - id: server_maintenance
    name: Server Security Upgrade & Patch
    tasks:
      - action: system.package_update
        target: os_packages
        security_only: true
        description: "Apply critical security patches before processing data"
      - action: shield.agent_upgrade
        channel: stable
        version_constraint: ">= 2.5.0"
        description: "Upgrade Data Shield agent to latest stable version"

  - id: encrypt_content
    name: AES-256 Encrypt Content
    tasks:
      - action: crypto.encrypt
        algorithm: aes-256-gcm
        key_ref: secrets.KMS_PRIMARY_KEY
        iv_strategy: random_96bit
        inputs:
          - source: artifacts/raw_payload_02.json
            target: vault/encrypted/payload_02.bin

  - id: decrypt_verify
    name: Controlled Decryption
    tasks:
      - action: crypto.decrypt
        algorithm: aes-256-gcm
        key_ref: secrets.KMS_PRIMARY_KEY
        integrity_check: sha256
        inputs:
          - source: vault/encrypted/payload_02.bin
            target: artifacts/decrypted/payload_02.json

  - id: outbound_guard
    name: DLP Egress Control
    tasks:
      - action: dlp.scan
        modes: [pii, secrets, credentials]
        block_on_match: true
        file_allowlist: ['.sql','.parquet','.json']
        destinations: [s3, ftp, http]

  - id: db_encrypt_and_index
    name: Secure Table with Index
    tasks:
      - action: database.create_table
        engine: sqlite
        table: secure_dataset_02
        columns:
          - name: record_id
            type: TEXT
            encrypted: false
            primary: true
          - name: payload_ciphertext
            type: BLOB
            encrypted: true
            encryption: aes-256-gcm
          - name: payload_hash
            type: TEXT
            encrypted: false
            derived_from: payload_ciphertext
      - action: database.create_index
        engine: sqlite
        table: secure_dataset_02
        index: idx_secure_dataset_02_hash
        columns: [payload_hash]
        unique: true
